# TheProjectSan é¡¹ç›®æ¶æ„ä¸ä»£ç é€»è¾‘åˆ†ææŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
> **é¡¹ç›®ç‰ˆæœ¬**: 1.0.0  
> **åˆ†æèŒƒå›´**: å®Œæ•´é¡¹ç›®æ¶æ„ã€æ ¸å¿ƒæ¨¡å—ä»£ç é€»è¾‘ã€æ•°æ®æµã€éƒ¨ç½²æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
4. [æ•°æ®æµåˆ†æ](#æ•°æ®æµåˆ†æ)
5. [å…³é”®æŠ€æœ¯å®ç°](#å…³é”®æŠ€æœ¯å®ç°)
6. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
7. [ä»£ç è´¨é‡ä¸ä¼˜åŒ–å»ºè®®](#ä»£ç è´¨é‡ä¸ä¼˜åŒ–å»ºè®®)

---

## é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®å®šä½
TheProjectSan æ˜¯ä¸€ä¸ªåŸºäºAIçš„å®æ—¶å¯¹è¯ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- **Live2Dè§’è‰²äº¤äº’**ï¼šå®æ—¶æ¸²æŸ“Live2Dæ¨¡å‹ï¼Œæ”¯æŒè¡¨æƒ…ã€åŠ¨ä½œæ§åˆ¶
- **è¯­éŸ³å¯¹è¯**ï¼šè¯­éŸ³è¯†åˆ«(ASR) + æ–‡æœ¬è½¬è¯­éŸ³(TTS) + è¯­éŸ³æ´»åŠ¨æ£€æµ‹(VAD)
- **å¤šæ¨¡æ€è¾“å…¥**ï¼šæ”¯æŒæ–‡æœ¬ã€è¯­éŸ³ã€å›¾ç‰‡è¾“å…¥
- **å·¥å…·è°ƒç”¨**ï¼šé€šè¿‡MCPåè®®é›†æˆå¤–éƒ¨å·¥å…·ï¼ˆå¹¿å‘Šã€å¤©æ°”ã€æ—¶é—´ç­‰ï¼‰
- **å¤šç§Ÿæˆ·æ”¯æŒ**ï¼šåŸºäºCLIENT_IDçš„å®Œå…¨æ•°æ®éš”ç¦»
- **äº‘å­˜å‚¨é›†æˆ**ï¼šæ”¯æŒæœ¬åœ°å­˜å‚¨å’ŒS3å¯¹è±¡å­˜å‚¨

### æŠ€æœ¯æ ˆ

**åç«¯**:
- Python 3.x
- FastAPI (Webæ¡†æ¶)
- WebSocket (å®æ—¶é€šä¿¡)
- asyncio (å¼‚æ­¥å¤„ç†)
- Loguru (æ—¥å¿—)
- Pydantic (é…ç½®éªŒè¯)

**å‰ç«¯**:
- Electron (æ¡Œé¢åº”ç”¨æ¡†æ¶)
- React 18 (UIæ¡†æ¶)
- TypeScript
- Pixi.js (Live2Dæ¸²æŸ“)
- Zustand (çŠ¶æ€ç®¡ç†)
- Vite (æ„å»ºå·¥å…·)

**AI/ML**:
- OpenAI API / å…¼å®¹API (LLM)
- Sherpa-ONNX (ASR)
- Fish TTS API (TTS)
- Silero VAD (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)

**å­˜å‚¨**:
- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- AWS S3 (å¯é€‰)
- SQLite (èŠå¤©å†å²)

---

## æ•´ä½“æ¶æ„

### æ¶æ„åˆ†å±‚å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±‚ (Electron + React)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Live2D   â”‚  â”‚ éŸ³é¢‘å¤„ç† â”‚  â”‚ WebSocketâ”‚  â”‚ çŠ¶æ€ç®¡ç†â”‚ â”‚
â”‚  â”‚ æ¸²æŸ“å¼•æ“ â”‚  â”‚ VAD/ASR  â”‚  â”‚ å®¢æˆ·ç«¯   â”‚  â”‚ Zustand â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†• WebSocket / HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 åç«¯å±‚ (FastAPI + Python)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚WebSocket â”‚  â”‚ å¯¹è¯å¤„ç† â”‚  â”‚ Agent    â”‚  â”‚ å­˜å‚¨æœåŠ¡â”‚ â”‚
â”‚  â”‚ Handler  â”‚  â”‚ ç®¡ç†å™¨   â”‚  â”‚ å¼•æ“     â”‚  â”‚ Factory â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ASRå¼•æ“ â”‚  â”‚ TTSå¼•æ“  â”‚  â”‚ VADå¼•æ“  â”‚  â”‚ MCPå®¢æˆ·ç«¯â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ æœ¬åœ°å­˜å‚¨ â”‚  â”‚ S3å­˜å‚¨   â”‚  â”‚ SQLite   â”‚              â”‚
â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ å†å²è®°å½• â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¤–éƒ¨æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ OpenAI   â”‚  â”‚ Fish TTS â”‚  â”‚ MCPæœåŠ¡å™¨â”‚              â”‚
â”‚  â”‚ API      â”‚  â”‚ API      â”‚  â”‚ (å¹¿å‘Š/å¤©æ°”)â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶å…³ç³»

```
run_server.py (å…¥å£)
    â†“
WebSocketServer (server.py)
    â”œâ”€â”€ WebSocketHandler (websocket_handler.py)
    â”‚   â”œâ”€â”€ ServiceContext (service_context.py)
    â”‚   â”‚   â”œâ”€â”€ AgentEngine (agent/)
    â”‚   â”‚   â”œâ”€â”€ ASREngine (asr/)
    â”‚   â”‚   â”œâ”€â”€ TTSEngine (tts/)
    â”‚   â”‚   â”œâ”€â”€ VADEngine (vad/)
    â”‚   â”‚   â””â”€â”€ MCPClient (mcpp/)
    â”‚   â””â”€â”€ ConversationHandler (conversations/)
    â””â”€â”€ Routes (routes.py)
        â”œâ”€â”€ /client-ws (WebSocket)
        â”œâ”€â”€ /api/ads (å¹¿å‘Šç®¡ç†)
        â””â”€â”€ /api/upload (æ–‡ä»¶ä¸Šä¼ )
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. å…¥å£æ¨¡å— (`run_server.py`)

**èŒè´£**: åº”ç”¨å¯åŠ¨å…¥å£ï¼Œåˆå§‹åŒ–æ—¥å¿—ã€é…ç½®ã€æœåŠ¡å™¨

**å…³é”®é€»è¾‘**:
```python
# 1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
init_logger(console_log_level)

# 2. åŠ è½½é…ç½®æ–‡ä»¶
config = validate_config(read_yaml("conf.yaml"))

# 3. åˆ›å»ºWebSocketæœåŠ¡å™¨
server = WebSocketServer(config=config)

# 4. å¼‚æ­¥åˆå§‹åŒ–æœåŠ¡ä¸Šä¸‹æ–‡
await server.initialize()

# 5. å¯åŠ¨UvicornæœåŠ¡å™¨
uvicorn.run(app=server.app, host=host, port=port)
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨`asyncio.run()`è¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–
- æ”¯æŒ`--verbose`å‚æ•°æ§åˆ¶æ—¥å¿—çº§åˆ«
- æ”¯æŒHuggingFaceé•œåƒé…ç½®

---

### 2. WebSocketæœåŠ¡å™¨ (`server.py`)

**èŒè´£**: FastAPIåº”ç”¨åˆ›å»ºã€è·¯ç”±æ³¨å†Œã€é™æ€æ–‡ä»¶æœåŠ¡

**å…³é”®ç»„ä»¶**:

#### 2.1 CORSStaticFiles
- è‡ªå®šä¹‰é™æ€æ–‡ä»¶å¤„ç†å™¨
- ä¸ºæ‰€æœ‰å“åº”æ·»åŠ CORSå¤´
- æ”¯æŒåª’ä½“æ–‡ä»¶çš„è·¨åŸŸè®¿é—®

#### 2.2 WebSocketServerç±»
```python
class WebSocketServer:
    def __init__(self, config, default_context_cache=None):
        self.app = FastAPI()
        self.config = config
        self.default_context_cache = default_context_cache or ServiceContext()
        
        # æ³¨å†Œè·¯ç”±
        client_ws_router, self.websocket_handler = init_client_ws_route(...)
        self.app.include_router(client_ws_router)
        
        # æŒ‚è½½é™æ€æ–‡ä»¶
        self.app.mount("/cache", CORSStaticFiles(...))
        self.app.mount("/live2d-models", CORSStaticFiles(...))
        self.app.mount("/ads", CORSStaticFiles(...))
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨`default_context_cache`ä½œä¸ºå…±äº«æœåŠ¡ä¸Šä¸‹æ–‡
- é™æ€æ–‡ä»¶æŒ‰ä¼˜å…ˆçº§æŒ‚è½½ï¼ˆcache â†’ live2d â†’ ads â†’ frontendï¼‰
- æ”¯æŒä»£ç†æ¨¡å¼ï¼ˆ`enable_proxy`ï¼‰

---

### 3. WebSocketå¤„ç†å™¨ (`websocket_handler.py`)

**èŒè´£**: ç®¡ç†WebSocketè¿æ¥ã€æ¶ˆæ¯è·¯ç”±ã€å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸ

#### 3.1 è¿æ¥ç®¡ç†

**æ•°æ®ç»“æ„**:
```python
class WebSocketHandler:
    def __init__(self, default_context_cache):
        self.client_connections: Dict[str, WebSocket] = {}  # å®¢æˆ·ç«¯è¿æ¥
        self.client_contexts: Dict[str, ServiceContext] = {}  # å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡
        self.current_conversation_tasks: Dict[str, Task] = {}  # å¯¹è¯ä»»åŠ¡
        self.received_data_buffers: Dict[str, np.ndarray] = {}  # éŸ³é¢‘ç¼“å†²
        self._last_heartbeat: Dict[str, float] = {}  # å¿ƒè·³æ—¶é—´
```

**è¿æ¥æµç¨‹**:
```
1. å®¢æˆ·ç«¯è¿æ¥ â†’ handle_new_connection()
   â”œâ”€â”€ åˆ›å»ºServiceContextï¼ˆå¤ç”¨default_context_cacheçš„ç»„ä»¶ï¼‰
   â”œâ”€â”€ åˆå§‹åŒ–å®¢æˆ·ç«¯æ•°æ®ï¼ˆbuffers, heartbeatï¼‰
   â””â”€â”€ å‘é€åˆå§‹æ¶ˆæ¯ï¼ˆæ¨¡å‹ä¿¡æ¯ã€å¯åŠ¨éº¦å…‹é£ï¼‰

2. æ¶ˆæ¯å¤„ç† â†’ handle_websocket_communication()
   â”œâ”€â”€ æ¥æ”¶JSONæ¶ˆæ¯
   â”œâ”€â”€ è·¯ç”±åˆ°å¯¹åº”å¤„ç†å™¨
   â””â”€â”€ å¤„ç†å¼‚å¸¸å’Œæ–­å¼€

3. æ–­å¼€æ¸…ç† â†’ handle_disconnect()
   â”œâ”€â”€ å–æ¶ˆè¿›è¡Œä¸­çš„å¯¹è¯ä»»åŠ¡
   â”œâ”€â”€ æ¸…ç†ServiceContextï¼ˆè·³è¿‡å…±äº«ç»„ä»¶ï¼‰
   â””â”€â”€ æ¸…ç†æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€
```

#### 3.2 æ¶ˆæ¯è·¯ç”±

**æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**:
```python
_message_handlers = {
    # å†å²è®°å½•
    "fetch-history-list": _handle_history_list_request,
    "fetch-and-set-history": _handle_fetch_history,
    "create-new-history": _handle_create_history,
    "delete-history": _handle_delete_history,
    
    # å¯¹è¯è§¦å‘
    "mic-audio-end": _handle_conversation_trigger,
    "text-input": _handle_conversation_trigger,
    "ai-speak-signal": _handle_conversation_trigger,
    
    # éŸ³é¢‘æ•°æ®
    "mic-audio-data": _handle_audio_data,
    "raw-audio-data": _handle_raw_audio_data,
    
    # æ§åˆ¶
    "interrupt-signal": _handle_interrupt,
    "adaptive-vad-control": _handle_adaptive_vad_control,
    
    # é…ç½®
    "fetch-configs": _handle_fetch_configs,
    "switch-config": _handle_config_switch,
    
    # MCPå·¥å…·
    "mcp-tool-call": _handle_mcp_tool_call,
    
    # å¿ƒè·³
    "heartbeat": _handle_heartbeat,
}
```

**å…³é”®è®¾è®¡**:
- å•ç”¨æˆ·ä¼˜åŒ–ï¼šå¤ç”¨MCPç»„ä»¶ï¼ˆ`mcp_client`, `tool_manager`, `tool_executor`ï¼‰
- å¿ƒè·³ä¿æ´»ï¼šæ¯30ç§’æ£€æŸ¥ï¼Œ60ç§’æ— å¿ƒè·³è‡ªåŠ¨æ–­å¼€
- ä»»åŠ¡ç®¡ç†ï¼šæ¯ä¸ªå®¢æˆ·ç«¯æœ€å¤šä¸€ä¸ªå¯¹è¯ä»»åŠ¡ï¼Œæ–°ä»»åŠ¡ä¼šå–æ¶ˆæ—§ä»»åŠ¡

---

### 4. æœåŠ¡ä¸Šä¸‹æ–‡ (`service_context.py`)

**èŒè´£**: ç®¡ç†æ‰€æœ‰AIæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸå’Œé…ç½®

#### 4.1 ç»„ä»¶åˆå§‹åŒ–

**åˆå§‹åŒ–é¡ºåº**:
```
1. Live2Dæ¨¡å‹ (åŒæ­¥ï¼Œåœ¨çº¿ç¨‹æ± æ‰§è¡Œ)
2. ASRå¼•æ“ (åŒæ­¥ï¼Œåœ¨çº¿ç¨‹æ± æ‰§è¡Œ)
3. TTSå¼•æ“ (åŒæ­¥ï¼Œåœ¨çº¿ç¨‹æ± æ‰§è¡Œ)
4. VADå¼•æ“ (åŒæ­¥ï¼Œåœ¨çº¿ç¨‹æ± æ‰§è¡Œ)
5. MCPç»„ä»¶ (å¼‚æ­¥)
   â”œâ”€â”€ ServerRegistry
   â”œâ”€â”€ ToolAdapter
   â”œâ”€â”€ ToolManager
   â”œâ”€â”€ MCPClient
   â””â”€â”€ ToolExecutor
6. Agentå¼•æ“ (å¼‚æ­¥ï¼Œåœ¨çº¿ç¨‹æ± æ‰§è¡Œ)
```

**å…³é”®æ–¹æ³•**:

**`load_from_config()`**: ä»é…ç½®æ–‡ä»¶åŠ è½½æ‰€æœ‰ç»„ä»¶
```python
async def load_from_config(self, config: Config):
    # åœ¨çº¿ç¨‹æ± ä¸­åˆå§‹åŒ–åŒæ­¥ç»„ä»¶
    await asyncio.to_thread(self.init_live2d, ...)
    await asyncio.to_thread(self.init_asr, ...)
    await asyncio.to_thread(self.init_tts, ...)
    await asyncio.to_thread(self.init_vad, ...)
    
    # å¼‚æ­¥åˆå§‹åŒ–MCPç»„ä»¶
    await self._init_mcp_components(...)
    
    # åœ¨çº¿ç¨‹æ± ä¸­åˆå§‹åŒ–Agent
    await asyncio.to_thread(AgentFactory.create_agent, ...)
```

**`load_cache()`**: å¤ç”¨å·²æœ‰ç»„ä»¶ï¼ˆå•ç”¨æˆ·ä¼˜åŒ–ï¼‰
```python
async def load_cache(
    self,
    config, system_config, character_config,
    live2d_model, asr_engine, tts_engine, vad_engine, agent_engine,
    mcp_client, tool_manager, tool_executor, mcp_prompt,  # å¤ç”¨MCPç»„ä»¶
    ...
):
    # ç›´æ¥å¼•ç”¨ï¼Œä¸é‡æ–°åˆ›å»º
    self.mcp_client = mcp_client
    self.tool_manager = tool_manager
    self.tool_executor = tool_executor
```

**`handle_config_switch()`**: åŠ¨æ€åˆ‡æ¢é…ç½®
```python
async def handle_config_switch(self, websocket, config_file_name):
    # 1. åŠ è½½æ–°é…ç½®ï¼ˆåˆå¹¶åŸºç¡€é…ç½®ï¼‰
    new_config = validate_config(...)
    
    # 2. ç«‹å³åˆ‡æ¢Live2Dï¼ˆç”¨æˆ·å¯è§ï¼‰
    await asyncio.to_thread(self.init_live2d, ...)
    await websocket.send_text({"type": "set-model-and-conf", ...})
    
    # 3. åå°åˆå§‹åŒ–å…¶ä»–ç»„ä»¶ï¼ˆä¸é˜»å¡ï¼‰
    task = asyncio.create_task(_finish_heavy_init())
    self._background_tasks.append(task)
```

#### 4.2 MCPç»„ä»¶åˆå§‹åŒ–

**`_init_mcp_components()`**: åˆå§‹åŒ–MCPå·¥å…·ç³»ç»Ÿ
```python
async def _init_mcp_components(self, use_mcpp, enabled_servers):
    # 1. åˆ›å»ºServerRegistry
    self.mcp_server_registery = ServerRegistry()
    
    # 2. é€šè¿‡ToolAdapterè·å–å·¥å…·ä¿¡æ¯ï¼ˆé‡è¯•æœºåˆ¶ï¼‰
    for attempt in range(max_retries):
        try:
            mcp_prompt_string, openai_tools, claude_tools = \
                await self.tool_adapter.get_tools(enabled_servers)
            break
        except Exception as e:
            if attempt < max_retries - 1:
                await asyncio.sleep(retry_delay)
    
    # 3. åˆ›å»ºToolManager
    self.tool_manager = ToolManager(
        formatted_tools_openai=openai_tools,
        formatted_tools_claude=claude_tools,
        initial_tools_dict=raw_tools_dict,
    )
    
    # 4. åˆ›å»ºMCPClient
    self.mcp_client = MCPClient(self.mcp_server_registery, ...)
    
    # 5. åˆ›å»ºToolExecutor
    self.tool_executor = ToolExecutor(self.mcp_client, self.tool_manager)
    
    # 6. é¢„çƒ­MCPæœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
    for server_name in enabled_servers:
        await self.mcp_client.list_tools(server_name)
```

---

### 5. å¯¹è¯å¤„ç† (`conversations/`)

#### 5.1 å¯¹è¯æµç¨‹ (`single_conversation.py`)

**å®Œæ•´æµç¨‹**:
```
process_single_conversation()
    â†“
1. å‘é€å¯¹è¯å¼€å§‹ä¿¡å·
    â”œâ”€â”€ "conversation-start"
    â””â”€â”€ "thinking"
    â†“
2. å¤„ç†ç”¨æˆ·è¾“å…¥
    â”œâ”€â”€ å¦‚æœæ˜¯éŸ³é¢‘ â†’ ASRè½¬æ–‡æœ¬
    â””â”€â”€ å¦‚æœæ˜¯æ–‡æœ¬ â†’ ç›´æ¥ä½¿ç”¨
    â†“
3. å”¤é†’è¯å¤„ç† (wake_word_manager)
    â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†
    â””â”€â”€ ç§»é™¤å”¤é†’è¯å‰ç¼€
    â†“
4. å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚æœå¯ç”¨å†å²ï¼‰
    â†“
5. è°ƒç”¨Agentç”Ÿæˆå“åº”
    â”œâ”€â”€ agent.chat(batch_input)
    â””â”€â”€ æµå¼è¾“å‡ºå¤„ç†
        â”œâ”€â”€ SentenceOutput â†’ TTSç”ŸæˆéŸ³é¢‘
        â”œâ”€â”€ AudioOutput â†’ ç›´æ¥å‘é€
        â””â”€â”€ tool_call_status â†’ å‘é€å·¥å…·çŠ¶æ€
    â†“
6. ç­‰å¾…TTSä»»åŠ¡å®Œæˆ
    â†“
7. å‘é€å¯¹è¯ç»“æŸä¿¡å·
    â”œâ”€â”€ "backend-synth-complete"
    â””â”€â”€ "conversation-end"
    â†“
8. å­˜å‚¨AIå“åº”ï¼ˆå¦‚æœå¯ç”¨å†å²ï¼‰
```

**å…³é”®ä»£ç **:
```python
async def process_single_conversation(...):
    tts_manager = TTSTaskManager()
    full_response = ""
    
    # 1. å‘é€å¼€å§‹ä¿¡å·
    await send_conversation_start_signals(websocket_send)
    
    # 2. å¤„ç†ç”¨æˆ·è¾“å…¥
    input_text = await process_user_input(user_input, asr_engine, websocket_send)
    
    # 3. å”¤é†’è¯å¤„ç†
    should_process, processed_text = await wake_word_manager.process_transcription(
        input_text, client_uid, websocket_send
    )
    if not should_process:
        return ""  # å¿½ç•¥è¾“å…¥
    
    # 4. åˆ›å»ºæ‰¹å¤„ç†è¾“å…¥
    batch_input = create_batch_input(input_text, images, ...)
    
    # 5. Agentç”Ÿæˆå“åº”ï¼ˆæµå¼ï¼‰
    agent_output_stream = context.agent_engine.chat(batch_input)
    async for output_item in agent_output_stream:
        if isinstance(output_item, SentenceOutput):
            response_part = await process_agent_output(...)
            full_response += response_part
    
    # 6. ç­‰å¾…TTSå®Œæˆ
    await asyncio.gather(*tts_manager.task_list)
    
    # 7. å­˜å‚¨å†å²
    if context.history_uid:
        store_message(..., role="ai", content=full_response)
    
    return full_response
```

#### 5.2 å¯¹è¯å¤„ç†å™¨ (`conversation_handler.py`)

**èŒè´£**: å¤„ç†å¯¹è¯è§¦å‘å’Œä¸­æ–­

**`handle_conversation_trigger()`**:
```python
async def handle_conversation_trigger(...):
    # 1. æ ¹æ®æ¶ˆæ¯ç±»å‹è·å–ç”¨æˆ·è¾“å…¥
    if msg_type == "ai-speak-signal":
        user_input = load_proactive_speak_prompt()
        metadata = {"proactive_speak": True, "skip_memory": True, "skip_history": True}
    elif msg_type == "text-input":
        user_input = data.get("text")
    else:  # mic-audio-end
        user_input = received_data_buffers[client_uid]
        received_data_buffers[client_uid] = np.array([])
    
    # 2. å–æ¶ˆæ—§ä»»åŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    existing_task = current_conversation_tasks.get(client_uid)
    if existing_task and not existing_task.done():
        existing_task.cancel()
    
    # 3. å¯åŠ¨æ–°å¯¹è¯ä»»åŠ¡
    task = asyncio.create_task(_run_single_turn())
    current_conversation_tasks[client_uid] = task
```

**`handle_individual_interrupt()`**:
```python
async def handle_individual_interrupt(...):
    # 1. å–æ¶ˆå¯¹è¯ä»»åŠ¡
    task = current_conversation_tasks[client_uid]
    if task and not task.done():
        task.cancel()
    
    # 2. é€šçŸ¥Agentä¸­æ–­
    context.agent_engine.handle_interrupt(heard_response)
    
    # 3. å­˜å‚¨ä¸­æ–­è®°å½•
    store_message(..., role="ai", content=heard_response + "...")
    store_message(..., role="system", content="[Interrupted by user]")
```

---

### 6. Agentå¼•æ“ (`agent/agents/basic_memory_agent.py`)

**èŒè´£**: LLMå¯¹è¯ã€å·¥å…·è°ƒç”¨ã€è®°å¿†ç®¡ç†

#### 6.1 è®°å¿†ç®¡ç†

**å†…å­˜ç»“æ„**:
```python
class BasicMemoryAgent:
    MAX_MEMORY_MESSAGES: int = 6  # é™åˆ¶è®°å¿†é•¿åº¦
    
    def __init__(self, ...):
        self._memory: List[Dict] = []  # å¯¹è¯å†å²
    
    def _add_message(self, message, role, skip_memory=False):
        if skip_memory:
            return
        
        message_data = {"role": role, "content": text_content}
        self._memory.append(message_data)
        
        # é™åˆ¶è®°å¿†çª—å£
        if len(self._memory) > self.MAX_MEMORY_MESSAGES:
            self._memory = self._memory[-self.MAX_MEMORY_MESSAGES:]
```

#### 6.2 å·¥å…·è°ƒç”¨æµç¨‹

**ä¸¤ç§æ¨¡å¼**:

**1. OpenAIåŸç”Ÿå·¥å…·è°ƒç”¨**:
```python
async def _openai_tool_interaction_loop(self, messages, tools):
    while True:
        # 1. è°ƒç”¨LLMï¼ˆå¸¦toolså‚æ•°ï¼‰
        stream = self._llm.chat_completion(messages, system_prompt, tools=tools)
        
        # 2. æ£€æµ‹å·¥å…·è°ƒç”¨
        async for event in stream:
            if isinstance(event, list) and all(isinstance(tc, ToolCallObject) for tc in event):
                pending_tool_calls = event
                break
        
        # 3. æ‰§è¡Œå·¥å…·
        if pending_tool_calls:
            tool_executor_iterator = self._tool_executor.execute_tools(
                tool_calls=pending_tool_calls,
                caller_mode="OpenAI"
            )
            async for update in tool_executor_iterator:
                if update.get("type") == "final_tool_results":
                    tool_results = update.get("results", [])
                    messages.extend(tool_results)  # æ·»åŠ åˆ°å¯¹è¯å†å²
                    continue  # ç»§ç»­LLMè°ƒç”¨
```

**2. Promptæ¨¡å¼ï¼ˆJSONæ£€æµ‹ï¼‰**:
```python
# å½“LLMä¸æ”¯æŒåŸç”Ÿå·¥å…·è°ƒç”¨æ—¶
self.prompt_mode_flag = True

# 1. LLMç”ŸæˆåŒ…å«JSONçš„æ–‡æœ¬
stream = self._llm.chat_completion(messages, system_prompt + mcp_prompt_string)

# 2. å®æ—¶æ£€æµ‹JSON
async for event in stream:
    current_turn_text += event
    potential_json = self._json_detector.process_chunk(event)
    if potential_json:
        detected_prompt_json = potential_json
        break

# 3. è§£æå¹¶æ‰§è¡Œå·¥å…·
parsed_tools = self._tool_executor.process_tool_from_prompt_json(detected_prompt_json)
tool_executor_iterator = self._tool_executor.execute_tools(
    tool_calls=parsed_tools,
    caller_mode="Prompt"
)
```

#### 6.3 å¯¹è¯ç®¡é“

**è£…é¥°å™¨é“¾**:
```python
@tts_filter(tts_preprocessor_config)  # TTSé¢„å¤„ç†ï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
@display_processor()                   # æ˜¾ç¤ºæ–‡æœ¬å¤„ç†
@actions_extractor(live2d_model)      # æå–Live2DåŠ¨ä½œ
@sentence_divider(...)                 # å¥å­åˆ†å‰²
async def chat_with_memory(input_data):
    # 1. å‡†å¤‡æ¶ˆæ¯
    messages = self._to_messages(input_data)
    
    # 2. é€‰æ‹©å·¥å…·æ¨¡å¼
    if self._use_mcpp and tool_mode == "OpenAI":
        async for output in self._openai_tool_interaction_loop(messages, tools):
            yield output
    else:
        # ç®€å•å¯¹è¯
        token_stream = self._llm.chat_completion(messages, self._system)
        async for event in token_stream:
            yield event
```

---

### 7. MCPç³»ç»Ÿ (`mcpp/`)

#### 7.1 MCPå®¢æˆ·ç«¯ (`mcp_client.py`)

**èŒè´£**: ç®¡ç†ä¸MCPæœåŠ¡å™¨çš„è¿æ¥ã€å·¥å…·è°ƒç”¨

**å…³é”®æ–¹æ³•**:

**`_ensure_server_running_and_get_session()`**:
```python
async def _ensure_server_running_and_get_session(self, server_name):
    # 1. æ£€æŸ¥ç¼“å­˜
    if server_name in self.active_sessions:
        return self.active_sessions[server_name]
    
    # 2. ä»æ³¨å†Œè¡¨è·å–æœåŠ¡å™¨é…ç½®
    server = self.server_registery.get_server(server_name)
    
    # 3. åˆ›å»ºstdioè¿æ¥
    stdio_transport = await stdio_client(server_params)
    session = await ClientSession(read, write, ...)
    await session.initialize()
    
    # 4. ç¼“å­˜session
    self.active_sessions[server_name] = session
    return session
```

**`call_tool()`**:
```python
async def call_tool(self, server_name, tool_name, tool_args):
    max_attempts = 2
    for attempt in range(1, max_attempts + 1):
        try:
            session = await self._ensure_server_running_and_get_session(server_name)
            response = await session.call_tool(tool_name, tool_args)
            return {
                "metadata": response.metadata,
                "content_items": [...]
            }
        except ClosedResourceError:
            # é‡è¿
            if server_name in self.active_sessions:
                await self.active_sessions[server_name].close()
                del self.active_sessions[server_name]
```

#### 7.2 å·¥å…·æ‰§è¡Œå™¨ (`tool_executor.py`)

**èŒè´£**: æ‰§è¡Œå·¥å…·è°ƒç”¨ã€å¤„ç†ç»“æœã€æµå¼æ›´æ–°

**æ‰§è¡Œæµç¨‹**:
```
execute_tools(tool_calls, caller_mode)
    â†“
1. è§£æå·¥å…·è°ƒç”¨
    â”œâ”€â”€ OpenAIæ¨¡å¼: ç›´æ¥ä½¿ç”¨tool_calls
    â””â”€â”€ Promptæ¨¡å¼: ä»JSONè§£æ
    â†“
2. æŒ‰æœåŠ¡å™¨åˆ†ç»„
    â†“
3. å¹¶å‘æ‰§è¡Œå·¥å…·
    â”œâ”€â”€ è°ƒç”¨MCPClient.call_tool()
    â””â”€â”€ å‘é€çŠ¶æ€æ›´æ–°
        â”œâ”€â”€ "tool_call_start"
        â”œâ”€â”€ "tool_call_progress"
        â””â”€â”€ "tool_call_complete"
    â†“
4. æ ¼å¼åŒ–ç»“æœ
    â”œâ”€â”€ OpenAIæ ¼å¼: {"role": "tool", "content": ...}
    â””â”€â”€ è¿”å›ç»™Agent
```

---

### 8. å­˜å‚¨ç³»ç»Ÿ (`storage/`)

#### 8.1 å­˜å‚¨æ¥å£ (`storage_interface.py`)

**æŠ½è±¡æ¥å£**:
```python
class StorageInterface(ABC):
    @abstractmethod
    async def upload_file(file_data, category, filename) -> str
    
    @abstractmethod
    async def list_files(category) -> List[Dict]
    
    @abstractmethod
    async def delete_file(category, filename) -> bool
    
    @abstractmethod
    async def file_exists(category, filename) -> bool
    
    @abstractmethod
    def get_file_url(category, filename) -> str
```

#### 8.2 æœ¬åœ°å­˜å‚¨ (`local_service.py`)

**ç›®å½•ç»“æ„**:
```
ads/
  â””â”€â”€ client_001/
      â”œâ”€â”€ video1.mp4
      â””â”€â”€ video2.mp4
agent/
  â””â”€â”€ client_001/
      â”œâ”€â”€ images/
      â””â”€â”€ videos/
```

**å®ç°**:
```python
class LocalStorageService(StorageInterface):
    def _get_client_dir(self, category) -> Path:
        return self.base_directory / category / self.client_id
    
    async def upload_file(self, file_data, category, filename):
        client_dir = self._get_client_dir(category)
        file_path = client_dir / filename
        with open(file_path, "wb") as f:
            f.write(file_data)
        return f"{category}/{self.client_id}/{filename}"
```

#### 8.3 S3å­˜å‚¨ (`s3_service.py`)

**S3 Keyç»“æ„**:
```
client_001/ads/video1.mp4
client_001/agent/images/photo1.jpg
```

**å®ç°**:
```python
class S3StorageService(StorageInterface):
    def _get_s3_key(self, category, filename):
        return f"{self.client_id}/{category}/{filename}"
    
    async def upload_file(self, file_data, category, filename):
        s3_key = self._get_s3_key(category, filename)
        self.s3_client.put_object(
            Bucket=self.bucket,
            Key=s3_key,
            Body=file_data,
            ContentType=self._get_content_type(filename)
        )
        return s3_key
```

#### 8.4 å­˜å‚¨å·¥å‚ (`storage_factory.py`)

**å·¥å‚æ¨¡å¼**:
```python
def create_storage_service(config: MediaServerConfig, client_id: str):
    storage_type = config.storage_type.lower()
    
    if storage_type == "s3":
        return S3StorageService(
            client_id=client_id,
            bucket=config.s3_bucket,
            region=config.s3_region,
            ...
        )
    elif storage_type == "local":
        return LocalStorageService(
            client_id=client_id,
            base_directory=config.base_directory
        )
```

---

### 9. è·¯ç”±ç³»ç»Ÿ (`routes.py`)

#### 9.1 WebSocketè·¯ç”±

**`/client-ws`**: ä¸»å®¢æˆ·ç«¯è¿æ¥
```python
@router.websocket("/client-ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    client_uid = str(uuid4())
    
    await ws_handler.handle_new_connection(websocket, client_uid)
    await ws_handler.handle_websocket_communication(websocket, client_uid)
```

#### 9.2 HTTP APIè·¯ç”±

**å¹¿å‘Šç®¡ç†**:
- `GET /api/ads` - è·å–å¹¿å‘Šåˆ—è¡¨
- `POST /api/ads/upload` - ä¸Šä¼ å¹¿å‘Š
- `DELETE /api/ads/{filename}` - åˆ é™¤å¹¿å‘Š

**é€šç”¨ä¸Šä¼ **:
- `POST /api/upload` - ä¸Šä¼ åª’ä½“æ–‡ä»¶ï¼ˆæ”¯æŒads/agentåˆ†ç±»ï¼‰

**é…ç½®ç®¡ç†**:
- `GET /api/config-files` - è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨
- `GET /api/settings/load` - åŠ è½½è®¾ç½®
- `POST /api/settings/save` - ä¿å­˜è®¾ç½®

**å…³é”®è®¾è®¡**:
- æ‰€æœ‰APIæ”¯æŒ`client`å‚æ•°ï¼ˆå¤šç§Ÿæˆ·ï¼‰
- ä¼˜å…ˆçº§: APIå‚æ•° > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
- ä¸Šä¼ åè‡ªåŠ¨å¹¿æ’­åˆ·æ–°æ¶ˆæ¯åˆ°WebSocketå®¢æˆ·ç«¯

---

## æ•°æ®æµåˆ†æ

### 1. è¯­éŸ³å¯¹è¯æµç¨‹

```
ç”¨æˆ·è¯´è¯
    â†“
å‰ç«¯VADæ£€æµ‹ â†’ mic-audio-data (éŸ³é¢‘å—)
    â†“
åç«¯æ¥æ”¶ â†’ received_data_buffers[client_uid] += audio
    â†“
å‰ç«¯VADç¡®è®¤ç»“æŸ â†’ mic-audio-end
    â†“
åç«¯å¤„ç†:
    1. æå–éŸ³é¢‘ç¼“å†²
    2. ASRè½¬æ–‡æœ¬
    3. å”¤é†’è¯å¤„ç†
    4. è°ƒç”¨Agent
        â†“
    Agentç”Ÿæˆå“åº”ï¼ˆæµå¼ï¼‰
        â”œâ”€â”€ æ–‡æœ¬å— â†’ å¥å­åˆ†å‰² â†’ TTSç”ŸæˆéŸ³é¢‘
        â”œâ”€â”€ Live2DåŠ¨ä½œ â†’ å‘é€åŠ¨ä½œæŒ‡ä»¤
        â””â”€â”€ å·¥å…·è°ƒç”¨ â†’ MCPæ‰§è¡Œ â†’ ç»“æœè¿”å›Agent
    â†“
å‰ç«¯æ¥æ”¶:
    â”œâ”€â”€ audio-chunk (éŸ³é¢‘å—)
    â”œâ”€â”€ live2d-action (åŠ¨ä½œ)
    â””â”€â”€ full-text (å®Œæ•´æ–‡æœ¬)
    â†“
å‰ç«¯æ’­æ”¾éŸ³é¢‘ + æ˜¾ç¤ºæ–‡æœ¬ + æ›´æ–°Live2D
```

### 2. å·¥å…·è°ƒç”¨æµç¨‹

```
ç”¨æˆ·: "æ’­æ”¾å¹¿å‘Š"
    â†“
Agentæ£€æµ‹å·¥å…·è°ƒç”¨éœ€æ±‚
    â†“
_openai_tool_interaction_loop():
    1. LLMè¿”å›tool_calls: [{"name": "play_advertisement", ...}]
    2. ToolExecutor.execute_tools():
        â”œâ”€â”€ è§£æå·¥å…·è°ƒç”¨
        â”œâ”€â”€ è°ƒç”¨MCPClient.call_tool("advertisement-server", "play_advertisement", ...)
        â”œâ”€â”€ MCPClientè¿æ¥MCPæœåŠ¡å™¨ï¼ˆstdioï¼‰
        â”œâ”€â”€ MCPæœåŠ¡å™¨æ‰§è¡Œå·¥å…·
        â””â”€â”€ è¿”å›ç»“æœ
    3. å°†ç»“æœæ·»åŠ åˆ°messages
    4. ç»§ç»­LLMè°ƒç”¨ï¼ˆç”Ÿæˆæœ€ç»ˆå“åº”ï¼‰
    â†“
Agentè¿”å›: "å¥½çš„ï¼Œæ­£åœ¨æ’­æ”¾å¹¿å‘Š..."
    â†“
å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤º
```

### 3. é…ç½®åˆ‡æ¢æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢è§’è‰²
    â†“
å‰ç«¯å‘é€: {"type": "switch-config", "file": "sakura.yaml"}
    â†“
åç«¯å¤„ç† (_handle_config_switch):
    1. åŠ è½½æ–°é…ç½®ï¼ˆåˆå¹¶åŸºç¡€é…ç½®ï¼‰
    2. ç«‹å³åˆ‡æ¢Live2Dï¼ˆå‘é€set-model-and-confï¼‰
    3. åå°åˆå§‹åŒ–å…¶ä»–ç»„ä»¶ï¼ˆASR/TTS/VAD/MCP/Agentï¼‰
    â†“
å‰ç«¯æ¥æ”¶set-model-and-conf:
    â”œâ”€â”€ æ›´æ–°Zustand store
    â”œâ”€â”€ é‡æ–°åŠ è½½Live2Dæ¨¡å‹
    â””â”€â”€ æ›´æ–°UI
    â†“
åå°åˆå§‹åŒ–å®Œæˆï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
```

### 4. æ–‡ä»¶ä¸Šä¼ æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ å¹¿å‘Šè§†é¢‘
    â†“
å‰ç«¯FormData â†’ POST /api/ads/upload?client=client_001
    â†“
åç«¯å¤„ç†:
    1. è·å–client_idï¼ˆä¼˜å…ˆçº§: APIå‚æ•° > ç¯å¢ƒå˜é‡ > é…ç½®ï¼‰
    2. åˆ›å»ºå­˜å‚¨æœåŠ¡: create_storage_service(config, client_id)
    3. éªŒè¯æ–‡ä»¶ï¼ˆç±»å‹ã€å¤§å°ï¼‰
    4. ä¸Šä¼ : storage_service.upload_file(file_data, "ads", filename)
        â”œâ”€â”€ æœ¬åœ°: ä¿å­˜åˆ° ads/client_001/filename.mp4
        â””â”€â”€ S3: ä¸Šä¼ åˆ° s3://bucket/client_001/ads/filename.mp4
    5. å¹¿æ’­åˆ·æ–°æ¶ˆæ¯åˆ°WebSocketå®¢æˆ·ç«¯
    â†“
å‰ç«¯æ¥æ”¶advertisement-refresh:
    â””â”€â”€ åˆ·æ–°å¹¿å‘Šåˆ—è¡¨
```

---

## å…³é”®æŠ€æœ¯å®ç°

### 1. å•ç”¨æˆ·ä¼˜åŒ–ï¼ˆMCPç»„ä»¶å¤ç”¨ï¼‰

**é—®é¢˜**: æ¯æ¬¡è¿æ¥éƒ½åˆ›å»ºæ–°çš„MCPç»„ä»¶ï¼Œå¯¼è‡´Agentå¼•ç”¨å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
```python
# default_context_cacheåˆå§‹åŒ–æ—¶åˆ›å»ºMCPç»„ä»¶
await default_context_cache.load_from_config(config)

# æ–°è¿æ¥æ—¶å¤ç”¨MCPç»„ä»¶
session_context = ServiceContext()
await session_context.load_cache(
    ...,
    mcp_client=default_context_cache.mcp_client,  # å¤ç”¨
    tool_manager=default_context_cache.tool_manager,  # å¤ç”¨
    tool_executor=default_context_cache.tool_executor,  # å¤ç”¨
)

# æ–­å¼€æ—¶è·³è¿‡MCPç»„ä»¶æ¸…ç†
await context.close(skip_shared_cleanup=True)
```

### 2. å¼‚æ­¥åˆå§‹åŒ–ä¼˜åŒ–

**é—®é¢˜**: åŒæ­¥åˆå§‹åŒ–é˜»å¡äº‹ä»¶å¾ªç¯

**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡ŒåŒæ­¥åˆå§‹åŒ–
await asyncio.to_thread(self.init_live2d, model_name)
await asyncio.to_thread(self.init_asr, asr_config)

# é…ç½®åˆ‡æ¢æ—¶ç«‹å³è¿”å›ï¼Œåå°åˆå§‹åŒ–
await asyncio.to_thread(self.init_live2d, ...)  # ç«‹å³æ‰§è¡Œ
task = asyncio.create_task(_finish_heavy_init())  # åå°æ‰§è¡Œ
```

### 3. å¿ƒè·³ä¿æ´»æœºåˆ¶

**å®ç°**:
```python
async def _sweep_stale(self, ttl=60.0):
    while True:
        await asyncio.sleep(30)
        now = asyncio.get_event_loop().time()
        stale = [uid for uid, ts in self._last_heartbeat.items() 
                 if now - ts > ttl]
        for uid in stale:
            await self.handle_disconnect(uid)
```

### 4. è‡ªé€‚åº”VAD

**ç”¨é€”**: å¹¿å‘Šæ’­æ”¾æ—¶è‡ªåŠ¨è°ƒæ•´VADé˜ˆå€¼ï¼Œé¿å…è¯¯è§¦å‘

**å®ç°**:
```python
# å‰ç«¯å‘é€
{"type": "adaptive-vad-control", "action": "start", "volume": 0.8}

# åç«¯å¤„ç†
set_advertisement_playing(True, volume=0.8)
# VADå¼•æ“è‡ªåŠ¨è°ƒæ•´é˜ˆå€¼
```

### 5. å¤šç§Ÿæˆ·éš”ç¦»

**CLIENT_IDä¼ é€’è·¯å¾„**:
```
1. ç¯å¢ƒå˜é‡: CLIENT_ID=client_001 (Docker)
2. é…ç½®æ–‡ä»¶: media_server.client_id
3. APIå‚æ•°: ?client=client_001
4. é»˜è®¤å€¼: default_client
```

**å­˜å‚¨éš”ç¦»**:
- æœ¬åœ°: `ads/client_001/` vs `ads/client_002/`
- S3: `client_001/ads/` vs `client_002/ads/`

---

## éƒ¨ç½²æ¶æ„

### 1. å•æœºéƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æœ¬åœ°å¼€å‘ç¯å¢ƒ                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Pythonåç«¯ (12393ç«¯å£)    â”‚  â”‚
â”‚  â”‚  - FastAPIæœåŠ¡å™¨           â”‚  â”‚
â”‚  â”‚  - WebSocketæœåŠ¡           â”‚  â”‚
â”‚  â”‚  - æœ¬åœ°å­˜å‚¨ (ads/)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Electronå‰ç«¯              â”‚  â”‚
â”‚  â”‚  - Reactåº”ç”¨               â”‚  â”‚
â”‚  â”‚  - Live2Dæ¸²æŸ“             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Dockeréƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**docker-compose.yml**:
```yaml
services:
  backend:
    image: theprojectsan-backend:latest
    ports:
      - "12393:12393"
    environment:
      - CLIENT_ID=client_001
      - STORAGE_TYPE=s3
      - S3_BUCKET=your-bucket
    volumes:
      - ./conf.yaml:/app/conf.yaml:ro
      - ./cache:/app/cache
  
  frontend:
    image: theprojectsan-frontend:latest
    ports:
      - "80:80"
    depends_on:
      - backend
```

### 3. å¤šå±éƒ¨ç½²ï¼ˆå¤šç§Ÿæˆ·ï¼‰

**æ¶æ„**:
```
Caddyåå‘ä»£ç†
    â”œâ”€â”€ screen1.example.com â†’ backend-screen1:12393
    â”œâ”€â”€ screen2.example.com â†’ backend-screen2:12394
    â””â”€â”€ screen3.example.com â†’ backend-screen3:12395
        â†“
æ¯ä¸ªåç«¯å®¹å™¨:
    - CLIENT_ID=client_screen1
    - ç‹¬ç«‹é…ç½®
    - å…±äº«S3å­˜å‚¨ï¼ˆæŒ‰CLIENT_IDéš”ç¦»ï¼‰
```

---

## ä»£ç è´¨é‡ä¸ä¼˜åŒ–å»ºè®®

### 1. å·²å®ç°çš„ä¼˜åŒ–

âœ… **å•ç”¨æˆ·MCPç»„ä»¶å¤ç”¨**: é¿å…é‡å¤åˆ›å»ºï¼Œæé«˜æ€§èƒ½  
âœ… **å¼‚æ­¥åˆå§‹åŒ–**: ä¸é˜»å¡äº‹ä»¶å¾ªç¯  
âœ… **å¿ƒè·³ä¿æ´»**: è‡ªåŠ¨æ¸…ç†åƒµå°¸è¿æ¥  
âœ… **ä»»åŠ¡ç®¡ç†**: é˜²æ­¢å¯¹è¯ä»»åŠ¡é‡å   
âœ… **é”™è¯¯é‡è¯•**: MCPå·¥å…·è°ƒç”¨æ”¯æŒé‡è¯•  
âœ… **èµ„æºæ¸…ç†**: æ–­å¼€æ—¶å½»åº•æ¸…ç†èµ„æº  

### 2. æ½œåœ¨ä¼˜åŒ–ç‚¹

**å†…å­˜ç®¡ç†**:
- è€ƒè™‘é™åˆ¶`received_data_buffers`çš„å¤§å°
- å®šæœŸæ¸…ç†è¿‡æœŸçš„MCP sessionç¼“å­˜

**æ€§èƒ½ä¼˜åŒ–**:
- TTSä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ˆå·²å®ç°ï¼‰
- ASRå¯ä»¥æ”¯æŒæµå¼è¯†åˆ«ï¼ˆéƒ¨åˆ†å®ç°ï¼‰

**é”™è¯¯å¤„ç†**:
- å¢åŠ æ›´è¯¦ç»†çš„é”™è¯¯åˆ†ç±»
- å®ç°é”™è¯¯æ¢å¤æœºåˆ¶

**ç›‘æ§ä¸æ—¥å¿—**:
- å¢åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- å®ç°ç»“æ„åŒ–æ—¥å¿—

### 3. ä»£ç ç»“æ„å»ºè®®

**ä¼˜ç‚¹**:
- âœ… æ¨¡å—åŒ–è®¾è®¡æ¸…æ™°
- âœ… æ¥å£æŠ½è±¡è‰¯å¥½ï¼ˆStorageInterface, ASRInterfaceç­‰ï¼‰
- âœ… é…ç½®ç®¡ç†ç»Ÿä¸€ï¼ˆPydanticæ¨¡å‹ï¼‰

**æ”¹è¿›ç©ºé—´**:
- å¯ä»¥è€ƒè™‘å¢åŠ å•å…ƒæµ‹è¯•
- å¢åŠ ç±»å‹æ³¨è§£çš„å®Œæ•´æ€§
- æ–‡æ¡£å­—ç¬¦ä¸²å¯ä»¥æ›´è¯¦ç»†

---

## æ€»ç»“

TheProjectSanæ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„AIå¯¹è¯ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ¶æ„æ¸…æ™°**: å‰åç«¯åˆ†ç¦»ï¼Œæ¨¡å—åŒ–è®¾è®¡
2. **åŠŸèƒ½å®Œæ•´**: æ”¯æŒè¯­éŸ³ã€æ–‡æœ¬ã€å›¾ç‰‡å¤šæ¨¡æ€è¾“å…¥
3. **æ‰©å±•æ€§å¼º**: MCPå·¥å…·ç³»ç»Ÿæ”¯æŒçµæ´»æ‰©å±•
4. **å¤šç§Ÿæˆ·æ”¯æŒ**: åŸºäºCLIENT_IDçš„å®Œå…¨éš”ç¦»
5. **æ€§èƒ½ä¼˜åŒ–**: å¼‚æ­¥å¤„ç†ã€ç»„ä»¶å¤ç”¨ã€ä»»åŠ¡ç®¡ç†

**æ ¸å¿ƒä¼˜åŠ¿**:
- å®æ—¶æ€§: WebSocket + æµå¼å¤„ç†
- å¯æ‰©å±•: MCPå·¥å…·ç³»ç»Ÿ
- å¯éƒ¨ç½²: æ”¯æŒæœ¬åœ°å’Œäº‘å­˜å‚¨
- å¯ç»´æŠ¤: æ¸…æ™°çš„ä»£ç ç»“æ„

**é€‚ç”¨åœºæ™¯**:
- æ™ºèƒ½å®¢æœ
- è™šæ‹ŸåŠ©æ‰‹
- å¹¿å‘Šå±äº¤äº’
- æ•™è‚²åŸ¹è®­

---

**æŠ¥å‘Šç»“æŸ**


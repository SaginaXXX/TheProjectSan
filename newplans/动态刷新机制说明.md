# ä¸»é¢˜ä»‹ç» - åŠ¨æ€åˆ·æ–°æœºåˆ¶è¯´æ˜

## é—®é¢˜åˆ†æ

### åŸé—®é¢˜ âŒ
```
ç”¨æˆ·ä¸Šä¼ æ–°ä¸»é¢˜/å›¾ç‰‡/è§†é¢‘
    â†“
MCPæœåŠ¡å™¨ä¸çŸ¥é“ï¼ˆå¯åŠ¨æ—¶åŠ è½½çš„æ•°æ®ï¼‰
    â†“
AIè°ƒç”¨å·¥å…· â†’ è¿”å›æ—§æ•°æ®ï¼ˆç©ºåˆ—è¡¨ï¼‰
    â†“
å¿…é¡»é‡å¯æœåŠ¡å™¨æ‰èƒ½çœ‹åˆ°æ–°æ•°æ®
```

**ç”Ÿäº§ç¯å¢ƒä¸å¯æ¥å—**: å®¢æˆ·æ¯æ¬¡ä¸Šä¼ éƒ½è¦è”ç³»æŠ€æœ¯äººå‘˜é‡å¯æœåŠ¡å™¨ã€‚

### è§£å†³æ–¹æ¡ˆ âœ…
```
ç”¨æˆ·ä¸Šä¼ æ–°ä¸»é¢˜/å›¾ç‰‡/è§†é¢‘
    â†“
APIè‡ªåŠ¨è§¦å‘ refresh_topics å·¥å…·
    â†“
MCPæœåŠ¡å™¨é‡æ–°æ‰«æç›®å½•
    â†“
AIç«‹å³å¯ä»¥çœ‹åˆ°æ–°æ•°æ®
    â†“
æ— éœ€é‡å¯æœåŠ¡å™¨ï¼
```

---

## å®ç°æœºåˆ¶

### 1. MCPæœåŠ¡å™¨å±‚ - refresh_topicså·¥å…·

**æ–‡ä»¶**: `src/ai_chat/mcpp/topic_introduction_server.py`

**æ–°å¢å·¥å…·**:
```python
types.Tool(
    name="refresh_topics",
    description="é‡æ–°æ‰«æä¸»é¢˜ç›®å½•ï¼Œåˆ·æ–°ä¸»é¢˜åˆ—è¡¨ï¼ˆç”¨æˆ·ä¸Šä¼ æ–°ä¸»é¢˜åè‡ªåŠ¨è°ƒç”¨ï¼‰",
    inputSchema={
        "type": "object",
        "properties": {},
        "required": []
    }
)
```

**å®ç°æ–¹æ³•**:
```python
async def _refresh_topics(self, arguments: dict):
    """åˆ·æ–°ä¸»é¢˜åˆ—è¡¨ï¼ˆé‡æ–°æ‰«æç›®å½•ï¼‰"""
    old_count = len(self.topics)
    self._load_topics()  # â† é‡æ–°æ‰«ætopicsç›®å½•
    new_count = len(self.topics)
    
    return [{
        "type": "refresh_response",
        "old_count": old_count,
        "new_count": new_count,
        "message": f"ä¸»é¢˜åˆ—è¡¨å·²åˆ·æ–°: {old_count} â†’ {new_count}"
    }]
```

### 2. APIå±‚ - è‡ªåŠ¨è§¦å‘åˆ·æ–°

**æ–‡ä»¶**: `src/ai_chat/routes.py`

**è§¦å‘æ—¶æœº**:
- âœ… åˆ›å»ºä¸»é¢˜æ—¶ (`POST /api/topics`)
- âœ… ä¸Šä¼ å›¾ç‰‡æ—¶ (`POST /api/topics/{topic_id}/images`)
- âœ… ä¸Šä¼ è§†é¢‘æ—¶ (`POST /api/topics/{topic_id}/videos`)

**å®ç°ä»£ç **:
```python
# åœ¨ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨è§¦å‘åˆ·æ–°
try:
    if hasattr(default_context_cache, 'mcp_client') and default_context_cache.mcp_client:
        logger.info("ğŸ”„ è§¦å‘ä¸»é¢˜åˆ—è¡¨åˆ·æ–°...")
        asyncio.create_task(
            default_context_cache.mcp_client.call_tool(
                "topic-introduction-server",
                "refresh_topics",
                {}
            )
        )
except Exception as e:
    logger.warning(f"è§¦å‘MCPåˆ·æ–°å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰: {e}")
```

---

## å·¥ä½œæµç¨‹

### ç”¨æˆ·ä¸Šä¼ æµç¨‹
```
æ­¥éª¤1: ç”¨æˆ·åœ¨æ§åˆ¶é¢æ¿åˆ›å»ºä¸»é¢˜
    â†“
POST /api/topics
    â†“
åˆ›å»ºtopic.jsonæ–‡ä»¶
    â†“
è‡ªåŠ¨è°ƒç”¨ refresh_topics å·¥å…·
    â†“
MCPæœåŠ¡å™¨é‡æ–°æ‰«ætopicsç›®å½•
    â†“
âœ… AIç«‹å³å¯ä»¥çœ‹åˆ°æ–°ä¸»é¢˜

æ­¥éª¤2: ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    â†“
POST /api/topics/{topic_id}/images
    â†“
ä¿å­˜å›¾ç‰‡æ–‡ä»¶ + æ›´æ–°topic.json
    â†“
è‡ªåŠ¨è°ƒç”¨ refresh_topics å·¥å…·
    â†“
MCPæœåŠ¡å™¨é‡æ–°åŠ è½½ä¸»é¢˜æ•°æ®
    â†“
âœ… AIç«‹å³å¯ä»¥çœ‹åˆ°æ–°å›¾ç‰‡

æ­¥éª¤3: ç”¨æˆ·ä¸Šä¼ è§†é¢‘
    â†“
POST /api/topics/{topic_id}/videos
    â†“
ä¿å­˜è§†é¢‘æ–‡ä»¶ + æ›´æ–°topic.json
    â†“
è‡ªåŠ¨è°ƒç”¨ refresh_topics å·¥å…·
    â†“
MCPæœåŠ¡å™¨é‡æ–°åŠ è½½ä¸»é¢˜æ•°æ®
    â†“
âœ… AIç«‹å³å¯ä»¥çœ‹åˆ°æ–°è§†é¢‘
```

### AIè°ƒç”¨æµç¨‹
```
ç”¨æˆ·: "æ¶©è°·äºŒæ¬¡å…ƒä¸»é¢˜çš„å›¾ç‰‡"
    â†“
AIè°ƒç”¨: get_topic_listï¼ˆè·å–æœ€æ–°åˆ—è¡¨ï¼‰
    â†“
MCPè¿”å›: ["æ¶©è°·äºŒæ¬¡å…ƒä¸»é¢˜", "å‡é¢éª‘å£«ä¸»é¢˜é…’åº—", ...]
    â†“
AIè°ƒç”¨: get_topic_image("æ¶©è°·äºŒæ¬¡å…ƒä¸»é¢˜")
    â†“
MCPè¿”å›: å›¾ç‰‡URL + æè¿°
    â†“
ç¬¬äºŒç”»å¸ƒ: æ˜¾ç¤ºå›¾ç‰‡
    â†“
AI: ä»‹ç»å›¾ç‰‡å†…å®¹
```

---

## ä¸å¹¿å‘ŠæœåŠ¡å™¨å¯¹æ¯”

### Advertisement Serverï¼ˆå‚è€ƒå®ç°ï¼‰
```python
# å·¥å…·: refresh_advertisements
async def _refresh_advertisements(self, arguments: dict):
    old_count = len(self.advertisements)
    self._scan_advertisements()  # é‡æ–°æ‰«æ
    new_count = len(self.advertisements)
    return refresh_response
```

### Topic Introduction Serverï¼ˆç›¸åŒå®ç°ï¼‰
```python
# å·¥å…·: refresh_topics
async def _refresh_topics(self, arguments: dict):
    old_count = len(self.topics)
    self._load_topics()  # é‡æ–°æ‰«æ
    new_count = len(self.topics)
    return refresh_response
```

**ç»“è®º**: âœ… å®Œå…¨ä¸€è‡´çš„å®ç°æ¨¡å¼

---

## æ€§èƒ½è€ƒè™‘

### åˆ·æ–°æˆæœ¬
- **æ‰«æç›®å½•**: O(n) - nä¸ºä¸»é¢˜æ•°é‡
- **è¯»å–JSON**: O(n) - æ¯ä¸ªä¸»é¢˜ä¸€ä¸ªæ–‡ä»¶
- **æ€»å¤æ‚åº¦**: O(n)ï¼Œné€šå¸¸ < 100

### è§¦å‘é¢‘ç‡
- åˆ›å»ºä¸»é¢˜: ä½é¢‘ï¼ˆæ¯å¤©å‡ æ¬¡ï¼‰
- ä¸Šä¼ å›¾ç‰‡: ä¸­é¢‘ï¼ˆæ¯ä¸ªä¸»é¢˜æœ€å¤š10æ¬¡ï¼‰
- ä¸Šä¼ è§†é¢‘: ä½é¢‘ï¼ˆæ¯ä¸ªä¸»é¢˜æœ€å¤š3æ¬¡ï¼‰

### ä¼˜åŒ–æªæ–½
- âœ… å¼‚æ­¥æ‰§è¡Œ: `asyncio.create_task`ï¼ˆä¸é˜»å¡APIå“åº”ï¼‰
- âœ… é”™è¯¯éš”ç¦»: try-exceptåŒ…è£¹ï¼ˆåˆ·æ–°å¤±è´¥ä¸å½±å“ä¸Šä¼ ï¼‰
- âœ… éè‡´å‘½é”™è¯¯: å³ä½¿åˆ·æ–°å¤±è´¥ï¼Œæ•°æ®ä¹Ÿå·²ä¿å­˜

---

## å¯¹ç°æœ‰æ¶æ„çš„å½±å“

### âœ… æ— ç ´åæ€§æ›´æ”¹
- MCPæœåŠ¡å™¨åªæ˜¯æ·»åŠ äº†æ–°å·¥å…·
- ç°æœ‰å·¥å…·é€»è¾‘ä¸å˜
- APIåªæ˜¯å¢åŠ äº†åˆ·æ–°è°ƒç”¨

### âœ… å‘åå…¼å®¹
- æ—§çš„ä¸»é¢˜æ•°æ®ä»ç„¶å¯ç”¨
- åˆ·æ–°å¤±è´¥ä¸å½±å“åŠŸèƒ½
- å¯é€‰çš„ä¼˜åŒ–ï¼Œä¸æ˜¯å¿…éœ€çš„

### âœ… ä¸å…¶ä»–MCPä¸€è‡´
- Advertisement Server: æœ‰ refresh_advertisements
- Topic Server: æœ‰ refresh_topics
- å®ç°æ¨¡å¼å®Œå…¨ç›¸åŒ

---

## æµ‹è¯•åœºæ™¯

### æµ‹è¯•1: åˆ›å»ºä¸»é¢˜åç«‹å³å¯ç”¨
```
1. ç”¨æˆ·åˆ›å»ºä¸»é¢˜"å…½è€³å¤æ—¥é…’åº—"
2. APIè°ƒç”¨refresh_topics
3. ç«‹å³è¯¢é—®AIï¼š"å¯ç”¨ä¸»é¢˜"
4. é¢„æœŸ: AIè¿”å›åŒ…å«"å…½è€³å¤æ—¥é…’åº—"çš„åˆ—è¡¨
```

### æµ‹è¯•2: ä¸Šä¼ å›¾ç‰‡åç«‹å³å¯è§
```
1. ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼ˆæè¿°ï¼š"ãƒ›ãƒ†ãƒ«ã®å¤–è¦³"ï¼‰
2. APIè°ƒç”¨refresh_topics
3. ç«‹å³è¯¢é—®AIï¼š"å…½è€³å¤æ—¥é…’åº—çš„å›¾ç‰‡"
4. é¢„æœŸ: ç¬¬äºŒç”»å¸ƒæ˜¾ç¤ºå›¾ç‰‡ï¼ŒAIä»‹ç»å†…å®¹
```

### æµ‹è¯•3: ä¸Šä¼ è§†é¢‘åç«‹å³å¯è§
```
1. ç”¨æˆ·ä¸Šä¼ è§†é¢‘ï¼ˆæè¿°ï¼š"ãƒ›ãƒ†ãƒ«ãƒ„ã‚¢ãƒ¼"ï¼‰
2. APIè°ƒç”¨refresh_topics
3. ç«‹å³è¯¢é—®AIï¼š"å…½è€³å¤æ—¥é…’åº—çš„è§†é¢‘"
4. é¢„æœŸ: ç¬¬äºŒç”»å¸ƒæ’­æ”¾è§†é¢‘ï¼ŒAIé™éŸ³
```

---

## æ—¥å¿—è¾“å‡º

### æˆåŠŸåˆ·æ–°
```
âœ… ä¸Šä¼ ä¸»é¢˜å›¾ç‰‡æˆåŠŸ: topic_xxx/img_xxx.jpg (client: client_001)
ğŸ”„ è§¦å‘ä¸»é¢˜åˆ—è¡¨åˆ·æ–°...
ğŸ“ æ‰«æä¸»é¢˜ç›®å½•: topics\client_001 (CLIENT_ID: client_001)
âœ… [client_001] åŠ è½½ä¸»é¢˜: å…½è€³å¤æ—¥é…’åº— (language: ja)
ğŸ“š ä¸»é¢˜æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆ: 2 ä¸ªä¸»é¢˜å·²åŠ è½½
```

### åˆ·æ–°å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰
```
âœ… ä¸Šä¼ ä¸»é¢˜å›¾ç‰‡æˆåŠŸ: topic_xxx/img_xxx.jpg (client: client_001)
ğŸ”„ è§¦å‘ä¸»é¢˜åˆ—è¡¨åˆ·æ–°...
âš ï¸ è§¦å‘MCPåˆ·æ–°å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰: MCP client not initialized
```
**è¯´æ˜**: å³ä½¿åˆ·æ–°å¤±è´¥ï¼Œæ•°æ®ä¹Ÿå·²ä¿å­˜ï¼Œåªæ˜¯éœ€è¦æ‰‹åŠ¨åˆ·æ–°æˆ–é‡å¯æœåŠ¡å™¨

---

## ä½¿ç”¨è¯´æ˜

### å®¢æˆ·è‡ªåŠ©ä½¿ç”¨
1. **åˆ›å»ºä¸»é¢˜** â†’ è‡ªåŠ¨åˆ·æ–° â†’ âœ… ç«‹å³å¯ç”¨
2. **ä¸Šä¼ å›¾ç‰‡** â†’ è‡ªåŠ¨åˆ·æ–° â†’ âœ… ç«‹å³å¯è§
3. **ä¸Šä¼ è§†é¢‘** â†’ è‡ªåŠ¨åˆ·æ–° â†’ âœ… ç«‹å³å¯è§
4. **è¯¢é—®AI** â†’ è·å–æœ€æ–°æ•°æ® â†’ âœ… æ­£å¸¸å±•ç¤º

**æ— éœ€è”ç³»æŠ€æœ¯äººå‘˜ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ï¼**

### æ‰‹åŠ¨åˆ·æ–°ï¼ˆå¯é€‰ï¼‰
å¦‚æœç”¨æˆ·æ€€ç–‘æ•°æ®æ²¡æ›´æ–°ï¼Œå¯ä»¥è¯¢é—®AIï¼š
```
ç”¨æˆ·: "åˆ·æ–°ä¸»é¢˜åˆ—è¡¨"
AIè°ƒç”¨: refresh_topics
è¿”å›: "ä¸»é¢˜åˆ—è¡¨å·²åˆ·æ–°: 1 â†’ 2"
```

---

## ä¼˜åŠ¿æ€»ç»“

### âœ… ç”¨æˆ·å‹å¥½
- ä¸Šä¼ å³å¯ç”¨
- æ— éœ€ç­‰å¾…
- æ— éœ€æŠ€æœ¯æ”¯æŒ

### âœ… ç³»ç»Ÿç¨³å®š
- éé˜»å¡å¼‚æ­¥æ‰§è¡Œ
- é”™è¯¯éš”ç¦»
- ä¸å½±å“ä¸»åŠŸèƒ½

### âœ… æ¶æ„æ¸…æ™°
- ä¸å¹¿å‘ŠæœåŠ¡å™¨ä¸€è‡´
- éµå¾ªç°æœ‰æ¨¡å¼
- æ˜“äºç»´æŠ¤

### âœ… æ€§èƒ½ä¼˜ç§€
- æŒ‰éœ€åˆ·æ–°
- O(n)å¤æ‚åº¦
- å¼‚æ­¥æ‰§è¡Œä¸é˜»å¡

---

## ğŸ‰ ç»“è®º

**é—®é¢˜å®Œç¾è§£å†³ï¼ç”¨æˆ·ä¸Šä¼ åæ— éœ€é‡å¯ï¼ŒMCPæœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ŒAIç«‹å³å¯ä»¥ä½¿ç”¨æ–°å†…å®¹ã€‚**

è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†å®ç°ï¼Œä¸ç°æœ‰æ¶æ„å®Œå…¨ä¸€è‡´ï¼Œæ— ç ´åæ€§æ›´æ”¹ã€‚


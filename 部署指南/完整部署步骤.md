# TheProjectSan å®Œæ•´éƒ¨ç½²æ­¥éª¤æŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡æ¸…å•

åœ¨å¼€å§‹éƒ¨ç½²å‰ï¼Œè¯·ç¡®ä¿ä½ æœ‰ï¼š

- [ ] ä¸€å°å®‰è£…äº†å®å¡”Linuxé¢æ¿çš„æœåŠ¡å™¨
- [ ] æœåŠ¡å™¨çš„å…¬ç½‘IPåœ°å€
- [ ] ä¸€ä¸ªå·²è´­ä¹°çš„åŸŸå
- [ ] GitHubä»“åº“åœ°å€ï¼ˆå‰åç«¯ä»£ç å·²ä¸Šä¼ ï¼‰
- [ ] OpenAI APIå¯†é’¥ï¼ˆæˆ–å…¶ä»–LLMæœåŠ¡APIå¯†é’¥ï¼‰
- [ ] SSHè®¿é—®æƒé™

---

## ç¬¬ä¸€æ­¥ï¼šè¿æ¥æœåŠ¡å™¨å¹¶æ£€æŸ¥ç¯å¢ƒ

### 1.1 è¿æ¥æœåŠ¡å™¨

ä½¿ç”¨SSHè¿æ¥åˆ°ä½ çš„æœåŠ¡å™¨ï¼š

```bash
ssh root@ä½ çš„æœåŠ¡å™¨IP
# æˆ–
ssh ç”¨æˆ·å@ä½ çš„æœåŠ¡å™¨IP
```

### 1.2 æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯

```bash
# æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬
cat /etc/os-release

# æŸ¥çœ‹å½“å‰ç›®å½•
pwd

# æŸ¥çœ‹ç£ç›˜ç©ºé—´
df -h
```

---

## ç¬¬äºŒæ­¥ï¼šå®‰è£…Dockerå’ŒDocker Compose

### 2.1 æ£€æŸ¥Dockeræ˜¯å¦å·²å®‰è£…

```bash
docker --version
```

**å¦‚æœå·²å®‰è£…**ï¼Œè·³è¿‡2.2ï¼Œç›´æ¥åˆ°2.3ã€‚

**å¦‚æœæœªå®‰è£…**ï¼Œç»§ç»­ä¸‹é¢çš„æ­¥éª¤ã€‚

### 2.2 å®‰è£…Dockerï¼ˆOpenCloudOSç³»ç»Ÿï¼‰

```bash
# 1. å®‰è£…å¿…è¦çš„ä¾èµ–
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# 2. æ·»åŠ Dockerå®˜æ–¹ä»“åº“ï¼ˆCentOSå…¼å®¹æ–¹å¼ï¼‰
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 3. å®‰è£…Docker Engineï¼ˆåŒ…å«docker-compose-pluginï¼‰
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 4. å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# 5. éªŒè¯å®‰è£…
sudo docker --version
```

### 2.3 éªŒè¯Docker Compose

```bash
# éªŒè¯ Docker Composeï¼ˆæ³¨æ„æ˜¯ç©ºæ ¼ï¼Œä¸æ˜¯æ¨ªçº¿ï¼‰
docker compose version

# åº”è¯¥æ˜¾ç¤ºï¼šDocker Compose version v2.32.1 æˆ–ç±»ä¼¼ç‰ˆæœ¬
```

å¦‚æœå‘½ä»¤å¤±è´¥ï¼Œæ‰§è¡Œï¼š

```bash
# é‡å¯DockeræœåŠ¡
sudo systemctl restart docker

# å†æ¬¡éªŒè¯
docker compose version
```

### 2.4 é…ç½®Dockerç”¨æˆ·æƒé™ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ï¼ˆé¿å…æ¯æ¬¡ä½¿ç”¨sudoï¼‰
sudo usermod -aG docker $USER

# ä½¿ç»„æƒé™ç”Ÿæ•ˆ
newgrp docker

# éªŒè¯ï¼ˆä¸éœ€è¦sudoï¼‰
docker --version
```

---

## ç¬¬ä¸‰æ­¥ï¼šé…ç½®å®å¡”é¢æ¿é˜²ç«å¢™

### 3.1 ç™»å½•å®å¡”é¢æ¿

1. åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP:8888`ï¼ˆæˆ–ä½ çš„å®å¡”é¢æ¿ç«¯å£ï¼‰
2. ä½¿ç”¨å®å¡”é¢æ¿çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•

### 3.2 å¼€æ”¾å¿…è¦ç«¯å£

1. è¿›å…¥ **å®‰å…¨** â†’ **é˜²ç«å¢™**
2. ç‚¹å‡» **æ·»åŠ è§„åˆ™**
3. æ·»åŠ ä»¥ä¸‹ç«¯å£è§„åˆ™ï¼š

| ç«¯å£ | åè®® | å¤‡æ³¨ |
|------|------|------|
| 80 | TCP | HTTP |
| 443 | TCP | HTTPS |
| 22 | TCP | SSHï¼ˆå¦‚æœä½¿ç”¨ï¼‰ |

4. ç‚¹å‡» **æäº¤**

---

## ç¬¬å››æ­¥ï¼šé…ç½®åŸŸåDNSè§£æ

### 4.1 åœ¨åŸŸåæœåŠ¡å•†å¤„æ·»åŠ Aè®°å½•

1. ç™»å½•ä½ çš„åŸŸåæœåŠ¡å•†ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€Cloudflareç­‰ï¼‰
2. è¿›å…¥åŸŸåè§£æç®¡ç†
3. æ·»åŠ Aè®°å½•ï¼š

```
è®°å½•ç±»å‹: A
ä¸»æœºè®°å½•: @ (æˆ–ç•™ç©ºï¼Œè¡¨ç¤ºä¸»åŸŸå)
è®°å½•å€¼: ä½ çš„æœåŠ¡å™¨å…¬ç½‘IPåœ°å€
TTL: 600 (æˆ–é»˜è®¤å€¼)
```

4. ä¿å­˜è®¾ç½®

### 4.2 éªŒè¯DNSè§£æ

ç­‰å¾…å‡ åˆ†é’Ÿåï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# æ£€æŸ¥DNSè§£æï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼‰
nslookup your-domain.com

# æˆ–
ping your-domain.com
```

**é‡è¦**ï¼šç¡®ä¿DNSè§£æå·²ç”Ÿæ•ˆï¼ˆæ˜¾ç¤ºä½ çš„æœåŠ¡å™¨IPï¼‰åå†ç»§ç»­ä¸‹ä¸€æ­¥ã€‚

---

## ç¬¬äº”æ­¥ï¼šä»GitHubå…‹éš†é¡¹ç›®

### 5.1 é€‰æ‹©é¡¹ç›®ç›®å½•

```bash
# è¿›å…¥åˆé€‚çš„ç›®å½•ï¼ˆæ¨èä½¿ç”¨å®å¡”é¢æ¿çš„ç½‘ç«™ç›®å½•ï¼‰
cd /www/wwwroot

# æˆ–è€…ä½¿ç”¨å…¶ä»–ç›®å½•
# cd /opt
# cd /home
```

### 5.2 å…‹éš†é¡¹ç›®

```bash
# å…‹éš†é¡¹ç›®ï¼ˆæ›¿æ¢ä¸ºä½ çš„GitHubä»“åº“åœ°å€ï¼‰
git clone https://github.com/YOUR_USERNAME/TheProjectSan.git

# è¿›å…¥é¡¹ç›®ç›®å½•
cd TheProjectSan

# æŸ¥çœ‹é¡¹ç›®ç»“æ„
ls -la
```

### 5.3 æ£€æŸ¥å¿…éœ€æ–‡ä»¶

ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨ï¼š

```bash
# æ£€æŸ¥å…³é”®æ–‡ä»¶
ls -la Dockerfile docker-compose.yml Caddyfile
ls -la frontend/Dockerfile.frontend frontend/nginx.conf
ls -la requirements.linux.txt
```

**å¦‚æœç¼ºå°‘æ–‡ä»¶**ï¼Œéœ€è¦ï¼š
- æ£€æŸ¥GitHubä»“åº“æ˜¯å¦å®Œæ•´
- ç¡®ä¿æ‰€æœ‰æ–‡ä»¶éƒ½å·²æäº¤åˆ°GitHub
- é‡æ–°å…‹éš†æˆ–æ‰‹åŠ¨åˆ›å»ºç¼ºå¤±çš„æ–‡ä»¶ï¼ˆè§ç¬¬ä¸ƒæ­¥ï¼‰

---

## ç¬¬å…­æ­¥ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶

### 6.1 åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ (.env)

```bash
# åˆ›å»º .env æ–‡ä»¶
cat > .env << 'EOF'
# å®¢æˆ·ID
CLIENT_ID=client_001

# API å¯†é’¥ï¼ˆè‡³å°‘é…ç½®ä¸€ä¸ªï¼Œæ›¿æ¢ä¸ºä½ çš„å®é™…å¯†é’¥ï¼‰
OPENAI_API_KEY=sk-your-actual-openai-api-key-here
# ANTHROPIC_API_KEY=your_anthropic_api_key_here
# GROQ_API_KEY=your_groq_api_key_here

# åŸŸåé…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼‰
DOMAIN=your-domain.com

# å…¶ä»–é…ç½®
LOG_LEVEL=INFO
PYTHONUNBUFFERED=1
EOF
```

**é‡è¦**ï¼šç¼–è¾‘æ–‡ä»¶ï¼Œæ›¿æ¢å®é™…å€¼ï¼š

```bash
# ä½¿ç”¨nanoç¼–è¾‘å™¨
nano .env

# æˆ–ä½¿ç”¨viç¼–è¾‘å™¨
vi .env
```

**å¿…é¡»ä¿®æ”¹çš„å†…å®¹**ï¼š
- `OPENAI_API_KEY`ï¼šæ›¿æ¢ä¸ºä½ çš„å®é™…OpenAI APIå¯†é’¥
- `DOMAIN`ï¼šæ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼ˆå¦‚ï¼š`example.com`ï¼‰

ä¿å­˜æ–‡ä»¶ï¼š
- nano: æŒ‰ `Ctrl+O` ä¿å­˜ï¼Œ`Ctrl+X` é€€å‡º
- vi: æŒ‰ `Esc`ï¼Œè¾“å…¥ `:wq` ä¿å­˜é€€å‡º

### 6.2 åˆ›å»ºé…ç½®æ–‡ä»¶ (conf.yaml)

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®æ–‡ä»¶æ¨¡æ¿
ls -la conf.yaml.example

# å¦‚æœæœ‰æ¨¡æ¿ï¼Œå¤åˆ¶å®ƒ
cp conf.yaml.example conf.yaml

# å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼ˆè§ä¸‹é¢çš„é…ç½®å†…å®¹ï¼‰
```

ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
nano conf.yaml
```

**æœ€å°é…ç½®ç¤ºä¾‹**ï¼ˆå¦‚æœconf.yamlä¸å­˜åœ¨ï¼Œåˆ›å»ºæ­¤æ–‡ä»¶ï¼‰ï¼š

```yaml
system_config:
  conf_version: 1.0.0
  host: 0.0.0.0
  port: 12393
  config_alts_dir: 'characters'
  enable_history: false
  
  media_server:
    host: 0.0.0.0
    port: 12393
    ads_directory: 'ads'
    client_id: 'client_001'
    use_absolute_paths: false
    base_directory: null

character_config:
  conf_name: 'suitwoman'
  conf_uid: 'suitwoman_001'
  live2d_model_name: 'suitwoman'
  character_name: 'SuitWoman'
  avatar: 'suitwoman.jpg'
  human_name: 'Human'
  
  persona_prompt: |
    ä½ æ˜¯ä¸€ä¸ªJTLå…¬å¸çš„AIï¼Œä½ å¯ä»¥è®²å¤šå›½è¯­è¨€ï¼Œä½ æ“…é•¿ä½¿ç”¨æ•¬è¯­
    è¯·å°½é‡ç”¨ä¸€å¥ç®€çŸ­è¯å›ç­”ï¼Œé™¤éç”¨æˆ·ç‰¹åˆ«è¦æ±‚è¯¦ç»†ã€‚

  agent_config:
    conversation_agent_choice: 'basic_memory_agent'
    agent_settings:
      basic_memory_agent:
        llm_provider: 'openai_llm'
        faster_first_response: true
        segment_method: 'regex'
        use_mcpp: True
        mcp_enabled_servers: ["advertisement-server", "topic-introduction-server", "time", "weather-server"]
    
    llm_config:
      openai_llm:
        llm_api_key: ''  # ç•™ç©ºï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ OPENAI_API_KEY
        model: 'gpt-4o-mini'
        temperature: 0.2

  asr_config:
    asr_model: 'sherpa_onnx_asr'
    sherpa_onnx_asr:
      model_type: 'sense_voice'
      sense_voice: './models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/model.onnx'
      tokens: './models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/tokens.txt'
      num_threads: 4
      use_itn: True
      provider: 'cpu'

  tts_config:
    tts_model: 'fish_api_tts'
    fish_api_tts:
      api_key: 'your_fish_tts_api_key'
      reference_id: 'your_fish_tts_reference_id'
      latency: 'balanced'
      base_url: 'https://api.fish.audio'

  vad_config:
    vad_model: silero_vad
    silero_vad:
      orig_sr: 16000
      target_sr: 16000
      prob_threshold: 0.4
      db_threshold: 60
      required_hits: 2
      required_misses: 8
      smoothing_window: 2
```

**é‡è¦é…ç½®é¡¹**ï¼š
- `host: 0.0.0.0` - å¿…é¡»ä¿æŒæ­¤å€¼ï¼ˆDockerç¯å¢ƒéœ€è¦ï¼‰
- `client_id: 'client_001'` - ä¸ `.env` ä¸­çš„ `CLIENT_ID` ä¿æŒä¸€è‡´
- `llm_api_key: ''` - ç•™ç©ºï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡

### 6.3 ä¿®æ”¹ Caddyfile

```bash
# ç¼–è¾‘ Caddyfile
nano Caddyfile
```

**å¿…é¡»ä¿®æ”¹**ï¼šå°†æ–‡ä»¶ç¬¬ä¸€è¡Œçš„ `your-domain.com` æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸå

ä¿®æ”¹å‰ï¼š
```caddyfile
your-domain.com {
```

ä¿®æ”¹åï¼ˆç¤ºä¾‹ï¼‰ï¼š
```caddyfile
example.com {
```

ä¿å­˜æ–‡ä»¶ã€‚

---

## ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºå¿…éœ€çš„Dockeré…ç½®æ–‡ä»¶

### 7.1 æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®æ–‡ä»¶

```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la Dockerfile docker-compose.yml Caddyfile
```

### 7.2 å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º

#### åˆ›å»º Dockerfileï¼ˆåç«¯ï¼‰

```bash
cat > Dockerfile << 'EOF'
# åç«¯æœåŠ¡ Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    ffmpeg \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.linux.txt requirements.txt

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p cache logs topics ads videos backgrounds avatars live2d-models web_tool models characters

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app
ENV HF_HOME=/app/models
ENV MODELSCOPE_CACHE=/app/models

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:12393/health')" || exit 1

# æš´éœ²ç«¯å£
EXPOSE 12393

# å¯åŠ¨æœåŠ¡
CMD ["python", "run_server.py"]
EOF
```

#### åˆ›å»º docker-compose.yml

```bash
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  # ==================== åç«¯æœåŠ¡ ====================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: theproject-san-backend
    environment:
      - CLIENT_ID=${CLIENT_ID:-client_001}
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - HF_HOME=/app/models
      - MODELSCOPE_CACHE=/app/models
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - S3_BUCKET=${S3_BUCKET:-}
    volumes:
      - ./conf.yaml:/app/conf.yaml:ro
      - ./cache:/app/cache
      - ./logs:/app/logs
      - ./topics:/app/topics
      - ./ads:/app/ads
      - ./videos:/app/videos
      - ./backgrounds:/app/backgrounds
      - ./avatars:/app/avatars
      - ./live2d-models:/app/live2d-models
      - ./web_tool:/app/web_tool
      - ./models:/app/models
      - ./characters:/app/characters
    restart: unless-stopped
    networks:
      - theproject-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:12393/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== å‰ç«¯æœåŠ¡ ====================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
    container_name: theproject-san-frontend
    environment:
      - VITE_API_BASE_URL=http://backend:12393
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - theproject-network

  # ==================== Caddy åå‘ä»£ç† ====================
  caddy:
    image: caddy:2-alpine
    container_name: theproject-san-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    depends_on:
      - frontend
      - backend
    networks:
      - theproject-network

networks:
  theproject-network:
    driver: bridge

volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
EOF
```

#### åˆ›å»ºå‰ç«¯ Dockerfile

```bash
# è¿›å…¥frontendç›®å½•
cd frontend

# åˆ›å»º Dockerfile.frontend
cat > Dockerfile.frontend << 'EOF'
# AIå¹¿å‘Šå±ç³»ç»Ÿ - å‰ç«¯Dockerfile (ç”Ÿäº§ç¯å¢ƒ)
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆwebæ¨¡å¼ï¼Œè¾“å‡ºåˆ° dist/webï¼‰
RUN npm run build:web

# ===== ç”Ÿäº§é•œåƒ =====
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist/web /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨Nginx
CMD ["nginx", "-g", "daemon off;"]
EOF

# åˆ›å»º nginx.conf
cat > nginx.conf << 'EOF'
server {
    listen 3000;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPAè·¯ç”±æ”¯æŒ - æ‰€æœ‰è·¯ç”±éƒ½è¿”å›index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
EOF

# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..
```

#### åˆ›å»º Caddyfileï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

```bash
cat > Caddyfile << 'EOF'
# TheProjectSan åå‘ä»£ç†é…ç½®
# è¯·å°† your-domain.com æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸå

your-domain.com {
    # æ—¥å¿—é…ç½®
    log {
        output file /data/logs/access.log
        format json
    }

    # å‰ç«¯é™æ€æ–‡ä»¶
    handle / {
        reverse_proxy frontend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # åç«¯ API
    handle /api/* {
        reverse_proxy backend:12393 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket è¿æ¥
    handle /client-ws {
        reverse_proxy backend:12393 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Upgrade {http.upgrade}
            header_up Connection {http.connection}
        }
    }

    # Web å·¥å…·
    handle /web-tool/* {
        reverse_proxy backend:12393 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # é™æ€èµ„æº
    handle /cache/* {
        reverse_proxy backend:12393
    }

    handle /topics/* {
        reverse_proxy backend:12393
    }

    handle /ads/* {
        reverse_proxy backend:12393
    }

    handle /live2d-models/* {
        reverse_proxy backend:12393
    }

    handle /bg/* {
        reverse_proxy backend:12393
    }

    handle /avatars/* {
        reverse_proxy backend:12393
    }

    # å¥åº·æ£€æŸ¥
    handle /health {
        reverse_proxy backend:12393
    }

    handle /api/health {
        reverse_proxy backend:12393
    }

    # è‡ªåŠ¨ HTTPSï¼ˆLet's Encryptï¼‰
    tls {
        protocols tls1.2 tls1.3
    }
}
EOF
```

**é‡è¦**ï¼šç¼–è¾‘ Caddyfileï¼Œå°† `your-domain.com` æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼š

```bash
nano Caddyfile
# å°†ç¬¬ä¸€è¡Œçš„ your-domain.com æ”¹ä¸ºä½ çš„å®é™…åŸŸå
```

### 7.3 éªŒè¯æ‰€æœ‰æ–‡ä»¶å·²åˆ›å»º

```bash
# è¿”å›é¡¹ç›®æ ¹ç›®å½•ï¼ˆå¦‚æœä¸åœ¨ï¼‰
cd /www/wwwroot/TheProjectSan

# æ£€æŸ¥æ‰€æœ‰å¿…éœ€æ–‡ä»¶
ls -la Dockerfile docker-compose.yml Caddyfile .env 
ls -la frontend/Dockerfile.frontend frontend/nginx.conf
ls -la requirements.linux.txt

# åº”è¯¥çœ‹åˆ°æ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨
```

---

## ç¬¬å…«æ­¥ï¼šåœæ­¢å®å¡”é¢æ¿çš„WebæœåŠ¡ï¼ˆé‡è¦ï¼‰

### 8.1 æ£€æŸ¥ç«¯å£å ç”¨

```bash
# æ£€æŸ¥80å’Œ443ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo netstat -tulpn | grep -E ":(80|443)"
```

### 8.2 åœæ­¢å®å¡”é¢æ¿çš„Nginx/Apache

å¦‚æœç«¯å£è¢«å ç”¨ï¼Œéœ€è¦åœ¨å®å¡”é¢æ¿ä¸­åœæ­¢WebæœåŠ¡ï¼š

1. ç™»å½•å®å¡”é¢æ¿
2. è¿›å…¥ **è½¯ä»¶å•†åº—**
3. æ‰¾åˆ° **Nginx** æˆ– **Apache**
4. ç‚¹å‡» **è®¾ç½®** â†’ **æœåŠ¡** â†’ **åœæ­¢**

**æˆ–è€…**ä½¿ç”¨å‘½ä»¤è¡Œï¼š

```bash
# åœæ­¢Nginx
sudo systemctl stop nginx
sudo systemctl disable nginx

# æˆ–åœæ­¢Apache
sudo systemctl stop httpd
sudo systemctl disable httpd
```

---

## ç¬¬ä¹æ­¥ï¼šå¯åŠ¨DockeræœåŠ¡å¹¶æ„å»ºé•œåƒ

### 9.1 æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€
systemctl status docker
```

**å¦‚æœDockeræœåŠ¡æœªè¿è¡Œ**ï¼ˆæ˜¾ç¤º `inactive (dead)`ï¼‰ï¼Œéœ€è¦å¯åŠ¨ï¼š

```bash
# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker

# è®¾ç½®DockeræœåŠ¡å¼€æœºè‡ªå¯ï¼ˆæ¨èï¼‰
sudo systemctl enable docker

# å†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼Œåº”è¯¥æ˜¾ç¤º active (running)
systemctl status docker
```

### 9.2 éªŒè¯Dockerå’ŒDocker Compose

```bash
# éªŒè¯Dockeræ˜¯å¦å¯ç”¨
docker --version

# éªŒè¯Docker Composeæ˜¯å¦å¯ç”¨
docker compose version

# æµ‹è¯•Dockeræ˜¯å¦æ­£å¸¸å·¥ä½œ
docker ps
```

### 9.3 è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd /www/wwwroot/TheProjectSan
# æˆ–ä½ å…‹éš†é¡¹ç›®çš„ç›®å½•
```

### 9.4 æ£€æŸ¥å‰ç«¯ Dockerfile

åœ¨æ„å»ºä¹‹å‰ï¼Œç¡®ä¿ `frontend/Dockerfile.frontend` æ–‡ä»¶å†…å®¹æ­£ç¡®ï¼š

```bash
# æ£€æŸ¥ Dockerfile å†…å®¹
cat frontend/Dockerfile.frontend | grep "npm run"

# åº”è¯¥çœ‹åˆ°ï¼šRUN npm run build:web
# å¦‚æœçœ‹åˆ°ï¼šRUN npm run buildï¼Œéœ€è¦ä¿®å¤
```

**å¦‚æœ Dockerfile ä¸æ­£ç¡®**ï¼Œä¿®å¤å®ƒï¼š

```bash
# ç¼–è¾‘ Dockerfile
nano frontend/Dockerfile.frontend

# ç¡®ä¿ç¬¬16è¡Œæ˜¯ï¼š
# RUN npm run build:web
# è€Œä¸æ˜¯ï¼š
# RUN npm run build
```

### 9.5 æ„å»ºé•œåƒ

```bash
# æ„å»ºæ‰€æœ‰æœåŠ¡çš„é•œåƒï¼ˆé¦–æ¬¡éƒ¨ç½²éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå¯èƒ½éœ€è¦10-30åˆ†é’Ÿï¼‰
docker compose build

# å¦‚æœæ„å»ºè¿‡ç¨‹å¾ˆæ…¢ï¼Œå¯ä»¥æŸ¥çœ‹è¯¦ç»†è¿›åº¦ï¼ˆæ³¨æ„ï¼š--progress æ˜¯å…¨å±€é€‰é¡¹ï¼Œåº”è¯¥æ”¾åœ¨ compose åé¢ï¼‰
docker compose --progress=plain build

# å¦‚æœé‡åˆ°ç¼“å­˜é—®é¢˜ï¼Œä½¿ç”¨ --no-cache å¼ºåˆ¶é‡æ–°æ„å»º
docker compose build --no-cache
```

**æ³¨æ„**ï¼š
- å¦‚æœçœ‹åˆ°è­¦å‘Š `the attribute 'version' is obsolete`ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œæ–°ç‰ˆæœ¬çš„Docker Composeä¸å†éœ€è¦versionå­—æ®µï¼Œå¯ä»¥å¿½ç•¥æˆ–ä»docker-compose.ymlä¸­åˆ é™¤versionè¡Œã€‚
- å¦‚æœå‰ç«¯æ„å»ºå¤±è´¥ï¼Œæç¤ºæ‰¾ä¸åˆ° `/app/dist`ï¼Œæ£€æŸ¥ Dockerfile æ˜¯å¦ä½¿ç”¨äº† `npm run build:web` è€Œä¸æ˜¯ `npm run build`

**æ„å»ºè¿‡ç¨‹è¯´æ˜**ï¼š
- åç«¯é•œåƒï¼šä¼šä¸‹è½½Pythonä¾èµ–ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
- å‰ç«¯é•œåƒï¼šä¼šä¸‹è½½Node.jsä¾èµ–å¹¶æ„å»ºå‰ç«¯ä»£ç ï¼ˆä½¿ç”¨ `build:web` æ¨¡å¼ï¼Œè¾“å‡ºåˆ° `dist/web`ï¼‰

**å¦‚æœæ„å»ºå¤±è´¥**ï¼š
```bash
# æ¸…é™¤æ„å»ºç¼“å­˜å¹¶é‡æ–°æ„å»º
docker compose build --no-cache

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æ„å»ºæ—¥å¿—
docker compose build frontend 2>&1 | tee build-frontend.log

# æ£€æŸ¥å‰ç«¯æ„å»ºè¾“å‡ºç›®å½•
docker compose run --rm frontend ls -la /app/dist/
```

---

## ç¬¬åæ­¥ï¼šå¯åŠ¨æœåŠ¡

### 10.1 å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
docker compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps
```

**é¢„æœŸè¾“å‡º**ï¼š
```
NAME                        STATUS          PORTS
theproject-san-backend      Up (healthy)    12393/tcp
theproject-san-frontend     Up              3000/tcp
theproject-san-caddy        Up              0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp
```

### 10.2 æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f caddy
```

**æŒ‰ `Ctrl+C` é€€å‡ºæ—¥å¿—æŸ¥çœ‹**

---

## ç¬¬åä¸€æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 11.1 æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦æ­£å¸¸è¿è¡Œ
curl http://localhost:12393/health

# åº”è¯¥è¿”å›: ok
```

### 11.2 æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker compose ps

# åº”è¯¥çœ‹åˆ°æ‰€æœ‰å®¹å™¨éƒ½æ˜¯ "Up" çŠ¶æ€
```

### 11.3 æ£€æŸ¥HTTPSè¯ä¹¦ç”³è¯·

ç­‰å¾…2-5åˆ†é’Ÿè®©Caddyè‡ªåŠ¨ç”³è¯·Let's Encryptè¯ä¹¦ï¼Œç„¶åï¼š

```bash
# æ£€æŸ¥HTTPSè®¿é—®ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼‰
curl https://your-domain.com/health

# æŸ¥çœ‹Caddyæ—¥å¿—ç¡®è®¤è¯ä¹¦ç”³è¯·çŠ¶æ€
docker compose logs caddy | grep -i certificate
```

**è¯ä¹¦ç”³è¯·æˆåŠŸçš„æ ‡å¿—**ï¼š
- Caddyæ—¥å¿—ä¸­æ˜¾ç¤º "certificate obtained successfully"
- `curl https://your-domain.com/health` è¿”å› "ok"

### 11.4 è®¿é—®å‰ç«¯ç•Œé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š

- **å‰ç«¯ç•Œé¢**: `https://your-domain.com`
- **å¥åº·æ£€æŸ¥**: `https://your-domain.com/health`
- **Webæ§åˆ¶é¢æ¿**: `https://your-domain.com/web-tool/control-panel.html?client=client_001`

---

## ç¬¬åäºŒæ­¥ï¼šéªŒè¯åŠŸèƒ½

### 12.1 æµ‹è¯•å‰ç«¯è®¿é—®

1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® `https://your-domain.com`
2. åº”è¯¥èƒ½çœ‹åˆ°å‰ç«¯ç•Œé¢
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### 12.2 æµ‹è¯•APIè¿æ¥

```bash
# æµ‹è¯•APIç«¯ç‚¹
curl https://your-domain.com/api/health

# æµ‹è¯•WebSocketç«¯ç‚¹ï¼ˆåº”è¯¥è¿”å›WebSocketæ¡æ‰‹å“åº”ï¼‰
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" https://your-domain.com/client-ws
```

### 12.3 æµ‹è¯•Webæ§åˆ¶é¢æ¿

è®¿é—®ï¼š`https://your-domain.com/web-tool/control-panel.html?client=client_001`

åº”è¯¥èƒ½çœ‹åˆ°æ§åˆ¶é¢æ¿ç•Œé¢ã€‚

---

## å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³

### é—®é¢˜1: å®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
docker compose logs backend
docker compose logs frontend
docker compose logs caddy

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat .env
cat conf.yaml | head -20
```

### é—®é¢˜2: HTTPSè¯ä¹¦ç”³è¯·å¤±è´¥

```bash
# æ£€æŸ¥DNSè§£æ
nslookup your-domain.com

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443

# æ£€æŸ¥Caddyæ—¥å¿—
docker compose logs caddy
```

### é—®é¢˜3: å‰ç«¯æ— æ³•è¿æ¥åç«¯

```bash
# æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
curl http://localhost:12393/health

# æ£€æŸ¥å®¹å™¨ç½‘ç»œ
docker compose exec frontend ping backend

# æ£€æŸ¥Caddyé…ç½®
cat Caddyfile | grep -A 5 "/api"
```

---

## éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œè¯·ç¡®è®¤ï¼š

- [ ] Dockerå’ŒDocker Composeå·²å®‰è£…å¹¶å¯ç”¨
- [ ] æ‰€æœ‰å®¹å™¨éƒ½åœ¨è¿è¡Œï¼ˆ`docker compose ps`ï¼‰
- [ ] åç«¯å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆ`curl http://localhost:12393/health`ï¼‰
- [ ] HTTPSè¯ä¹¦å·²ç”³è¯·æˆåŠŸï¼ˆæµè§ˆå™¨æ˜¾ç¤ºç»¿è‰²é”å›¾æ ‡ï¼‰
- [ ] å‰ç«¯é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] Webæ§åˆ¶é¢æ¿å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] æ²¡æœ‰é”™è¯¯æ—¥å¿—ï¼ˆ`docker compose logs` æ— ERRORï¼‰

---

## åç»­ç»´æŠ¤

### æ›´æ–°ä»£ç 

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/TheProjectSan

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker compose up -d --build
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
docker compose logs --tail=100 backend
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker compose restart backend
```

---

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`docker compose logs`
2. **æ£€æŸ¥é…ç½®**ï¼šç¡®è®¤ `.env` å’Œ `conf.yaml` é…ç½®æ­£ç¡®
3. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®è®¤DNSè§£æå’Œç«¯å£å¼€æ”¾
4. **æŸ¥çœ‹æ–‡æ¡£**ï¼šå‚è€ƒ `éƒ¨ç½²æŒ‡å—/DEPLOYMENT.md` çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†

---

**éƒ¨ç½²å®Œæˆåï¼Œä½ çš„ç³»ç»Ÿåº”è¯¥å¯ä»¥é€šè¿‡ `https://your-domain.com` è®¿é—®ï¼**


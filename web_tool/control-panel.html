<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ§åˆ¶é¢æ¿ - ç§»åŠ¨ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .client-id {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            min-height: 400px;
        }
        
        .panel h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="color"]),
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
        }
        
        .file-size {
            font-size: 12px;
            color: #666;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .qrcode-container {
            text-align: center;
            padding: 20px;
        }
        
        .qrcode-image {
            max-width: 200px;
            margin: 0 auto 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .qrcode-url {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            margin-bottom: 16px;
        }
        
        .about-content {
            line-height: 1.6;
        }
        
        .about-content h3 {
            margin: 16px 0 8px 0;
            color: #333;
        }
        
        .about-content p {
            margin-bottom: 12px;
            color: #666;
        }
        
        .about-content ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        
        .about-content li {
            margin-bottom: 4px;
            color: #666;
        }
        
        .hidden {
            display: none !important;
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-container input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš™ï¸ æ§åˆ¶é¢æ¿</h1>
            <div class="client-id" id="clientId">client_001</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="media">ğŸ¬ åª’ä½“</div>
            <div class="tab" data-tab="general">ğŸ­ è§’è‰²è®¾ç½®</div>
            <div class="tab" data-tab="asr">ğŸ¤ ASRè®¾ç½®</div>
            <div class="tab" data-tab="topics">ğŸ“š ä¸»é¢˜ä»‹ç»</div>
            <div class="tab" data-tab="qrcode">ğŸ“± äºŒç»´ç </div>
            <div class="tab" data-tab="about">â„¹ï¸ å…³äº</div>
        </div>
        
        <!-- åª’ä½“ç®¡ç†é¢æ¿ -->
        <div class="panel" id="media-panel">
            <h2>åª’ä½“ç®¡ç†</h2>
            
            <!-- å¹¿å‘ŠéŸ³é¢‘è®¾ç½® -->
            <div style="background: #f8f9ff; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e1e5e9;">
                <h3 style="margin-bottom: 16px; color: #333;">å¹¿å‘ŠéŸ³é¢‘è®¾ç½®</h3>
                <div class="form-group">
                    <label>éŸ³é¢‘æ’­æ”¾æ¨¡å¼</label>
                    <select id="audioMode">
                        <option value="muted">é™éŸ³æ¨¡å¼</option>
                        <option value="audio">éŸ³é¢‘æ¨¡å¼</option>
                        <option value="audio_vad">éŸ³é¢‘+VADæ¨¡å¼</option>
                    </select>
                </div>
                <div style="font-size: 14px; color: #666; margin-top: 8px;">
                    â€¢ é™éŸ³æ¨¡å¼ï¼šå¹¿å‘Šæ’­æ”¾æ—¶é™éŸ³<br>
                    â€¢ éŸ³é¢‘æ¨¡å¼ï¼šå¹¿å‘Šæ’­æ”¾æ—¶æ’­æ”¾éŸ³é¢‘<br>
                    â€¢ éŸ³é¢‘+VADæ¨¡å¼ï¼šå¹¿å‘Šæ’­æ”¾æ—¶æ’­æ”¾éŸ³é¢‘ï¼ŒåŒæ—¶è¿›è¡Œè¯­éŸ³æ£€æµ‹
                </div>
                <button class="btn" onclick="saveAudioSettings()" style="margin-top: 12px;">ä¿å­˜éŸ³é¢‘è®¾ç½®</button>
            </div>
            
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #333;">ä¸Šä¼ å¹¿å‘Šè§†é¢‘</h3>
                <div class="upload-area" id="mediaUploadArea">
                    <div class="upload-icon">ğŸ“¤</div>
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ </div>
                    <div style="font-size: 14px; color: #666; margin-top: 8px;">
                        æ”¯æŒæ ¼å¼: MP4, AVI, MOV, WEBM<br>
                        æœ€å¤§å¤§å°: 500MB
                    </div>
                </div>
                <input type="file" id="mediaFileInput" accept="video/*" multiple>
                <div id="mediaUploadStatus"></div>
            </div>
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div>
                <h3 style="margin-bottom: 16px; color: #333;">å¹¿å‘Šè§†é¢‘åˆ—è¡¨</h3>
                <div id="mediaFileList" class="file-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>åŠ è½½æ–‡ä»¶ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è§’è‰²è®¾ç½®é¢æ¿ -->
        <div class="panel hidden" id="general-panel">
            <h2>è§’è‰²è®¾ç½®</h2>
            
            <div style="background: #f8f9ff; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e1e5e9;">
                <h3 style="margin-bottom: 16px; color: #333;">è§’è‰²é¢„è®¾åˆ‡æ¢</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    é€‰æ‹©ä¸åŒçš„è§’è‰²é¢„è®¾æ¥åˆ‡æ¢AIçš„ä¸ªæ€§å’Œè¡Œä¸ºæ¨¡å¼ã€‚åˆ‡æ¢åç«‹å³ç”Ÿæ•ˆã€‚
                </p>
                
                <div class="form-group">
                    <label>è§’è‰²é¢„è®¾</label>
                    <select id="characterPreset">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                
                <button class="btn" onclick="saveCharacterSettings()">åˆ‡æ¢è§’è‰²</button>
            </div>
            
            <div style="background: #fff3cd; padding: 16px; border-radius: 8px; border: 1px solid #ffeaa7; margin-top: 20px;">
                <h4 style="color: #856404; margin-bottom: 8px;">ğŸ’¡ æç¤º</h4>
                <p style="color: #856404; font-size: 14px; margin: 0;">
                    å…¶ä»–UIè®¾ç½®ï¼ˆå¦‚å­—å¹•ã€è¯­è¨€ç­‰ï¼‰è¯·åœ¨åŸæ§åˆ¶é¢æ¿ï¼ˆæŒ‰Ctrl+Spaceï¼‰ä¸­ä¿®æ”¹ï¼Œä»¥ç¡®ä¿æ­£ç¡®ç”Ÿæ•ˆã€‚
                </p>
            </div>
        </div>
        
        <!-- ä¸»é¢˜ä»‹ç»é¢æ¿ -->
        <div class="panel hidden" id="topics-panel">
            <h2>ä¸»é¢˜ä»‹ç»ç®¡ç†</h2>
            
            <!-- ä¸»é¢˜åˆ—è¡¨ -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #333;">ä¸»é¢˜åˆ—è¡¨</h3>
                <div id="topicsList" class="file-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>åŠ è½½ä¸»é¢˜ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- æ–°å»º/ç¼–è¾‘ä¸»é¢˜è¡¨å• -->
            <div style="background: #f8f9ff; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e1e5e9;">
                <h3 style="margin-bottom: 16px; color: #333;" id="topicFormTitle">æ–°å»ºä¸»é¢˜</h3>
                
                <input type="hidden" id="editingTopicId" value="">
                
                <!-- ä¸»é¢˜åç§° -->
                <div class="form-group">
                    <label>ä¸»é¢˜åç§°</label>
                    <input type="text" id="topicName" placeholder="ä¸»é¢˜åç§°ï¼ˆå¦‚ï¼šå…½è€³å¤æ—¥é…’åº—ï¼‰" style="width: 100%;">
                </div>
                
                <!-- æ•´ä½“æè¿° -->
                <div class="form-group">
                    <label>æ•´ä½“æè¿°</label>
                    <textarea id="topicDescription" rows="4" placeholder="ä¸»é¢˜æè¿°ï¼ˆå¦‚ï¼šå¤ã®ãƒ›ãƒ†ãƒ«ç´¹ä»‹...ï¼‰" style="width: 100%;"></textarea>
                </div>
                
                <!-- å†…å®¹è¯­è¨€ -->
                <div class="form-group">
                    <label>å†…å®¹è¯­è¨€</label>
                    <select id="contentLanguage" style="width: 100%;">
                        <option value="ja">æ—¥è¯­ (Japanese)</option>
                        <option value="en">è‹±è¯­ (English)</option>
                        <option value="zh">ä¸­æ–‡ (Chinese)</option>
                        <option value="ko">éŸ©è¯­ (Korean)</option>
                        <option value="es">è¥¿ç­ç‰™è¯­ (Spanish)</option>
                        <option value="fr">æ³•è¯­ (French)</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        é€‰æ‹©å†…å®¹ä½¿ç”¨çš„è¯­è¨€ã€‚ç”¨æˆ·å¯ä»¥ç”¨ä»»æ„è¯­è¨€æé—®ï¼ŒAIä¼šè‡ªåŠ¨ç¿»è¯‘ã€‚
                    </div>
                </div>
                
                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸï¼ˆæœ€å¤š10ä¸ªï¼‰ -->
                <div class="form-group" id="topicImagesSection">
                    <label>å›¾ç‰‡ï¼ˆæœ€å¤š10ä¸ªï¼‰</label>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        ğŸ“¸ æ¯ä¸ªå›¾ç‰‡å¿…é¡»å¡«å†™æè¿°ï¼ˆç”¨äºAIä»‹ç»å›¾ç‰‡å†…å®¹ï¼Œæ˜¾ç¤ºåœ¨ç¬¬äºŒç”»å¸ƒä¸Šï¼‰<br>
                        ğŸ’¡ æç¤ºï¼šå¡«å†™å®Œæ‰€æœ‰ä¿¡æ¯åï¼Œç‚¹å‡»"ä¿å­˜ä¸»é¢˜"ä¼šè‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰å›¾ç‰‡å’Œè§†é¢‘
                    </div>
                    <div id="topicImagesList" style="margin-bottom: 12px;">
                        <!-- åŠ¨æ€æ·»åŠ çš„å›¾ç‰‡é¡¹ -->
                    </div>
                    <button type="button" class="btn" onclick="addTopicImageItem()" style="background: #28a745; margin-bottom: 8px;" id="addImageBtn">
                        + æ·»åŠ å›¾ç‰‡
                    </button>
                </div>
                
                <!-- è§†é¢‘ä¸Šä¼ åŒºåŸŸï¼ˆæœ€å¤š3ä¸ªï¼‰ -->
                <div class="form-group" id="topicVideosSection">
                    <label>è§†é¢‘ï¼ˆæœ€å¤š3ä¸ªï¼‰</label>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        ğŸ¬ æ¯ä¸ªè§†é¢‘å¿…é¡»å¡«å†™æè¿°ï¼ˆç”¨äºAIè¯´æ˜è§†é¢‘å†…å®¹ï¼Œåœ¨æ’­æ”¾å‰å‘ŠçŸ¥ç”¨æˆ·ï¼‰<br>
                        ğŸ’¡ æç¤ºï¼šå¡«å†™å®Œæ‰€æœ‰ä¿¡æ¯åï¼Œç‚¹å‡»"ä¿å­˜ä¸»é¢˜"ä¼šè‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰å›¾ç‰‡å’Œè§†é¢‘
                    </div>
                    <div id="topicVideosList" style="margin-bottom: 12px;">
                        <!-- åŠ¨æ€æ·»åŠ çš„è§†é¢‘é¡¹ -->
                    </div>
                    <button type="button" class="btn" onclick="addTopicVideoItem()" style="background: #28a745; margin-bottom: 8px;" id="addVideoBtn">
                        + æ·»åŠ è§†é¢‘
                    </button>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" onclick="saveTopic()" id="saveTopicBtn">ä¿å­˜ä¸»é¢˜</button>
                    <button class="btn" onclick="cancelTopicEdit()" style="background: #6c757d;" id="cancelTopicBtn" style="display: none;">å–æ¶ˆç¼–è¾‘</button>
                </div>
            </div>
        </div>
        
        <!-- ASRè®¾ç½®é¢æ¿ -->
        <div class="panel hidden" id="asr-panel">
            <h2>ASRè®¾ç½®</h2>
            
            <div style="background: #f8f9ff; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e1e5e9;">
                <h3 style="margin-bottom: 16px; color: #333;">éº¦å…‹é£è‡ªåŠ¨æ§åˆ¶</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    è®¾ç½®AIè¯´è¯æ—¶éº¦å…‹é£çš„è‡ªåŠ¨æ§åˆ¶è¡Œä¸ºã€‚
                </p>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autoStopMic" checked>
                        <span>AIè¯´è¯æ—¶è‡ªåŠ¨åœæ­¢éº¦å…‹é£</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autoStartMicOnConvEnd" checked>
                        <span>å¯¹è¯ç»“æŸæ—¶è‡ªåŠ¨å¼€å§‹éº¦å…‹é£</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autoStartMicOn" checked>
                        <span>AIä¸­æ–­æ—¶è‡ªåŠ¨å¼€å§‹éº¦å…‹é£ï¼ˆèƒ½å¦è¢«æ‰“æ–­ï¼‰</span>
                    </label>
                </div>
                
                <button class="btn" onclick="saveASRSettings()">ä¿å­˜ASRè®¾ç½®</button>
            </div>
            
            <div style="background: #e8f4f8; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #b3d9e6;">
                <h3 style="margin-bottom: 16px; color: #333;">VADé«˜çº§è®¾ç½®ï¼ˆå¯é€‰ï¼‰</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    è¯­éŸ³æ´»åŠ¨æ£€æµ‹é˜ˆå€¼è®¾ç½®ï¼Œé«˜çº§ç”¨æˆ·å¯è°ƒæ•´ã€‚
                </p>
                
                <div class="form-group">
                    <label>è¯­éŸ³æ£€æµ‹é˜ˆå€¼ (0-100)</label>
                    <input type="number" id="positiveSpeechThreshold" min="0" max="100" value="50" step="1">
                </div>
                
                <div class="form-group">
                    <label>é™éŸ³æ£€æµ‹é˜ˆå€¼ (0-100)</label>
                    <input type="number" id="negativeSpeechThreshold" min="0" max="100" value="30" step="1">
                </div>
                
                <div class="form-group">
                    <label>æ¢å¤å¸§æ•° (1-100)</label>
                    <input type="number" id="redemptionFrames" min="1" max="100" value="8" step="1">
                </div>
                
                <button class="btn" onclick="saveVADSettings()">ä¿å­˜VADè®¾ç½®</button>
            </div>
        </div>
        
        
        <!-- äºŒç»´ç ç®¡ç†é¢æ¿ -->
        <div class="panel hidden" id="qrcode-panel">
            <h2>äºŒç»´ç ç®¡ç†</h2>
            <div class="qrcode-container">
                <div id="qrcodeImage"></div>
                <div class="qrcode-url" id="qrcodeUrl"></div>
                <button class="btn btn-secondary" onclick="downloadQRCode()">ä¸‹è½½PNG</button>
                <button class="btn btn-success" onclick="printQRCode()">æ‰“å°äºŒç»´ç </button>
                <button class="btn" onclick="regenerateQRCode()">é‡æ–°ç”Ÿæˆ</button>
            </div>
        </div>
        
        <!-- å…³äºé¢æ¿ -->
        <div class="panel hidden" id="about-panel">
            <h2>å…³äº</h2>
            <div class="about-content">
                <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                <p><strong>ç‰ˆæœ¬:</strong> 1.0.0</p>
                <p><strong>å®¢æˆ·ç«¯ID:</strong> <span id="aboutClientId">client_001</span></p>
                <p><strong>æœåŠ¡å™¨åœ°å€:</strong> <span id="serverAddress">127.0.0.1:12393</span></p>
                
                <h3>åŠŸèƒ½ç‰¹æ€§</h3>
                <ul>
                    <li>å¤šç§Ÿæˆ·èµ„æºéš”ç¦»</li>
                    <li>å¹¿å‘Šè§†é¢‘ä¸Šä¼ ç®¡ç†</li>
                    <li>Live2Dè§’è‰²æ§åˆ¶</li>
                    <li>è¯­éŸ³è¯†åˆ«ä¸åˆæˆ</li>
                    <li>AIå¯¹è¯ä»£ç†</li>
                    <li>ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿</li>
                </ul>
                
                <h3>æŠ€æœ¯æ”¯æŒ</h3>
                <p>å¦‚æœ‰é—®é¢˜è¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentClientId = 'client_001';
        let currentTab = 'upload';
        let files = [];
        
        // æ›´æ–°rangeæ»‘å—æ˜¾ç¤ºå€¼
        function updateRangeValue(input, valueId) {
            const value = parseFloat(input.value);
            const displayValue = input.step && input.step !== '1' ? value.toFixed(2) : value.toString();
            document.getElementById(valueId).textContent = displayValue;
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testAPI() {
            try {
                console.log('æµ‹è¯•APIè¿æ¥...');
                const response = await fetch('/api/ads');
                if (response.ok) {
                    console.log('APIè¿æ¥æ­£å¸¸');
                    return true;
                } else {
                    console.error('APIè¿æ¥å¤±è´¥:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('APIè¿æ¥é”™è¯¯:', error);
                return false;
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»URLå‚æ•°è·å–å®¢æˆ·ç«¯ID
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('client');
            if (clientId) {
                currentClientId = clientId;
                document.getElementById('clientId').textContent = clientId;
                document.getElementById('aboutClientId').textContent = clientId;
            }
            
            // è®¾ç½®æœåŠ¡å™¨åœ°å€
            const serverAddress = window.location.host;
            document.getElementById('serverAddress').textContent = serverAddress;
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('Webæ§åˆ¶é¢æ¿åˆå§‹åŒ–:', {
                clientId: currentClientId,
                serverAddress: serverAddress,
                currentUrl: window.location.href
            });
            
            // æµ‹è¯•APIè¿æ¥
            testAPI().then(apiOk => {
                if (!apiOk) {
                    console.warn('APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');
                }
            });
            
            // åˆå§‹åŒ–æ ‡ç­¾é¡µ
            initTabs();
            
            // åˆå§‹åŒ–åª’ä½“ä¸Šä¼ åŠŸèƒ½
            initMediaUpload();
            
            // åŠ è½½åª’ä½“æ–‡ä»¶åˆ—è¡¨
            loadMediaFiles();
            
            // ä¿¡å·æ¨¡å¼ï¼šä¸å†éœ€è¦åŠ è½½è®¾ç½®
            // loadSettings(); // å·²ç§»é™¤
            
            // åŠ è½½è§’è‰²é¢„è®¾åˆ—è¡¨ï¼ˆä»…ç”¨äºæ˜¾ç¤ºé€‰é¡¹ï¼‰
            loadCharacterPresets();
            
            // ç”ŸæˆäºŒç»´ç 
            generateQRCode();
            
            // åŠ è½½ä¸»é¢˜åˆ—è¡¨
            loadTopics();
        });
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const panels = document.querySelectorAll('.panel');
            
            // åˆå§‹åŒ–ï¼šç¡®ä¿åª’ä½“é¢æ¿æ˜¾ç¤ºï¼Œå…¶ä»–é¢æ¿éšè—
            panels.forEach(panel => {
                if (panel.id === 'media-panel') {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            
            // ç¡®ä¿åª’ä½“æ ‡ç­¾é¡µæ˜¯æ¿€æ´»çŠ¶æ€
            tabs.forEach(tab => {
                if (tab.dataset.tab === 'media') {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ›´æ–°é¢æ¿æ˜¾ç¤º
                    panels.forEach(panel => panel.classList.add('hidden'));
                    const targetPanel = document.getElementById(tabName + '-panel');
                    if (targetPanel) {
                        targetPanel.classList.remove('hidden');
                    }
                    
                    currentTab = tabName;
                    
                    // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
                    if (tabName === 'media') {
                        loadMediaFiles();
                        loadAudioSettings();
                    } else if (tabName === 'general') {
                        loadCharacterPresets();
                    } else if (tabName === 'qrcode') {
                        generateQRCode();
                    }
                });
            });
        }
        
        // åˆå§‹åŒ–åª’ä½“ä¸Šä¼ åŠŸèƒ½
        function initMediaUpload() {
            const uploadArea = document.getElementById('mediaUploadArea');
            const fileInput = document.getElementById('mediaFileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                uploadMediaFiles(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                uploadMediaFiles(e.target.files);
            });
        }
        
        // ä¸Šä¼ åª’ä½“æ–‡ä»¶
        async function uploadMediaFiles(fileList) {
            const statusDiv = document.getElementById('mediaUploadStatus');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>ä¸Šä¼ ä¸­...</div></div>';
            
            try {
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // é€ä¸ªä¸Šä¼ æ–‡ä»¶
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('client', currentClientId);
                    formData.append('category', 'ads');
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            const error = await response.text();
                            errors.push(`${file.name}: ${error}`);
                            errorCount++;
                        }
                    } catch (error) {
                        errors.push(`${file.name}: ${error.message}`);
                        errorCount++;
                    }
                }
                
                // æ˜¾ç¤ºç»“æœ
                if (successCount > 0 && errorCount === 0) {
                    statusDiv.innerHTML = `<div class="alert alert-success">ä¸Šä¼ æˆåŠŸï¼ä¸Šä¼ äº† ${successCount} ä¸ªæ–‡ä»¶ã€‚</div>`;
                } else if (successCount > 0 && errorCount > 0) {
                    statusDiv.innerHTML = `<div class="alert alert-info">éƒ¨åˆ†æˆåŠŸï¼š${successCount} ä¸ªæˆåŠŸï¼Œ${errorCount} ä¸ªå¤±è´¥ã€‚<br>${errors.join('<br>')}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-error">ä¸Šä¼ å¤±è´¥ï¼š${errors.join('<br>')}</div>`;
                }
                
                // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                if (successCount > 0) {
                    loadMediaFiles();
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-error">ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½åª’ä½“æ–‡ä»¶åˆ—è¡¨
        async function loadMediaFiles() {
            const fileListDiv = document.getElementById('mediaFileList');
            fileListDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>åŠ è½½æ–‡ä»¶ä¸­...</div></div>';
            
            try {
                const url = `/api/media/list?client=${encodeURIComponent(currentClientId)}&category=ads`;
                console.log('æ­£åœ¨è¯·æ±‚åª’ä½“æ–‡ä»¶åˆ—è¡¨:', url);
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    console.log('åª’ä½“æ–‡ä»¶åˆ—è¡¨APIå“åº”:', data);
                    renderMediaFileList(data.files || []);
                } else {
                    const error = await response.text();
                    console.error('åª’ä½“æ–‡ä»¶åˆ—è¡¨APIå¤±è´¥:', response.status, error);
                    fileListDiv.innerHTML = `<div class="alert alert-error">åŠ è½½æ–‡ä»¶å¤±è´¥: ${error}</div>`;
                }
            } catch (error) {
                console.error('åª’ä½“æ–‡ä»¶åˆ—è¡¨åŠ è½½é”™è¯¯:', error);
                fileListDiv.innerHTML = `<div class="alert alert-error">åŠ è½½æ–‡ä»¶å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“åª’ä½“æ–‡ä»¶åˆ—è¡¨
        function renderMediaFileList(mediaFiles) {
            const fileListDiv = document.getElementById('mediaFileList');
            console.log('æ¸²æŸ“åª’ä½“æ–‡ä»¶åˆ—è¡¨:', mediaFiles);
            
            if (!mediaFiles || mediaFiles.length === 0) {
                console.log('æ²¡æœ‰åª’ä½“æ–‡ä»¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                fileListDiv.innerHTML = '<div class="alert alert-info">æš‚æ— å¹¿å‘Šè§†é¢‘</div>';
                return;
            }
            
            console.log(`æ‰¾åˆ° ${mediaFiles.length} ä¸ªåª’ä½“æ–‡ä»¶`);
            let html = '';
            mediaFiles.forEach(file => {
                console.log('æ¸²æŸ“æ–‡ä»¶:', file);
                // ä½¿ç”¨filenameå­—æ®µï¼ˆAPIè¿”å›çš„å­—æ®µåï¼‰
                const displayName = file.filename || file.name || 'unknown';
                const fileSize = file.size_mb || (file.size_bytes / 1024 / 1024).toFixed(2);
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">${displayName}</div>
                            <div class="file-size">${fileSize} MB</div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small btn-danger" onclick="deleteMediaFile('${file.filename}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            
            fileListDiv.innerHTML = html;
        }
        
        // åˆ é™¤åª’ä½“æ–‡ä»¶
        async function deleteMediaFile(filename) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¹¿å‘Šè§†é¢‘å—ï¼Ÿ')) return;
            
            try {
                // âœ… ä½¿ç”¨queryå‚æ•°ï¼Œä¸æ˜¯body
                const url = `/api/media/delete?category=ads&filename=${encodeURIComponent(filename)}&client=${encodeURIComponent(currentClientId)}`;
                const response = await fetch(url, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadMediaFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                } else {
                    const error = await response.text();
                    alert('åˆ é™¤å¤±è´¥: ' + error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½éŸ³é¢‘è®¾ç½®ï¼ˆä¿¡å·æ¨¡å¼ï¼šä¸éœ€è¦åŠ è½½ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
        async function loadAudioSettings() {
            // ä¿¡å·æ¨¡å¼ï¼šä¸æŸ¥è¯¢å½“å‰çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤å€¼
                document.getElementById('audioMode').value = 'audio';
        }
        
        // ä¿å­˜éŸ³é¢‘è®¾ç½®ï¼ˆä¿¡å·æ¨¡å¼ï¼‰
        async function saveAudioSettings() {
            const audioMode = document.getElementById('audioMode').value;
            
            if (!audioMode) {
                alert('è¯·é€‰æ‹©éŸ³é¢‘æ¨¡å¼');
                return;
            }
            
            try {
                // ä½¿ç”¨ä¿¡å·æ¨¡å¼APIï¼šç›´æ¥å‘é€è®¾ç½®ä¿¡å·ï¼Œæ— éœ€æŸ¥è¯¢å½“å‰çŠ¶æ€
                const formData = new FormData();
                formData.append('audio_mode', audioMode);
                formData.append('client', currentClientId);
                
                const response = await fetch('/api/media/audio-mode', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } else {
                    const error = await response.json();
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + (error.error || 'ç½‘ç»œé”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFiles(fileList) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>ä¸Šä¼ ä¸­...</div></div>';
            
            try {
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // é€ä¸ªä¸Šä¼ æ–‡ä»¶ï¼ˆå› ä¸ºAPIåªæ”¯æŒå•æ–‡ä»¶ä¸Šä¼ ï¼‰
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('client', currentClientId);
                    formData.append('category', 'ads');
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            const error = await response.text();
                            errors.push(`${file.name}: ${error}`);
                            errorCount++;
                        }
                    } catch (error) {
                        errors.push(`${file.name}: ${error.message}`);
                        errorCount++;
                    }
                }
                
                // æ˜¾ç¤ºç»“æœ
                if (successCount > 0 && errorCount === 0) {
                    statusDiv.innerHTML = `<div class="alert alert-success">ä¸Šä¼ æˆåŠŸï¼ä¸Šä¼ äº† ${successCount} ä¸ªæ–‡ä»¶ã€‚</div>`;
                } else if (successCount > 0 && errorCount > 0) {
                    statusDiv.innerHTML = `<div class="alert alert-info">éƒ¨åˆ†æˆåŠŸï¼š${successCount} ä¸ªæˆåŠŸï¼Œ${errorCount} ä¸ªå¤±è´¥ã€‚<br>${errors.join('<br>')}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-error">ä¸Šä¼ å¤±è´¥ï¼š${errors.join('<br>')}</div>`;
                }
                
                // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                if (successCount > 0) {
                    loadFiles();
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-error">ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>åŠ è½½æ–‡ä»¶ä¸­...</div></div>';
            
            try {
                const url = `/api/media/list?client=${encodeURIComponent(currentClientId)}&category=ads`;
                const response = await fetch(url);
                if (response.ok) {
                    files = await response.json();
                    renderFileList();
                } else {
                    const error = await response.text();
                    fileListDiv.innerHTML = `<div class="alert alert-error">åŠ è½½æ–‡ä»¶å¤±è´¥: ${error}</div>`;
                }
            } catch (error) {
                fileListDiv.innerHTML = `<div class="alert alert-error">åŠ è½½æ–‡ä»¶å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            const fileListDiv = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileListDiv.innerHTML = '<div class="alert alert-info">æš‚æ— æ–‡ä»¶</div>';
                return;
            }
            
            let html = '';
            files.forEach(file => {
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${(file.size_bytes / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small btn-danger" onclick="deleteFile('${file.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            
            fileListDiv.innerHTML = html;
        }
        
        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(fileId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/media/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        client: currentClientId,
                        category: 'ads'
                    })
                });
                
                if (response.ok) {
                    loadFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                } else {
                    const error = await response.text();
                    alert('åˆ é™¤å¤±è´¥: ' + error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // ç”ŸæˆäºŒç»´ç 
        async function generateQRCode() {
            try {
                const url = `/api/qrcode/upload?client=${encodeURIComponent(currentClientId)}&category=ads`;
                const response = await fetch(url);
                if (response.ok) {
                    const result = await response.json();
                    // åç«¯è¿”å›çš„æ˜¯ qrcode_base64 (å·²åŒ…å«data:å‰ç¼€) å’Œ control_panel_url
                    const qrcodeData = result.qrcode_base64 || `data:image/png;base64,${result.qrcode_image}`;
                    document.getElementById('qrcodeImage').innerHTML = `<img src="${qrcodeData}" alt="QR Code" class="qrcode-image">`;
                    document.getElementById('qrcodeUrl').textContent = result.control_panel_url || result.upload_url;
                } else {
                    const error = await response.text();
                    document.getElementById('qrcodeImage').innerHTML = `<div class="alert alert-error">ç”ŸæˆäºŒç»´ç å¤±è´¥: ${error}</div>`;
                }
            } catch (error) {
                document.getElementById('qrcodeImage').innerHTML = `<div class="alert alert-error">ç”ŸæˆäºŒç»´ç å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ä¸‹è½½äºŒç»´ç 
        function downloadQRCode() {
            const img = document.querySelector('.qrcode-image');
            if (img) {
                const link = document.createElement('a');
                link.download = `qrcode_${currentClientId}.png`;
                link.href = img.src;
                link.click();
            }
        }
        
        // æ‰“å°äºŒç»´ç 
        function printQRCode() {
            const img = document.querySelector('.qrcode-image');
            if (img) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head><title>äºŒç»´ç æ‰“å°</title></head>
                        <body style="text-align: center; padding: 20px;">
                            <h2>å®¢æˆ·ç«¯ ${currentClientId} æ§åˆ¶é¢æ¿äºŒç»´ç </h2>
                            <img src="${img.src}" style="max-width: 300px;">
                            <p>æ‰«ææ­¤äºŒç»´ç å¯ç›´æ¥æ‰“å¼€æ§åˆ¶é¢æ¿</p>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }
        
        // é‡æ–°ç”ŸæˆäºŒç»´ç 
        function regenerateQRCode() {
            generateQRCode();
        }
        
        // åŠ è½½è®¾ç½®ï¼ˆç®€åŒ–ç‰ˆï¼ŒåªåŠ è½½è§’è‰²é¢„è®¾ï¼‰
        // ä¿¡å·æ¨¡å¼ï¼šä¸å†éœ€è¦åŠ è½½è®¾ç½®ï¼Œç”¨æˆ·åªéœ€å‘é€æƒ³è¦çš„çŠ¶æ€
        async function loadSettings() {
            // ä¿¡å·æ¨¡å¼ï¼šä¸æŸ¥è¯¢å½“å‰çŠ¶æ€ï¼ŒåªåŠ è½½è§’è‰²é¢„è®¾åˆ—è¡¨
            console.log('ä¿¡å·æ¨¡å¼ï¼šè·³è¿‡è®¾ç½®åŠ è½½ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·é€‰æ‹©');
        }
        
        // åŠ è½½è§’è‰²é¢„è®¾
        async function loadCharacterPresets() {
            try {
                const response = await fetch('/api/config-files');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('characterPreset');
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    select.innerHTML = '';
                    
                    // æ·»åŠ é»˜è®¤é€‰é¡¹
                    select.innerHTML = '<option value="">é€‰æ‹©è§’è‰²é¢„è®¾...</option>';
                    
                    // æ·»åŠ è§’è‰²é¢„è®¾é€‰é¡¹
                    if (data.configs && Array.isArray(data.configs)) {
                        data.configs.forEach(config => {
                            const option = document.createElement('option');
                            option.value = config.filename;
                            option.textContent = config.name;
                            select.appendChild(option);
                        });
                    }
                } else {
                    console.error('åŠ è½½è§’è‰²é¢„è®¾å¤±è´¥:', response.status);
                    document.getElementById('characterPreset').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²é¢„è®¾å¤±è´¥:', error);
                document.getElementById('characterPreset').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        // é€šç”¨ä¿å­˜å‡½æ•°
        async function saveSettings(settingsType, settings) {
            try {
                const response = await fetch('/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        settings_data: settings,
                        client: currentClientId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    let message = result.message;
                    if (result.heavyweight_pending && result.heavyweight_pending.length > 0) {
                        message += '\n\nâš ï¸ éƒ¨åˆ†è®¾ç½®éœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆ';
                    }
                    
                    alert(message);
                } else {
                    const error = await response.text();
                    alert('ä¿å­˜å¤±è´¥: ' + error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¿å­˜è§’è‰²è®¾ç½®ï¼ˆä¿¡å·æ¨¡å¼ï¼‰
        async function saveCharacterSettings() {
            const characterPreset = document.getElementById('characterPreset').value;
            
            if (!characterPreset) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²é¢„è®¾');
                return;
            }
            
            try {
                // ä½¿ç”¨ä¿¡å·æ¨¡å¼APIï¼šç›´æ¥å‘é€åˆ‡æ¢ä¿¡å·ï¼Œæ— éœ€æŸ¥è¯¢å½“å‰çŠ¶æ€
                const formData = new FormData();
                formData.append('character_preset', characterPreset);
                formData.append('client', currentClientId);
                
                const response = await fetch('/api/live2d/switch', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ åˆ‡æ¢å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } else {
                    const error = await response.json();
                    alert('âŒ åˆ‡æ¢å¤±è´¥: ' + (error.error || 'ç½‘ç»œé”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ åˆ‡æ¢å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¿å­˜ASRè®¾ç½®ï¼ˆä¿¡å·æ¨¡å¼ï¼‰
        async function saveASRSettings() {
            try {
                const formData = new FormData();
                formData.append('auto_stop_mic', document.getElementById('autoStopMic').checked);
                formData.append('auto_start_mic_on_conv_end', document.getElementById('autoStartMicOnConvEnd').checked);
                formData.append('auto_start_mic_on', document.getElementById('autoStartMicOn').checked);
                formData.append('client', currentClientId);
                
                const response = await fetch('/api/asr/settings', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } else {
                    const error = await response.json();
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + (error.error || 'ç½‘ç»œé”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¿å­˜VADè®¾ç½®ï¼ˆä¿¡å·æ¨¡å¼ï¼‰
        async function saveVADSettings() {
            try {
                const formData = new FormData();
                const positiveThreshold = parseFloat(document.getElementById('positiveSpeechThreshold').value);
                const negativeThreshold = parseFloat(document.getElementById('negativeSpeechThreshold').value);
                const redemptionFrames = parseInt(document.getElementById('redemptionFrames').value);
                
                if (isNaN(positiveThreshold) || isNaN(negativeThreshold) || isNaN(redemptionFrames)) {
                    alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                    return;
                }
                
                formData.append('positive_speech_threshold', positiveThreshold);
                formData.append('negative_speech_threshold', negativeThreshold);
                formData.append('redemption_frames', redemptionFrames);
                formData.append('client', currentClientId);
                
                const response = await fetch('/api/asr/settings', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } else {
                    const error = await response.json();
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + (error.error || 'ç½‘ç»œé”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ==================== ä¸»é¢˜ä»‹ç»ç®¡ç† ====================
        
        let topicImageItems = [];
        let topicVideoItems = [];
        
        // åŠ è½½ä¸»é¢˜åˆ—è¡¨
        async function loadTopics() {
            const topicsListDiv = document.getElementById('topicsList');
            if (!topicsListDiv) return;
            
            topicsListDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>åŠ è½½ä¸»é¢˜ä¸­...</div></div>';
            
            try {
                const url = `/api/topics?client=${encodeURIComponent(currentClientId)}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    renderTopicsList(data.topics || []);
                } else {
                    const error = await response.text();
                    topicsListDiv.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error}</div>`;
                }
            } catch (error) {
                topicsListDiv.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“ä¸»é¢˜åˆ—è¡¨
        function renderTopicsList(topics) {
            const topicsListDiv = document.getElementById('topicsList');
            if (!topicsListDiv) return;
            
            if (topics.length === 0) {
                topicsListDiv.innerHTML = '<div class="alert alert-info">æš‚æ— ä¸»é¢˜ï¼Œè¯·åˆ›å»ºæ–°ä¸»é¢˜</div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            topics.forEach(topic => {
                const name = topic.name || 'Unknown';
                html += `
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e1e5e9; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${name}</div>
                            <div style="font-size: 14px; color: #666;">
                                å›¾ç‰‡: ${topic.image_count || 0} | è§†é¢‘: ${topic.video_count || 0}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" onclick="editTopic('${topic.topic_id}')" style="background: #007bff; padding: 8px 16px; font-size: 14px;">æ›´æ–°</button>
                            <button class="btn" onclick="deleteTopic('${topic.topic_id}')" style="background: #dc3545; padding: 8px 16px; font-size: 14px;">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            topicsListDiv.innerHTML = html;
        }
        
        // æ·»åŠ å›¾ç‰‡é¡¹
        function addTopicImageItem() {
            if (topicImageItems.length >= 10) {
                alert('å›¾ç‰‡æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ10ä¸ªï¼‰');
                return;
            }
            
            const itemId = `img_${Date.now()}`;
            topicImageItems.push({ id: itemId, file: null, description: '' });
            
            const imagesList = document.getElementById('topicImagesList');
            const itemDiv = document.createElement('div');
            itemDiv.id = `imageItem_${itemId}`;
            itemDiv.style.cssText = 'background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #dee2e6;';
            itemDiv.innerHTML = `
                <div class="upload-area" onclick="document.getElementById('imgFile_${itemId}').click()" style="margin-bottom: 12px; cursor: pointer; padding: 30px; text-align: center; border: 2px dashed #007bff; border-radius: 8px; background: #f8f9ff;">
                    <div style="font-size: 40px;">ğŸ“</div>
                    <div style="font-weight: 600; margin-top: 8px;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">æ”¯æŒæ ¼å¼: JPG, PNG, GIF, WEBP</div>
                    <div id="imgFileName_${itemId}" style="color: #28a745; font-weight: 600; margin-top: 8px;"></div>
                </div>
                <input type="file" id="imgFile_${itemId}" accept="image/*" onchange="handleTopicImageFile('${itemId}', this)" style="display: none;">
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px;">
                        ğŸ“ å›¾ç‰‡æè¿° <span style="color: red;">*</span>
                    </label>
                    <input type="text" placeholder="å¿…å¡«ï¼Œå¦‚ï¼šãƒ›ãƒ†ãƒ«ã®å¤–è¦³" onchange="updateTopicImageDesc('${itemId}', this.value)" id="imgDesc_${itemId}" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 4px; font-size: 14px;" required>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="uploadSingleImage('${itemId}')" style="background: #28a745; padding: 10px 20px; flex: 1; font-weight: 600; font-size: 15px;">
                        ğŸ“¤ ä¸Šä¼ æ­¤å›¾ç‰‡
                    </button>
                    <button class="btn" onclick="removeTopicImageItem('${itemId}')" style="background: #dc3545; padding: 10px 20px;">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </div>
                <div id="imgStatus_${itemId}" style="margin-top: 8px; font-size: 13px; font-weight: 600;"></div>
            `;
            imagesList.appendChild(itemDiv);
            
            updateAddButtonsState();
        }
        
        // æ·»åŠ è§†é¢‘é¡¹
        function addTopicVideoItem() {
            if (topicVideoItems.length >= 3) {
                alert('è§†é¢‘æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ3ä¸ªï¼‰');
                return;
            }
            
            const itemId = `vid_${Date.now()}`;
            topicVideoItems.push({ id: itemId, file: null, description: '' });
            
            const videosList = document.getElementById('topicVideosList');
            const itemDiv = document.createElement('div');
            itemDiv.id = `videoItem_${itemId}`;
            itemDiv.style.cssText = 'background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #dee2e6;';
            itemDiv.innerHTML = `
                <div class="upload-area" onclick="document.getElementById('vidFile_${itemId}').click()" style="margin-bottom: 12px; cursor: pointer; padding: 30px; text-align: center; border: 2px dashed #007bff; border-radius: 8px; background: #f8f9ff;">
                    <div style="font-size: 40px;">ğŸ¬</div>
                    <div style="font-weight: 600; margin-top: 8px;">ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">æ”¯æŒæ ¼å¼: MP4, AVI, MOV, WEBM | æœ€å¤§500MB</div>
                    <div id="vidFileName_${itemId}" style="color: #28a745; font-weight: 600; margin-top: 8px;"></div>
                </div>
                <input type="file" id="vidFile_${itemId}" accept="video/*" onchange="handleTopicVideoFile('${itemId}', this)" style="display: none;">
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px;">
                        ğŸ“ è§†é¢‘æè¿° <span style="color: red;">*</span>
                    </label>
                    <input type="text" placeholder="å¿…å¡«ï¼Œå¦‚ï¼šãƒ›ãƒ†ãƒ«ãƒ„ã‚¢ãƒ¼" onchange="updateTopicVideoDesc('${itemId}', this.value)" id="vidDesc_${itemId}" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 4px; font-size: 14px;" required>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="uploadSingleVideo('${itemId}')" style="background: #28a745; padding: 10px 20px; flex: 1; font-weight: 600; font-size: 15px;">
                        ğŸ“¤ ä¸Šä¼ æ­¤è§†é¢‘
                    </button>
                    <button class="btn" onclick="removeTopicVideoItem('${itemId}')" style="background: #dc3545; padding: 10px 20px;">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </div>
                <div id="vidStatus_${itemId}" style="margin-top: 8px; font-size: 13px; font-weight: 600;"></div>
            `;
            videosList.appendChild(itemDiv);
            
            updateAddButtonsState();
        }
        
        // å¤„ç†å›¾ç‰‡æ–‡ä»¶é€‰æ‹©
        function handleTopicImageFile(itemId, input) {
            const item = topicImageItems.find(i => i.id === itemId);
            if (item && input.files && input.files[0]) {
                item.file = input.files[0];
                // æ˜¾ç¤ºæ–‡ä»¶å
                const fileNameDiv = document.getElementById(`imgFileName_${itemId}`);
                if (fileNameDiv) {
                    const fileSize = (item.file.size / (1024 * 1024)).toFixed(2);
                    fileNameDiv.innerHTML = `âœ… å·²é€‰æ‹©: ${item.file.name} (${fileSize}MB)`;
                }
            }
        }
        
        // å¤„ç†è§†é¢‘æ–‡ä»¶é€‰æ‹©
        function handleTopicVideoFile(itemId, input) {
            const item = topicVideoItems.find(i => i.id === itemId);
            if (item && input.files && input.files[0]) {
                item.file = input.files[0];
                // æ˜¾ç¤ºæ–‡ä»¶å
                const fileNameDiv = document.getElementById(`vidFileName_${itemId}`);
                if (fileNameDiv) {
                    const fileSize = (item.file.size / (1024 * 1024)).toFixed(2);
                    fileNameDiv.innerHTML = `âœ… å·²é€‰æ‹©: ${item.file.name} (${fileSize}MB)`;
                }
            }
        }
        
        // æ›´æ–°å›¾ç‰‡æè¿°
        function updateTopicImageDesc(itemId, value) {
            const item = topicImageItems.find(i => i.id === itemId);
            if (item) {
                item.description = value;
            }
        }
        
        // æ›´æ–°è§†é¢‘æè¿°
        function updateTopicVideoDesc(itemId, value) {
            const item = topicVideoItems.find(i => i.id === itemId);
            if (item) {
                item.description = value;
            }
        }
        
        // åˆ é™¤å›¾ç‰‡é¡¹
        function removeTopicImageItem(itemId) {
            topicImageItems = topicImageItems.filter(i => i.id !== itemId);
            const itemDiv = document.getElementById(`imageItem_${itemId}`);
            if (itemDiv) {
                itemDiv.remove();
            }
            updateAddButtonsState();
        }
        
        // åˆ é™¤è§†é¢‘é¡¹
        function removeTopicVideoItem(itemId) {
            topicVideoItems = topicVideoItems.filter(i => i.id !== itemId);
            const itemDiv = document.getElementById(`videoItem_${itemId}`);
            if (itemDiv) {
                itemDiv.remove();
            }
            updateAddButtonsState();
        }
        
        // æ›´æ–°æ·»åŠ æŒ‰é’®çŠ¶æ€
        function updateAddButtonsState() {
            const addImageBtn = document.getElementById('addImageBtn');
            const addVideoBtn = document.getElementById('addVideoBtn');
            if (addImageBtn) addImageBtn.disabled = topicImageItems.length >= 10;
            if (addVideoBtn) addVideoBtn.disabled = topicVideoItems.length >= 3;
        }
        
        // ä¸Šä¼ å•ä¸ªå›¾ç‰‡ï¼ˆå¯é€‰åŠŸèƒ½ï¼Œä¿å­˜æ—¶ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼‰
        async function uploadSingleImage(itemId) {
            const item = topicImageItems.find(i => i.id === itemId);
            if (!item) return;
            
            // éªŒè¯æ–‡ä»¶å’Œæè¿°
            if (!item.file) {
                alert('âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            if (!item.description || !item.description.trim()) {
                alert('âŒ è¯·å¡«å†™å›¾ç‰‡æè¿°ï¼\n\næè¿°æ˜¯å¿…éœ€çš„ï¼Œç”¨äºAIä»‹ç»å›¾ç‰‡å†…å®¹ã€‚');
                return;
            }
            
            // è·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„ä¸»é¢˜IDï¼Œå¦‚æœæ²¡æœ‰åˆ™æç¤ºä¿å­˜
            let editingTopicId = document.getElementById('editingTopicId').value;
            if (!editingTopicId) {
                const name = document.getElementById('topicName').value.trim();
                if (!name) {
                    alert('âš ï¸ è¯·å…ˆå¡«å†™ä¸»é¢˜åç§°å¹¶ä¿å­˜ä¸»é¢˜ï¼\n\næç¤ºï¼šæ‚¨å¯ä»¥å¡«å†™æ‰€æœ‰ä¿¡æ¯åï¼Œç‚¹å‡»"ä¿å­˜ä¸»é¢˜"ä¸€æ¬¡æ€§ä¿å­˜å¹¶ä¸Šä¼ ã€‚');
                    return;
                }
                // å°è¯•å…ˆåˆ›å»ºä¸»é¢˜
                try {
                    const formData = new FormData();
                    formData.append('name', name);
                    formData.append('description', document.getElementById('topicDescription').value.trim());
                    formData.append('language', document.getElementById('contentLanguage').value);
                    formData.append('client', currentClientId);
                    
                    const response = await fetch('/api/topics', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('åˆ›å»ºä¸»é¢˜å¤±è´¥');
                    }
                    
                    const result = await response.json();
                    editingTopicId = result.topic_id;
                    document.getElementById('editingTopicId').value = editingTopicId;
                    document.getElementById('topicFormTitle').textContent = 'ç¼–è¾‘ä¸»é¢˜';
                    document.getElementById('cancelTopicBtn').style.display = 'inline-block';
                } catch (error) {
                    alert('âŒ è‡ªåŠ¨åˆ›å»ºä¸»é¢˜å¤±è´¥ï¼Œè¯·å…ˆç‚¹å‡»"ä¿å­˜ä¸»é¢˜"æŒ‰é’®ã€‚');
                    return;
                }
            }
            
            const statusDiv = document.getElementById(`imgStatus_${itemId}`);
            statusDiv.innerHTML = '<span style="color: #007bff;">â³ ä¸Šä¼ ä¸­...</span>';
            
            try {
                const formData = new FormData();
                formData.append('file', item.file);
                formData.append('description', item.description.trim());
                formData.append('client', currentClientId);
                
                const response = await fetch(`/api/topics/${editingTopicId}/images`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = '<span style="color: #28a745;">âœ… ä¸Šä¼ æˆåŠŸï¼</span>';
                    item.uploaded = true;
                    item.uploadedId = result.image_id;
                    loadTopics(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ${error.error || 'ä¸Šä¼ å¤±è´¥'}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</span>`;
            }
        }
        
        // ä¸Šä¼ å•ä¸ªè§†é¢‘ï¼ˆå¯é€‰åŠŸèƒ½ï¼Œä¿å­˜æ—¶ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼‰
        async function uploadSingleVideo(itemId) {
            const item = topicVideoItems.find(i => i.id === itemId);
            if (!item) return;
            
            // éªŒè¯æ–‡ä»¶å’Œæè¿°
            if (!item.file) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼');
                return;
            }
            
            if (!item.description || !item.description.trim()) {
                alert('âŒ è¯·å¡«å†™è§†é¢‘æè¿°ï¼\n\næè¿°æ˜¯å¿…éœ€çš„ï¼Œç”¨äºAIè¯´æ˜è§†é¢‘å†…å®¹ã€‚');
                return;
            }
            
            // è·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„ä¸»é¢˜IDï¼Œå¦‚æœæ²¡æœ‰åˆ™æç¤ºä¿å­˜
            let editingTopicId = document.getElementById('editingTopicId').value;
            if (!editingTopicId) {
                const name = document.getElementById('topicName').value.trim();
                if (!name) {
                    alert('âš ï¸ è¯·å…ˆå¡«å†™ä¸»é¢˜åç§°å¹¶ä¿å­˜ä¸»é¢˜ï¼\n\næç¤ºï¼šæ‚¨å¯ä»¥å¡«å†™æ‰€æœ‰ä¿¡æ¯åï¼Œç‚¹å‡»"ä¿å­˜ä¸»é¢˜"ä¸€æ¬¡æ€§ä¿å­˜å¹¶ä¸Šä¼ ã€‚');
                    return;
                }
                // å°è¯•å…ˆåˆ›å»ºä¸»é¢˜
                try {
                    const formData = new FormData();
                    formData.append('name', name);
                    formData.append('description', document.getElementById('topicDescription').value.trim());
                    formData.append('language', document.getElementById('contentLanguage').value);
                    formData.append('client', currentClientId);
                    
                    const response = await fetch('/api/topics', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('åˆ›å»ºä¸»é¢˜å¤±è´¥');
                    }
                    
                    const result = await response.json();
                    editingTopicId = result.topic_id;
                    document.getElementById('editingTopicId').value = editingTopicId;
                    document.getElementById('topicFormTitle').textContent = 'ç¼–è¾‘ä¸»é¢˜';
                    document.getElementById('cancelTopicBtn').style.display = 'inline-block';
                } catch (error) {
                    alert('âŒ è‡ªåŠ¨åˆ›å»ºä¸»é¢˜å¤±è´¥ï¼Œè¯·å…ˆç‚¹å‡»"ä¿å­˜ä¸»é¢˜"æŒ‰é’®ã€‚');
                    return;
                }
            }
            
            const statusDiv = document.getElementById(`vidStatus_${itemId}`);
            statusDiv.innerHTML = '<span style="color: #007bff;">â³ ä¸Šä¼ ä¸­...</span>';
            
            try {
                const formData = new FormData();
                formData.append('file', item.file);
                formData.append('description', item.description.trim());
                formData.append('client', currentClientId);
                
                const response = await fetch(`/api/topics/${editingTopicId}/videos`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = '<span style="color: #28a745;">âœ… ä¸Šä¼ æˆåŠŸï¼</span>';
                    item.uploaded = true;
                    item.uploadedId = result.video_id;
                    loadTopics(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ${error.error || 'ä¸Šä¼ å¤±è´¥'}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</span>`;
            }
        }
        
        // ä¿å­˜ä¸»é¢˜ï¼ˆè‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰å·²é€‰æ‹©çš„å›¾ç‰‡å’Œè§†é¢‘ï¼‰
        async function saveTopic() {
            const editingTopicId = document.getElementById('editingTopicId').value;
            const name = document.getElementById('topicName').value.trim();
            const description = document.getElementById('topicDescription').value.trim();
            const language = document.getElementById('contentLanguage').value;
            
            // éªŒè¯åç§°
            if (!name) {
                alert('è¯·å¡«å†™ä¸»é¢˜åç§°');
                return;
            }
            
            // éªŒè¯å›¾ç‰‡å’Œè§†é¢‘ï¼ˆå¦‚æœå·²é€‰æ‹©ï¼‰
            const pendingImages = topicImageItems.filter(item => item.file && !item.uploaded);
            const pendingVideos = topicVideoItems.filter(item => item.file && !item.uploaded);
            
            for (const item of pendingImages) {
                if (!item.description || !item.description.trim()) {
                    alert(`âŒ è¯·å¡«å†™æ‰€æœ‰å›¾ç‰‡çš„æè¿°ï¼\n\nå›¾ç‰‡ "${item.file?.name || 'æœªå‘½å'}" ç¼ºå°‘æè¿°ã€‚`);
                    return;
                }
            }
            
            for (const item of pendingVideos) {
                if (!item.description || !item.description.trim()) {
                    alert(`âŒ è¯·å¡«å†™æ‰€æœ‰è§†é¢‘çš„æè¿°ï¼\n\nè§†é¢‘ "${item.file?.name || 'æœªå‘½å'}" ç¼ºå°‘æè¿°ã€‚`);
                    return;
                }
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const saveBtn = document.getElementById('saveTopicBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'â³ ä¿å­˜ä¸­...';
            
            try {
                let topicId = editingTopicId;
                
                // åˆ›å»ºæˆ–æ›´æ–°ä¸»é¢˜åŸºæœ¬ä¿¡æ¯
                if (editingTopicId) {
                    // æ›´æ–°ä¸»é¢˜
                    const formData = new FormData();
                    formData.append('name', name);
                    formData.append('description', description);
                    formData.append('language', language);
                    formData.append('client', currentClientId);
                    
                    const response = await fetch(`/api/topics/${editingTopicId}`, {
                        method: 'PUT',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'æ›´æ–°å¤±è´¥');
                    }
                } else {
                    // åˆ›å»ºæ–°ä¸»é¢˜
                    const formData = new FormData();
                    formData.append('name', name);
                    formData.append('description', description);
                    formData.append('language', language);
                    formData.append('client', currentClientId);
                    
                    const response = await fetch('/api/topics', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'åˆ›å»ºå¤±è´¥');
                    }
                    
                    const result = await response.json();
                    topicId = result.topic_id;
                    
                    // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
                    document.getElementById('editingTopicId').value = topicId;
                    document.getElementById('topicFormTitle').textContent = 'ç¼–è¾‘ä¸»é¢˜';
                    document.getElementById('cancelTopicBtn').style.display = 'inline-block';
                }
                
                // è‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰æœªä¸Šä¼ çš„å›¾ç‰‡
                let uploadedImages = 0;
                let failedImages = 0;
                for (const item of pendingImages) {
                    try {
                        const statusDiv = document.getElementById(`imgStatus_${item.id}`);
                        if (statusDiv) statusDiv.innerHTML = '<span style="color: #007bff;">â³ ä¸Šä¼ ä¸­...</span>';
                        
                        const formData = new FormData();
                        formData.append('file', item.file);
                        formData.append('description', item.description.trim());
                        formData.append('client', currentClientId);
                        
                        const response = await fetch(`/api/topics/${topicId}/images`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            item.uploaded = true;
                            item.uploadedId = result.image_id;
                            uploadedImages++;
                            if (statusDiv) statusDiv.innerHTML = '<span style="color: #28a745;">âœ… å·²ä¸Šä¼ </span>';
                        } else {
                            const error = await response.json();
                            failedImages++;
                            if (statusDiv) statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ${error.error || 'ä¸Šä¼ å¤±è´¥'}</span>`;
                        }
                    } catch (error) {
                        failedImages++;
                        const statusDiv = document.getElementById(`imgStatus_${item.id}`);
                        if (statusDiv) statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</span>`;
                    }
                }
                
                // è‡ªåŠ¨ä¸Šä¼ æ‰€æœ‰æœªä¸Šä¼ çš„è§†é¢‘
                let uploadedVideos = 0;
                let failedVideos = 0;
                for (const item of pendingVideos) {
                    try {
                        const statusDiv = document.getElementById(`vidStatus_${item.id}`);
                        if (statusDiv) statusDiv.innerHTML = '<span style="color: #007bff;">â³ ä¸Šä¼ ä¸­...</span>';
                        
                        const formData = new FormData();
                        formData.append('file', item.file);
                        formData.append('description', item.description.trim());
                        formData.append('client', currentClientId);
                        
                        const response = await fetch(`/api/topics/${topicId}/videos`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            item.uploaded = true;
                            item.uploadedId = result.video_id;
                            uploadedVideos++;
                            if (statusDiv) statusDiv.innerHTML = '<span style="color: #28a745;">âœ… å·²ä¸Šä¼ </span>';
                        } else {
                            const error = await response.json();
                            failedVideos++;
                            if (statusDiv) statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ${error.error || 'ä¸Šä¼ å¤±è´¥'}</span>`;
                        }
                    } catch (error) {
                        failedVideos++;
                        const statusDiv = document.getElementById(`vidStatus_${item.id}`);
                        if (statusDiv) statusDiv.innerHTML = `<span style="color: #dc3545;">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</span>`;
                    }
                }
                
                // æ˜¾ç¤ºç»“æœ
                let message = 'âœ… ä¿å­˜æˆåŠŸï¼\n\n';
                if (uploadedImages > 0 || uploadedVideos > 0) {
                    message += `ğŸ“¸ å·²ä¸Šä¼  ${uploadedImages} å¼ å›¾ç‰‡\n`;
                    message += `ğŸ¬ å·²ä¸Šä¼  ${uploadedVideos} ä¸ªè§†é¢‘\n\n`;
                }
                if (failedImages > 0 || failedVideos > 0) {
                    message += `âš ï¸ ${failedImages} å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥\n`;
                    message += `âš ï¸ ${failedVideos} ä¸ªè§†é¢‘ä¸Šä¼ å¤±è´¥\n`;
                }
                if (uploadedImages === 0 && uploadedVideos === 0 && failedImages === 0 && failedVideos === 0) {
                    message += 'ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥ç»§ç»­æ·»åŠ å›¾ç‰‡å’Œè§†é¢‘ï¼Œç„¶åå†æ¬¡ç‚¹å‡»"ä¿å­˜ä¸»é¢˜"ä¸Šä¼ ã€‚';
                }
                
                alert(message);
                
                // åˆ·æ–°ä¸»é¢˜åˆ—è¡¨
                loadTopics();
                
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤ä¿å­˜æŒ‰é’®
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        // ç¼–è¾‘ä¸»é¢˜
        async function editTopic(topicId) {
            try {
                const response = await fetch(`/api/topics/${topicId}?client=${encodeURIComponent(currentClientId)}`);
                if (!response.ok) {
                    throw new Error('åŠ è½½ä¸»é¢˜å¤±è´¥');
                }
                
                const data = await response.json();
                const topic = data.topic;
                
                // å¡«å……è¡¨å•
                document.getElementById('editingTopicId').value = topicId;
                document.getElementById('topicFormTitle').textContent = 'ç¼–è¾‘ä¸»é¢˜';
                document.getElementById('cancelTopicBtn').style.display = 'inline-block';
                
                // å¡«å……åç§°å’Œæè¿°
                document.getElementById('topicName').value = topic.name || '';
                document.getElementById('topicDescription').value = topic.description || '';
                document.getElementById('contentLanguage').value = topic.language || 'ja';
                
                // æ¸…ç©ºå¹¶é‡æ–°åŠ è½½å›¾ç‰‡å’Œè§†é¢‘é¡¹
                topicImageItems = [];
                topicVideoItems = [];
                document.getElementById('topicImagesList').innerHTML = '';
                document.getElementById('topicVideosList').innerHTML = '';
                
                // åŠ è½½ç°æœ‰å›¾ç‰‡ï¼ˆåªæ˜¾ç¤ºï¼Œä¸èƒ½é‡æ–°ä¸Šä¼ ï¼‰
                for (const img of topic.images || []) {
                    addTopicImageItem();
                    const lastItem = topicImageItems[topicImageItems.length - 1];
                    lastItem.description = img.description || '';
                    // ç¦ç”¨æ–‡ä»¶è¾“å…¥ï¼ˆç¼–è¾‘æ—¶ä¸èƒ½é‡æ–°ä¸Šä¼ ï¼‰
                    const itemDiv = document.getElementById(`imageItem_${lastItem.id}`);
                    if (itemDiv) {
                        const fileInput = itemDiv.querySelector('input[type="file"]');
                        if (fileInput) fileInput.disabled = true;
                        // å¡«å……æè¿°è¾“å…¥æ¡†
                        const descInput = itemDiv.querySelector('input[type="text"]');
                        if (descInput) descInput.value = img.description || '';
                    }
                }
                
                // åŠ è½½ç°æœ‰è§†é¢‘ï¼ˆåªæ˜¾ç¤ºï¼Œä¸èƒ½é‡æ–°ä¸Šä¼ ï¼‰
                for (const vid of topic.videos || []) {
                    addTopicVideoItem();
                    const lastItem = topicVideoItems[topicVideoItems.length - 1];
                    lastItem.description = vid.description || '';
                    // ç¦ç”¨æ–‡ä»¶è¾“å…¥ï¼ˆç¼–è¾‘æ—¶ä¸èƒ½é‡æ–°ä¸Šä¼ ï¼‰
                    const itemDiv = document.getElementById(`videoItem_${lastItem.id}`);
                    if (itemDiv) {
                        const fileInput = itemDiv.querySelector('input[type="file"]');
                        if (fileInput) fileInput.disabled = true;
                        // å¡«å……æè¿°è¾“å…¥æ¡†
                        const descInput = itemDiv.querySelector('input[type="text"]');
                        if (descInput) descInput.value = vid.description || '';
                    }
                }
                
                // æ»šåŠ¨åˆ°è¡¨å•
                document.getElementById('topics-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                alert('âŒ åŠ è½½ä¸»é¢˜å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤ä¸»é¢˜
        async function deleteTopic(topicId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸»é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/topics/${topicId}?client=${encodeURIComponent(currentClientId)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('âœ… ä¸»é¢˜åˆ é™¤æˆåŠŸ');
                    loadTopics();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // å–æ¶ˆç¼–è¾‘
        function cancelTopicEdit() {
            resetTopicForm();
        }
        
        // é‡ç½®è¡¨å•
        function resetTopicForm() {
            document.getElementById('editingTopicId').value = '';
            document.getElementById('topicFormTitle').textContent = 'æ–°å»ºä¸»é¢˜';
            document.getElementById('cancelTopicBtn').style.display = 'none';
            
            document.getElementById('topicName').value = '';
            document.getElementById('topicDescription').value = '';
            document.getElementById('contentLanguage').value = 'ja';
            
            topicImageItems = [];
            topicVideoItems = [];
            document.getElementById('topicImagesList').innerHTML = '';
            document.getElementById('topicVideosList').innerHTML = '';
            updateAddButtonsState();
        }
        
    </script>
</body>
</html>
### 项目总览与使用指南（TheProjectSan）

本项目是一个“语音对话 + Live2D 角色 + Electron 前端”的一体化方案，包含：
- 后端服务：FastAPI + Starlette（Uvicorn 启动），提供 WebSocket、REST API、静态资源服务与工具页。
- 前端桌面端：Electron + React + TypeScript（electron-vite），用于可视化与本地桌面体验。
- Web 工具页：`web_tool` 目录下的纯前端页面，可直接通过后端静态服务访问。

---

## 架构概览

- 后端入口：`run_server.py`
  - 读取 `conf.yaml` 配置，初始化 `ServiceContext`（ASR/TTS/VAD/LLM/Live2D 等）。
  - 创建 `FastAPI` 应用并注册路由（WebSocket、TTS、资源管理等）。
  - 通过 `Uvicorn` 启动 HTTP 服务，按配置监听 `host:port`。

- 核心服务：`src/ai_chat/server.py`
  - WebSocket 主通道：`/client-ws`（客户端实时对话与状态同步）。
  - 代理 WebSocket（可选）：`/proxy-ws`（多客户端复用一个后端连接）。
  - TTS WebSocket：`/tts-ws`（文本转语音流式返回片段）。
  - 健康检查：`/health` 与 `/api/health`。
  - 静态资源挂载与 CORS 处理（`/videos`、`/ads`、`/live2d-models`、`/avatars`、`/cache`、`/web-tool`、`/`）。

- 业务路由：`src/ai_chat/routes.py`
  - ASR 相关：`POST /asr`、`POST /api/asr-chunk`
  - 媒资管理：
    - 广告视频：`GET /api/ads`、`POST /api/ads/upload`、`DELETE /api/ads/{filename}`
    - 教程视频：`GET /api/videos`、`POST /api/videos/upload`、`DELETE /api/videos/{filename}`
  - Live2D 列表：`GET /live2d-models/info`
  - SSE 测试：`GET /api/stream`

- 服务上下文：`src/ai_chat/service_context.py`
  - 负责按 `conf.yaml` 初始化与管理 ASR、TTS、VAD、LLM、Live2D、MCP 工具等模块。
  - 提供配置切换、延迟初始化与资源释放等能力。

- 前端（桌面端）：`frontend/`
  - Electron + React（electron-vite）。
  - 开发：`npm run dev`，构建：`npm run build:*`。
  - Web 预览：`npm run dev:web`（Vite 直起渲染层）。
  - 环境变量配置参考 `frontend/DEPLOYMENT.md`。

---

## 运行方式

前置要求：
- 已安装 Python 3.10+ 与 Node.js（建议 v18+）、npm。
- Windows 用户建议在 PowerShell/Terminal 中执行命令（路径包含中文也可）。

### 方式 A：仅后端 + Web 工具页
1) 在项目根目录创建 `conf.yaml`（参考下方模板）。
2) 启动后端：
   - 标准日志：`python run_server.py`
   - 详细日志：`python run_server.py --verbose`
3) 浏览器访问：`http://<host>:<port>/web-tool/`（默认 `http://127.0.0.1:12393/web-tool/`）。

### 方式 B：后端 + Web 预览（Vite 渲染层）
1) 启动后端（同上）。
2) 进入 `frontend/`：
   - 安装依赖：`npm install`
   - 启动渲染层：`npm run dev:web`
3) 浏览器访问：终端显示的 Vite 地址（通常 `http://localhost:5173`）。
   - 若后端与前端不在同源域名，请在 `frontend/.env.*` 或启动命令中设置 `VITE_API_BASE_URL`。

### 方式 C：桌面应用（Electron）
1) 进入 `frontend/`，安装依赖：`npm install`
2) 开发模式：`npm run dev`
3) 构建安装包：
   - Windows: `npm run build:win`
   - macOS: `npm run build:mac`
   - Linux: `npm run build:linux`

> 提示：后端会把 `frontend/` 目录作为静态站点挂载到 `/`。要通过后端直接访问构建产物，请先在 `frontend/` 执行构建并确保生成的 `out/renderer` 静态文件可被 `/` 挂载路径访问（必要时将产物拷贝到 `frontend/` 根下）。开发阶段推荐使用「方式 B 或 C」。

---

## 主要端点与资源挂载

- WebSocket
  - `/client-ws`：主通道（状态、消息、指令）。
  - `/proxy-ws`：代理通道（开启 `enable_proxy: true` 才可用）。
  - `/tts-ws`：TTS 片段流式推送。

- REST
  - 健康检查：`GET /health`、`GET /api/health`
  - ASR：`POST /asr`、`POST /api/asr-chunk`
  - 广告：`GET /api/ads`、`POST /api/ads/upload`、`DELETE /api/ads/{filename}`
  - 教程：`GET /api/videos`、`POST /api/videos/upload`、`DELETE /api/videos/{filename}`
  - Live2D 信息：`GET /live2d-models/info`
  - SSE 测试：`GET /api/stream`

- 静态资源挂载（均已开启 CORS）
  - `/cache` → `cache/`（运行时生成的缓存与音频等）
  - `/videos` → `videos/`（教程视频）
  - `/ads` → `ads/`（广告视频）
  - `/live2d-models` → `live2d-models/`（Live2D 模型资源）
  - `/avatars` → `avatars/`（头像，仅限图片扩展名）
  - `/bg` → `backgrounds/`（背景图，需自行创建该目录并放入 jpg/png/gif）
  - `/web-tool` → `web_tool/`（工具页面）
  - `/` → `frontend/`（前端构建产物或静态资源）

---

## 配置文件 `conf.yaml` 模板

在项目根目录创建 `conf.yaml`，包含后端系统配置与角色配置两部分：

```yaml
system_config:
  conf_version: "1.0.0"
  host: "127.0.0.1"
  port: 12393
  # 角色配置备选目录（用于在前端或后端切换不同角色配置文件）
  config_alts_dir: "characters"

  # 工具提示词（用于拼接到系统提示词中）
  tool_prompts:
    live2d_expression_prompt: "prompts/utils/live2d_expression_prompt.txt"
    speakable_prompt: "prompts/utils/speakable_prompt.txt"
    concise_style_prompt: "prompts/utils/concise_style_prompt.txt"
    think_tag_prompt: "prompts/utils/think_tag_prompt.txt"
    tool_guidance_prompt: "prompts/utils/tool_guidance_prompt.txt"
    # 可选（通常由系统逻辑内部处理）
    group_conversation_prompt: "prompts/utils/group_conversation_prompt.txt"
    proactive_speak_prompt: "prompts/utils/proactive_speak_prompt.txt"
    mcp_prompt: "prompts/utils/mcp_prompt.txt"

  enable_proxy: false
  enable_history: true

  # 媒体服务器（用于生成视频 URL，若仅本地访问可保持默认即可）
  media_server:
    host: "127.0.0.1"
    port: 12393
    ads_directory: "ads"
    videos_directory: "videos"
    use_absolute_paths: false
    # base_directory 留空表示以当前工作目录为基准

character_config:
  # 基本信息
  conf_name: "sakura"
  conf_uid: "sakura_001"
  live2d_model_name: "sakura"   # 对应 `live2d-models/sakura/`
  character_name: "Sakura"
  human_name: "User"
  avatar: "avatars/sakura.png"   # 可为空字符串
  persona_prompt: |
    你是一个温柔的虚拟角色 Sakura，与用户自然对话。
    回答要简洁亲切，必要时使用表情与拟声词。

  # 智能体（LLM）配置
  agent_config:
    conversation_agent_choice: "basic_memory_agent"
    agent_settings:
      basic_memory_agent:
        llm_provider: "openai_compatible_llm"   # 或 "openai_llm"
        faster_first_response: false
        segment_method: "pysbd"
        use_mcpp: false
        mcp_enabled_servers: []

    llm_config:
      # 方式一：标准 OpenAI 兼容
      openai_compatible_llm:
        base_url: "https://api.openai.com/v1"   # 或兼容供应商的 Base URL
        llm_api_key: "${OPENAI_API_KEY}"       # 可用环境变量占位
        model: "gpt-4o-mini"
        organization_id: null
        project_id: null
        temperature: 0.8

      # 方式二：官方 OpenAI
      # openai_llm:
      #   base_url: "https://api.openai.com/v1"
      #   llm_api_key: "${OPENAI_API_KEY}"
      #   model: "gpt-4o"
      #   organization_id: null
      #   project_id: null
      #   temperature: 0.7

  # 语音识别（ASR）
  asr_config:
    asr_model: "openai_whisper_asr"     # 简单云端方案；或使用本地 sherpa_onnx_asr
    openai_whisper_asr:
      model: "gpt-4o-transcribe"
      base_url: null
      api_key: "${OPENAI_API_KEY}"
      language: null
      timeout: 60

    # 本地方案（示例，需自行下载模型，并正确填写文件路径）
    # asr_model: "sherpa_onnx_asr"
    # sherpa_onnx_asr:
    #   model_type: "sense_voice"
    #   sense_voice: "models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/xxxx.onnx"
    #   tokens: "models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/tokens.txt"
    #   num_threads: 4
    #   use_itn: true
    #   provider: "cpu"   # 或 "cuda"（如用 GPU）

  # 文本转语音（TTS）
  tts_config:
    tts_model: "fish_api_tts"
    fish_api_tts:
      api_key: "${FISH_API_KEY}"
      reference_id: "your_reference_id"
      latency: "balanced"   # normal/balanced
      base_url: "https://api.fish.audio"

  # 语音活动检测（VAD，可选）
  vad_config:
    vad_model: null  # 设为 "silero_vad" 可启用
    # silero_vad:
    #   orig_sr: 16000
    #   target_sr: 16000
    #   prob_threshold: 0.4
    #   db_threshold: 60
    #   required_hits: 3
    #   required_misses: 24
    #   smoothing_window: 5

  # TTS 前处理（可选）
  tts_preprocessor_config:
    remove_special_char: true
    ignore_brackets: true
    ignore_parentheses: true
    ignore_asterisks: true
    ignore_angle_brackets: true
    ignore_hyphens: true
    ignore_slashes: true
```

> 说明：
> - 上述模板中的 `${ENV}` 形式会在加载配置时被环境变量替换（留空则保持字面值）。
> - 若使用本地 ASR（sherpa-onnx），请确保模型与 `tokens` 路径正确。
> - `characters/` 下的示例 `*.yaml` 仅包含极简字段，实际运行建议集中使用根级 `conf.yaml`。

---

## 资源与目录约定

- Live2D 模型：`live2d-models/<model_name>/<model_name>.model3.json`（配套贴图等）
  - 示例：`live2d-models/sakura/sakura.model3.json`
  - 前端模型列表可参考根目录 `model_dict.json`

- 头像：`avatars/*.png|jpg|jpeg|gif|svg`

- 广告与教程视频：将文件置于 `ads/` 与 `videos/`，也可通过 API 上传管理。

- 背景图：`backgrounds/`（如需背景功能请自行创建目录并放置图片）。

---

## 前端环境变量（节选）

参考 `frontend/DEPLOYMENT.md`：
- `VITE_API_BASE_URL`：后端 API 根地址（自动匹配 ws/wss）。
- `VITE_SERVER_HOST` / `VITE_SERVER_PORT`：主机与端口的拆分配置（可选）。
- React 兼容：`REACT_APP_API_BASE_URL` 等（备选）。

开发常用：
```bash
# Web 预览时直指后端
VITE_API_BASE_URL=http://127.0.0.1:12393 npm run dev:web
```

---

## 常见问题排查

- 启动报错“Configuration file not found: conf.yaml”
  - 请在项目根目录创建 `conf.yaml`（用上述模板）。

- 前端 404 或白屏
  - 使用「方式 B/C」进行开发。若需通过后端直接开放 `/`，确保构建产物位于 `frontend/` 可被直接访问的位置（必要时复制 `out/renderer` 内容到 `frontend/` 根下）。

- CORS 报错
  - 服务器已开启全局 CORS，若仍有问题，多为跨域端口与协议不一致导致，请检查 `VITE_API_BASE_URL` 与浏览器地址栏是否同源策略合理。

- 媒体无法播放或下载
  - 确认文件放置在对应目录（`ads/`、`videos/`、`cache/`），并使用服务器提供的挂载路径访问（例如 `/ads/<name>.mp4`）。

---

## 最小可运行清单（Quick Start）

1) 准备目录（若缺失则创建）：`cache/`、`ads/`、`videos/`、`avatars/`、`live2d-models/`、`backgrounds/`（可选）。
2) 放入至少一个 Live2D 模型（如 `live2d-models/sakura/…`）。
3) 根目录新建 `conf.yaml`（用上文模板，优先用云端 ASR/TTS 以便快速跑通）。
4) 启动后端：`python run_server.py`。
5) 访问 `http://127.0.0.1:12393/web-tool/` 验证。
6) 如需桌面端，进入 `frontend/`，执行 `npm install && npm run dev`。

---

如需进一步定制（多角色配置切换、MCP 工具集成、GPU 推理等），请查看 `src/ai_chat/` 目录下对应模块与注释。



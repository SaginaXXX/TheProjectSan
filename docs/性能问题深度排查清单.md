# æ€§èƒ½é—®é¢˜æ·±åº¦æ’æŸ¥æ¸…å• - æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„å¡é¡¿åŸå› 

> **é—®é¢˜**: å¶å°”å¼€å…³ç½‘é¡µå¤šäº†è¿˜æ˜¯ä¼šå¡  
> **ç›®æ ‡**: å½»åº•æ‰¾å‡ºæ‰€æœ‰æ€§èƒ½é—®é¢˜  
> **æ–¹æ³•**: ç³»ç»Ÿæ€§å…¨é¢æ’æŸ¥

---

## ğŸ” å·²å®Œæˆçš„ä¿®å¤

### âœ… å·²ä¿®å¤çš„é—®é¢˜

1. âœ… service_context.py - åå°ä»»åŠ¡æ³„æ¼
2. âœ… ad-carousel.tsx - setTimeout æ³„æ¼
3. âœ… vad-context.tsx - Immer åªè¯»é”™è¯¯
4. âœ… store/index.ts - ç”Ÿäº§ç¯å¢ƒé…ç½®

---

## ğŸš¨ å‘ç°çš„æ½œåœ¨é—®é¢˜

### ğŸ”´ é—®é¢˜ 1: proxy_message_queue.py - Fire-and-Forget ä»»åŠ¡ï¼ˆä»æœªä¿®å¤ï¼‰

**ä½ç½®**: ç¬¬ 114 è¡Œ

```python
# âŒ ä»ç„¶å­˜åœ¨çš„é—®é¢˜
asyncio.create_task(self._forward_message(message, sender_id))
```

**å½±å“åˆ¤æ–­**ï¼š
```python
# å…³é”®é—®é¢˜ï¼šä½ ä½¿ç”¨ proxy æ¨¡å¼å—ï¼Ÿ

æ£€æŸ¥æ–¹æ³•ï¼š
cat conf.yaml | grep proxy
æˆ–
cat src/ai_chat/config_manager/*.py | grep proxy
```

**å¦‚æœä¸ç”¨ proxy**ï¼š
- ğŸŸ¢ è¿™ä¸ªé—®é¢˜ä¸å½±å“ä½ 
- ProxyHandler æ ¹æœ¬ä¸ä¼šè¢«åˆå§‹åŒ–

**å¦‚æœä½¿ç”¨ proxy**ï¼š
- ğŸ”´ è¿™æ˜¯ä¸¥é‡é—®é¢˜ï¼ˆæ¯æ¡æ¶ˆæ¯æ³„æ¼ 1 ä¸ªä»»åŠ¡ï¼‰

---

### ğŸŸ¡ é—®é¢˜ 2: Agent å†…éƒ¨çŠ¶æ€å¯èƒ½ç´¯ç§¯

**ä½ç½®**: `agent/agents/basic_memory_agent.py`

**å¯èƒ½çš„é—®é¢˜**ï¼š

```python
class BasicMemoryAgent:
    def __init__(self):
        # Agent æœ‰å†…éƒ¨å¯¹è¯å†å²
        self.memory = []  # â“ æ˜¯å¦ä¼šæ— é™å¢é•¿ï¼Ÿ
        self.context = []  # â“ æ˜¯å¦ä¼šç´¯ç§¯ï¼Ÿ
```

**æ£€æŸ¥æ–¹æ³•**ï¼š

æŸ¥çœ‹ Agent æ˜¯å¦æœ‰ `close()` æˆ– `reset()` æ–¹æ³•è¢«è°ƒç”¨ï¼š

```python
# service_context.py ç¬¬ 251 è¡Œ
if self.agent_engine and hasattr(self.agent_engine, "close"):
    await self.agent_engine.close()  # âœ… æœ‰è°ƒç”¨
```

**éœ€è¦ç¡®è®¤**ï¼š
- Agent.close() æ˜¯å¦æ¸…ç†äº†å†…éƒ¨çŠ¶æ€ï¼Ÿ
- å¯¹è¯å†å²æ˜¯å¦ä¼šæ— é™å¢é•¿ï¼Ÿ

---

### ğŸŸ¡ é—®é¢˜ 3: MCP Client å¯èƒ½æœ‰æ®‹ç•™è¿æ¥

**ä½ç½®**: `mcpp/mcp_client.py`

**è§‚å¯Ÿæ—¥å¿—**ï¼š
```
Closing MCPClient... and 4 active connections
```

**å¯èƒ½çš„é—®é¢˜**ï¼š
- MCP æœ‰ 4 ä¸ªæœåŠ¡å™¨è¿æ¥
- è¿™äº›è¿æ¥æ˜¯å¦çœŸçš„è¢«å…³é—­ï¼Ÿ
- æ˜¯å¦æœ‰æ®‹ç•™çš„ subprocess æˆ– stdio æµï¼Ÿ

**éœ€è¦æ£€æŸ¥**ï¼š
- `aclose()` æ–¹æ³•æ˜¯å¦å®Œæ•´ï¼Ÿ
- æ˜¯å¦æœ‰ subprocess æœªç»ˆæ­¢ï¼Ÿ

---

### ğŸŸ¡ é—®é¢˜ 4: TTS éŸ³é¢‘æ–‡ä»¶ç´¯ç§¯

**å¯èƒ½çš„é—®é¢˜**ï¼š

```python
# TTS ç”ŸæˆéŸ³é¢‘æ–‡ä»¶
audio_file_path = await tts_engine.async_generate_audio(...)

# æ–‡ä»¶è¢«åˆ é™¤äº†å—ï¼Ÿ
# tts_manager.py ç¬¬ 162-164 è¡Œ
finally:
    if audio_file_path:
        tts_engine.remove_file(audio_file_path)  # âœ… æœ‰æ¸…ç†
```

**ä½†**ï¼šå¦‚æœå¼‚å¸¸å‘ç”Ÿåœ¨ `finally` ä¹‹å‰ï¼Ÿ

**æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹ cache ç›®å½•å¤§å°
du -sh cache/
ls cache/ | wc -l  # æ–‡ä»¶æ•°é‡
```

å¦‚æœ cache ç›®å½•æ–‡ä»¶æ•°é‡æŒç»­å¢é•¿ â†’ æœ‰é—®é¢˜

---

### ğŸŸ¢ é—®é¢˜ 5: èŠå¤©å†å²æ•°æ®åº“å¢é•¿

**å¯èƒ½çš„é—®é¢˜**ï¼š

```python
# æ¯æ¬¡å¯¹è¯å­˜å‚¨åˆ°æ•°æ®åº“
store_message(
    conf_uid=context.character_config.conf_uid,
    history_uid=context.history_uid,
    role="ai",
    content=full_response,
    # ...
)
```

**æ£€æŸ¥**ï¼š
- å†å²æ•°æ®åº“æ–‡ä»¶åœ¨å“ªï¼Ÿ
- æ˜¯å¦ä¼šæ— é™å¢é•¿ï¼Ÿ

```bash
# æŸ¥æ‰¾æ•°æ®åº“æ–‡ä»¶
find . -name "*.db" -o -name "*.sqlite"
du -sh chat_history/
```

**å½±å“**ï¼š
- ğŸŸ¢ æ•°æ®åº“å¢é•¿æ˜¯æ­£å¸¸çš„
- ä½†å¦‚æœæ²¡æœ‰æ¸…ç†æœºåˆ¶ï¼Œå¯èƒ½ä¼šå˜æ…¢

---

### ğŸŸ¡ é—®é¢˜ 6: default_context_cache å¯èƒ½å…±äº«çŠ¶æ€

**ä½ç½®**: `routes.py` ç¬¬ 55 è¡Œ

```python
ws_handler = WebSocketHandler(default_context_cache)
```

**è§‚å¯Ÿ**ï¼š

```python
# WebSocketHandler æ˜¯æ¯ä¸ªè·¯ç”±åˆ›å»ºä¸€æ¬¡ï¼ˆå•ä¾‹ï¼‰
# ä½† default_context_cache æ˜¯å…¨å±€å…±äº«çš„

class WebSocketHandler:
    def __init__(self, default_context_cache: ServiceContext):
        self.default_context_cache = default_context_cache  # âœ… å…±äº«
        
    async def _init_service_context(self, ...):
        # æ¯ä¸ªå®¢æˆ·ç«¯å…‹éš† default_context_cache
        session_context = ServiceContext()
        await session_context.load_cache(
            config=self.default_context_cache.config.model_copy(deep=True),
            asr_engine=self.default_context_cache.asr_engine,  # â† å…±äº«å¼•ç”¨ï¼Ÿ
            tts_engine=self.default_context_cache.tts_engine,  # â† å…±äº«å¼•ç”¨ï¼Ÿ
            # ...
        )
```

**æ½œåœ¨é—®é¢˜**ï¼š
- ASR/TTS å¼•æ“æ˜¯å…±äº«çš„ï¼ˆä¸æ˜¯æ·±æ‹·è´ï¼‰
- å¦‚æœå¼•æ“å†…éƒ¨æœ‰çŠ¶æ€ç´¯ç§¯...
- å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™

---

### ğŸŸ¢ é—®é¢˜ 7: å‰ç«¯ WebSocket é‡è¿å¾ªç¯

**å‰ç«¯æ—¥å¿—è§‚å¯Ÿ**ï¼š

ä½ ä¹‹å‰æåˆ°çœ‹åˆ°å¾ˆå¤šé‡è¿æ—¥å¿—ï¼Œå¯èƒ½æ˜¯ï¼š

```javascript
ğŸ”„ WS schedule reconnect in 2000ms
ğŸŒ WS connecting...
WebSocket connection failed
ğŸš¨ WebSocketè¿æ¥é”™è¯¯
ğŸ”„ å°è¯•æ¢å¤ websocket
```

**å¯èƒ½åŸå› **ï¼š
- å‰ç«¯ä¸€ç›´å°è¯•é‡è¿
- åç«¯å·²å…³é—­ä½†å‰ç«¯ä¸çŸ¥é“
- é‡è¿å¾ªç¯æ¶ˆè€—èµ„æº

---

## ğŸ“‹ å®Œæ•´æ’æŸ¥è®¡åˆ’

### ç¬¬ 1 æ­¥ï¼šç¡®è®¤æ˜¯å¦ä½¿ç”¨ proxy æ¨¡å¼

```bash
grep -r "enable_proxy" conf.yaml
grep -r "enable_proxy" characters/
```

**å¦‚æœæ˜¯ true**ï¼š
- ğŸ”´ å¿…é¡»ä¿®å¤ proxy_message_queue
- è¿™å¯èƒ½æ˜¯ä¸»è¦é—®é¢˜

**å¦‚æœæ˜¯ false**ï¼š
- ğŸŸ¢ æ’é™¤è¿™ä¸ªé—®é¢˜

---

### ç¬¬ 2 æ­¥ï¼šæ£€æŸ¥ cache ç›®å½•

```bash
# Windows PowerShell
Get-ChildItem -Path cache\ | Measure-Object | Select-Object Count
Get-ChildItem -Path cache\ | Measure-Object -Property Length -Sum

# åº”è¯¥çœ‹åˆ°ï¼š
# Count: <100 ä¸ªæ–‡ä»¶ï¼ˆæ­£å¸¸ï¼‰
# Sum: <500MBï¼ˆæ­£å¸¸ï¼‰

# å¦‚æœï¼š
# Count: 1000+ ä¸ªæ–‡ä»¶ â†’ æ–‡ä»¶æœªåˆ é™¤ ğŸ”´
# Sum: 5GB+ â†’ ä¸¥é‡æ³„æ¼ ğŸ”´
```

---

### ç¬¬ 3 æ­¥ï¼šæ£€æŸ¥èŠå¤©å†å²å¤§å°

```bash
Get-ChildItem -Path chat_history\ -Recurse | Measure-Object -Property Length -Sum
```

**å¦‚æœå¾ˆå¤§**ï¼ˆ>1GBï¼‰ï¼š
- å¯èƒ½éœ€è¦å®šæœŸæ¸…ç†
- æˆ–æ·»åŠ è‡ªåŠ¨å½’æ¡£

---

### ç¬¬ 4 æ­¥ï¼šæ·»åŠ è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æ—¥å¿—

åœ¨ `websocket_handler.py` çš„ `handle_disconnect` æ·»åŠ ï¼š

```python
async def handle_disconnect(self, client_uid: str):
    # ... ç°æœ‰æ¸…ç†é€»è¾‘
    
    # âœ… æ·»åŠ è¯¦ç»†ç›‘æ§
    logger.info(f"ğŸ“Š æ€§èƒ½ç»Ÿè®¡:")
    logger.info(f"  - æ´»è·ƒè¿æ¥æ•°: {len(self.client_connections)}")
    logger.info(f"  - æ´»è·ƒå¯¹è¯ä»»åŠ¡: {len([t for t in self.current_conversation_tasks.values() if t and not t.done()])}")
    logger.info(f"  - éŸ³é¢‘ç¼“å†²åŒº: {len(self.received_data_buffers)}")
    
    # âœ… æ£€æŸ¥ asyncio ä»»åŠ¡æ•°
    import asyncio
    all_tasks = asyncio.all_tasks()
    active_tasks = [t for t in all_tasks if not t.done()]
    logger.info(f"  - å…¨å±€ asyncio ä»»åŠ¡æ•°: {len(active_tasks)}")
    if len(active_tasks) > 20:
        logger.warning(f"  âš ï¸ ä»»åŠ¡æ•°é‡å¼‚å¸¸: {len(active_tasks)}")
        for task in active_tasks[:5]:
            logger.warning(f"    - {task.get_name()}: {task}")
```

---

### ç¬¬ 5 æ­¥ï¼šç›‘æ§å†…å­˜å¢é•¿

```python
# åœ¨ server.py æ·»åŠ å®šæœŸå†…å­˜ç›‘æ§
import psutil
import os

async def monitor_memory():
    while True:
        await asyncio.sleep(60)  # æ¯åˆ†é’Ÿ
        process = psutil.Process(os.getpid())
        mem_mb = process.memory_info().rss / 1024 / 1024
        logger.info(f"ğŸ“Š å†…å­˜ä½¿ç”¨: {mem_mb:.2f} MB")
        
        # æ£€æŸ¥ä»»åŠ¡æ•°
        tasks = [t for t in asyncio.all_tasks() if not t.done()]
        logger.info(f"ğŸ“Š æ´»è·ƒä»»åŠ¡æ•°: {len(tasks)}")

# å¯åŠ¨ç›‘æ§
asyncio.create_task(monitor_memory())
```

---

## ğŸ¯ ç«‹å³å¯ä»¥åšçš„æ£€æŸ¥

### æ£€æŸ¥ 1: ç¡®è®¤ proxy æ¨¡å¼

```powershell
Select-String -Path "conf.yaml" -Pattern "proxy"
```

### æ£€æŸ¥ 2: æŸ¥çœ‹ cache ç›®å½•

```powershell
Get-ChildItem -Path cache\ | Measure-Object
```

### æ£€æŸ¥ 3: æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„ä»»åŠ¡æ•°

æ‰“å¼€ç½‘é¡µå‡ æ¬¡åï¼Œåœ¨åç«¯æ·»åŠ ä¸´æ—¶æ—¥å¿—ï¼š

```python
# åœ¨ Python REPL æˆ–æ·»åŠ åˆ°ä»£ç 
import asyncio
tasks = asyncio.all_tasks()
print(f"å½“å‰ä»»åŠ¡æ•°: {len(tasks)}")
for t in tasks:
    print(f"  - {t.get_name()}")
```

---

## ğŸ”¬ å¯èƒ½çš„å…¶ä»–åŸå› 

### åŸå›  A: LLM API é™æµ

å¦‚æœä½ ç”¨çš„æ˜¯å¤–éƒ¨ LLM APIï¼ˆå¦‚ OpenAIï¼‰ï¼š
- API æœ‰é€Ÿç‡é™åˆ¶
- å¤šæ¬¡è°ƒç”¨å¯èƒ½è¢«é™æµ
- å¯¼è‡´å“åº”å˜æ…¢

### åŸå›  B: ç³»ç»Ÿèµ„æºä¸è¶³

```
CPU: 19ï¼ˆç´¯ç§¯å€¼ï¼Œä¸æ˜¯å®æ—¶å ç”¨ç‡ï¼‰
å†…å­˜: 2.1GB

# éœ€è¦æ£€æŸ¥å®æ—¶å€¼
```

### åŸå›  C: ç½‘ç»œå»¶è¿Ÿ

å¦‚æœåç«¯å’Œå‰ç«¯ä¸åœ¨åŒä¸€å°æœºå™¨ï¼š
- ç½‘ç»œå»¶è¿Ÿç´¯ç§¯
- WebSocket è¿æ¥è´¨é‡ä¸‹é™

---

## ğŸš€ å»ºè®®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿï¼‰

1. **æ£€æŸ¥æ˜¯å¦ç”¨ proxy**
   ```powershell
   Select-String -Path "conf.yaml" -Pattern "proxy"
   ```

2. **æ£€æŸ¥ cache ç›®å½•**
   ```powershell
   Get-ChildItem -Path cache\ | Measure-Object
   ```

3. **æ·»åŠ ä»»åŠ¡ç›‘æ§**
   åœ¨åç«¯ä»£ç æ·»åŠ ä»»åŠ¡è®¡æ•°æ—¥å¿—

### æ ¹æ®ç»“æœå†³å®š

- å¦‚æœç”¨ proxy â†’ ä¿®å¤ proxy_message_queue
- å¦‚æœ cache å¾ˆå¤§ â†’ æ·»åŠ æ¸…ç†é€»è¾‘
- å¦‚æœä»»åŠ¡æ•°å¾ˆå¤š â†’ æ‰¾å‡ºæœªæ¸…ç†çš„ä»»åŠ¡

---

**å‘Šè¯‰æˆ‘è¿™äº›æ£€æŸ¥çš„ç»“æœï¼Œæˆ‘ä¼šç»™ä½ ç²¾ç¡®çš„ä¿®å¤æ–¹æ¡ˆï¼**


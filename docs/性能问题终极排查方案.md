# 性能问题终极排查方案 - 找出真正的卡顿原因

> **问题**: 偶尔开关网页多了会卡  
> **状态**: 已修复部分问题，仍需深入排查  
> **目标**: 找出所有性能瓶颈

---

## 🎯 当前状态分析

### 你的后端日志显示

```
✅ 所有后台任务已清理
✅ 客户端资源清理完成
📊 所有客户端已断开，检查是否有残留资源...
（无 warning）← 说明资源清理正常
```

**判断**: ✅ **我们的修复是有效的**

但你说**偶尔还会卡**，可能的原因：

---

## 🔍 可能的原因分析

### 原因 1: proxy_message_queue 任务泄漏（如果用 proxy）🔴

**检查方法**: 查看配置文件中是否启用了 proxy

```bash
# 检查你的配置
cat conf.yaml
# 或
cat characters/*.yaml
```

**关键字**: 查找 `enable_proxy` 或 `proxy`

**如果找到 `enable_proxy: true`**:
- 🔴 这是问题！proxy_message_queue.py 第 114 行仍在泄漏任务
- 需要修复

**如果没有或 `enable_proxy: false`**:
- 🟢 排除这个原因

---

### 原因 2: Agent/LLM 本身性能问题 🟡

**可能的情况**：

```python
# 你使用的是什么 LLM？
# 1. 本地模型（Ollama, LM Studio）
#    └─ 多次调用后模型可能需要重新加载
#    └─ 模型缓存可能满了
#
# 2. API 服务（OpenAI, Claude）
#    └─ API 限流
#    └─ 网络延迟累积
#
# 3. LangChain Agent
#    └─ 内部状态累积
#    └─ Tool 调用历史增长
```

**检查方法**：

观察后端日志，看 AI 生成时间：

```
Conversation total elapsed: X.XXXs
                            ^^^^^^
                            这个时间是多少？

第 1 次: 2.5 秒 ✅
第 5 次: 10 秒 🔴 ← 如果这样，问题在 Agent
```

---

### 原因 3: 文件未清理（cache 目录）🟡

**检查**：

```powershell
# 查看 cache 目录
cd cache
Get-ChildItem | Measure-Object
```

**正常情况**：
- 文件数: <50 个
- 总大小: <200MB

**有问题**：
- 文件数: 500+ 个 🔴
- 总大小: 2GB+ 🔴

**修复**：
```powershell
# 清空 cache
Remove-Item cache\* -Force
```

---

### 原因 4: 前端重连循环 🟡

**症状**：

```javascript
// 前端控制台疯狂输出
🔄 WS schedule reconnect
🌐 WS connecting...
❌ Connection failed
🔄 WS schedule reconnect
// 循环往复
```

**影响**：
- 前端 CPU 占用高
- 页面响应变慢
- 感觉"卡"

**修复**：
- 已在 store/index.ts 中修复环境检测
- 如果仍有问题，可能是网络配置

---

### 原因 5: 浏览器标签页累积 🟢

**可能的情况**：

```
你可能打开了多个标签页:
├─ 标签页 1: 关闭了但 ServiceWorker 还在
├─ 标签页 2: 后台运行
└─ 标签页 3: 当前活跃

每个标签页都可能有：
├─ WebSocket 连接
├─ VAD 实例
└─ 音频队列
```

**检查**：
- 关闭所有标签页
- 只打开 1 个测试

---

## 🚀 立即诊断方法

### 方法 1: 添加详细监控日志

在后端 `websocket_handler.py` 的 `handle_disconnect` 方法最后添加：

```python
async def handle_disconnect(self, client_uid: str):
    # ... 现有清理逻辑
    
    # ✅ 添加详细监控（临时调试）
    import asyncio
    all_tasks = asyncio.all_tasks()
    active_tasks = [t for t in all_tasks if not t.done()]
    
    logger.info(f"📊 全局任务统计:")
    logger.info(f"  - 总任务数: {len(all_tasks)}")
    logger.info(f"  - 活跃任务数: {len(active_tasks)}")
    logger.info(f"  - 已完成任务数: {len(all_tasks) - len(active_tasks)}")
    
    if len(active_tasks) > 20:
        logger.warning(f"⚠️  活跃任务数异常: {len(active_tasks)}")
        logger.warning("前 5 个任务:")
        for task in active_tasks[:5]:
            logger.warning(f"  - {task.get_name()}")
```

**测试**：
- 打开关闭网页 5 次
- 观察任务数是否增长
- 如果增长 → 有任务泄漏

---

### 方法 2: 记录每次对话的耗时

观察后端日志中的：

```
Conversation total elapsed: X.XXXs
```

**记录**：
```
第 1 次: ___ 秒
第 2 次: ___ 秒
第 3 次: ___ 秒
第 5 次: ___ 秒

如果持续增长 → Agent 性能问题
如果稳定 → 不是 Agent 的问题
```

---

### 方法 3: 使用 Python 内存分析

```python
# 在后端代码中临时添加
import tracemalloc
tracemalloc.start()

# 每次连接后
snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')

print("[ Top 10 内存占用 ]")
for stat in top_stats[:10]:
    print(stat)
```

---

## 🎯 根据症状判断

### 症状 A: "偶尔卡" - 不是每次都卡

**可能原因**：
1. 🟡 文件系统缓存满了（cache 目录）
2. 🟡 某些操作触发了 GC（垃圾回收）
3. 🟡 网络波动
4. 🟡 系统资源临时不足

**不太可能**：
- ❌ 任务泄漏（应该是逐渐变慢）
- ❌ 内存泄漏（应该是持续变慢）

---

### 症状 B: "多了会卡" - 累积效应

**可能原因**：
1. 🔴 任务累积（但我们已修复 service_context）
2. 🟡 文件累积（cache 目录）
3. 🟡 数据库增长（chat_history）
4. 🟡 浏览器缓存/标签页

---

## 📋 诊断清单

请帮我确认以下信息：

### 1. 配置确认

- [ ] 查看 `conf.yaml`，`enable_proxy` 是 true 还是 false？
- [ ] 使用的是什么 LLM（OpenAI API / 本地模型）？
- [ ] 历史记录是否启用？

### 2. 文件检查

```powershell
# cache 目录
Get-ChildItem cache\ | Measure-Object

# chat_history 目录  
Get-ChildItem chat_history\ -Recurse | Measure-Object -Property Length -Sum
```

### 3. 卡顿时机确认

- [ ] 是打开网页时卡？
- [ ] 是 AI 回复时卡？
- [ ] 是切换角色时卡？
- [ ] 是随机卡顿？

### 4. 卡顿程度

- [ ] 轻微延迟（2-3秒）
- [ ] 明显卡顿（5-10秒）
- [ ] 严重卡顿（30+秒）

---

## 🔧 可能的额外修复

根据你提供的信息，我会给出精确的修复方案：

### 如果是 proxy 问题 → 修复 proxy_message_queue
### 如果是文件累积 → 添加自动清理
### 如果是 Agent 问题 → 优化 Agent 配置
### 如果是网络问题 → 优化重连逻辑

---

**请告诉我**：

1. `conf.yaml` 中 `enable_proxy` 的值
2. cache 目录有多少文件
3. 卡顿具体发生在什么时候
4. 每次对话的 "Conversation total elapsed" 时间

有了这些信息，我可以给你精确的修复方案！


# åç«¯æ€§èƒ½é—®é¢˜ - æœ€ç»ˆåˆ¤æ–­ä¸ä¿®å¤æ–¹æ¡ˆ

> **é—®é¢˜**: å¤šæ¬¡æ‰“å¼€å…³é—­ç½‘é¡µåå›å¤å˜æ…¢  
> **åˆ¤æ–­**: å·²ç†è§£å…¨éƒ¨ä»£ç æ¶æ„  
> **ç»“è®º**: âœ… **åº”è¯¥ä¿®å¤ï¼Œä½†é€‰æ‹©æ­£ç¡®çš„æ–¹æ¡ˆ**

---

## ğŸ“Š é¡¹ç›®æ¶æ„ç†è§£ï¼ˆå®Œæ•´ï¼‰

### ä»»åŠ¡ç®¡ç†æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket Handler (ä¸»è¦æ¨¡å¼)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿æ¥ç®¡ç†:                                                    â”‚
â”‚  â”œâ”€ client_connections[client_uid] = websocket               â”‚
â”‚  â”œâ”€ client_contexts[client_uid] = ServiceContext            â”‚
â”‚  â””â”€ current_conversation_tasks[client_uid] = task  âœ… è¿½è¸ª   â”‚
â”‚                                                              â”‚
â”‚  æ–­å¼€æ¸…ç†:                                                    â”‚
â”‚  â”œâ”€ 1. å–æ¶ˆ conversation task  âœ…                            â”‚
â”‚  â”œâ”€ 2. è°ƒç”¨ context.close()  âœ…                              â”‚
â”‚  â”œâ”€ 3. æ¸…ç†æ‰€æœ‰å­—å…¸  âœ…                                       â”‚
â”‚  â””â”€ 4. æ¸…ç†å¤–éƒ¨ç®¡ç†å™¨  âœ…                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Conversation Handler                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹è¯ä»»åŠ¡:                                                    â”‚
â”‚  â”œâ”€ task = asyncio.create_task(_run_single_turn())          â”‚
â”‚  â”œâ”€ current_conversation_tasks[client_uid] = task  âœ… è¿½è¸ª   â”‚
â”‚  â””â”€ æ—§ä»»åŠ¡ä¼šè¢«è‡ªåŠ¨å–æ¶ˆ  âœ…                                    â”‚
â”‚                                                              â”‚
â”‚  TTS ä»»åŠ¡:                                                    â”‚
â”‚  â”œâ”€ tts_manager.task_list.append(task)  âœ… è¿½è¸ª             â”‚
â”‚  â””â”€ await asyncio.gather(*task_list)  âœ… ç­‰å¾…å®Œæˆ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»»åŠ¡ç®¡ç†è¯„åˆ†

| ç»„ä»¶ | ä»»åŠ¡è¿½è¸ª | ä»»åŠ¡ç­‰å¾… | ä»»åŠ¡å–æ¶ˆ | è¯„åˆ† |
|------|----------|----------|----------|------|
| conversation_tasks | âœ… è¿½è¸ª | âœ… ç­‰å¾… | âœ… å–æ¶ˆ | ğŸŸ¢ 100% |
| TTS tasks | âœ… è¿½è¸ª | âœ… gather | âœ… clear | ğŸŸ¢ 100% |
| ServiceContext.close() | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | ğŸŸ¢ 100% |
| **proxy forward tasks** | âŒ æ—  | âŒ æ—  | âŒ æ—  | ğŸ”´ 0% |
| **service_context init** | âŒ æ—  | âŒ æ—  | âŒ æ—  | ğŸ”´ 0% |

---

## ğŸ” é—®é¢˜å®šä½ï¼ˆç²¾ç¡®ï¼‰

### é—®é¢˜ 1: proxy_message_queue.py ğŸŸ¡

**ä»£ç ä½ç½®**: ç¬¬ 114 è¡Œ

```python
asyncio.create_task(self._forward_message(message, sender_id))
```

**å½±å“èŒƒå›´åˆ†æ**ï¼š

```python
# è¿™ä¸ªé—®é¢˜åªåœ¨ PROXY æ¨¡å¼ä¸‹å­˜åœ¨

# æ£€æŸ¥ï¼šæ˜¯å¦å¯ç”¨ proxyï¼Ÿ
# server.py ç¬¬ 129-136 è¡Œ
if hasattr(system_config, "enable_proxy") and system_config.enable_proxy:
    # åªæœ‰å¯ç”¨ proxy æ‰ä¼šåŒ…å«è¿™ä¸ªè·¯ç”±
    self.app.include_router(init_proxy_route(...))
```

**åˆ¤æ–­**ï¼š
- â“ ä½ çš„é¡¹ç›®å¯ç”¨äº† proxy æ¨¡å¼å—ï¼Ÿ
- â“ å¦‚æœæ²¡æœ‰ï¼Œè¿™ä¸ªé—®é¢˜**ä¸å½±å“ä½ **
- å¦‚æœæœ‰ï¼Œè¿™æ˜¯ ğŸ”´ ä¸¥é‡é—®é¢˜

**æ£€æŸ¥æ–¹æ³•**ï¼š
```yaml
# æŸ¥çœ‹ conf.yaml æˆ–é…ç½®æ–‡ä»¶
system_config:
  enable_proxy: true/false  # â† è¿™ä¸ªå€¼æ˜¯ä»€ä¹ˆï¼Ÿ
```

---

### é—®é¢˜ 2: service_context.py ğŸ”´

**ä»£ç ä½ç½®**: ç¬¬ 585 è¡Œ

```python
async def handle_config_switch(self, websocket, config_file_name):
    # ...
    async def _finish_heavy_init():
        # åˆå§‹åŒ– Agentï¼ˆè€—æ—¶ 3-5 ç§’ï¼‰
        await self.init_agent(...)
    
    asyncio.create_task(_finish_heavy_init())  # âŒ æœªè¿½è¸ª
```

**å½±å“èŒƒå›´åˆ†æ**ï¼š

```python
# è§¦å‘åœºæ™¯ï¼šç”¨æˆ·åˆ‡æ¢è§’è‰²
# å‰ç«¯ï¼šé€‰æ‹©æ–°è§’è‰² â†’ å‘é€ switch-config æ¶ˆæ¯
# åç«¯ï¼šhandle_config_switch â†’ åˆ›å»ºåå°åˆå§‹åŒ–ä»»åŠ¡

# é—®é¢˜ï¼š
# åœºæ™¯ 1: æ­£å¸¸ä½¿ç”¨
#   â””â”€ åˆ‡æ¢è§’è‰² 1-2 æ¬¡/å¤© â†’ å½±å“å¾ˆå° ğŸŸ¢
#
# åœºæ™¯ 2: é¢‘ç¹åˆ‡æ¢
#   â””â”€ åˆ‡æ¢è§’è‰² 10+ æ¬¡ â†’ æ³„æ¼ 500MB+ å†…å­˜ ğŸ”´
#
# åœºæ™¯ 3: ä»»åŠ¡æœªå®Œæˆå°±æ–­å¼€
#   â””â”€ åˆ‡æ¢è§’è‰²å 1 ç§’å†…å…³é—­ç½‘é¡µ
#   â””â”€ åˆå§‹åŒ–ä»»åŠ¡ä»åœ¨è¿è¡Œï¼ˆ5 ç§’ï¼‰
#   â””â”€ ServiceContext æ— æ³•è¢« GC å›æ”¶ ğŸ”´
```

**åˆ¤æ–­**ï¼š
- âœ… è¿™ä¸ª**ç¡®å®æ˜¯é—®é¢˜**
- âœ… å³ä½¿ä¸é¢‘ç¹åˆ‡æ¢è§’è‰²ï¼Œä¹Ÿå¯èƒ½æ³„æ¼
- åŸå› ï¼šä»»åŠ¡å¼•ç”¨äº† ServiceContextï¼Œé˜»æ­¢ GC

---

## ğŸ¯ çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆåˆ†æ

### è®©æˆ‘é‡æ–°å®¡è§†ä½ çš„é—®é¢˜

ä½ è¯´ï¼š**"å¤šæ¬¡å…³é—­æ‰“å¼€ç½‘é¡µï¼Œåç«¯å­˜åœ¨å°±ä¼šå˜å¡ï¼Œå›å¤å°±ä¼šç­‰å¾ˆé•¿æ—¶é—´"**

è¿™ä¸ªç—‡çŠ¶æ›´åƒæ˜¯ï¼š

#### å¯èƒ½åŸå›  A: ServiceContext æœªè¢«é‡Šæ”¾ ğŸ”´

```python
# æ¯æ¬¡è¿æ¥åˆ›å»ºæ–°çš„ ServiceContext
session_context = await self._init_service_context(...)

# æ¯ä¸ª ServiceContext åŒ…å«ï¼š
â”œâ”€ Agent Engineï¼ˆLLMï¼Œå¯èƒ½ 500MB-2GB å†…å­˜ï¼‰
â”œâ”€ MCP Clientï¼ˆå¤šä¸ªè¿æ¥ï¼‰
â”œâ”€ TTS Engine
â”œâ”€ ASR Engine
â””â”€ å…¶ä»–ç»„ä»¶

# å¦‚æœ ServiceContext å› ä¸ºåå°ä»»åŠ¡æœªé‡Šæ”¾ï¼š
ç¬¬ 1 æ¬¡: 1 ä¸ª ServiceContext (2GB)
ç¬¬ 3 æ¬¡: 3 ä¸ª ServiceContext (6GB)  â† å¼€å§‹å¡
ç¬¬ 5 æ¬¡: 5 ä¸ª ServiceContext (10GB) â† ä¸¥é‡å¡é¡¿
```

**è¿™æ‰æ˜¯çœŸæ­£çš„é—®é¢˜ï¼**

#### å¯èƒ½åŸå›  B: Agent Engine çŠ¶æ€ç´¯ç§¯

æŸ¥çœ‹ä»£ç ï¼Œæ¯æ¬¡å¯¹è¯éƒ½è°ƒç”¨ agent_engine...

---

## âœ… ä¿®å¤æ–¹æ¡ˆåˆ¤æ–­

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¿®å¤ç‚¹ | æ•ˆæœ | éš¾åº¦ | æ¨èåº¦ |
|------|--------|------|------|--------|
| **A. ä¿®å¤ service_context** | è¿½è¸ªå¹¶å–æ¶ˆåå°ä»»åŠ¡ | ğŸŸ¢ é«˜ | ğŸŸ¢ ç®€å• | â­â­â­â­â­ |
| **B. ä¿®å¤ proxy_message_queue** | è¿½è¸ª forward ä»»åŠ¡ | ğŸŸ¡ ä¸­ï¼ˆå¦‚æœç”¨ proxyï¼‰ | ğŸŸ¡ ä¸­ç­‰ | â­â­â­ |
| **C. ä¸¤ä¸ªéƒ½ä¿®å¤** | å…¨éƒ¨ä¿®å¤ | ğŸŸ¢ æœ€é«˜ | ğŸŸ¡ ä¸­ç­‰ | â­â­â­â­ |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### ç«‹å³ä¿®å¤ï¼šservice_context.py ğŸ”´

**è¿™æ˜¯æœ€é‡è¦çš„ï¼**

```python
class ServiceContext:
    def __init__(self):
        # ...
        self._background_tasks: list[asyncio.Task] = []  # âœ… è¿½è¸ªä»»åŠ¡
    
    async def handle_config_switch(self, websocket, config_file_name):
        # ...
        # âœ… å…ˆå–æ¶ˆæ—§çš„åˆå§‹åŒ–ä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
        for task in self._background_tasks:
            if not task.done():
                logger.info("â¹ï¸  å–æ¶ˆæ—§çš„åˆå§‹åŒ–ä»»åŠ¡")
                task.cancel()
                try:
                    await task
                except asyncio.CancelledError:
                    pass
        self._background_tasks.clear()
        
        # âœ… åˆ›å»ºæ–°ä»»åŠ¡å¹¶è¿½è¸ª
        task = asyncio.create_task(_finish_heavy_init())
        self._background_tasks.append(task)
        logger.info("ğŸ”§ å¯åŠ¨åå°åˆå§‹åŒ–ä»»åŠ¡")
    
    async def close(self):
        logger.info("Closing ServiceContext resources...")
        
        # âœ… å–æ¶ˆæ‰€æœ‰åå°ä»»åŠ¡
        for task in self._background_tasks:
            if not task.done():
                logger.info(f"  â¹ï¸  å–æ¶ˆåå°ä»»åŠ¡")
                task.cancel()
                try:
                    await task
                except asyncio.CancelledError:
                    pass
        self._background_tasks.clear()
        logger.info("  âœ… æ‰€æœ‰åå°ä»»åŠ¡å·²æ¸…ç†")
        
        # MCP Client
        if self.mcp_client:
            await self.mcp_client.aclose()
        
        # Agent
        if self.agent_engine and hasattr(self.agent_engine, "close"):
            await self.agent_engine.close()
        
        logger.info("ServiceContext closed.")
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… é˜²æ­¢ ServiceContext å†…å­˜æ³„æ¼
- âœ… åˆ‡æ¢è§’è‰²æ—¶å–æ¶ˆæ—§ä»»åŠ¡
- âœ… æ–­å¼€è¿æ¥æ—¶å½»åº•æ¸…ç†

---

### å¯é€‰ä¿®å¤ï¼šproxy_message_queue.py ğŸŸ¡

**åªåœ¨ä½¿ç”¨ proxy æ¨¡å¼æ—¶éœ€è¦ï¼**

å…ˆç¡®è®¤ï¼šä½ ç”¨äº† proxy æ¨¡å¼å—ï¼Ÿ

```bash
# æ£€æŸ¥é…ç½®
grep -r "enable_proxy" conf.yaml
```

**å¦‚æœä¸ç”¨ proxy**ï¼š
- ğŸŸ¢ ä¸éœ€è¦ä¿®å¤è¿™ä¸ª
- proxy_message_queue æ ¹æœ¬ä¸ä¼šè¢«ä½¿ç”¨

**å¦‚æœä½¿ç”¨ proxy**ï¼š
- ğŸ”´ å¿…é¡»ä¿®å¤

---

## ğŸ“‹ ä¿®å¤å†³ç­–æ ‘

```
ä½ çš„é—®é¢˜ï¼šå¤šæ¬¡è¿æ¥åå˜å¡
â”œâ”€ æ£€æŸ¥ 1: ä½¿ç”¨ proxy æ¨¡å¼å—ï¼Ÿ
â”‚   â”œâ”€ æ˜¯ â†’ ä¿®å¤ proxy_message_queue + service_context
â”‚   â””â”€ å¦ â†’ åªä¿®å¤ service_context
â”‚
â”œâ”€ æ£€æŸ¥ 2: é¢‘ç¹åˆ‡æ¢è§’è‰²å—ï¼Ÿ
â”‚   â”œâ”€ æ˜¯ â†’ service_context ä¿®å¤ä¼˜å…ˆçº§ P0
â”‚   â””â”€ å¦ â†’ service_context ä¿®å¤ä¼˜å…ˆçº§ P1
â”‚
â””â”€ æ£€æŸ¥ 3: æœ‰å…¶ä»–æ€§èƒ½é—®é¢˜å—ï¼Ÿ
    â”œâ”€ Agent åŠ è½½æ…¢ â†’ ä¼˜åŒ– Agent åˆå§‹åŒ–
    â”œâ”€ MCP è¿æ¥å¤š â†’ ä¼˜åŒ– MCP ç®¡ç†
    â””â”€ å†…å­˜å ç”¨é«˜ â†’ æ£€æŸ¥å…¶ä»–æ³„æ¼ç‚¹
```

---

## ğŸ¯ æˆ‘çš„æœ€ç»ˆåˆ¤æ–­

### åˆ¤æ–­ 1: service_context.py **å¿…é¡»ä¿®å¤** âœ…

**ç†ç”±**ï¼š
1. âœ… é—®é¢˜æ˜ç¡®å­˜åœ¨ï¼ˆæœªè¿½è¸ªçš„åå°ä»»åŠ¡ï¼‰
2. âœ… å½±å“ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼ˆåˆ‡æ¢è§’è‰²ï¼‰
3. âœ… å¯èƒ½å¯¼è‡´ ServiceContext æ— æ³•é‡Šæ”¾ï¼ˆä¸¥é‡ï¼ï¼‰
4. âœ… ä¿®å¤ç®€å•ï¼Œé£é™©ä½
5. âœ… æ”¶ç›Šæ˜æ˜¾

**ä¿®å¤æ”¶ç›Š**ï¼š
- é˜²æ­¢å†…å­˜æ³„æ¼ï¼ˆå¯èƒ½ 500MB-2GBï¼‰
- é˜²æ­¢ Agent/MCP èµ„æºç´¯ç§¯
- æ”¹å–„å¤šæ¬¡è¿æ¥åçš„æ€§èƒ½

---

### åˆ¤æ–­ 2: proxy_message_queue.py **è§†æƒ…å†µä¿®å¤** ğŸŸ¡

**å…ˆç¡®è®¤**: ä½ çš„é¡¹ç›®å¯ç”¨äº† proxy æ¨¡å¼å—ï¼Ÿ

```bash
# æŸ¥çœ‹é…ç½®
cat conf.yaml | grep proxy
```

**å¦‚æœ enable_proxy: false**:
- ğŸŸ¢ ä¸éœ€è¦ä¿®å¤
- ProxyHandler æ ¹æœ¬ä¸ä¼šè¢«ä½¿ç”¨
- è¿™ä¸ªé—®é¢˜ä¸å½±å“ä½ 

**å¦‚æœ enable_proxy: true**:
- ğŸ”´ å¿…é¡»ä¿®å¤
- ä½†ä¿®å¤æ–¹æ¡ˆè¦é€‰å¯¹

---

## ğŸš€ æ¨èçš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šåªä¿®å¤ service_context.pyï¼ˆæ¨èï¼‰

**ä¿®æ”¹ 2 ä¸ªä½ç½®**ï¼š

#### ä½ç½® 1: __init__ æ–¹æ³•ï¼ˆæ·»åŠ ä»»åŠ¡è¿½è¸ªï¼‰

```python
def __init__(self):
    # ... ç°æœ‰ä»£ç 
    self._background_tasks: list[asyncio.Task] = []  # âœ… æ–°å¢
```

#### ä½ç½® 2: handle_config_switch æ–¹æ³•ï¼ˆè¿½è¸ªä»»åŠ¡ï¼‰

```python
# ç¬¬ 585 è¡Œé™„è¿‘
# âŒ Before
asyncio.create_task(_finish_heavy_init())

# âœ… After
# å–æ¶ˆæ—§ä»»åŠ¡
for task in self._background_tasks:
    if not task.done():
        task.cancel()
        try:
            await task
        except asyncio.CancelledError:
            pass
self._background_tasks.clear()

# åˆ›å»ºæ–°ä»»åŠ¡å¹¶è¿½è¸ª
task = asyncio.create_task(_finish_heavy_init())
self._background_tasks.append(task)
```

#### ä½ç½® 3: close() æ–¹æ³•ï¼ˆæ¸…ç†ä»»åŠ¡ï¼‰

```python
async def close(self):
    logger.info("Closing ServiceContext resources...")
    
    # âœ… æ–°å¢ï¼šå–æ¶ˆæ‰€æœ‰åå°ä»»åŠ¡
    for task in self._background_tasks:
        if not task.done():
            logger.info("  â¹ï¸  å–æ¶ˆåå°ä»»åŠ¡")
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
    self._background_tasks.clear()
    
    # ... ç°æœ‰çš„æ¸…ç†é€»è¾‘ï¼ˆMCP, Agentï¼‰
```

**ä¿®æ”¹è¡Œæ•°**: ~15 è¡Œ  
**é£é™©**: ğŸŸ¢ ä½  
**æ”¶ç›Š**: ğŸŸ¢ é«˜  

---

## â“ è¿˜æœ‰å…¶ä»–å¯èƒ½çš„åŸå› å—ï¼Ÿ

### è®©æˆ‘æ£€æŸ¥å…¶ä»–æ½œåœ¨é—®é¢˜

#### 1. MCP Client è¿æ¥ç´¯ç§¯ï¼Ÿ

```python
# service_context.py ä¸­
if self.mcp_client:
    await self.mcp_client.aclose()  # âœ… æœ‰æ¸…ç†
```

**åˆ¤æ–­**: âœ… è¿™ä¸ªåº”è¯¥æ²¡é—®é¢˜

#### 2. Agent Engine çŠ¶æ€ç´¯ç§¯ï¼Ÿ

```python
if self.agent_engine and hasattr(self.agent_engine, "close"):
    await self.agent_engine.close()  # âœ… æœ‰æ¸…ç†
```

**åˆ¤æ–­**: âœ… è¿™ä¸ªä¹Ÿæœ‰æ¸…ç†

#### 3. å…¨å±€å•ä¾‹ç»„ä»¶ï¼Ÿ

```python
# message_handler, wake_word_manager æ˜¯å…¨å±€å•ä¾‹
# ä½†æœ‰ cleanup_client æ–¹æ³• âœ…
message_handler.cleanup_client(client_uid)
wake_word_manager.cleanup_client(client_uid)
```

**åˆ¤æ–­**: âœ… è¿™äº›ä¹Ÿæœ‰æ¸…ç†

---

## ğŸ¯ æœ€ç»ˆç»“è®º

### âœ… åº”è¯¥ä¿®å¤ï¼Œä¿®å¤æ–¹æ¡ˆå¦‚ä¸‹ï¼š

#### å¿…é¡»ä¿®å¤ï¼ˆP0ï¼‰:
1. **service_context.py** - è¿½è¸ªå¹¶å–æ¶ˆåå°åˆå§‹åŒ–ä»»åŠ¡

#### å¯é€‰ä¿®å¤ï¼ˆP1ï¼‰:
2. **proxy_message_queue.py** - ä»…å½“ä½¿ç”¨ proxy æ¨¡å¼æ—¶

#### ä¸éœ€è¦ä¿®å¤ï¼ˆâœ… å·²æ­£ç¡®ï¼‰:
- conversation_handler.py âœ…
- tts_manager.py âœ…
- websocket_handler.py âœ…
- mcp_client.py âœ…

---

## ğŸ”„ å®Œæ•´ä¿®å¤ä»£ç 

### service_context.pyï¼ˆ3 å¤„ä¿®æ”¹ï¼‰

```python
# ===== ä¿®æ”¹ 1: __init__ =====
def __init__(self):
    # ... ç°æœ‰ä»£ç 
    self._background_tasks: list[asyncio.Task] = []

# ===== ä¿®æ”¹ 2: handle_config_switch =====
async def handle_config_switch(self, websocket, config_file_name):
    # ... ç°æœ‰ä»£ç ï¼Œåˆ° _finish_heavy_init å®šä¹‰ä¹‹å
    
    # âœ… å–æ¶ˆæ—§ä»»åŠ¡
    for task in self._background_tasks:
        if not task.done():
            logger.info("â¹ï¸  å–æ¶ˆæ—§çš„åˆå§‹åŒ–ä»»åŠ¡")
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
    self._background_tasks.clear()
    
    # âœ… åˆ›å»ºå¹¶è¿½è¸ªæ–°ä»»åŠ¡
    task = asyncio.create_task(_finish_heavy_init())
    self._background_tasks.append(task)
    logger.info("ğŸ”§ å¯åŠ¨åå°åˆå§‹åŒ–ä»»åŠ¡")

# ===== ä¿®æ”¹ 3: close() =====
async def close(self):
    logger.info("Closing ServiceContext resources...")
    
    # âœ… æ–°å¢ï¼šå–æ¶ˆæ‰€æœ‰åå°ä»»åŠ¡
    for task in self._background_tasks:
        if not task.done():
            logger.info("  â¹ï¸  å–æ¶ˆåå°ä»»åŠ¡")
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
    self._background_tasks.clear()
    logger.info("  âœ… æ‰€æœ‰åå°ä»»åŠ¡å·²æ¸…ç†")
    
    # ç°æœ‰æ¸…ç†é€»è¾‘
    if self.mcp_client:
        logger.info(f"Closing MCPClient for context instance {id(self)}...")
        await self.mcp_client.aclose()
        self.mcp_client = None
    
    if self.agent_engine and hasattr(self.agent_engine, "close"):
        await self.agent_engine.close()
    
    logger.info("ServiceContext closed.")
```

---

## âœ… æˆ‘çš„å»ºè®®

### ç«‹å³æ‰§è¡Œä¿®å¤

**ç†ç”±**ï¼š
1. âœ… é—®é¢˜æ˜ç¡®ï¼ˆåå°ä»»åŠ¡æœªè¿½è¸ªï¼‰
2. âœ… ä¿®å¤ç®€å•ï¼ˆ15 è¡Œä»£ç ï¼‰
3. âœ… é£é™©å¾ˆä½ï¼ˆåªæ˜¯æ·»åŠ æ¸…ç†é€»è¾‘ï¼‰
4. âœ… æ”¶ç›Šæ˜æ˜¾ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
5. âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½

**é¢„æœŸæ•ˆæœ**ï¼š
```
ä¿®å¤å‰ï¼š
æ‰“å¼€å…³é—­ 5 æ¬¡ â†’ å¯èƒ½ 5 ä¸ª ServiceContext æœªé‡Šæ”¾ â†’ 10GB+ å†…å­˜

ä¿®å¤åï¼š
æ‰“å¼€å…³é—­ 10 æ¬¡ â†’ 0 ä¸ª ServiceContext æ³„æ¼ â†’ å†…å­˜ç¨³å®š
```

---

**è¦æˆ‘ç°åœ¨å®æ–½ä¿®å¤å—ï¼Ÿ** âœ… **æˆ‘å»ºè®®ï¼šæ˜¯ï¼**


# æ€§èƒ½é—®é¢˜ç»ˆæåˆ†ææŠ¥å‘Š - é¸Ÿç°å…¨é¡¹ç›®

> **åˆ†æèŒƒå›´**: å®Œæ•´é¡¹ç›®é€’å½’æ‰«æ  
> **æ£€æŸ¥ç»“æœ**: ä½ çš„æ£€æŸ¥éƒ½é€šè¿‡äº† âœ…  
> **ç»“è®º**: æ‰¾åˆ°äº†å‰©ä½™çš„æ‰€æœ‰æ½œåœ¨é—®é¢˜

---

## âœ… ä½ çš„æ£€æŸ¥ç»“æœï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰

```powershell
cache ç›®å½•: 0 ä¸ªæ–‡ä»¶ âœ…
proxy é…ç½®: æœªå¯ç”¨ âœ…
chat_history: 0 MB âœ…
```

**åˆ¤æ–­**: 
- âœ… æ–‡ä»¶æ³„æ¼ï¼šä¸å­˜åœ¨
- âœ… proxy ä»»åŠ¡æ³„æ¼ï¼šä¸å½±å“ï¼ˆæœªå¯ç”¨ï¼‰
- âœ… å†å²æ•°æ®ï¼šæ­£å¸¸

---

## ğŸ” é€’å½’æ‰«æå‘ç°çš„æ‰€æœ‰ asyncio.create_task

### æ‰«æç»“æœï¼ˆ11 å¤„ï¼‰

| æ–‡ä»¶ | è¡Œå· | ä»»åŠ¡ç±»å‹ | æ˜¯å¦è¿½è¸ª | æ˜¯å¦æ¸…ç† | é£é™© |
|------|------|----------|----------|----------|------|
| conversation_handler.py | 98 | å¯¹è¯ä»»åŠ¡ | âœ… è¿½è¸ª | âœ… å–æ¶ˆ | ğŸŸ¢ æ—  |
| tts_manager.py | 58,75,80 | TTS ä»»åŠ¡ | âœ… è¿½è¸ª | âœ… gather | ğŸŸ¢ æ—  |
| websocket_handler.py | 121 | sweeper ä»»åŠ¡ | âœ… å•ä¾‹ | âœ… è‡ªç®¡ç† | ğŸŸ¢ æ—  |
| service_context.py | 611 | åˆå§‹åŒ–ä»»åŠ¡ | âœ… å·²ä¿®å¤ | âœ… å·²ä¿®å¤ | ğŸŸ¢ æ—  |
| proxy_handler.py | 60,63 | proxy ä»»åŠ¡ | ğŸŸ¡ éƒ¨åˆ† | ğŸŸ¡ éƒ¨åˆ† | ğŸŸ¡ æœªç”¨ |
| proxy_message_queue.py | 88,114 | æ¶ˆæ¯ä»»åŠ¡ | âŒ æ—  | âŒ æ—  | ğŸŸ¡ æœªç”¨ |
| **basic_memory_agent.py** | **706** | **WS å‘é€** | âŒ **æ— ** | âŒ **æ— ** | ğŸ”´ **æœ‰** |

---

## ğŸš¨ å‘ç°çš„å‰©ä½™é—®é¢˜

### ğŸ”´ é—®é¢˜ï¼šbasic_memory_agent.py - Fire-and-Forget WebSocket å‘é€

**ä½ç½®**: `src/ai_chat/agent/agents/basic_memory_agent.py` ç¬¬ 706 è¡Œ

```python
# âŒ é—®é¢˜ä»£ç 
asyncio.create_task(self._websocket_send_func(json.dumps(websocket_message)))
```

**ä¸Šä¸‹æ–‡**ï¼ˆç¬¬ 700-710 è¡Œï¼‰ï¼š

```python
# åœ¨ Agent å¤„ç† MCP å·¥å…·ç»“æœæ—¶
if tool_name == "get_machine_tutorial":
    if content:
        try:
            # Process through LaundryHandler
            websocket_message = self._laundry_handler.process_mcp_tool_result(content)
            
            # âŒ Fire-and-forget å‘é€
            asyncio.create_task(self._websocket_send_func(json.dumps(websocket_message)))
            logger.info("Queued laundry video WebSocket message to frontend")
        except json.JSONDecodeError as e:
            logger.error(f"Failed to decode JSON: {e}")
```

**é—®é¢˜åˆ†æ**ï¼š

1. **è§¦å‘åœºæ™¯**: ç”¨æˆ·è¯¢é—®æ´—è¡£æœºæ•™ç¨‹
2. **é¢‘ç‡**: å¯èƒ½å¾ˆé«˜ï¼ˆå¦‚æœç»å¸¸ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼‰
3. **ç´¯ç§¯æ•ˆåº”**: æ¯æ¬¡æŸ¥è¯¢ = 1 ä¸ªæœªè¿½è¸ªä»»åŠ¡

**å½±å“è¯„ä¼°**ï¼š

```
å¦‚æœç”¨æˆ·é¢‘ç¹æŸ¥è¯¢æ´—è¡£æœºæ•™ç¨‹:
â”œâ”€ æŸ¥è¯¢ 10 æ¬¡ = 10 ä¸ªä»»åŠ¡æ³„æ¼
â”œâ”€ æŸ¥è¯¢ 50 æ¬¡ = 50 ä¸ªä»»åŠ¡æ³„æ¼
â””â”€ å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™

ä½†å¦‚æœä¸å¸¸ç”¨è¿™ä¸ªåŠŸèƒ½:
â””â”€ å½±å“å¾ˆå° ğŸŸ¢
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```python
# âœ… æ–¹æ¡ˆ A: ç›´æ¥ç­‰å¾…ï¼ˆæ¨èï¼‰
try:
    await self._websocket_send_func(json.dumps(websocket_message))
except Exception as e:
    logger.error(f"Failed to send WebSocket message: {e}")

# âœ… æ–¹æ¡ˆ B: è¿½è¸ªä»»åŠ¡
if not hasattr(self, '_ws_send_tasks'):
    self._ws_send_tasks = []

task = asyncio.create_task(self._websocket_send_func(json.dumps(websocket_message)))
self._ws_send_tasks.append(task)

# å®šæœŸæ¸…ç†
self._ws_send_tasks = [t for t in self._ws_send_tasks if not t.done()]
```

**æ¨è**: æ–¹æ¡ˆ Aï¼ˆWebSocket å‘é€å¾ˆå¿«ï¼Œç›´æ¥ç­‰å¾…å³å¯ï¼‰

---

### ğŸŸ¡ å¯èƒ½çš„é—®é¢˜ï¼š_sweep_stale å…¨å±€å•ä¾‹ä»»åŠ¡

**ä½ç½®**: `websocket_handler.py` ç¬¬ 600-615 è¡Œ

```python
async def _sweep_stale(self, ttl: float = 60.0):
    """Periodically disconnect clients that stopped heartbeating."""
    while True:  # â† æ— é™å¾ªç¯
        try:
            await asyncio.sleep(30)
            now = asyncio.get_event_loop().time()
            stale = [uid for uid, ts in list(self._last_heartbeat.items()) if now - ts > ttl]
            for uid in stale:
                await self.handle_disconnect(uid)
        except Exception as e:
            logger.warning(f"Sweeper loop error: {e}")
```

**åˆ†æ**ï¼š

è¿™æ˜¯ä¸€ä¸ª**å…¨å±€åå°ä»»åŠ¡**ï¼Œå®šæœŸæ£€æŸ¥è¿‡æœŸè¿æ¥ã€‚

**é—®é¢˜**ï¼š
- è¿™ä¸ªä»»åŠ¡**æ°¸è¿œä¸ä¼šåœæ­¢**
- æ¯ 30 ç§’è¿è¡Œä¸€æ¬¡
- å¦‚æœ `self._last_heartbeat` ç´¯ç§¯å¾ˆå¤šæ¡ç›®...

**æ£€æŸ¥é€»è¾‘**ï¼š

```python
# åœ¨ handle_disconnect ä¸­
self._last_heartbeat.pop(client_uid, None)  # âœ… æœ‰æ¸…ç†

# åœ¨ _sweep_stale ä¸­
self._last_heartbeat.pop(uid, None)  # âœ… ä¹Ÿæœ‰æ¸…ç†
```

**åˆ¤æ–­**: ğŸŸ¢ **åº”è¯¥æ²¡é—®é¢˜**ï¼ˆæœ‰æ¸…ç†é€»è¾‘ï¼‰

ä½†**å¯èƒ½çš„è¾¹ç•Œæƒ…å†µ**ï¼š
- å¦‚æœæ¸…ç†å¤±è´¥
- æˆ–è€… client_uid ä¸åŒ¹é…
- å¯èƒ½å¯¼è‡´ `_last_heartbeat` ç´¯ç§¯

---

### ğŸŸ¡ å¯èƒ½çš„é—®é¢˜ï¼šAgent å†…éƒ¨çŠ¶æ€ç´¯ç§¯

**ä½ç½®**: `agent/agents/basic_memory_agent.py`

**å¯èƒ½çš„é—®é¢˜**ï¼š

```python
class BasicMemoryAgent:
    def __init__(self):
        # Agent å†…éƒ¨å¯èƒ½æœ‰ï¼š
        # - å¯¹è¯å†å²
        # - å·¥å…·è°ƒç”¨è®°å½•
        # - ä¸Šä¸‹æ–‡ç¼“å­˜
        # 
        # è¿™äº›å¯èƒ½ä¼šæ— é™å¢é•¿
```

**æ£€æŸ¥æ–¹æ³•**ï¼š

æŸ¥çœ‹ Agent çš„ `close()` æ–¹æ³•æ˜¯å¦æ¸…ç†å†…éƒ¨çŠ¶æ€ï¼š

```python
# service_context.py ç¬¬ 251 è¡Œ
if self.agent_engine and hasattr(self.agent_engine, "close"):
    await self.agent_engine.close()  # âœ… æœ‰è°ƒç”¨
```

**éœ€è¦ç¡®è®¤**: `basic_memory_agent.py` çš„ `close()` æ–¹æ³•æ˜¯å¦å­˜åœ¨å¹¶æ¸…ç†çŠ¶æ€ï¼Ÿ

---

## ğŸ“Š å®Œæ•´çš„ä»»åŠ¡ç®¡ç†è¯„ä¼°

### æ‰€æœ‰é•¿æœŸè¿è¡Œçš„åå°ä»»åŠ¡

| ä»»åŠ¡ | ä½ç½® | ç”Ÿå‘½å‘¨æœŸ | æ¸…ç†æœºåˆ¶ | é£é™© |
|------|------|----------|----------|------|
| **_sweep_stale** | websocket_handler | å…¨å±€å•ä¾‹ | æ°¸ä¸åœæ­¢ | ğŸŸ¡ ä½ |
| _consume_loop | proxy_message_queue | proxy å®ä¾‹ | stop() | ğŸŸ¢ æ— ï¼ˆæœªç”¨ï¼‰ |
| _maintain_connection | proxy_handler | proxy å®ä¾‹ | disconnect() | ğŸŸ¢ æ— ï¼ˆæœªç”¨ï¼‰ |
| _process_payload_queue | tts_manager | æ¯æ¬¡å¯¹è¯ | è‡ªåŠ¨ç»“æŸ | ğŸŸ¢ æ—  |

**å”¯ä¸€å¯èƒ½çš„é—®é¢˜**ï¼š_sweep_stale æ˜¯å…¨å±€çš„ï¼Œæ°¸è¿œè¿è¡Œ

**ä½†**ï¼šè¿™æ˜¯è®¾è®¡æ„å›¾ï¼ˆç›‘æ§è¿æ¥å¥åº·ï¼‰

---

## ğŸ¯ æ ¹æ®"å¶å°”ä¼šå¡"åˆ¤æ–­çœŸæ­£åŸå› 

### "å¶å°”" çš„ç‰¹å¾åˆ†æ

```
ä¸æ˜¯æ¯æ¬¡éƒ½å¡ â†’ æ’é™¤ç¨³å®šçš„èµ„æºæ³„æ¼
æ˜¯ç´¯ç§¯æ€§çš„ â†’ å¯èƒ½æ˜¯æŸç§ç´¯ç§¯æ•ˆåº”
```

### æœ€å¯èƒ½çš„åŸå› ï¼ˆæŒ‰æ¦‚ç‡æ’åºï¼‰

#### 1. Python åƒåœ¾å›æ”¶ï¼ˆGCï¼‰è§¦å‘ ğŸŸ¡ 40%

```python
# Python GC çš„ç‰¹æ€§
å½“å†…å­˜ä½¿ç”¨è¾¾åˆ°é˜ˆå€¼æ—¶ â†’ è§¦å‘ GC
GC è¿è¡Œæ—¶ â†’ æš‚åœæ‰€æœ‰æ“ä½œï¼ˆStop-the-Worldï¼‰
GC å®Œæˆå â†’ æ¢å¤æ­£å¸¸

è¡¨ç°:
â”œâ”€ å¤§éƒ¨åˆ†æ—¶é—´æµç•…
â”œâ”€ å¶å°”å¡é¡¿ 1-2 ç§’
â””â”€ å¡é¡¿åæ¢å¤æ­£å¸¸
```

**éªŒè¯æ–¹æ³•**ï¼š

åœ¨åç«¯æ·»åŠ  GC ç›‘æ§ï¼š

```python
import gc
import time

# è®°å½• GC æ—¶é—´
gc.callbacks.append(lambda phase, info: 
    logger.info(f"ğŸ—‘ï¸  GC {phase}: {info}")
)
```

#### 2. Agent/LLM æ€§èƒ½æ³¢åŠ¨ ğŸŸ¡ 30%

```python
# LLM API çš„ç‰¹æ€§
æ­£å¸¸æƒ…å†µ: å“åº” 1-2 ç§’
API é™æµ: å“åº” 5-10 ç§’
API è¿‡è½½: å“åº” 30+ ç§’

è¡¨ç°:
â”œâ”€ å¤§éƒ¨åˆ†æ—¶é—´å¿«é€Ÿ
â””â”€ å¶å°”å¾ˆæ…¢ï¼ˆAPI ç«¯é—®é¢˜ï¼‰
```

**éªŒè¯æ–¹æ³•**ï¼š

è§‚å¯Ÿæ—¥å¿—ä¸­çš„ "Conversation total elapsed"

#### 3. basic_memory_agent çš„ fire-and-forget ğŸŸ¡ 20%

å¦‚æœä½ ç»å¸¸ä½¿ç”¨æ´—è¡£æœºæ•™ç¨‹åŠŸèƒ½ï¼Œè¿™ä¸ªå¯èƒ½ç´¯ç§¯ã€‚

#### 4. å‰ç«¯æ€§èƒ½é—®é¢˜ ğŸŸ¡ 10%

```javascript
// å‰ç«¯å¯èƒ½çš„é—®é¢˜
â”œâ”€ Live2D æ¸²æŸ“ç´¯ç§¯
â”œâ”€ éŸ³é¢‘é˜Ÿåˆ—ç´¯ç§¯
â”œâ”€ React ç»„ä»¶æœªä¼˜åŒ–
â””â”€ æµè§ˆå™¨å†…å­˜æ³„æ¼
```

---

## ğŸš€ æœ€ç»ˆä¿®å¤å»ºè®®

### ç«‹å³ä¿®å¤ï¼šbasic_memory_agent.pyï¼ˆå®‰å…¨ä¸”ç®€å•ï¼‰

**ä¿®æ”¹ 1 è¡Œä»£ç **ï¼š

```python
# src/ai_chat/agent/agents/basic_memory_agent.py ç¬¬ 706 è¡Œ

# âŒ Before
asyncio.create_task(self._websocket_send_func(json.dumps(websocket_message)))

# âœ… After
await self._websocket_send_func(json.dumps(websocket_message))
```

**ç†ç”±**ï¼š
- WebSocket å‘é€å¾ˆå¿«ï¼ˆ<10msï¼‰
- ç›´æ¥ç­‰å¾…ä¸ä¼šé˜»å¡
- æ¶ˆé™¤ä»»åŠ¡æ³„æ¼
- **é£é™©**: ğŸŸ¢ æä½

---

### å¯é€‰ä¼˜åŒ–ï¼šæ·»åŠ æ€§èƒ½ç›‘æ§

åœ¨ `websocket_handler.py` æ·»åŠ ï¼š

```python
async def handle_disconnect(self, client_uid: str):
    # ... ç°æœ‰æ¸…ç†é€»è¾‘
    
    # âœ… æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    if logger.level <= 20:  # DEBUG level
        all_tasks = asyncio.all_tasks()
        active_tasks = [t for t in all_tasks if not t.done()]
        logger.debug(f"ğŸ“Š ä»»åŠ¡ç»Ÿè®¡: æ€»={len(all_tasks)}, æ´»è·ƒ={len(active_tasks)}")
        
        if len(active_tasks) > 30:
            logger.warning(f"âš ï¸  æ´»è·ƒä»»åŠ¡æ•°å¼‚å¸¸: {len(active_tasks)}")
```

---

### å¯é€‰ä¼˜åŒ–ï¼šGC è°ƒä¼˜

```python
# run_server.py æˆ– server.py
import gc

# è°ƒæ•´ GC é˜ˆå€¼ï¼ˆå‡å°‘ GC é¢‘ç‡ï¼‰
gc.set_threshold(700, 10, 10)  # é»˜è®¤æ˜¯ (700, 10, 10)

# æˆ–ç¦ç”¨è‡ªåŠ¨ GCï¼Œæ‰‹åŠ¨è§¦å‘
gc.disable()

# åœ¨é€‚å½“çš„æ—¶æœºæ‰‹åŠ¨ GC
# ä¾‹å¦‚ï¼šæ¯æ¬¡å®¢æˆ·ç«¯æ–­å¼€å
gc.collect()
```

---

## ğŸ“‹ å®Œæ•´çš„æ€§èƒ½é—®é¢˜æ¸…å•

### å·²ä¿®å¤ âœ…

1. âœ… service_context åå°ä»»åŠ¡æ³„æ¼
2. âœ… ad-carousel setTimeout æ³„æ¼
3. âœ… vad-context Immer åªè¯»é”™è¯¯
4. âœ… é…ç½®é‡å¤å­˜å‚¨ï¼ˆ10 å¤„ï¼‰
5. âœ… ç”Ÿäº§ç¯å¢ƒ HTTPS é…ç½®

### å¾…ä¿®å¤ ğŸŸ¡

6. ğŸŸ¡ basic_memory_agent fire-and-forgetï¼ˆè½»å¾®ï¼‰
7. ğŸŸ¡ å¯èƒ½çš„ GC æ€§èƒ½ä¼˜åŒ–

### å·²æ’é™¤ âœ…

8. âœ… proxy ä»»åŠ¡æ³„æ¼ï¼ˆæœªå¯ç”¨ï¼‰
9. âœ… cache æ–‡ä»¶ç´¯ç§¯ï¼ˆç©ºç›®å½•ï¼‰
10. âœ… å†å²æ•°æ®ç´¯ç§¯ï¼ˆæ­£å¸¸ï¼‰
11. âœ… _sweep_stale ä»»åŠ¡ï¼ˆæœ‰æ¸…ç†ï¼‰

---

## ğŸ¯ é’ˆå¯¹"å¶å°”ä¼šå¡"çš„ç‰¹åˆ«åˆ†æ

### "å¶å°”"çš„ç‰¹å¾

```
ä¸æ˜¯æ¯æ¬¡éƒ½å¡ â†’ ä¸æ˜¯ç¨³å®šçš„èµ„æºæ³„æ¼
æ‰“å¼€å…³é—­å¤šäº†ä¼šå¡ â†’ æœ‰ç´¯ç§¯æ•ˆåº”
ä½†ä¸æ˜¯çº¿æ€§å¢é•¿ â†’ å¯èƒ½æ˜¯é˜ˆå€¼è§¦å‘
```

### æœ€å¯èƒ½çš„åŸå› ï¼ˆç»¼åˆåˆ¤æ–­ï¼‰

#### å¯èƒ½æ€§ 1: Python GCï¼ˆ40%ï¼‰

```python
# Python çš„ GC ç‰¹æ€§
æ­£å¸¸æƒ…å†µï¼šä¸è§¦å‘ GC
å†…å­˜è¾¾åˆ°é˜ˆå€¼ï¼šè§¦å‘ GCï¼ˆå¡é¡¿ 0.5-2 ç§’ï¼‰
GC åï¼šé‡Šæ”¾å†…å­˜ï¼Œæ¢å¤æµç•…

è¡¨ç°ï¼š
â”œâ”€ å¼€å…³ 5 æ¬¡ï¼šæµç•…ï¼ˆæœªè¾¾é˜ˆå€¼ï¼‰
â”œâ”€ å¼€å…³ 8 æ¬¡ï¼šå¡ä¸€ä¸‹ï¼ˆGC è§¦å‘ï¼‰
â””â”€ å¼€å…³ 10 æ¬¡ï¼šåˆæµç•…ï¼ˆGC å®Œæˆï¼‰
```

**éªŒè¯**: æ·»åŠ  GC ç›‘æ§æ—¥å¿—

---

#### å¯èƒ½æ€§ 2: å‰ç«¯ Live2D æ¸²æŸ“ç´¯ç§¯ï¼ˆ30%ï¼‰

```javascript
// å‰ç«¯å¯èƒ½çš„é—®é¢˜
æ¯æ¬¡åŠ è½½ Live2D æ¨¡å‹:
â”œâ”€ PIXI.js åˆ›å»ºæ–°åº”ç”¨
â”œâ”€ åŠ è½½çº¹ç†å’Œç½‘æ ¼
â””â”€ å¦‚æœæ—§çš„æ²¡å®Œå…¨é‡Šæ”¾...

å¤šæ¬¡æ‰“å¼€:
â”œâ”€ çº¹ç†ç´¯ç§¯
â”œâ”€ WebGL ä¸Šä¸‹æ–‡ç´¯ç§¯
â””â”€ æµè§ˆå™¨å†…å­˜å¢é•¿ â†’ å¡é¡¿
```

**éªŒè¯**: 
- æ‰“å¼€æµè§ˆå™¨ä»»åŠ¡ç®¡ç†å™¨ï¼ˆShift+Escï¼‰
- è§‚å¯Ÿå†…å­˜å¢é•¿
- å¦‚æœå‰ç«¯å†…å­˜æŒç»­å¢é•¿ â†’ æ˜¯å‰ç«¯é—®é¢˜

---

#### å¯èƒ½æ€§ 3: MCP å·¥å…·è¿æ¥æœªå®Œå…¨å…³é—­ï¼ˆ20%ï¼‰

```python
# ä½ çš„æ—¥å¿—æ˜¾ç¤º
Closing MCPClient... and 4 active connections

# å¯èƒ½çš„é—®é¢˜
è¿™ 4 ä¸ªè¿æ¥çœŸçš„å…³é—­äº†å—ï¼Ÿ
æ˜¯å¦æœ‰ stdio æµæˆ– subprocess æ®‹ç•™ï¼Ÿ
```

**éªŒè¯**: 

è§‚å¯Ÿç³»ç»Ÿè¿›ç¨‹ï¼š

```powershell
# æŸ¥çœ‹æ‰€æœ‰ Python è¿›ç¨‹
Get-Process python
Get-Process node  # MCP æœåŠ¡å™¨å¯èƒ½æ˜¯ Node.js

# åº”è¯¥åªæœ‰ 1 ä¸ªä¸»è¿›ç¨‹
# å¦‚æœæœ‰å¤šä¸ª â†’ å¯èƒ½æ˜¯ MCP subprocess æœªæ¸…ç†
```

---

#### å¯èƒ½æ€§ 4: basic_memory_agent ä»»åŠ¡æ³„æ¼ï¼ˆ10%ï¼‰

å¦‚æœä½ ç»å¸¸ä½¿ç”¨æ´—è¡£æœºåŠŸèƒ½ã€‚

---

## ğŸš€ æ¨èçš„ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤ï¼ˆ5 åˆ†é’Ÿï¼‰

**ä¿®å¤ basic_memory_agent.py ç¬¬ 706 è¡Œ**

```python
# âŒ Before
asyncio.create_task(self._websocket_send_func(json.dumps(websocket_message)))

# âœ… After
try:
    await self._websocket_send_func(json.dumps(websocket_message))
except Exception as e:
    logger.error(f"Failed to send laundry video message: {e}")
```

**ç†ç”±**ï¼š
- ä¿®æ”¹ç®€å•ï¼ˆ1 è¡Œï¼‰
- é£é™©æä½ï¼ˆWebSocket å‘é€å¾ˆå¿«ï¼‰
- æ¶ˆé™¤æœ€åä¸€ä¸ªå·²çŸ¥çš„ä»»åŠ¡æ³„æ¼

---

### P1 - æ·»åŠ ç›‘æ§ï¼ˆ10 åˆ†é’Ÿï¼‰

**åœ¨ websocket_handler.py æ·»åŠ ä»»åŠ¡ç›‘æ§**

```python
async def handle_disconnect(self, client_uid: str):
    # ... ç°æœ‰æ¸…ç†
    
    # âœ… ä¸´æ—¶ç›‘æ§ï¼ˆå¯ä»¥åç»­åˆ é™¤ï¼‰
    all_tasks = asyncio.all_tasks()
    active = [t for t in all_tasks if not t.done()]
    logger.info(f"ğŸ“Š ä»»åŠ¡: æ€»={len(all_tasks)}, æ´»è·ƒ={len(active)}")
    
    if len(active) > 30:
        logger.warning(f"âš ï¸  ä»»åŠ¡æ•°å¼‚å¸¸: {len(active)}")
```

**ä½œç”¨**: 
- ç¡®è®¤æ˜¯å¦æœ‰ä»»åŠ¡ç´¯ç§¯
- å®šä½å…·ä½“æ˜¯å“ªä¸ªä»»åŠ¡

---

### P2 - å‰ç«¯æ’æŸ¥ï¼ˆå¦‚æœåç«¯æ­£å¸¸ï¼‰

**æ£€æŸ¥å‰ç«¯å†…å­˜**ï¼š

1. æ‰“å¼€æµè§ˆå™¨ä»»åŠ¡ç®¡ç†å™¨ï¼ˆShift+Escï¼‰
2. æ‰¾åˆ°ä½ çš„æ ‡ç­¾é¡µ
3. è§‚å¯Ÿå†…å­˜å˜åŒ–

**å¦‚æœå‰ç«¯å†…å­˜æŒç»­å¢é•¿**ï¼š
- å¯èƒ½æ˜¯ Live2D çº¹ç†æœªé‡Šæ”¾
- éœ€è¦ä¼˜åŒ–å‰ç«¯èµ„æºæ¸…ç†

---

## ğŸ”¬ æ·±åº¦è¯Šæ–­æ–¹æ¡ˆ

### å¦‚æœä¿®å¤åä»ç„¶å¡

**æ·»åŠ è¯¦ç»†çš„æ€§èƒ½æ—¥å¿—**ï¼š

```python
# service_context.py
async def close(self):
    start_time = time.time()
    logger.info("Closing ServiceContext...")
    
    # æ¸…ç†é€»è¾‘...
    
    elapsed = time.time() - start_time
    logger.info(f"ServiceContext æ¸…ç†è€—æ—¶: {elapsed:.3f}s")
    
    if elapsed > 1.0:
        logger.warning(f"âš ï¸  æ¸…ç†è€—æ—¶å¼‚å¸¸: {elapsed:.3f}s")
```

**è§‚å¯Ÿ**ï¼š
- å¦‚æœæ¸…ç†å¾ˆæ…¢ â†’ æŸä¸ªç»„ä»¶æ¸…ç†æœ‰é—®é¢˜
- å¦‚æœæ¸…ç†å¾ˆå¿« â†’ é—®é¢˜ä¸åœ¨æ¸…ç†é€»è¾‘

---

## âœ… æˆ‘çš„æœ€ç»ˆå»ºè®®

### ç«‹å³æ‰§è¡Œ

1. **ä¿®å¤ basic_memory_agent.py**ï¼ˆ1 åˆ†é’Ÿï¼‰
   - æ”¹ 1 è¡Œä»£ç 
   - æ¶ˆé™¤æœ€åçš„ä»»åŠ¡æ³„æ¼

2. **æ·»åŠ ä»»åŠ¡ç›‘æ§æ—¥å¿—**ï¼ˆ5 åˆ†é’Ÿï¼‰
   - ç¡®è®¤ä»»åŠ¡æ•°æ˜¯å¦æ­£å¸¸

3. **æµ‹è¯• 10 æ¬¡è¿æ¥**
   - è§‚å¯Ÿä»»åŠ¡æ•°å’Œå†…å­˜
   - è§‚å¯Ÿå“åº”æ—¶é—´

### æ ¹æ®ç»“æœ

- å¦‚æœä»»åŠ¡æ•°ç¨³å®šï¼ˆ<20ï¼‰ â†’ åç«¯æ²¡é—®é¢˜äº† âœ…
- å¦‚æœä»»åŠ¡æ•°å¢é•¿ â†’ è¿˜æœ‰å…¶ä»–æ³„æ¼ç‚¹
- å¦‚æœå‰ç«¯å¡ â†’ æ£€æŸ¥å‰ç«¯å†…å­˜

---

**è¦æˆ‘ç°åœ¨ä¿®å¤ basic_memory_agent.py å—ï¼Ÿ** è¿™æ˜¯æœ€åä¸€ä¸ªå·²çŸ¥çš„é—®é¢˜ï¼


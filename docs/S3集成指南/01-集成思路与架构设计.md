# ğŸ“¦ S3é›†æˆæ€è·¯ä¸æ¶æ„è®¾è®¡

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### è®¾è®¡åŸåˆ™
æœ¬é¡¹ç›®é‡‡ç”¨**å­˜å‚¨æŠ½è±¡å±‚**è®¾è®¡æ¨¡å¼ï¼Œå®ç°äº†**æœ¬åœ°å­˜å‚¨**å’Œ**äº‘å­˜å‚¨ï¼ˆS3ï¼‰**çš„æ— ç¼åˆ‡æ¢ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

1. **ç»Ÿä¸€æ¥å£** - æ— è®ºåº•å±‚æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯S3ï¼Œä¸Šå±‚ä»£ç ä½¿ç”¨ç›¸åŒçš„API
2. **é…ç½®é©±åŠ¨** - é€šè¿‡é…ç½®æ–‡ä»¶`conf.yaml`ä¸€é”®åˆ‡æ¢å­˜å‚¨æ–¹å¼
3. **å¤šç§Ÿæˆ·éš”ç¦»** - æ¯ä¸ªå®¢æˆ·ï¼ˆCLIENT_IDï¼‰çš„æ•°æ®å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°
4. **é›¶ä»£ç ä¿®æ”¹** - ä»æœ¬åœ°åˆ‡æ¢åˆ°S3ï¼Œä¸éœ€è¦ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ä»£ç 

---

## ğŸ—ï¸ å­˜å‚¨æŠ½è±¡å±‚æ¶æ„

### ä¸‰å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸šåŠ¡å±‚ (Business Layer)                   â”‚
â”‚  routes.py, MCP Server, WebSocket Handler, etc.             â”‚
â”‚  âœ… ä¸å…³å¿ƒåº•å±‚å­˜å‚¨å®ç°                                        â”‚
â”‚  âœ… åªè°ƒç”¨ç»Ÿä¸€çš„ storage_service æ¥å£                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ è°ƒç”¨ç»Ÿä¸€æ¥å£
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å­˜å‚¨æŠ½è±¡å±‚ (Storage Abstraction Layer)           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  StorageInterface (æ¥å£å®šä¹‰)                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ upload_file(file_data, category, filename)      â”‚   â”‚
â”‚  â”‚  â”œâ”€ list_files(category)                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ delete_file(category, filename)                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ file_exists(category, filename)                 â”‚   â”‚
â”‚  â”‚  â””â”€ get_file_url(category, filename)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  storage_factory.py (å·¥å‚æ¨¡å¼)                       â”‚   â”‚
â”‚  â”‚  æ ¹æ®é…ç½®è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„å­˜å‚¨æœåŠ¡å®ä¾‹                   â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  if storage_type == "local":                        â”‚   â”‚
â”‚  â”‚      return LocalStorageService()                   â”‚   â”‚
â”‚  â”‚  elif storage_type == "s3":                         â”‚   â”‚
â”‚  â”‚      return S3StorageService()                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â”‚ æœ¬åœ°å­˜å‚¨æ¨¡å¼                  â”‚ S3å­˜å‚¨æ¨¡å¼
             â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LocalStorageService       â”‚  â”‚   S3StorageService           â”‚
â”‚                             â”‚  â”‚                              â”‚
â”‚  ğŸ“ æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ              â”‚  â”‚  â˜ï¸ AWS S3 / é˜¿é‡Œäº‘OSS       â”‚
â”‚                             â”‚  â”‚                              â”‚
â”‚  ads/                       â”‚  â”‚  s3://bucket/                â”‚
â”‚  â”œâ”€ client_001/             â”‚  â”‚  â”œâ”€ client_001/              â”‚
â”‚  â”‚  â”œâ”€ video1.mp4           â”‚  â”‚  â”‚  â”œâ”€ ads/video1.mp4        â”‚
â”‚  â”‚  â””â”€ video2.mp4           â”‚  â”‚  â”‚  â””â”€ agent/menu.jpg        â”‚
â”‚  â””â”€ client_002/             â”‚  â”‚  â””â”€ client_002/              â”‚
â”‚     â””â”€ ad.mp4               â”‚  â”‚     â””â”€ ads/ad.mp4            â”‚
â”‚                             â”‚  â”‚                              â”‚
â”‚  âœ… ä½æˆæœ¬                   â”‚  â”‚  âœ… æ— é™å®¹é‡                  â”‚
â”‚  âœ… ä½å»¶è¿Ÿ                   â”‚  â”‚  âœ… å…¨çƒCDNåŠ é€Ÿ              â”‚
â”‚  âœ… ç®€å•éƒ¨ç½²                 â”‚  â”‚  âœ… é«˜å¯ç”¨æ€§                  â”‚
â”‚  âŒ å®¹é‡å—é™                 â”‚  â”‚  âœ… è‡ªåŠ¨å¤‡ä»½                  â”‚
â”‚  âŒ å•ç‚¹æ•…éšœ                 â”‚  â”‚  ğŸ’° éœ€è¦ä»˜è´¹                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å­˜å‚¨åˆ‡æ¢æµç¨‹

### æœ¬åœ°å­˜å‚¨ â†’ S3å­˜å‚¨

```mermaid
graph TD
    A[ä¿®æ”¹ conf.yaml] --> B{storage_type: s3}
    B --> C[é…ç½® S3 å‚æ•°]
    C --> D[s3_bucket<br/>s3_region<br/>s3_access_key<br/>cdn_url]
    D --> E[é‡å¯æœåŠ¡å™¨]
    E --> F[storage_factory è‡ªåŠ¨è¯†åˆ«]
    F --> G{åˆ›å»º S3StorageService}
    G --> H[ä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹]
    H --> I[âœ… è‡ªåŠ¨ä½¿ç”¨ S3 å­˜å‚¨]
```

### é…ç½®å¯¹æ¯”

**æœ¬åœ°å­˜å‚¨é…ç½®**:
```yaml
system_config:
  media_server:
    storage_type: "local"
    client_id: "client_001"
    base_directory: "."
```

**S3å­˜å‚¨é…ç½®**:
```yaml
system_config:
  media_server:
    storage_type: "s3"
    client_id: "client_001"
    
    # S3é…ç½®
    s3_bucket: "my-advertisement-bucket"
    s3_region: "us-east-1"
    s3_access_key: "YOUR_ACCESS_KEY"
    s3_secret_key: "YOUR_SECRET_KEY"
    
    # CDNé…ç½®ï¼ˆå¯é€‰ä½†æ¨èï¼‰
    cdn_url: "https://cdn.example.com"
```

---

## ğŸ” å¤šç§Ÿæˆ·éš”ç¦»æœºåˆ¶

### CLIENT_ID éš”ç¦»ç­–ç•¥

æœ¬é¡¹ç›®ä½¿ç”¨**CLIENT_ID**ä½œä¸ºç§Ÿæˆ·æ ‡è¯†ï¼Œç¡®ä¿ä¸åŒå®¢æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»ã€‚

#### æœ¬åœ°å­˜å‚¨éš”ç¦»
```
ads/
â”œâ”€ client_001/          # æ˜Ÿå·´å…‹çš„å¹¿å‘Š
â”‚  â”œâ”€ coffee_ad.mp4
â”‚  â””â”€ promo_2024.mp4
â”œâ”€ client_002/          # éº¦å½“åŠ³çš„å¹¿å‘Š
â”‚  â”œâ”€ burger_ad.mp4
â”‚  â””â”€ breakfast.mp4
â””â”€ client_003/          # è‚¯å¾·åŸºçš„å¹¿å‘Š
   â””â”€ chicken_ad.mp4

âœ… æ–‡ä»¶ç³»ç»Ÿçº§åˆ«éš”ç¦»
âœ… æ— æ³•è·¨ç›®å½•è®¿é—®
```

#### S3å­˜å‚¨éš”ç¦»
```
s3://my-bucket/
â”œâ”€ client_001/          # æ˜Ÿå·´å…‹
â”‚  â”œâ”€ ads/
â”‚  â”‚  â”œâ”€ coffee_ad.mp4
â”‚  â”‚  â””â”€ promo_2024.mp4
â”‚  â””â”€ agent/
â”‚     â””â”€ menu.jpg
â”œâ”€ client_002/          # éº¦å½“åŠ³
â”‚  â”œâ”€ ads/
â”‚  â”‚  â””â”€ burger_ad.mp4
â”‚  â””â”€ agent/
â”‚     â””â”€ menu.png
â””â”€ client_003/          # è‚¯å¾·åŸº
   â””â”€ ads/
      â””â”€ chicken_ad.mp4

âœ… S3 Keyå‰ç¼€éš”ç¦»
âœ… IAMç­–ç•¥çº§åˆ«éš”ç¦»ï¼ˆå¯é€‰ï¼‰
âœ… CDN URLè‡ªåŠ¨åŒ…å«CLIENT_ID
```

---

## ğŸ“¤ ä¸Šä¼ æµç¨‹è¯¦è§£

### ç»Ÿä¸€ä¸Šä¼ API

æ— è®ºæœ¬åœ°è¿˜æ˜¯S3ï¼Œéƒ½ä½¿ç”¨åŒä¸€ä¸ªAPIï¼š

```
POST /api/upload
Content-Type: multipart/form-data

å‚æ•°:
  - file: ä¸Šä¼ çš„æ–‡ä»¶
  - category: åˆ†ç±» (ads=å¹¿å‘Š, agent=Agentèµ„æº)
  - client: å®¢æˆ·ID (å¯é€‰ï¼Œä¼˜å…ˆä½¿ç”¨æ­¤å‚æ•°)
```

### å®Œæ•´ä¸Šä¼ æµç¨‹

```mermaid
sequenceDiagram
    participant ç”¨æˆ· as ğŸ“± ç”¨æˆ·æ‰‹æœº/Webæ§åˆ¶é¢æ¿
    participant è·¯ç”± as ğŸŒ FastAPI Routes
    participant å·¥å‚ as ğŸ­ storage_factory
    participant æœ¬åœ° as ğŸ“ LocalStorage
    participant S3 as â˜ï¸ S3Storage
    participant CDN as ğŸš€ CDN

    ç”¨æˆ·->>è·¯ç”±: POST /api/upload<br/>(file, category, client)
    
    Note over è·¯ç”±: 1. éªŒè¯å‚æ•°
    è·¯ç”±->>è·¯ç”±: è·å–CLIENT_ID<br/>APIå‚æ•° > ç¯å¢ƒå˜é‡ > é…ç½®
    
    Note over è·¯ç”±: 2. éªŒè¯æƒé™
    è·¯ç”±->>è·¯ç”±: éªŒè¯CLIENT_IDæ ¼å¼<br/>éªŒè¯ç™½åå•ï¼ˆå¯é€‰ï¼‰
    
    Note over è·¯ç”±: 3. éªŒè¯æ–‡ä»¶
    è·¯ç”±->>è·¯ç”±: æ–‡ä»¶ç±»å‹æ£€æŸ¥<br/>æ–‡ä»¶å¤§å°æ£€æŸ¥
    
    Note over è·¯ç”±: 4. åˆ›å»ºå­˜å‚¨æœåŠ¡
    è·¯ç”±->>å·¥å‚: create_storage_service(config, client_id)
    
    alt æœ¬åœ°å­˜å‚¨æ¨¡å¼
        å·¥å‚->>æœ¬åœ°: è¿”å› LocalStorageService
        è·¯ç”±->>æœ¬åœ°: upload_file(data, category, filename)
        æœ¬åœ°->>æœ¬åœ°: å†™å…¥ ads/client_001/video.mp4
        æœ¬åœ°-->>è·¯ç”±: è¿”å›æœ¬åœ°è·¯å¾„
        è·¯ç”±->>æœ¬åœ°: get_file_url(category, filename)
        æœ¬åœ°-->>è·¯ç”±: http://127.0.0.1:12393/ads/client_001/video.mp4
    else S3å­˜å‚¨æ¨¡å¼
        å·¥å‚->>S3: è¿”å› S3StorageService
        è·¯ç”±->>S3: upload_file(data, category, filename)
        S3->>S3: boto3.put_object<br/>Key=client_001/ads/video.mp4
        S3-->>è·¯ç”±: è¿”å›S3 Key
        è·¯ç”±->>S3: get_file_url(category, filename)
        alt é…ç½®äº†CDN
            S3-->>è·¯ç”±: https://cdn.example.com/client_001/ads/video.mp4
        else ç›´æ¥S3
            S3-->>è·¯ç”±: https://bucket.s3.region.amazonaws.com/client_001/ads/video.mp4
        end
    end
    
    Note over è·¯ç”±: 5. å¹¿æ’­åˆ·æ–°é€šçŸ¥
    è·¯ç”±->>è·¯ç”±: å¦‚æœæ˜¯å¹¿å‘Š(category=ads)<br/>å‘é€WebSocketå¹¿æ’­
    
    è·¯ç”±-->>ç”¨æˆ·: è¿”å›æˆåŠŸ<br/>{ url, filename, storage_path }
```

### ä»£ç å®ç°

```python
# routes.py
@router.post("/api/upload")
async def upload_media(
    file: UploadFile = File(...),
    category: str = Form("ads"),
    client: Optional[str] = Form(None)
):
    # 1. è·å–CLIENT_IDï¼ˆä¼˜å…ˆçº§ï¼‰
    media_config = default_context_cache.config.system_config.media_server
    client_id = (
        client                                    # APIå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        or os.getenv('CLIENT_ID')                 # ç¯å¢ƒå˜é‡ï¼ˆDockerï¼‰
        or media_config.client_id                 # é…ç½®æ–‡ä»¶
        or 'default_client'                       # é»˜è®¤å€¼
    )
    
    # 2. éªŒè¯æ–‡ä»¶
    contents = await file.read()
    file_ext = Path(file.filename).suffix.lower()
    
    # 3. åˆ›å»ºå­˜å‚¨æœåŠ¡ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ¬åœ°/S3ï¼‰
    storage_service = create_storage_service(media_config, client_id=client_id)
    
    # 4. ä¸Šä¼ æ–‡ä»¶ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
    filename = f"{original_name}_{timestamp}{file_ext}"
    storage_path = await storage_service.upload_file(contents, category, filename)
    file_url = storage_service.get_file_url(category, filename)
    
    # 5. è¿”å›ç»“æœ
    return {
        "success": True,
        "filename": filename,
        "storage_path": storage_path,  # æœ¬åœ°: ads/client_001/video.mp4
                                        # S3: client_001/ads/video.mp4
        "url": file_url,                # æœ¬åœ°: http://localhost:12393/...
                                        # S3: https://cdn.example.com/...
        "client_id": client_id
    }
```

---

## ğŸ¬ å¹¿å‘Šè§†é¢‘æ’­æ”¾æµç¨‹

### MCPå¹¿å‘ŠæœåŠ¡å™¨é›†æˆ

#### å½“å‰æ¶æ„ï¼ˆä»…æœ¬åœ°ï¼‰
```python
# âŒ å½“å‰ advertisement_server.py
class AdvertisementServer:
    def __init__(self, ads_dir: str = "ads"):
        self.ads_dir = Path(ads_dir) / self.client_id  # ç¡¬ç¼–ç æœ¬åœ°è·¯å¾„
        
    def _scan_advertisements(self):
        for file_path in self.ads_dir.iterdir():  # åªèƒ½æ‰«ææœ¬åœ°
            ad_info = {
                "url_path": f"/ads/{self.client_id}/{file_path.name}"
            }
```

#### æœªæ¥æ¶æ„ï¼ˆæ”¯æŒS3ï¼‰
```python
# âœ… æœªæ¥ advertisement_server.py
class AdvertisementServer:
    def __init__(self, media_config, storage_service, client_id):
        self.storage_service = storage_service  # æ³¨å…¥storageæœåŠ¡
        self.client_id = client_id
        
    async def _scan_advertisements(self):
        # ä½¿ç”¨ç»Ÿä¸€æ¥å£ï¼Œè‡ªåŠ¨æ”¯æŒæœ¬åœ°/S3
        files = await self.storage_service.list_files(category="ads")
        
        for file_info in files:
            ad_info = {
                "filename": file_info["filename"],
                "url": self.storage_service.get_file_url("ads", file_info["filename"])
                # æœ¬åœ°: http://localhost:12393/ads/client_001/video.mp4
                # S3: https://cdn.example.com/client_001/ads/video.mp4
            }
```

### æ’­æ”¾æµç¨‹

```mermaid
graph TD
    A[å‰ç«¯å¯åŠ¨] --> B[è¿æ¥WebSocket]
    B --> C[MCP: get_advertisement_playlist]
    C --> D{storage_type?}
    
    D -->|local| E[æ‰«ææœ¬åœ°ç›®å½•<br/>ads/client_001/]
    D -->|s3| F[S3: list_objects_v2<br/>prefix=client_001/ads/]
    
    E --> G[è¿”å›æ’­æ”¾åˆ—è¡¨<br/>æœ¬åœ°URL]
    F --> H[è¿”å›æ’­æ”¾åˆ—è¡¨<br/>CDN URL]
    
    G --> I[å‰ç«¯æ¥æ”¶]
    H --> I
    
    I --> J[<video> æ ‡ç­¾æ’­æ”¾]
    
    J -->|local| K[HTTPè¯·æ±‚<br/>æœ¬åœ°é™æ€æ–‡ä»¶æœåŠ¡]
    J -->|s3| L[HTTPSè¯·æ±‚<br/>CDNåŠ é€Ÿ]
    
    K --> M[æ’­æ”¾è§†é¢‘]
    L --> M
```

---

## ğŸ–¼ï¸ Agentå›¾ç‰‡/è§†é¢‘ä¸Šä¼ ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

### è®¾è®¡æ€è·¯

Agentåœ¨å¯¹è¯ä¸­å¯ä»¥åŠ¨æ€ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘ï¼Œè¿™äº›èµ„æºä¹Ÿéœ€è¦å­˜å‚¨å’Œç®¡ç†ã€‚

#### ä¸Šä¼ åœºæ™¯ç¤ºä¾‹

```
ç”¨æˆ·: "æˆ‘æƒ³çœ‹çœ‹ä»Šå¤©çš„æ–°å“èœå•"

Agent: "ç¨ç­‰ï¼Œæˆ‘ç»™æ‚¨å±•ç¤ºä¸€ä¸‹..."
    â†“
[Agenté€šè¿‡MCPå·¥å…·è°ƒç”¨ä¸Šä¼ ]
    tool: upload_image
    category: "agent"
    description: "2024æ–°å“èœå•"
    â†“
[ä¸Šä¼ åˆ° S3: client_001/agent/menu_20241027.jpg]
    â†“
[è¿”å›URL: https://cdn.example.com/client_001/agent/menu_20241027.jpg]
    â†“
[å‰ç«¯æ˜¾ç¤ºå›¾ç‰‡]
    <img src="https://cdn.example.com/client_001/agent/menu_20241027.jpg" />
```

#### MCPå·¥å…·è®¾è®¡

```python
# æœªæ¥çš„ MCP å·¥å…·
@server.call_tool()
async def upload_agent_resource(
    uri: str,
    file_data: bytes,
    resource_type: str,  # "image" or "video"
    description: str
) -> list[types.TextContent]:
    """
    Agentä¸Šä¼ èµ„æºå·¥å…·
    
    Args:
        uri: mcp://agent/upload
        file_data: æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®
        resource_type: èµ„æºç±»å‹
        description: èµ„æºæè¿°
    """
    # 1. è·å–storageæœåŠ¡
    storage_service = self.storage_service
    
    # 2. ç”Ÿæˆæ–‡ä»¶å
    timestamp = int(time.time())
    ext = ".jpg" if resource_type == "image" else ".mp4"
    filename = f"{description}_{timestamp}{ext}"
    
    # 3. ä¸Šä¼ ï¼ˆè‡ªåŠ¨ä½¿ç”¨é…ç½®çš„å­˜å‚¨æ–¹å¼ï¼‰
    storage_path = await storage_service.upload_file(
        file_data, 
        category="agent",  # Agentèµ„æºåˆ†ç±»
        filename=filename
    )
    
    # 4. è·å–URL
    url = storage_service.get_file_url("agent", filename)
    
    # 5. è¿”å›ç»“æœ
    return [types.TextContent(
        type="text",
        text=json.dumps({
            "success": True,
            "url": url,
            "filename": filename,
            "type": resource_type
        })
    )]
```

#### å­˜å‚¨ç»“æ„

```
S3 Bucket: my-bucket
â”œâ”€ client_001/
â”‚  â”œâ”€ ads/                    # å¹¿å‘Šè§†é¢‘ï¼ˆç°æœ‰ï¼‰
â”‚  â”‚  â”œâ”€ coffee_ad.mp4
â”‚  â”‚  â””â”€ promo_2024.mp4
â”‚  â””â”€ agent/                  # Agentèµ„æºï¼ˆæœªæ¥ï¼‰
â”‚     â”œâ”€ menu_20241027.jpg    # èœå•å›¾ç‰‡
â”‚     â”œâ”€ product_demo.mp4     # äº§å“æ¼”ç¤ºè§†é¢‘
â”‚     â””â”€ store_map.png        # åº—é“ºåœ°å›¾
â”œâ”€ client_002/
â”‚  â”œâ”€ ads/
â”‚  â””â”€ agent/
```

---

## ğŸ” ç”¨æˆ·åŒºåˆ†æœºåˆ¶

### CLIENT_ID è·å–ä¼˜å…ˆçº§

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹ä¼˜å…ˆçº§ç¡®å®šå½“å‰å®¢æˆ·èº«ä»½ï¼š

```
1. APIå‚æ•° (æœ€é«˜ä¼˜å…ˆçº§)
   ?client=client_001
   
2. ç¯å¢ƒå˜é‡ (Dockeréƒ¨ç½²)
   CLIENT_ID=client_001
   
3. é…ç½®æ–‡ä»¶ (æœ¬åœ°å¼€å‘)
   conf.yaml â†’ media_server.client_id
   
4. é»˜è®¤å€¼ (å…œåº•)
   default_client
```

### ä¸åŒåœºæ™¯çš„CLIENT_IDæ¥æº

#### åœºæ™¯1: Webæ§åˆ¶é¢æ¿ä¸Šä¼ 
```
ç”¨æˆ·æ‰«æäºŒç»´ç  â†’ æ‰“å¼€URL
https://ads.xyz/web-tool/control-panel.html?client=client_001
                                            â†‘
                                      URLå‚æ•°æºå¸¦

å‰ç«¯ä¸Šä¼ æ–‡ä»¶æ—¶:
POST /api/upload?category=ads&client=client_001
                               â†‘
                         APIå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
```

#### åœºæ™¯2: Dockerå®¹å™¨éƒ¨ç½²
```yaml
# docker-compose.yml
services:
  backend_client001:
    environment:
      - CLIENT_ID=client_001  # ç¯å¢ƒå˜é‡
    volumes:
      - ./ads/client_001:/app/ads/client_001
      
  backend_client002:
    environment:
      - CLIENT_ID=client_002  # ä¸åŒçš„CLIENT_ID
    volumes:
      - ./ads/client_002:/app/ads/client_002
```

#### åœºæ™¯3: æœ¬åœ°å¼€å‘
```yaml
# conf.yaml
system_config:
  media_server:
    client_id: "client_001"  # é…ç½®æ–‡ä»¶
    storage_type: "local"
```

### CLIENT_IDéªŒè¯æœºåˆ¶

```python
# routes.py
def validate_client_id(client_id: str) -> bool:
    """éªŒè¯CLIENT_IDæ ¼å¼å’Œæƒé™"""
    
    # 1. æ ¼å¼éªŒè¯
    if not client_id.startswith('client_'):
        raise ValueError("CLIENT_IDå¿…é¡»ä»¥'client_'å¼€å¤´")
    
    # 2. ç™½åå•éªŒè¯ï¼ˆå¯é€‰ï¼‰
    valid_clients = os.getenv('VALID_CLIENTS', '')
    if valid_clients:
        valid_list = [c.strip() for c in valid_clients.split(',')]
        if client_id not in valid_list:
            raise PermissionError(f"CLIENT_ID '{client_id}' æœªæˆæƒ")
    
    return True
```

### è®¿é—®éš”ç¦»ç¤ºä¾‹

```python
# æ˜Ÿå·´å…‹ (client_001) ä¸Šä¼ æ–‡ä»¶
POST /api/upload?client=client_001
â†’ å­˜å‚¨åˆ°: s3://bucket/client_001/ads/coffee.mp4

# æ˜Ÿå·´å…‹ åˆ—å‡ºæ–‡ä»¶
GET /api/media/list?client=client_001
â†’ åªè¿”å›: s3://bucket/client_001/* ä¸‹çš„æ–‡ä»¶
â†’ âŒ æ— æ³•çœ‹åˆ° client_002 çš„æ–‡ä»¶

# éº¦å½“åŠ³ (client_002) åˆ—å‡ºæ–‡ä»¶
GET /api/media/list?client=client_002
â†’ åªè¿”å›: s3://bucket/client_002/* ä¸‹çš„æ–‡ä»¶
â†’ âŒ æ— æ³•çœ‹åˆ° client_001 çš„æ–‡ä»¶

âœ… å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **ç»Ÿä¸€æ¥å£** - ä¸šåŠ¡ä»£ç ä¸å…³å¿ƒåº•å±‚å­˜å‚¨
2. **é…ç½®åˆ‡æ¢** - ä¸€è¡Œé…ç½®åˆ‡æ¢æœ¬åœ°/S3
3. **å¤šç§Ÿæˆ·éš”ç¦»** - CLIENT_IDç¡®ä¿æ•°æ®å®‰å…¨
4. **æ¸è¿›å¼è¿ç§»** - å…ˆæœ¬åœ°åS3ï¼Œæ— ç¼å‡çº§

### å…³é”®è®¾è®¡æ¨¡å¼

- **å·¥å‚æ¨¡å¼**: `storage_factory` æ ¹æ®é…ç½®åˆ›å»ºæœåŠ¡
- **ç­–ç•¥æ¨¡å¼**: `StorageInterface` å®šä¹‰ç»Ÿä¸€æ¥å£
- **ä¾èµ–æ³¨å…¥**: ä¸šåŠ¡å±‚æ³¨å…¥ `storage_service`

### æœªæ¥æ‰©å±•æ–¹å‘

1. âœ… MCPå¹¿å‘ŠæœåŠ¡å™¨æ”¯æŒS3
2. âœ… Agentèµ„æºåŠ¨æ€ä¸Šä¼ 
3. âœ… S3é¢„ç­¾åURLï¼ˆç§æœ‰æ¡¶ï¼‰
4. âœ… å¤šåŒºåŸŸS3æ”¯æŒ
5. âœ… CDNç¼“å­˜ç­–ç•¥ä¼˜åŒ–

---

**ä¸‹ä¸€ç¯‡**: [02-å¹¿å‘Šè§†é¢‘S3ä¸Šä¼ è¯¦è§£](./02-å¹¿å‘Šè§†é¢‘S3ä¸Šä¼ è¯¦è§£.md)


# ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æŒ‡å—

## ðŸŽ¯ éƒ¨ç½²æž¶æž„å…¨æ™¯

### æŽ¨èæž¶æž„ï¼šå¤šå®¹å™¨ + S3 + CDN

```
                              Internet (å…¬ç½‘)
                                   â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åŸŸåè§£æž (DNS)           â”‚
                    â”‚   screen1.example.com â†’ IPâ”‚
                    â”‚   screen2.example.com â†’ IPâ”‚
                    â”‚   screen3.example.com â†’ IPâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Caddy (åå‘ä»£ç† + HTTPS) â”‚
                    â”‚   Port: 80, 443           â”‚
                    â”‚   âœ… è‡ªåŠ¨HTTPSè¯ä¹¦          â”‚
                    â”‚   âœ… WebSocketæ”¯æŒ         â”‚
                    â”‚   âœ… è·¯å¾„è·¯ç”±              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚               â”‚
        â†“               â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Container 1  â”‚ â”‚ Container 2  â”‚ â”‚ Container 3  â”‚
â”‚ æ˜Ÿå·´å…‹å±å¹•1   â”‚ â”‚ éº¦å½“åŠ³å±å¹•2   â”‚ â”‚ è‚¯å¾·åŸºå±å¹•3   â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Frontend â”‚ â”‚ â”‚ â”‚ Frontend â”‚ â”‚ â”‚ â”‚ Frontend â”‚ â”‚
â”‚ â”‚ :80      â”‚ â”‚ â”‚ â”‚ :80      â”‚ â”‚ â”‚ â”‚ :80      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Backend  â”‚ â”‚ â”‚ â”‚ Backend  â”‚ â”‚ â”‚ â”‚ Backend  â”‚ â”‚
â”‚ â”‚ :12393   â”‚ â”‚ â”‚ â”‚ :12393   â”‚ â”‚ â”‚ â”‚ :12393   â”‚ â”‚
â”‚ â”‚          â”‚ â”‚ â”‚ â”‚          â”‚ â”‚ â”‚ â”‚          â”‚ â”‚
â”‚ â”‚ ENV:     â”‚ â”‚ â”‚ â”‚ ENV:     â”‚ â”‚ â”‚ â”‚ ENV:     â”‚ â”‚
â”‚ â”‚ CLIENT_IDâ”‚ â”‚ â”‚ â”‚ CLIENT_IDâ”‚ â”‚ â”‚ â”‚ CLIENT_IDâ”‚ â”‚
â”‚ â”‚ =client_ â”‚ â”‚ â”‚ â”‚ =client_ â”‚ â”‚ â”‚ â”‚ =client_ â”‚ â”‚
â”‚ â”‚ 001      â”‚ â”‚ â”‚ â”‚ 002      â”‚ â”‚ â”‚ â”‚ 003      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
            æ‰€æœ‰å®¹å™¨å…±äº«åŒä¸€ä¸ªS3å­˜å‚¨
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  AWS S3 / é˜¿é‡Œäº‘OSS                â”‚
        â”‚  Bucket: my-ads-bucket             â”‚
        â”‚                                    â”‚
        â”‚  client_001/                       â”‚
        â”‚  â”œâ”€ ads/                           â”‚
        â”‚  â”‚  â”œâ”€ coffee_ad_001.mp4           â”‚
        â”‚  â”‚  â””â”€ coffee_ad_002.mp4           â”‚
        â”‚  â””â”€ agent/                         â”‚
        â”‚     â””â”€ menu.jpg                    â”‚
        â”‚                                    â”‚
        â”‚  client_002/                       â”‚
        â”‚  â””â”€ ads/                           â”‚
        â”‚     â””â”€ burger_ad.mp4               â”‚
        â”‚                                    â”‚
        â”‚  client_003/                       â”‚
        â”‚  â””â”€ ads/                           â”‚
        â”‚     â””â”€ chicken_ad.mp4              â”‚
        â”‚                                    â”‚
        â”‚  âœ… ç»Ÿä¸€å­˜å‚¨                        â”‚
        â”‚  âœ… æŒ‰éœ€æ‰©å®¹                        â”‚
        â”‚  âœ… è‡ªåŠ¨å¤‡ä»½                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CDN (CloudFront/é˜¿é‡Œäº‘CDN)        â”‚
        â”‚  https://cdn.example.com/          â”‚
        â”‚                                    â”‚
        â”‚  âœ… å…¨çƒåŠ é€Ÿ                        â”‚
        â”‚  âœ… é™ä½Žæºç«™åŽ‹åŠ›                    â”‚
        â”‚  âœ… HTTPSç»ˆæ­¢                       â”‚
        â”‚  âœ… è‡ªåŠ¨ç¼“å­˜                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“‹ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: å‡†å¤‡S3å­˜å‚¨

#### 1.1 åˆ›å»ºS3æ¡¶

**AWS S3**:
```bash
# ä½¿ç”¨AWS CLIåˆ›å»ºæ¡¶
aws s3 mb s3://my-ads-bucket --region us-east-1

# é…ç½®CORSï¼ˆå…è®¸æµè§ˆå™¨ç›´æŽ¥è®¿é—®ï¼‰
aws s3api put-bucket-cors --bucket my-ads-bucket --cors-configuration file://cors.json
```

**cors.json**:
```json
{
    "CORSRules": [
        {
            "AllowedOrigins": ["*"],
            "AllowedMethods": ["GET", "HEAD"],
            "AllowedHeaders": ["*"],
            "MaxAgeSeconds": 3600
        }
    ]
}
```

**é˜¿é‡Œäº‘OSS**:
```bash
# ä½¿ç”¨ossutilåˆ›å»ºæ¡¶
ossutil mb oss://my-ads-bucket

# é…ç½®CORS
ossutil cors --method put oss://my-ads-bucket cors.xml
```

#### 1.2 é…ç½®IAMç”¨æˆ·

```bash
# åˆ›å»ºIAMç”¨æˆ·
aws iam create-user --user-name ai-screen-uploader

# åˆ›å»ºè®¿é—®å¯†é’¥
aws iam create-access-key --user-name ai-screen-uploader

# è¾“å‡º:
# AccessKeyId: AKIAIOSFODNN7EXAMPLE
# SecretAccessKey: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

**IAMç­–ç•¥**:
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::my-ads-bucket",
                "arn:aws:s3:::my-ads-bucket/*"
            ]
        }
    ]
}
```

---

### æ­¥éª¤2: é…ç½®CDN

#### CloudFronté…ç½®

```yaml
# CloudFront Distribution é…ç½®
Origin:
  Domain: my-ads-bucket.s3.us-east-1.amazonaws.com
  Origin Path: /  # ç•™ç©ºï¼Œä½¿ç”¨å®Œæ•´keyè·¯å¾„
  Origin Protocol: HTTPS only

Behavior:
  Path Pattern: *
  Viewer Protocol Policy: Redirect HTTP to HTTPS
  Allowed Methods: GET, HEAD, OPTIONS
  Cached Methods: GET, HEAD
  Cache Policy:
    Min TTL: 0
    Default TTL: 86400      # 1å¤©
    Max TTL: 31536000       # 1å¹´
  
Compression: Enabled
Custom Domain: cdn.example.com

# è®¿é—®ç¤ºä¾‹
# S3æºç«™: https://my-ads-bucket.s3.us-east-1.amazonaws.com/client_001/ads/video.mp4
# CDN: https://cdn.example.com/client_001/ads/video.mp4
```

#### é˜¿é‡Œäº‘CDNé…ç½®

```bash
# åˆ›å»ºCDNåŠ é€ŸåŸŸå
aliyun cdn AddCdnDomain \
  --DomainName cdn.example.com \
  --CdnType web \
  --Sources '[{"Content":"my-ads-bucket.oss-cn-hangzhou.aliyuncs.com","Type":"oss","Priority":"20","Port":80}]'

# é…ç½®ç¼“å­˜è§„åˆ™
aliyun cdn BatchSetCdnDomainConfig \
  --DomainNames cdn.example.com \
  --Functions '[{"FunctionArgs":[{"ArgName":"ttl","ArgValue":"86400"}],"FunctionName":"set_resp_header"}]'
```

---

### æ­¥éª¤3: é…ç½®åº”ç”¨

#### 3.1 åŽç«¯é…ç½®

**conf.yaml**:
```yaml
system_config:
  host: "0.0.0.0"  # ç›‘å¬æ‰€æœ‰ç½‘å¡ï¼ˆDockerå†…éƒ¨ï¼‰
  port: 12393
  
  media_server:
    storage_type: "s3"                              # â† å¯ç”¨S3
    client_id: "client_001"                         # â† é»˜è®¤CLIENT_IDï¼ˆä¼šè¢«çŽ¯å¢ƒå˜é‡è¦†ç›–ï¼‰
    
    # S3é…ç½®ï¼ˆä¹Ÿå¯é€šè¿‡çŽ¯å¢ƒå˜é‡ï¼‰
    s3_bucket: "my-ads-bucket"
    s3_region: "us-east-1"
    # s3_access_key: "ç•™ç©ºï¼Œä½¿ç”¨çŽ¯å¢ƒå˜é‡"
    # s3_secret_key: "ç•™ç©ºï¼Œä½¿ç”¨çŽ¯å¢ƒå˜é‡"
    
    # CDNé…ç½®
    cdn_url: "https://cdn.example.com"
    
    # ç¼“å­˜é…ç½®ï¼ˆS3æ¨¡å¼ä»å¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼‰
    cache_enabled: true
    cache_dir: "/app/cache"
    cache_size_limit: "10GB"
  
  config_alts_dir: "characters"

character_config:
  # è§’è‰²é…ç½®...
```

#### 3.2 çŽ¯å¢ƒå˜é‡é…ç½®

**.env (ç”Ÿäº§çŽ¯å¢ƒ)**:
```bash
# ==================== ç§Ÿæˆ·é…ç½® ====================
CLIENT_ID=client_001

# ==================== S3å­˜å‚¨é…ç½® ====================
STORAGE_TYPE=s3
S3_BUCKET=my-ads-bucket
S3_REGION=us-east-1

# AWSå‡­è¯ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦æäº¤åˆ°Gitï¼‰
AWS_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

# CDN URL
CDN_URL=https://cdn.example.com

# ==================== å®‰å…¨é…ç½® ====================
# å®¢æˆ·ç™½åå•ï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰
VALID_CLIENTS=client_001,client_002,client_003

# ==================== åŸŸåé…ç½® ====================
# ç‹¬ç«‹åŸŸåæ¨¡å¼
DOMAIN=screen1.example.com

# æˆ–å…±äº«åŸŸåæ¨¡å¼
# SHARED_DOMAIN=ads.xyz
# CLIENT_PATH=client1

# ==================== å…¶ä»–é…ç½® ====================
LOG_LEVEL=INFO
PYTHONUNBUFFERED=1
```

---

### æ­¥éª¤4: Dockeréƒ¨ç½²

#### 4.1 Dockerfile

**Dockerfile.backend**:
```dockerfile
FROM python:3.10-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–ï¼ˆåŒ…å«boto3ï¼‰
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs cache

# çŽ¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV HF_HOME=/app/models

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:12393/health')"

# æš´éœ²ç«¯å£
EXPOSE 12393

# å¯åŠ¨å‘½ä»¤
CMD ["python", "run_server.py"]
```

**Dockerfile.frontend**:
```dockerfile
# å¤šé˜¶æ®µæž„å»º
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY frontend/package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY frontend/ .

# æž„å»º
RUN npm run build

# -------------------- ç”Ÿäº§é•œåƒ --------------------
FROM nginx:alpine

# å¤åˆ¶æž„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 4.2 docker-compose.yml

```yaml
version: '3.8'

services:
  # ==================== æ˜Ÿå·´å…‹å®¹å™¨ ====================
  screen_client001:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: ai-screen-backend-client001
    environment:
      # ç§Ÿæˆ·é…ç½®
      - CLIENT_ID=client_001
      
      # S3å­˜å‚¨é…ç½®
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-ads-bucket
      - S3_REGION=us-east-1
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}  # ä»Ž.envè¯»å–
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - CDN_URL=https://cdn.example.com
      
      # åŸŸåé…ç½®
      - DOMAIN=screen1.example.com
    ports:
      - "12393:12393"  # åŽç«¯API
    volumes:
      - ./cache/client_001:/app/cache       # æœ¬åœ°ç¼“å­˜
      - ./logs/client_001:/app/logs         # æ—¥å¿—
      - ./characters:/app/characters:ro     # è§’è‰²é…ç½®ï¼ˆåªè¯»ï¼‰
      - ./live2d-models:/app/live2d-models:ro  # Live2Dæ¨¡åž‹ï¼ˆåªè¯»ï¼‰
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:12393/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  frontend_client001:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: ai-screen-frontend-client001
    environment:
      - VITE_WS_URL=ws://screen_client001:12393/client-ws
      - VITE_BASE_URL=http://screen_client001:12393
      - VITE_CLIENT_ID=client_001
    depends_on:
      - screen_client001
    restart: unless-stopped
  
  # ==================== éº¦å½“åŠ³å®¹å™¨ ====================
  screen_client002:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: ai-screen-backend-client002
    environment:
      - CLIENT_ID=client_002
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-ads-bucket
      - S3_REGION=us-east-1
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - CDN_URL=https://cdn.example.com
      - DOMAIN=screen2.example.com
    ports:
      - "12394:12393"
    volumes:
      - ./cache/client_002:/app/cache
      - ./logs/client_002:/app/logs
      - ./characters:/app/characters:ro
      - ./live2d-models:/app/live2d-models:ro
    restart: unless-stopped
  
  frontend_client002:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: ai-screen-frontend-client002
    environment:
      - VITE_WS_URL=ws://screen_client002:12393/client-ws
      - VITE_BASE_URL=http://screen_client002:12393
      - VITE_CLIENT_ID=client_002
    depends_on:
      - screen_client002
    restart: unless-stopped
  
  # ==================== è‚¯å¾·åŸºå®¹å™¨ ====================
  screen_client003:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: ai-screen-backend-client003
    environment:
      - CLIENT_ID=client_003
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-ads-bucket
      - S3_REGION=us-east-1
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - CDN_URL=https://cdn.example.com
      - DOMAIN=screen3.example.com
    ports:
      - "12395:12393"
    volumes:
      - ./cache/client_003:/app/cache
      - ./logs/client_003:/app/logs
      - ./characters:/app/characters:ro
      - ./live2d-models:/app/live2d-models:ro
    restart: unless-stopped
  
  frontend_client003:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: ai-screen-frontend-client003
    environment:
      - VITE_WS_URL=ws://screen_client003:12393/client-ws
      - VITE_BASE_URL=http://screen_client003:12393
      - VITE_CLIENT_ID=client_003
    depends_on:
      - screen_client003
    restart: unless-stopped
  
  # ==================== åå‘ä»£ç† ====================
  caddy:
    image: caddy:2-alpine
    container_name: ai-screen-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./caddy_data:/data
      - ./caddy_config:/config
    restart: unless-stopped
    depends_on:
      - frontend_client001
      - frontend_client002
      - frontend_client003
```

---

### æ­¥éª¤5: Caddyé…ç½®

**Caddyfile**:
```caddyfile
# ==================== æ˜Ÿå·´å…‹å±å¹• ====================
screen1.example.com {
    # å‰ç«¯é™æ€æ–‡ä»¶
    reverse_proxy frontend_client001:80
    
    # åŽç«¯APIå’ŒWebSocket
    reverse_proxy /api/* screen_client001:12393
    reverse_proxy /client-ws screen_client001:12393
    reverse_proxy /web-tool/* screen_client001:12393
    
    # æ—¥å¿—
    log {
        output file /data/logs/screen1.log
    }
}

# ==================== éº¦å½“åŠ³å±å¹• ====================
screen2.example.com {
    reverse_proxy frontend_client002:80
    reverse_proxy /api/* screen_client002:12393
    reverse_proxy /client-ws screen_client002:12393
    reverse_proxy /web-tool/* screen_client002:12393
    
    log {
        output file /data/logs/screen2.log
    }
}

# ==================== è‚¯å¾·åŸºå±å¹• ====================
screen3.example.com {
    reverse_proxy frontend_client003:80
    reverse_proxy /api/* screen_client003:12393
    reverse_proxy /client-ws screen_client003:12393
    reverse_proxy /web-tool/* screen_client003:12393
    
    log {
        output file /data/logs/screen3.log
    }
}

# ==================== WebæŽ§åˆ¶é¢æ¿ ====================
# æ‰€æœ‰åŸŸåéƒ½æ”¯æŒWebæŽ§åˆ¶é¢æ¿
# https://screen1.example.com/web-tool/control-panel.html?client=client_001
```

---

### æ­¥éª¤6: å¯åŠ¨éƒ¨ç½²

```bash
# 1. åˆ›å»º.envæ–‡ä»¶
cat > .env << EOF
AWS_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
EOF

# 2. æž„å»ºé•œåƒ
docker-compose build

# 3. å¯åŠ¨æ‰€æœ‰å®¹å™¨
docker-compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f screen_client001

# 5. æ£€æŸ¥å¥åº·çŠ¶æ€
docker-compose ps

# è¾“å‡ºç¤ºä¾‹:
# NAME                              STATUS         PORTS
# ai-screen-backend-client001       Up (healthy)   12393/tcp
# ai-screen-frontend-client001      Up             80/tcp
# ai-screen-backend-client002       Up (healthy)   12393/tcp
# ai-screen-frontend-client002      Up             80/tcp
# ai-screen-caddy                   Up             80/tcp, 443/tcp
```

---

## ðŸŒ åŸŸåé…ç½®

### DNSè§£æž

```bash
# Aè®°å½•
screen1.example.com  â†’  123.45.67.89  (æœåŠ¡å™¨IP)
screen2.example.com  â†’  123.45.67.89
screen3.example.com  â†’  123.45.67.89
cdn.example.com      â†’  CNAME to CloudFront

# æˆ–ä½¿ç”¨æ³›åŸŸå
*.example.com        â†’  123.45.67.89
```

### è®¿é—®URL

**å‰ç«¯ç•Œé¢**:
- æ˜Ÿå·´å…‹: `https://screen1.example.com/`
- éº¦å½“åŠ³: `https://screen2.example.com/`
- è‚¯å¾·åŸº: `https://screen3.example.com/`

**WebæŽ§åˆ¶é¢æ¿**:
- æ˜Ÿå·´å…‹: `https://screen1.example.com/web-tool/control-panel.html?client=client_001`
- éº¦å½“åŠ³: `https://screen2.example.com/web-tool/control-panel.html?client=client_002`
- è‚¯å¾·åŸº: `https://screen3.example.com/web-tool/control-panel.html?client=client_003`

**CDNèµ„æº**:
- `https://cdn.example.com/client_001/ads/video.mp4`
- `https://cdn.example.com/client_002/ads/burger.mp4`
- `https://cdn.example.com/client_003/ads/chicken.mp4`

---

## ðŸ“Š ç›‘æŽ§å’Œç»´æŠ¤

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨å¥åº·çŠ¶æ€
docker-compose ps

# æ£€æŸ¥åŽç«¯å¥åº·
curl https://screen1.example.com/api/health
# è¾“å‡º: ok

# æ£€æŸ¥S3è¿žæŽ¥
aws s3 ls s3://my-ads-bucket/client_001/ads/

# æ£€æŸ¥CDN
curl -I https://cdn.example.com/client_001/ads/test.mp4
# åº”è¯¥è¿”å›ž: 200 OK æˆ– 307 Redirect
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹ç‰¹å®šå®¹å™¨æ—¥å¿—
docker-compose logs -f screen_client001

# æŸ¥çœ‹åŽç«¯æ—¥å¿—æ–‡ä»¶
tail -f logs/client_001/debug_2024-10-27.log

# æŸ¥çœ‹Caddyè®¿é—®æ—¥å¿—
tail -f caddy_data/logs/screen1.log
```

### æ€§èƒ½ç›‘æŽ§

```bash
# å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# è¾“å‡ºç¤ºä¾‹:
# CONTAINER           CPU %   MEM USAGE / LIMIT     NET I/O
# backend-client001   5.2%    512MB / 2GB          10MB / 50MB
# frontend-client001  0.1%    50MB / 512MB         1MB / 20MB
```

---

## ðŸ”§ æ•…éšœæŽ’é™¤

### é—®é¢˜1: ä¸Šä¼ åˆ°S3å¤±è´¥

```bash
# æ£€æŸ¥S3å‡­è¯
aws s3 ls s3://my-ads-bucket --profile ai-screen

# æ£€æŸ¥IAMæƒé™
aws iam get-user-policy --user-name ai-screen-uploader --policy-name S3Access

# æ£€æŸ¥å®¹å™¨çŽ¯å¢ƒå˜é‡
docker exec ai-screen-backend-client001 env | grep S3

# æ£€æŸ¥åŽç«¯æ—¥å¿—
docker logs ai-screen-backend-client001 | grep "S3"
```

### é—®é¢˜2: CDNæ— æ³•è®¿é—®

```bash
# æ£€æŸ¥CDNé…ç½®
aws cloudfront get-distribution --id E1234567890ABC

# æµ‹è¯•CDNå¯è¾¾æ€§
curl -I https://cdn.example.com/client_001/ads/test.mp4

# æ£€æŸ¥CORSé…ç½®
aws s3api get-bucket-cors --bucket my-ads-bucket
```

### é—®é¢˜3: WebSocketè¿žæŽ¥å¤±è´¥

```bash
# æ£€æŸ¥Caddyé…ç½®
docker exec ai-screen-caddy caddy validate --config /etc/caddy/Caddyfile

# æµ‹è¯•WebSocket
wscat -c wss://screen1.example.com/client-ws

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
# ç¡®ä¿ 80, 443 ç«¯å£å¼€æ”¾
```

---

## ðŸ’° æˆæœ¬ä¼°ç®—

### AWSæ–¹æ¡ˆï¼ˆ100GBå­˜å‚¨ + 200GBæœˆæµé‡ï¼‰

```
æœåŠ¡å™¨:
- EC2 t3.medium (2vCPU, 4GB RAM)  â†’ $30/æœˆ

å­˜å‚¨:
- S3å­˜å‚¨: 100GB Ã— $0.023/GB      â†’ $2.30/æœˆ
- S3è¯·æ±‚: 50ä¸‡æ¬¡ Ã— $0.0004/1000  â†’ $0.20/æœˆ

CDN:
- CloudFrontæµé‡: 200GB Ã— $0.085/GB â†’ $17/æœˆ

æ€»è®¡: ~$50/æœˆ
```

### é˜¿é‡Œäº‘æ–¹æ¡ˆï¼ˆ100GBå­˜å‚¨ + 200GBæœˆæµé‡ï¼‰

```
æœåŠ¡å™¨:
- ECS 2æ ¸4GB                      â†’ Â¥80/æœˆ

å­˜å‚¨:
- OSSå­˜å‚¨: 100GB Ã— Â¥0.12/GB       â†’ Â¥12/æœˆ
- OSSæµé‡: 200GB Ã— Â¥0.50/GB       â†’ Â¥100/æœˆ

CDN:
- é˜¿é‡Œäº‘CDN: 200GB Ã— Â¥0.24/GB     â†’ Â¥48/æœˆ

æ€»è®¡: ~Â¥240/æœˆ (~$34/æœˆ)
```

### Backblaze B2 + Cloudflareæ–¹æ¡ˆï¼ˆæœ€çœé’±ï¼‰

```
å­˜å‚¨:
- B2å­˜å‚¨: 100GB Ã— $0.005/GB       â†’ $0.50/æœˆ
- B2ä¸‹è½½: å‰10GBå…è´¹ï¼ŒåŽç»­$0.01/GB â†’ $1.90/æœˆ

CDN:
- Cloudflare CDN: å…è´¹ï¼ˆæ— é™æµé‡ï¼‰â†’ $0/æœˆ

æœåŠ¡å™¨:
- DigitalOcean Droplet 2GB        â†’ $12/æœˆ

æ€»è®¡: ~$15/æœˆ ï¼ˆæœ€çœé’±æ–¹æ¡ˆï¼ï¼‰
```

---

## ðŸŽ¯ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] S3æ¡¶å·²åˆ›å»º
- [ ] IAMç”¨æˆ·å·²é…ç½®
- [ ] S3å‡­è¯å·²èŽ·å–
- [ ] CDNå·²é…ç½®
- [ ] åŸŸåå·²è§£æž
- [ ] SSLè¯ä¹¦å·²å‡†å¤‡ï¼ˆCaddyè‡ªåŠ¨ï¼‰
- [ ] `.env`æ–‡ä»¶å·²é…ç½®
- [ ] `conf.yaml`å·²æ›´æ–°
- [ ] Dockerfileå·²å‡†å¤‡
- [ ] docker-compose.ymlå·²é…ç½®

### éƒ¨ç½²åŽéªŒè¯

- [ ] å®¹å™¨å…¨éƒ¨è¿è¡Œ: `docker-compose ps`
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡: `curl https://screen1.example.com/api/health`
- [ ] WebSocketè¿žæŽ¥æˆåŠŸ: å‰ç«¯æ˜¾ç¤º"å·²è¿žæŽ¥"
- [ ] S3ä¸Šä¼ æˆåŠŸ: WebæŽ§åˆ¶é¢æ¿ä¸Šä¼ æµ‹è¯•è§†é¢‘
- [ ] S3åˆ—è¡¨æˆåŠŸ: å‰ç«¯èƒ½çœ‹åˆ°ä¸Šä¼ çš„è§†é¢‘
- [ ] CDNè®¿é—®æˆåŠŸ: è§†é¢‘èƒ½æ­£å¸¸æ’­æ”¾
- [ ] è§’è‰²åˆ‡æ¢æˆåŠŸ: WebæŽ§åˆ¶é¢æ¿åˆ‡æ¢è§’è‰²
- [ ] äºŒç»´ç ç”ŸæˆæˆåŠŸ: æ‰«ç èƒ½è®¿é—®æŽ§åˆ¶é¢æ¿

---

## ðŸš€ æ‰©å®¹æ–¹æ¡ˆ

### æ°´å¹³æ‰©å®¹

```yaml
# æ·»åŠ æ–°å®¢æˆ·åªéœ€:
# 1. å¤åˆ¶ä¸€ç»„å®¹å™¨é…ç½®
# 2. ä¿®æ”¹CLIENT_IDå’Œç«¯å£
# 3. æ·»åŠ åŸŸåè§£æž
# 4. docker-compose up -d

services:
  screen_client004:  # æ–°å®¢æˆ·
    build: .
    environment:
      - CLIENT_ID=client_004  # æ–°CLIENT_ID
      - STORAGE_TYPE=s3
      - ...
    ports:
      - "12396:12393"  # æ–°ç«¯å£
```

### åž‚ç›´æ‰©å®¹

```yaml
# å¢žåŠ èµ„æºé™åˆ¶
services:
  screen_client001:
    deploy:
      resources:
        limits:
          cpus: '2.0'      # å¢žåŠ CPU
          memory: 4G       # å¢žåŠ å†…å­˜
        reservations:
          cpus: '1.0'
          memory: 2G
```

---

## ðŸŽ¯ æ€»ç»“

### ç”Ÿäº§éƒ¨ç½²è¦ç‚¹

1. **ä½¿ç”¨S3å­˜å‚¨** - é¿å…ç£ç›˜æ»¡é—®é¢˜
2. **é…ç½®CDN** - æå‡å…¨çƒè®¿é—®é€Ÿåº¦
3. **å®¹å™¨åŒ–éƒ¨ç½²** - æ˜“äºŽæ‰©å®¹å’Œç®¡ç†
4. **ä½¿ç”¨HTTPS** - ç¡®ä¿é€šä¿¡å®‰å…¨
5. **ç‹¬ç«‹åŸŸå** - æ¯ä¸ªå®¢æˆ·ç‹¬ç«‹è®¿é—®
6. **å¥åº·æ£€æŸ¥** - è‡ªåŠ¨é‡å¯æ•…éšœå®¹å™¨
7. **æ—¥å¿—é›†ä¸­** - ä¾¿äºŽé—®é¢˜æŽ’æŸ¥
8. **å®šæœŸå¤‡ä»½** - S3è‡ªåŠ¨å¤‡ä»½ï¼Œé…ç½®æ–‡ä»¶Gitç®¡ç†

### æŽ¨èé…ç½®

- **å°è§„æ¨¡ï¼ˆ1-3ä¸ªå±å¹•ï¼‰**: Docker Compose + AWS S3
- **ä¸­ç­‰è§„æ¨¡ï¼ˆ4-10ä¸ªå±å¹•ï¼‰**: Docker Compose + Backblaze B2 + Cloudflare
- **å¤§è§„æ¨¡ï¼ˆ10+ä¸ªå±å¹•ï¼‰**: Kubernetes + S3 + CDN + Auto Scaling

---

**ä¸‹ä¸€ç¯‡**: [06-å®žæ–½è·¯çº¿å›¾](./06-å®žæ–½è·¯çº¿å›¾.md)


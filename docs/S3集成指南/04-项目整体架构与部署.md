# ğŸ—ï¸ é¡¹ç›®æ•´ä½“æ¶æ„ä¸éƒ¨ç½²

## ğŸ¯ é¡¹ç›®æ¶æ„æ€»è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å‰ç«¯å±‚ (Frontend Layer)                              â”‚
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Electron å‰ç«¯ (æ ‘è“æ´¾/æ¡Œé¢)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ React + TypeScript                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Zustand çŠ¶æ€ç®¡ç†                                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Live2D æ¨¡å‹æ¸²æŸ“                                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ WebRTC VAD è¯­éŸ³æ£€æµ‹                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ WebSocket åŒå‘é€šä¿¡                                                     â”‚  â”‚
â”‚  â”‚  â””â”€ MCP Client (ä¸åç«¯MCP Serveré€šä¿¡)                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â†•                                           â”‚
â”‚                         WebSocket (ws://localhost:12393/client-ws)               â”‚
â”‚                                       â†•                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Web æ§åˆ¶é¢æ¿ (æ‰‹æœº/å¹³æ¿)                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ çº¯ HTML/CSS/JavaScript                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ å“åº”å¼è®¾è®¡                                                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ HTTP API è°ƒç”¨                                                         â”‚  â”‚
â”‚  â”‚  â””â”€ åŠŸèƒ½: å¹¿å‘Šä¸Šä¼ ã€è§’è‰²åˆ‡æ¢ã€äºŒç»´ç                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                       â†•
                         HTTP/WebSocket (HTTPS in production)
                                       â†•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            åç«¯å±‚ (Backend Layer)                                 â”‚
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FastAPI æœåŠ¡å™¨ (run_server.py)                                           â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  WebSocket Handler                                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ è¿æ¥ç®¡ç† (client_connections, client_contexts)                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ æ¶ˆæ¯è·¯ç”± (message handlers)                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ å¿ƒè·³æ£€æµ‹ (heartbeat)                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ å¹¿æ’­åŠŸèƒ½ (broadcast_to_all)                                      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  API Routes (routes.py)                                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /client-ws           - WebSocketè¿æ¥                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/upload          - åª’ä½“ä¸Šä¼                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/media/list      - åª’ä½“åˆ—è¡¨                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/media/delete    - åª’ä½“åˆ é™¤                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/settings/save   - è®¾ç½®ä¿å­˜ï¼ˆè§’è‰²åˆ‡æ¢ï¼‰                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/settings/load   - è®¾ç½®åŠ è½½                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/config-files    - è§’è‰²é¢„è®¾åˆ—è¡¨                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ /api/qrcode/upload   - äºŒç»´ç ç”Ÿæˆ                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Service Context (service_context.py)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Live2D Engine       - æ¨¡å‹æ¸²æŸ“                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ ASR Engine          - è¯­éŸ³è¯†åˆ«                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ TTS Engine          - è¯­éŸ³åˆæˆ                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ VAD Engine          - è¯­éŸ³æ£€æµ‹                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Agent Engine        - AIå¯¹è¯                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ MCP Client          - MCPåè®®å®¢æˆ·ç«¯                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Tool Adapter        - å·¥å…·é€‚é…å™¨                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Storage Layer (å­˜å‚¨æŠ½è±¡å±‚)                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ StorageInterface â”‚â—„â”€â”€â”€â”¤ StorageFactory  â”‚                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  (æŠ½è±¡æ¥å£)       â”‚    â”‚  (å·¥å‚æ¨¡å¼)      â”‚                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â–³                                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           â”‚                 â”‚                 â”‚                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ LocalStorage     â”‚ â”‚ S3Storage     â”‚ â”‚ MinIOStorage  â”‚          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  (æœ¬åœ°æ–‡ä»¶)       â”‚ â”‚  (äº‘å­˜å‚¨)      â”‚ â”‚  (è‡ªå»ºS3)     â”‚          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                       â†•
                            MCP åè®® (stdio/HTTP)
                                       â†•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MCP æœåŠ¡å™¨å±‚ (MCP Servers)                              â”‚
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Advertisement Server (advertisement_server.py)                          â”‚    â”‚
â”‚  â”‚  â”œâ”€ ç®¡ç†å¹¿å‘Šæ’­æ”¾åˆ—è¡¨                                                      â”‚    â”‚
â”‚  â”‚  â”œâ”€ æ‰«æå¹¿å‘Šç›®å½•ï¼ˆæœ¬åœ°/S3ï¼‰                                               â”‚    â”‚
â”‚  â”‚  â”œâ”€ å·¥å…·: get_advertisement_playlist, search, refresh                   â”‚    â”‚
â”‚  â”‚  â””â”€ CLIENT_IDéš”ç¦»                                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Agent Resource Server (æœªæ¥)                                            â”‚    â”‚
â”‚  â”‚  â”œâ”€ ç®¡ç†AgentåŠ¨æ€ä¸Šä¼ çš„èµ„æº                                               â”‚    â”‚
â”‚  â”‚  â”œâ”€ å·¥å…·: upload_image, upload_video, list_resources                    â”‚    â”‚
â”‚  â”‚  â””â”€ CLIENT_IDéš”ç¦»                                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                       â†•
                              Storage Operations
                                       â†•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å­˜å‚¨å±‚ (Storage Layer)                                   â”‚
â”‚                                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ               â”‚          â”‚  S3 äº‘å­˜å‚¨                    â”‚        â”‚
â”‚  â”‚                            â”‚          â”‚                              â”‚        â”‚
â”‚  â”‚  ads/                      â”‚          â”‚  s3://my-bucket/             â”‚        â”‚
â”‚  â”‚  â”œâ”€ client_001/            â”‚          â”‚  â”œâ”€ client_001/              â”‚        â”‚
â”‚  â”‚  â”‚  â”œâ”€ video1.mp4          â”‚          â”‚  â”‚  â”œâ”€ ads/video1.mp4        â”‚        â”‚
â”‚  â”‚  â”‚  â””â”€ video2.mp4          â”‚          â”‚  â”‚  â””â”€ agent/menu.jpg        â”‚        â”‚
â”‚  â”‚  â””â”€ client_002/            â”‚          â”‚  â””â”€ client_002/              â”‚        â”‚
â”‚  â”‚     â””â”€ ad.mp4              â”‚          â”‚     â””â”€ ads/ad.mp4            â”‚        â”‚
â”‚  â”‚                            â”‚          â”‚                              â”‚        â”‚
â”‚  â”‚  agent/                    â”‚          â”‚  â†“                           â”‚        â”‚
â”‚  â”‚  â”œâ”€ client_001/            â”‚          â”‚  CDN: https://cdn.example.comâ”‚        â”‚
â”‚  â”‚  â”‚  â”œâ”€ menu.jpg            â”‚          â”‚  â”œâ”€ client_001/ads/video1.mp4â”‚        â”‚
â”‚  â”‚  â”‚  â””â”€ map.png             â”‚          â”‚  â””â”€ client_002/ads/ad.mp4   â”‚        â”‚
â”‚  â”‚  â””â”€ client_002/            â”‚          â”‚                              â”‚        â”‚
â”‚  â”‚     â””â”€ image.jpg           â”‚          â”‚  âœ… æ— é™å®¹é‡                  â”‚        â”‚
â”‚  â”‚                            â”‚          â”‚  âœ… å…¨çƒåŠ é€Ÿ                  â”‚        â”‚
â”‚  â”‚  âœ… ä½æˆæœ¬                  â”‚          â”‚  âœ… é«˜å¯ç”¨                    â”‚        â”‚
â”‚  â”‚  âœ… ç®€å•éƒ¨ç½²                â”‚          â”‚  ğŸ’° ä»˜è´¹æœåŠ¡                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµå‘å›¾

### å®Œæ•´ä¸šåŠ¡æµç¨‹

```mermaid
graph TB
    subgraph ç”¨æˆ·äº¤äº’
        U1[ğŸ‘¤ åº—é•¿æ‰‹æœº] --> WP[ğŸ“± Webæ§åˆ¶é¢æ¿]
        U2[ğŸ‘¥ é¡¾å®¢] --> FE[ğŸ–¥ï¸ å‰ç«¯ç•Œé¢]
    end
    
    subgraph å‰ç«¯å±‚
        WP --> |HTTP API| API
        FE --> |WebSocket| WS[WebSocket Handler]
        FE --> |MCP Protocol| MCP_C[MCP Client]
    end
    
    subgraph åç«¯æ ¸å¿ƒ
        WS --> SC[Service Context]
        API[API Routes] --> SF[Storage Factory]
        
        SC --> ASR[ASR Engine<br/>è¯­éŸ³è¯†åˆ«]
        SC --> TTS[TTS Engine<br/>è¯­éŸ³åˆæˆ]
        SC --> VAD[VAD Engine<br/>è¯­éŸ³æ£€æµ‹]
        SC --> AGENT[Agent Engine<br/>AIå¯¹è¯]
        SC --> L2D[Live2D Engine<br/>æ¨¡å‹æ¸²æŸ“]
        SC --> TA[Tool Adapter<br/>å·¥å…·é€‚é…]
    end
    
    subgraph MCPæœåŠ¡å™¨å±‚
        MCP_C --> |stdio/HTTP| MCP_S1[Advertisement Server<br/>å¹¿å‘Šç®¡ç†]
        MCP_C --> |stdio/HTTP| MCP_S2[Agent Resource Server<br/>èµ„æºç®¡ç†<br/>æœªæ¥]
        
        MCP_S1 --> SF
        MCP_S2 --> SF
    end
    
    subgraph å­˜å‚¨å±‚
        SF --> |storage_type=local| LS[Local Storage<br/>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ]
        SF --> |storage_type=s3| S3S[S3 Storage<br/>äº‘å­˜å‚¨]
        
        LS --> LOCAL[(æœ¬åœ°ç£ç›˜<br/>ads/<br/>agent/)]
        S3S --> S3[(AWS S3/é˜¿é‡Œäº‘OSS<br/>bucket/client_001/<br/>bucket/client_002/)]
        S3 --> CDN[ğŸš€ CDNåŠ é€Ÿ<br/>CloudFront/é˜¿é‡Œäº‘CDN]
    end
    
    subgraph é…ç½®å±‚
        CONFIG[conf.yaml] --> SC
        CONFIG --> SF
        CONFIG --> MCP_S1
        ENV[ç¯å¢ƒå˜é‡<br/>CLIENT_ID<br/>S3_BUCKET] --> SF
    end
    
    style WP fill:#e1f5ff
    style FE fill:#e1f5ff
    style API fill:#fff4e1
    style WS fill:#fff4e1
    style SF fill:#e8f5e9
    style S3S fill:#e8f5e9
    style CDN fill:#fce4ec
```

---

## ğŸš€ å¯åŠ¨æµç¨‹

### æœåŠ¡å™¨å¯åŠ¨åºåˆ—

```mermaid
sequenceDiagram
    participant Main as run_server.py
    participant Server as WebSocketServer
    participant Context as ServiceContext
    participant Config as Config Manager
    participant MCP as MCP Servers
    participant Storage as Storage Factory

    Note over Main: 1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
    Main->>Main: init_logger()
    
    Note over Main: 2. åŠ è½½é…ç½®æ–‡ä»¶
    Main->>Config: validate_config(read_yaml("conf.yaml"))
    Config-->>Main: è¿”å› Config å¯¹è±¡
    
    Note over Main: 3. åˆ›å»ºWebSocketæœåŠ¡å™¨
    Main->>Server: WebSocketServer(config)
    
    activate Server
    Note over Server: 3.1 åˆ›å»ºFastAPI app
    Server->>Server: self.app = FastAPI()
    
    Note over Server: 3.2 æ·»åŠ CORSä¸­é—´ä»¶
    Server->>Server: app.add_middleware(CORSMiddleware)
    
    Note over Server: 3.3 åˆå§‹åŒ–WebSocket Handler
    Server->>Server: init_client_ws_route(default_context_cache)
    Server-->>Server: websocket_handler
    
    Note over Server: 3.4 æ³¨å†ŒAPIè·¯ç”±
    Server->>Server: init_webtool_routes(default_context_cache, websocket_handler)
    
    Note over Server: 3.5 æŒ‚è½½é™æ€æ–‡ä»¶
    Server->>Server: app.mount("/ads", StaticFiles())
    Server->>Server: app.mount("/videos", StaticFiles())
    Server->>Server: app.mount("/web-tool", StaticFiles())
    
    deactivate Server
    Server-->>Main: è¿”å› server å®ä¾‹
    
    Note over Main: 4. å¼‚æ­¥åˆå§‹åŒ–
    Main->>Server: await server.initialize()
    
    activate Server
    Server->>Context: await default_context_cache.load_from_config(config)
    
    activate Context
    Note over Context: 4.1 åˆå§‹åŒ–å„å¼•æ“
    Context->>Context: init_live2d() - åŠ è½½Live2Dæ¨¡å‹
    Context->>Context: init_asr() - åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
    Context->>Context: init_tts() - åˆå§‹åŒ–è¯­éŸ³åˆæˆ
    Context->>Context: init_vad() - åˆå§‹åŒ–è¯­éŸ³æ£€æµ‹
    
    Note over Context: 4.2 åˆå§‹åŒ–MCPç»„ä»¶
    Context->>MCP: ServerRegistry() - æ³¨å†ŒMCPæœåŠ¡å™¨
    Context->>MCP: å¯åŠ¨ advertisement_server
    MCP-->>Context: MCPæœåŠ¡å™¨å·²å¯åŠ¨
    
    Context->>Context: init_agent() - åˆå§‹åŒ–AI Agent
    
    deactivate Context
    Context-->>Server: åˆå§‹åŒ–å®Œæˆ
    
    deactivate Server
    Server-->>Main: æœåŠ¡å™¨å°±ç»ª
    
    Note over Main: 5. å¯åŠ¨Uvicorn HTTPæœåŠ¡å™¨
    Main->>Main: uvicorn.run(app, host, port)
    
    Note over Main: âœ… æœåŠ¡å™¨è¿è¡Œä¸­...
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Service Contextï¼ˆæœåŠ¡ä¸Šä¸‹æ–‡ï¼‰

**èŒè´£**: é›†ä¸­ç®¡ç†æ‰€æœ‰å¼•æ“å®ä¾‹ï¼Œæä¾›ç»Ÿä¸€çš„æœåŠ¡è®¿é—®æ¥å£

```python
# src/ai_chat/service_context.py
class ServiceContext:
    """
    æœåŠ¡ä¸Šä¸‹æ–‡ - ç®¡ç†æ‰€æœ‰å¼•æ“çš„ç”Ÿå‘½å‘¨æœŸ
    
    æ ¸å¿ƒèŒè´£:
    1. åˆå§‹åŒ–å„å¼•æ“ï¼ˆLive2Dã€ASRã€TTSã€VADã€Agentï¼‰
    2. ç®¡ç†MCPå®¢æˆ·ç«¯å’Œå·¥å…·é€‚é…å™¨
    3. æä¾›é…ç½®åˆ‡æ¢åŠŸèƒ½
    4. ç¼“å­˜é‡é‡çº§èµ„æºï¼ˆé¿å…é‡å¤åˆå§‹åŒ–ï¼‰
    """
    
    # å¼•æ“å®ä¾‹
    live2d_model: Live2dModel          # Live2Dæ¨¡å‹
    asr_engine: ASRInterface           # è¯­éŸ³è¯†åˆ«å¼•æ“
    tts_engine: TTSInterface           # è¯­éŸ³åˆæˆå¼•æ“
    vad_engine: VADInterface           # è¯­éŸ³æ£€æµ‹å¼•æ“
    agent_engine: AgentInterface       # AIå¯¹è¯å¼•æ“
    
    # MCPç»„ä»¶
    mcp_server_registery: ServerRegistry    # MCPæœåŠ¡å™¨æ³¨å†Œè¡¨
    tool_adapter: ToolAdapter                # å·¥å…·é€‚é…å™¨
    mcp_client: MCPClient                    # MCPåè®®å®¢æˆ·ç«¯
    tool_manager: ToolManager                # å·¥å…·ç®¡ç†å™¨
    tool_executor: ToolExecutor              # å·¥å…·æ‰§è¡Œå™¨
    
    # é…ç½®
    config: Config                      # å®Œæ•´é…ç½®
    character_config: CharacterConfig   # è§’è‰²é…ç½®
    system_config: SystemConfig         # ç³»ç»Ÿé…ç½®
```

**åˆå§‹åŒ–æµç¨‹**:
```python
async def load_from_config(self, config: Config):
    """ä»é…ç½®åŠ è½½æ‰€æœ‰å¼•æ“"""
    
    # 1. åŠ è½½Live2Dæ¨¡å‹ï¼ˆç¦»çº¿åŠ è½½ï¼Œä¸é˜»å¡ï¼‰
    await asyncio.to_thread(self.init_live2d, config.character_config.live2d_model_name)
    
    # 2. åˆå§‹åŒ–ASRå¼•æ“
    await asyncio.to_thread(self.init_asr, config.character_config.asr_config)
    
    # 3. åˆå§‹åŒ–TTSå¼•æ“
    await asyncio.to_thread(self.init_tts, config.character_config.tts_config)
    
    # 4. åˆå§‹åŒ–VADå¼•æ“
    await asyncio.to_thread(self.init_vad, config.character_config.vad_config)
    
    # 5. åˆå§‹åŒ–MCPç»„ä»¶
    if config.character_config.agent_config.agent_settings.basic_memory_agent.use_mcpp:
        self.mcp_server_registery = ServerRegistry()
        self.tool_adapter = ToolAdapter(server_registery=self.mcp_server_registery)
    
    # 6. åˆå§‹åŒ–Agentå¼•æ“
    await asyncio.to_thread(self.init_agent, config.character_config.agent_config)
```

---

### 2. WebSocket Handlerï¼ˆWebSocketå¤„ç†å™¨ï¼‰

**èŒè´£**: ç®¡ç†æ‰€æœ‰WebSocketè¿æ¥ï¼Œå¤„ç†æ¶ˆæ¯è·¯ç”±å’Œå¹¿æ’­

```python
# src/ai_chat/websocket_handler.py
class WebSocketHandler:
    """
    WebSocketè¿æ¥ç®¡ç†å™¨
    
    æ ¸å¿ƒèŒè´£:
    1. ç®¡ç†æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥
    2. è·¯ç”±æ¶ˆæ¯åˆ°å¯¹åº”çš„å¤„ç†å™¨
    3. å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
    4. å¿ƒè·³æ£€æµ‹å’Œè‡ªåŠ¨æ¸…ç†
    """
    
    # è¿æ¥ç®¡ç†
    client_connections: Dict[str, WebSocket]       # client_uid â†’ WebSocket
    client_contexts: Dict[str, ServiceContext]     # client_uid â†’ ServiceContext
    
    # æ¶ˆæ¯å¤„ç†å™¨
    message_handlers: Dict[str, Callable]
    
    # å…±äº«èµ„æº
    default_context_cache: ServiceContext          # é»˜è®¤ä¸Šä¸‹æ–‡ç¼“å­˜
```

**æ¶ˆæ¯è·¯ç”±è¡¨**:
```python
MESSAGE_HANDLERS = {
    # è¯­éŸ³ç›¸å…³
    "audio": handle_audio,                    # ç”¨æˆ·è¯­éŸ³è¾“å…¥
    "vad-stop": handle_vad_stop,              # VADåœæ­¢
    
    # å¯¹è¯ç›¸å…³
    "interrupt": handle_interrupt,            # ç”¨æˆ·æ‰“æ–­
    "text": handle_text,                      # æ–‡æœ¬è¾“å…¥
    
    # æ§åˆ¶ç›¸å…³
    "switch-config": handle_config_switch,    # åˆ‡æ¢è§’è‰²é…ç½®
    "control": handle_control,                # æ§åˆ¶å‘½ä»¤
    
    # Agentç›¸å…³
    "agent-trigger": handle_agent_trigger,    # è§¦å‘Agentå‘è¯
    "mcp-call": handle_mcp_call,              # MCPå·¥å…·è°ƒç”¨
    
    # çŠ¶æ€ç›¸å…³
    "heartbeat": handle_heartbeat,            # å¿ƒè·³
    "state-update": _ignore_message,          # çŠ¶æ€æ›´æ–°ï¼ˆå‰ç«¯â†’åç«¯ï¼‰
}
```

---

### 3. Storage Factoryï¼ˆå­˜å‚¨å·¥å‚ï¼‰

**èŒè´£**: æ ¹æ®é…ç½®è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„å­˜å‚¨æœåŠ¡å®ä¾‹

```python
# src/ai_chat/storage/storage_factory.py
def create_storage_service(
    config: MediaServerConfig, 
    client_id: str = None
) -> StorageInterface:
    """
    å­˜å‚¨æœåŠ¡å·¥å‚
    
    å†³ç­–é€»è¾‘:
    1. è¯»å– config.storage_type
    2. å¦‚æœæ˜¯ "s3" â†’ åˆ›å»º S3StorageService
    3. å¦‚æœæ˜¯ "local" â†’ åˆ›å»º LocalStorageService
    4. è¿”å›ç»Ÿä¸€çš„ StorageInterface æ¥å£
    
    ä½¿ç”¨æ–¹:
    - API Routes: ä¸Šä¼ /åˆ—è¡¨/åˆ é™¤API
    - MCP Servers: å¹¿å‘ŠæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨
    """
    
    storage_type = config.storage_type.lower()
    
    if storage_type == "s3":
        return S3StorageService(
            client_id=client_id,
            bucket=config.s3_bucket or os.getenv('S3_BUCKET'),
            region=config.s3_region or os.getenv('S3_REGION'),
            access_key=config.s3_access_key or os.getenv('S3_ACCESS_KEY'),
            secret_key=config.s3_secret_key or os.getenv('S3_SECRET_KEY'),
            cdn_url=config.cdn_url or os.getenv('CDN_URL')
        )
    
    elif storage_type == "local":
        return LocalStorageService(
            client_id=client_id,
            base_directory=config.base_directory or "."
        )
```

---

### 4. MCP Architectureï¼ˆMCPæ¶æ„ï¼‰

**èŒè´£**: æä¾›å·¥å…·è°ƒç”¨èƒ½åŠ›ï¼Œè®©Agentå¯ä»¥æ‰§è¡Œå¤–éƒ¨æ“ä½œ

```python
# MCP ç»„ä»¶å…³ç³»
ServiceContext
    â†“ åˆ›å»º
ServerRegistry (æ³¨å†Œæ‰€æœ‰MCPæœåŠ¡å™¨)
    â†“ æ³¨å†Œ
    â”œâ”€ advertisement_server (stdioé€šä¿¡)
    â”œâ”€ agent_resource_server (æœªæ¥)
    â””â”€ other_servers...
    â†“ ç®¡ç†
ToolAdapter (é€‚é…MCPåè®®)
    â†“ ä½¿ç”¨
MCPClient (åè®®å®¢æˆ·ç«¯)
    â†“ è°ƒç”¨
ToolManager (å·¥å…·ç®¡ç†)
    â†“ æ‰§è¡Œ
ToolExecutor (å·¥å…·æ‰§è¡Œ)
    â†“ è¿”å›ç»“æœ
Agent Engine (AIä½¿ç”¨å·¥å…·ç»“æœ)
```

**MCPé€šä¿¡æµç¨‹**:
```mermaid
sequenceDiagram
    participant Agent as AI Agent
    participant ToolMgr as Tool Manager
    participant MCPClient as MCP Client
    participant MCPServer as Advertisement Server
    participant Storage as Storage Service

    Note over Agent: AIå†³ç­–: éœ€è¦è·å–å¹¿å‘Šåˆ—è¡¨
    Agent->>ToolMgr: è¯·æ±‚å·¥å…·: get_advertisement_playlist
    ToolMgr->>MCPClient: è°ƒç”¨MCPå·¥å…·
    
    Note over MCPClient: stdioé€šä¿¡
    MCPClient->>MCPServer: { method: "tools/call",<br/>  name: "get_advertisement_playlist" }
    
    Note over MCPServer: æ‰§è¡Œå·¥å…·é€»è¾‘
    MCPServer->>Storage: list_files(category="ads")
    
    alt storage_type = "local"
        Storage->>Storage: æ‰«ææœ¬åœ°ç›®å½• ads/client_001/
        Storage-->>MCPServer: è¿”å›æœ¬åœ°æ–‡ä»¶åˆ—è¡¨
    else storage_type = "s3"
        Storage->>S3: list_objects_v2<br/>(Prefix="client_001/ads/")
        S3-->>Storage: è¿”å›S3å¯¹è±¡åˆ—è¡¨
        Storage-->>MCPServer: è¿”å›æ–‡ä»¶åˆ—è¡¨ï¼ˆå«CDN URLï¼‰
    end
    
    MCPServer->>MCPServer: æ„å»ºæ’­æ”¾åˆ—è¡¨JSON
    MCPServer-->>MCPClient: è¿”å›æ’­æ”¾åˆ—è¡¨
    MCPClient-->>ToolMgr: å·¥å…·æ‰§è¡Œç»“æœ
    ToolMgr-->>Agent: Agentè·å–æ’­æ”¾åˆ—è¡¨
    
    Note over Agent: ä½¿ç”¨æ’­æ”¾åˆ—è¡¨æ•°æ®ç”Ÿæˆå›å¤
```

---

## ğŸŒ éƒ¨ç½²æ¶æ„

### éƒ¨ç½²æ¨¡å¼1: å•æœºæœ¬åœ°éƒ¨ç½²

**é€‚ç”¨åœºæ™¯**: æœ¬åœ°å¼€å‘ã€å°å‹å±•ç¤ºã€æµ‹è¯•ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Raspberry Pi / Desktop PC               â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Frontend (Electron)                       â”‚ â”‚
â”‚  â”‚  Port: 3000 (dev) / N/A (production)       â”‚ â”‚
â”‚  â”‚  â”œâ”€ React Dev Server (å¼€å‘)                â”‚ â”‚
â”‚  â”‚  â””â”€ Electron App (ç”Ÿäº§)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â†• WebSocket                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Backend (FastAPI)                         â”‚ â”‚
â”‚  â”‚  Port: 12393                               â”‚ â”‚
â”‚  â”‚  â”œâ”€ WebSocket: /client-ws                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ API: /api/*                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Static: /ads, /videos, /web-tool       â”‚ â”‚
â”‚  â”‚  â””â”€ MCP Servers (stdio)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â†•                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Local Storage                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ ads/client_001/                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ agent/client_001/                      â”‚ â”‚
â”‚  â”‚  â””â”€ cache/                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¿é—®æ–¹å¼:
- Frontend: http://localhost:3000 (dev)
- Webæ§åˆ¶é¢æ¿: http://localhost:12393/web-tool/control-panel.html?client=client_001
```

---

### éƒ¨ç½²æ¨¡å¼2: Dockerå•å®¹å™¨éƒ¨ç½²

**é€‚ç”¨åœºæ™¯**: ç®€å•éƒ¨ç½²ã€å•å®¢æˆ·åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Docker Host                             â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container: ai-screen-client001                    â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Frontend (Nginxé™æ€æ–‡ä»¶)                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Port: 80                                     â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚           â†•                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Backend (FastAPI)                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Port: 12393 (å†…éƒ¨)                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  ENV:                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    CLIENT_ID=client_001                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    STORAGE_TYPE=local                         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚           â†•                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Volume: /app/ads                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  æ˜ å°„åˆ°: ./data/client_001/ads                 â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  Hostæ˜ å°„:                                               â”‚
â”‚  - 80:80 (HTTP)                                         â”‚
â”‚  - 443:443 (HTTPSï¼Œéœ€é…ç½®è¯ä¹¦)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¿é—®æ–¹å¼:
- http://server-ip/
- http://server-ip/web-tool/control-panel.html?client=client_001
```

---

### éƒ¨ç½²æ¨¡å¼3: Dockerå¤šå®¹å™¨éƒ¨ç½²ï¼ˆå¤šç§Ÿæˆ·ï¼‰

**é€‚ç”¨åœºæ™¯**: ä¸€å°æœåŠ¡å™¨è¿è¡Œå¤šä¸ªå®¢æˆ·å®ä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Docker Host (1å°æœåŠ¡å™¨)                        â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Reverse Proxy (Caddy/Nginx)                                    â”‚â”‚
â”‚  â”‚  Port: 80, 443                                                  â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  è·¯ç”±è§„åˆ™:                                                        â”‚â”‚
â”‚  â”‚  â”œâ”€ screen1.example.com â†’ Container 1                          â”‚â”‚
â”‚  â”‚  â”œâ”€ screen2.example.com â†’ Container 2                          â”‚â”‚
â”‚  â”‚  â””â”€ screen3.example.com â†’ Container 3                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                    â”‚                    â”‚                â”‚
â”‚           â†“                    â†“                    â†“                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Container 1     â”‚ â”‚  Container 2     â”‚ â”‚  Container 3     â”‚   â”‚
â”‚  â”‚  æ˜Ÿå·´å…‹           â”‚ â”‚  éº¦å½“åŠ³           â”‚ â”‚  è‚¯å¾·åŸº           â”‚   â”‚
â”‚  â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚   â”‚
â”‚  â”‚  Frontend:80     â”‚ â”‚  Frontend:80     â”‚ â”‚  Frontend:80     â”‚   â”‚
â”‚  â”‚  Backend:12393   â”‚ â”‚  Backend:12393   â”‚ â”‚  Backend:12393   â”‚   â”‚
â”‚  â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚   â”‚
â”‚  â”‚  ENV:            â”‚ â”‚  ENV:            â”‚ â”‚  ENV:            â”‚   â”‚
â”‚  â”‚  CLIENT_ID=      â”‚ â”‚  CLIENT_ID=      â”‚ â”‚  CLIENT_ID=      â”‚   â”‚
â”‚  â”‚    client_001    â”‚ â”‚    client_002    â”‚ â”‚    client_003    â”‚   â”‚
â”‚  â”‚  STORAGE_TYPE=   â”‚ â”‚  STORAGE_TYPE=   â”‚ â”‚  STORAGE_TYPE=   â”‚   â”‚
â”‚  â”‚    s3            â”‚ â”‚    s3            â”‚ â”‚    s3            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                    â”‚                    â”‚                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                              â†“                                       â”‚
â”‚                     å…±äº«S3å­˜å‚¨ï¼ˆæŒ‰CLIENT_IDéš”ç¦»ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       AWS S3 / é˜¿é‡Œäº‘OSS                      â”‚
        â”‚                                              â”‚
        â”‚  s3://my-bucket/                             â”‚
        â”‚  â”œâ”€ client_001/ (æ˜Ÿå·´å…‹)                     â”‚
        â”‚  â”‚  â”œâ”€ ads/video1.mp4                        â”‚
        â”‚  â”‚  â””â”€ agent/menu.jpg                        â”‚
        â”‚  â”œâ”€ client_002/ (éº¦å½“åŠ³)                     â”‚
        â”‚  â”‚  â””â”€ ads/burger.mp4                        â”‚
        â”‚  â””â”€ client_003/ (è‚¯å¾·åŸº)                     â”‚
        â”‚     â””â”€ ads/chicken.mp4                       â”‚
        â”‚                                              â”‚
        â”‚  âœ… ä¸‰ä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªS3æ¡¶                      â”‚
        â”‚  âœ… CLIENT_IDå‰ç¼€éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       CDN (CloudFront/é˜¿é‡Œäº‘CDN)              â”‚
        â”‚                                              â”‚
        â”‚  https://cdn.example.com/                    â”‚
        â”‚  â”œâ”€ client_001/ads/video1.mp4                â”‚
        â”‚  â”œâ”€ client_002/ads/burger.mp4                â”‚
        â”‚  â””â”€ client_003/ads/chicken.mp4               â”‚
        â”‚                                              â”‚
        â”‚  âœ… å…¨çƒåŠ é€Ÿ                                  â”‚
        â”‚  âœ… HTTPSè‡ªåŠ¨                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**docker-compose.yml ç¤ºä¾‹**:
```yaml
version: '3.8'

services:
  # æ˜Ÿå·´å…‹å®¹å™¨
  screen_client001:
    build: .
    environment:
      - CLIENT_ID=client_001
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-ads-bucket
      - S3_REGION=us-east-1
      - CDN_URL=https://cdn.example.com
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
    ports:
      - "8001:80"
    volumes:
      - ./cache/client_001:/app/cache
  
  # éº¦å½“åŠ³å®¹å™¨
  screen_client002:
    build: .
    environment:
      - CLIENT_ID=client_002
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-ads-bucket
      - S3_REGION=us-east-1
      - CDN_URL=https://cdn.example.com
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
    ports:
      - "8002:80"
    volumes:
      - ./cache/client_002:/app/cache
  
  # è‚¯å¾·åŸºå®¹å™¨
  screen_client003:
    build: .
    environment:
      - CLIENT_ID=client_003
      - STORAGE_TYPE=s3
      - S3_BUCKET=my-ads-bucket
      - S3_REGION=us-east-1
      - CDN_URL=https://cdn.example.com
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
    ports:
      - "8003:80"
    volumes:
      - ./cache/client_003:/app/cache
  
  # åå‘ä»£ç†
  caddy:
    image: caddy:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./caddy_data:/data
      - ./caddy_config:/config
```

**Caddyfile**:
```caddyfile
# æ˜Ÿå·´å…‹å±å¹•
screen1.example.com {
    reverse_proxy screen_client001:80
}

# éº¦å½“åŠ³å±å¹•
screen2.example.com {
    reverse_proxy screen_client002:80
}

# è‚¯å¾·åŸºå±å¹•
screen3.example.com {
    reverse_proxy screen_client003:80
}
```

---

### éƒ¨ç½²æ¨¡å¼4: äº‘åŸç”Ÿéƒ¨ç½²ï¼ˆK8s + S3ï¼‰

**é€‚ç”¨åœºæ™¯**: å¤§è§„æ¨¡éƒ¨ç½²ã€é«˜å¯ç”¨è¦æ±‚

```
                        Internet
                           â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Load Balancer (å…¬ç½‘)  â”‚
              â”‚   (ALB/NLB/é˜¿é‡Œäº‘SLB)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                      â”‚
        â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress (HTTPS)   â”‚              â”‚  Ingress (HTTPS)   â”‚
â”‚  screen1.example..  â”‚              â”‚  screen2.example.. â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: client-001   â”‚              â”‚  Pod: client-002   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Frontend    â”‚  â”‚              â”‚  â”‚  Frontend    â”‚  â”‚
â”‚  â”‚  Container   â”‚  â”‚              â”‚  â”‚  Container   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Backend     â”‚  â”‚              â”‚  â”‚  Backend     â”‚  â”‚
â”‚  â”‚  Container   â”‚  â”‚              â”‚  â”‚  Container   â”‚  â”‚
â”‚  â”‚  ENV:        â”‚  â”‚              â”‚  â”‚  ENV:        â”‚  â”‚
â”‚  â”‚  CLIENT_ID=  â”‚  â”‚              â”‚  â”‚  CLIENT_ID=  â”‚  â”‚
â”‚  â”‚   client_001 â”‚  â”‚              â”‚  â”‚   client_002 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   AWS S3 / é˜¿é‡Œäº‘OSS    â”‚
              â”‚                        â”‚
              â”‚  client_001/           â”‚
              â”‚  client_002/           â”‚
              â”‚  client_003/           â”‚
              â”‚  ...                   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   CDN (å…¨çƒåŠ é€Ÿ)        â”‚
              â”‚   CloudFront/é˜¿é‡Œäº‘CDN  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Kubernetes Deployment**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-screen-client001
spec:
  replicas: 2  # é«˜å¯ç”¨
  template:
    spec:
      containers:
      - name: frontend
        image: ai-screen-frontend:latest
        ports:
        - containerPort: 80
        
      - name: backend
        image: ai-screen-backend:latest
        ports:
        - containerPort: 12393
        env:
        - name: CLIENT_ID
          value: "client_001"
        - name: STORAGE_TYPE
          value: "s3"
        - name: S3_BUCKET
          valueFrom:
            secretKeyRef:
              name: s3-credentials
              key: bucket
        - name: AWS_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: s3-credentials
              key: access-key
        - name: AWS_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: s3-credentials
              key: secret-key
        - name: CDN_URL
          value: "https://cdn.example.com"
```

---

## ğŸ”„ CLIENT_ID åœ¨ä¸åŒéƒ¨ç½²æ¨¡å¼ä¸‹çš„ä¼ é€’

### æ¨¡å¼1: æœ¬åœ°å¼€å‘
```yaml
# conf.yaml
system_config:
  media_server:
    client_id: "client_001"  # â† é…ç½®æ–‡ä»¶
    storage_type: "local"

# ä¼ é€’è·¯å¾„:
conf.yaml â†’ Config â†’ MediaServerConfig â†’ storage_factory â†’ LocalStorageService
                                              â†“
                                        client_id = "client_001"
```

### æ¨¡å¼2: Dockerå•å®¹å™¨
```yaml
# docker-compose.yml
environment:
  - CLIENT_ID=client_001  # â† ç¯å¢ƒå˜é‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

# ä¼ é€’è·¯å¾„:
ç¯å¢ƒå˜é‡ â†’ os.getenv('CLIENT_ID') â†’ storage_factory â†’ S3StorageService
                                          â†“
                                    client_id = "client_001"
```

### æ¨¡å¼3: Webæ§åˆ¶é¢æ¿ä¸Šä¼ 
```javascript
// URL: https://ads.xyz/web-tool/control-panel.html?client=client_001
                                                            â†‘
                                                      URLå‚æ•°

// JavaScript
const urlParams = new URLSearchParams(window.location.search);
const currentClientId = urlParams.get('client');  // client_001

// ä¸Šä¼ è¯·æ±‚
POST /api/upload?client=client_001  # â† APIå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
```

### ä¼˜å…ˆçº§æ€»ç»“

```
CLIENT_ID ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰:

1. APIå‚æ•°        ?client=client_001     (Webæ§åˆ¶é¢æ¿)
2. ç¯å¢ƒå˜é‡        CLIENT_ID=client_001   (Docker)
3. é…ç½®æ–‡ä»¶        conf.yaml â†’ client_id  (æœ¬åœ°å¼€å‘)
4. é»˜è®¤å€¼          default_client         (å…œåº•)

ä»£ç å®ç°:
client_id = (
    api_param               # 1ï¸âƒ£ æœ€é«˜
    or os.getenv('CLIENT_ID')  # 2ï¸âƒ£
    or config.client_id     # 3ï¸âƒ£
    or 'default_client'     # 4ï¸âƒ£ å…œåº•
)
```

---

## ğŸ¨ å‰åç«¯äº¤äº’æµç¨‹

### WebSocket æ¶ˆæ¯æµ

```mermaid
sequenceDiagram
    participant FE as å‰ç«¯ (React)
    participant WS as WebSocket Handler
    participant SC as Service Context
    participant Agent as AI Agent
    participant MCP as MCP Server
    participant TTS as TTS Engine

    Note over FE: ç”¨æˆ·è¯´è¯
    FE->>WS: { type: "audio", audio: base64_data }
    
    WS->>SC: è·å– ASR Engine
    SC->>SC: ASRè¯†åˆ«è¯­éŸ³
    SC-->>WS: è¯†åˆ«ç»“æœæ–‡æœ¬
    
    WS->>Agent: å‘é€ç”¨æˆ·è¾“å…¥
    Note over Agent: AIæ€è€ƒ...
    
    Agent->>MCP: è°ƒç”¨å·¥å…· get_advertisement_playlist
    MCP->>MCP: è·å–å¹¿å‘Šåˆ—è¡¨ï¼ˆæœ¬åœ°/S3ï¼‰
    MCP-->>Agent: è¿”å›æ’­æ”¾åˆ—è¡¨
    
    Note over Agent: ç”Ÿæˆå›å¤ï¼ˆåŒ…å«å·¥å…·ç»“æœï¼‰
    Agent-->>WS: AIå›å¤æ–‡æœ¬
    
    WS->>TTS: ç”Ÿæˆè¯­éŸ³
    TTS-->>WS: éŸ³é¢‘æ•°æ®
    
    WS->>FE: { type: "audio", audio: audio_data, text: "..." }
    
    Note over FE: æ’­æ”¾AIè¯­éŸ³
    FE->>FE: æ˜¾ç¤ºå­—å¹•
    FE->>FE: Live2Dè¡¨æƒ…åŠ¨ç”»
```

---

## ğŸ“ ç›®å½•ç»“æ„

### é¡¹ç›®å®Œæ•´ç›®å½•æ ‘

```
TheProjectSan/
â”œâ”€â”€ frontend/                          # å‰ç«¯ (Electron + React)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main/                      # Electronä¸»è¿›ç¨‹
â”‚   â”‚   â”œâ”€â”€ preload/                   # é¢„åŠ è½½è„šæœ¬
â”‚   â”‚   â””â”€â”€ renderer/                  # Reactæ¸²æŸ“è¿›ç¨‹
â”‚   â”‚       â”œâ”€â”€ src/
â”‚   â”‚       â”‚   â”œâ”€â”€ components/        # UIç»„ä»¶
â”‚   â”‚       â”‚   â”œâ”€â”€ services/          # æœåŠ¡å±‚
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ websocket-service.tsx    # WebSocketé€šä¿¡
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ websocket-handler.tsx    # æ¶ˆæ¯å¤„ç†
â”‚   â”‚       â”‚   â”œâ”€â”€ store/             # ZustandçŠ¶æ€ç®¡ç†
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ index.ts       # Storeå…¥å£
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ types.ts       # ç±»å‹å®šä¹‰
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ initial-states.ts  # åˆå§‹çŠ¶æ€ï¼ˆåŒ…å«VADé»˜è®¤å€¼ï¼‰
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ slices/        # Storeåˆ†ç‰‡
â”‚   â”‚       â”‚   â”œâ”€â”€ hooks/             # React Hooks
â”‚   â”‚       â”‚   â””â”€â”€ context/           # React Context
â”‚   â”‚       â””â”€â”€ package.json
â”‚   â””â”€â”€ electron-builder.yml           # Electronæ„å»ºé…ç½®
â”‚
â”œâ”€â”€ src/ai_chat/                       # åç«¯æ ¸å¿ƒ
â”‚   â”œâ”€â”€ server.py                      # FastAPIæœåŠ¡å™¨
â”‚   â”œâ”€â”€ routes.py                      # APIè·¯ç”±
â”‚   â”œâ”€â”€ websocket_handler.py           # WebSocketå¤„ç†å™¨
â”‚   â”œâ”€â”€ service_context.py             # æœåŠ¡ä¸Šä¸‹æ–‡
â”‚   â”‚
â”‚   â”œâ”€â”€ config_manager/                # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ utils.py                   # Configç±»å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ system.py                  # ç³»ç»Ÿé…ç½®ï¼ˆåŒ…å«MediaServerConfigï¼‰
â”‚   â”‚   â”œâ”€â”€ character.py               # è§’è‰²é…ç½®
â”‚   â”‚   â”œâ”€â”€ asr.py                     # ASRé…ç½®
â”‚   â”‚   â”œâ”€â”€ tts.py                     # TTSé…ç½®
â”‚   â”‚   â”œâ”€â”€ vad.py                     # VADé…ç½®
â”‚   â”‚   â””â”€â”€ agent.py                   # Agenté…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                       # å­˜å‚¨æŠ½è±¡å±‚ â­
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ storage_interface.py      # ç»Ÿä¸€æ¥å£
â”‚   â”‚   â”œâ”€â”€ local_service.py          # æœ¬åœ°å­˜å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ s3_service.py             # S3å­˜å‚¨å®ç°
â”‚   â”‚   â””â”€â”€ storage_factory.py        # å­˜å‚¨å·¥å‚
â”‚   â”‚
â”‚   â”œâ”€â”€ mcpp/                          # MCPæœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ advertisement_server.py   # å¹¿å‘Šç®¡ç†æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ server_registry.py        # æœåŠ¡å™¨æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ mcp_client.py             # MCPå®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ tool_adapter.py           # å·¥å…·é€‚é…å™¨
â”‚   â”‚
â”‚   â””â”€â”€ agent/                         # AI Agent
â”‚       â””â”€â”€ agents/
â”‚           â””â”€â”€ basic_memory_agent.py  # åŸºç¡€è®°å¿†Agent
â”‚
â”œâ”€â”€ web_tool/                          # Webæ§åˆ¶é¢æ¿
â”‚   â”œâ”€â”€ control-panel.html             # æ§åˆ¶é¢æ¿ä¸»é¡µ
â”‚   â”œâ”€â”€ index.html                     # æ—§ä¸Šä¼ é¡µé¢ï¼ˆå¯åˆ é™¤ï¼‰
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ characters/                        # è§’è‰²é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ sakura.yaml                    # æ¨±èŠ±è§’è‰²
â”‚   â”œâ”€â”€ bloodsucker.yaml               # å¸è¡€é¬¼è§’è‰²
â”‚   â””â”€â”€ white_baby.yaml                # ç™½è‰²å®å®è§’è‰²
â”‚
â”œâ”€â”€ live2d-models/                     # Live2Dæ¨¡å‹èµ„æº
â”‚   â”œâ”€â”€ sakura/
â”‚   â”œâ”€â”€ bloodsucker/
â”‚   â””â”€â”€ white_baby/
â”‚
â”œâ”€â”€ ads/                               # å¹¿å‘Šè§†é¢‘ï¼ˆæœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼‰
â”‚   â”œâ”€ client_001/
â”‚   â””â”€ client_002/
â”‚
â”œâ”€â”€ agent/                             # Agentèµ„æºï¼ˆæœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼‰
â”‚   â”œâ”€ client_001/
â”‚   â””â”€ client_002/
â”‚
â”œâ”€â”€ cache/                             # ç¼“å­˜ç›®å½•
â”‚   â”œâ”€ client_001/
â”‚   â””â”€ client_002/
â”‚
â”œâ”€â”€ logs/                              # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ debug_2024-10-27.log
â”‚
â”œâ”€â”€ conf.yaml                          # ä¸»é…ç½®æ–‡ä»¶ â­
â”œâ”€â”€ mcp_servers.json                   # MCPæœåŠ¡å™¨é…ç½®
â”œâ”€â”€ run_server.py                      # æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements.txt                   # Pythonä¾èµ–
â””â”€â”€ package.json                       # Node.jsä¾èµ–ï¼ˆMCPï¼‰
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€è·¯

### 1. åˆ†å±‚æ¶æ„

é¡¹ç›®é‡‡ç”¨**ä¸¥æ ¼åˆ†å±‚**ï¼Œæ¯å±‚èŒè´£æ˜ç¡®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å±•ç¤ºå±‚ (Presentation Layer)                  â”‚
â”‚  - Reactç»„ä»¶                                  â”‚
â”‚  - Electronç•Œé¢                               â”‚
â”‚  - Webæ§åˆ¶é¢æ¿                                â”‚
â”‚  èŒè´£: ç”¨æˆ·äº¤äº’ã€UIæ¸²æŸ“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ WebSocket/HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIå±‚ (API Layer)                            â”‚
â”‚  - FastAPI Routes                             â”‚
â”‚  - WebSocket Handler                          â”‚
â”‚  èŒè´£: è¯·æ±‚è·¯ç”±ã€å‚æ•°éªŒè¯ã€å“åº”æ ¼å¼åŒ–           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ è°ƒç”¨æœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡å±‚ (Business Layer)                      â”‚
â”‚  - Service Context                            â”‚
â”‚  - Agent Engine                               â”‚
â”‚  - MCP Servers                                â”‚
â”‚  èŒè´£: ä¸šåŠ¡é€»è¾‘ã€AIå¯¹è¯ã€å·¥å…·è°ƒç”¨              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ å­˜å‚¨æ“ä½œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨æŠ½è±¡å±‚ (Storage Abstraction Layer)       â”‚
â”‚  - StorageInterface                           â”‚
â”‚  - Storage Factory                            â”‚
â”‚  èŒè´£: ç»Ÿä¸€å­˜å‚¨æ¥å£ã€è‡ªåŠ¨é€‰æ‹©å­˜å‚¨æ–¹å¼           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨å®ç°å±‚ (Storage Implementation Layer)    â”‚
â”‚  - LocalStorageService                        â”‚
â”‚  - S3StorageService                           â”‚
â”‚  èŒè´£: å…·ä½“çš„å­˜å‚¨æ“ä½œå®ç°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**:
- âœ… å…³æ³¨ç‚¹åˆ†ç¦» - æ¯å±‚åªå…³å¿ƒè‡ªå·±çš„èŒè´£
- âœ… æ˜“äºæµ‹è¯• - æ¯å±‚å¯ç‹¬ç«‹æµ‹è¯•
- âœ… æ˜“äºæ›¿æ¢ - ä¾‹å¦‚æ›¿æ¢å­˜å‚¨å±‚ä¸å½±å“ä¸šåŠ¡å±‚
- âœ… æ˜“äºæ‰©å±• - æ–°å¢åŠŸèƒ½åªéœ€åœ¨å¯¹åº”å±‚æ·»åŠ 

---

### 2. ä¾èµ–æ³¨å…¥

é¡¹ç›®å¤§é‡ä½¿ç”¨**ä¾èµ–æ³¨å…¥**æ¨¡å¼ï¼Œé™ä½è€¦åˆï¼š

```python
# âœ… å¥½çš„è®¾è®¡ - ä¾èµ–æ³¨å…¥
def init_webtool_routes(
    default_context_cache: ServiceContext,      # æ³¨å…¥
    websocket_handler: WebSocketHandler = None  # æ³¨å…¥
) -> APIRouter:
    
    @router.post("/api/settings/save")
    async def save_settings(request: dict):
        # ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–
        if websocket_handler:
            await websocket_handler.broadcast_settings_update(...)
        
        # ä½¿ç”¨æ³¨å…¥çš„ä¸Šä¸‹æ–‡
        await default_context_cache.handle_config_switch(...)

# âŒ å·®çš„è®¾è®¡ - ç¡¬ç¼–ç ä¾èµ–
def init_webtool_routes() -> APIRouter:
    # å†…éƒ¨åˆ›å»ºä¾èµ–ï¼Œéš¾ä»¥æµ‹è¯•å’Œæ›¿æ¢
    websocket_handler = WebSocketHandler()
```

**ä¼˜åŠ¿**:
- âœ… å¯æµ‹è¯•æ€§ - å¯ä»¥æ³¨å…¥mockå¯¹è±¡
- âœ… å¯å¤ç”¨æ€§ - åŒä¸€ä¸ªå®ä¾‹å¯è¢«å¤šå¤„ä½¿ç”¨
- âœ… è§£è€¦åˆ - é™ä½æ¨¡å—é—´ä¾èµ–
- âœ… çµæ´»æ€§ - æ˜“äºæ›¿æ¢å®ç°

---

### 3. å·¥å‚æ¨¡å¼

ä½¿ç”¨**å·¥å‚æ¨¡å¼**è‡ªåŠ¨åˆ›å»ºæ­£ç¡®çš„æœåŠ¡å®ä¾‹ï¼š

```python
# storage_factory.py
def create_storage_service(
    config: MediaServerConfig,
    client_id: str
) -> StorageInterface:
    """
    æ ¹æ®é…ç½®è‡ªåŠ¨åˆ›å»ºå­˜å‚¨æœåŠ¡
    
    å†³ç­–é€»è¾‘:
    if config.storage_type == "s3":
        return S3StorageService(...)
    elif config.storage_type == "local":
        return LocalStorageService(...)
    
    è°ƒç”¨æ–¹ä¸éœ€è¦çŸ¥é“å…·ä½“è¿”å›å“ªä¸ªå®ç°ç±»
    """
    storage_type = config.storage_type.lower()
    
    if storage_type == "s3":
        return S3StorageService(
            client_id=client_id,
            bucket=config.s3_bucket,
            ...
        )
    elif storage_type == "local":
        return LocalStorageService(
            client_id=client_id,
            base_directory=config.base_directory
        )
```

**ä¼˜åŠ¿**:
- âœ… å°è£…åˆ›å»ºé€»è¾‘ - è°ƒç”¨æ–¹ä¸å…³å¿ƒå…·ä½“ç±»å‹
- âœ… é…ç½®é©±åŠ¨ - é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶è¡Œä¸º
- âœ… æ˜“äºæ‰©å±• - æ–°å¢MinIOåªéœ€åŠ ä¸€ä¸ªåˆ†æ”¯
- âœ… ç»Ÿä¸€æ¥å£ - è¿”å›éƒ½æ˜¯StorageInterface

---

### 4. å¼‚æ­¥ç¼–ç¨‹

å…¨é¢ä½¿ç”¨**asyncio**å®ç°é«˜å¹¶å‘ï¼š

```python
# å¼‚æ­¥ä¸Šä¼ 
async def upload_media(file: UploadFile):
    contents = await file.read()                      # å¼‚æ­¥è¯»å–
    storage_path = await storage_service.upload_file(...) # å¼‚æ­¥ä¸Šä¼ 
    
    # å¼‚æ­¥å¹¿æ’­ï¼ˆä¸é˜»å¡å“åº”ï¼‰
    asyncio.create_task(
        websocket_handler.broadcast_settings_update(...)
    )
    
    return {"success": True}  # ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…å¹¿æ’­å®Œæˆ

# å¼‚æ­¥MCPè°ƒç”¨
async def call_mcp_tool(tool_name: str):
    result = await mcp_client.call_tool(tool_name, {})
    return result
```

**ä¼˜åŠ¿**:
- âœ… é«˜å¹¶å‘ - å•çº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚
- âœ… éé˜»å¡ - é•¿è€—æ—¶æ“ä½œä¸é˜»å¡å…¶ä»–è¯·æ±‚
- âœ… èµ„æºæ•ˆç‡ - ä½å†…å­˜å ç”¨
- âœ… å®æ—¶å“åº” - WebSocketå®æ—¶æ¨é€

---

### 5. é…ç½®é©±åŠ¨

æ‰€æœ‰å…³é”®è¡Œä¸ºéƒ½é€šè¿‡**é…ç½®æ–‡ä»¶**æ§åˆ¶ï¼š

```yaml
# conf.yaml - ä¸€ä¸ªé…ç½®æ–‡ä»¶æ§åˆ¶æ‰€æœ‰è¡Œä¸º

system_config:
  # æœåŠ¡å™¨é…ç½®
  host: "127.0.0.1"
  port: 12393
  
  # åª’ä½“å­˜å‚¨é…ç½®
  media_server:
    storage_type: "s3"              # â† åˆ‡æ¢å­˜å‚¨æ–¹å¼
    client_id: "client_001"         # â† ç§Ÿæˆ·æ ‡è¯†
    s3_bucket: "my-bucket"          # â† S3é…ç½®
    cdn_url: "https://cdn.example.com"
  
  # é…ç½®ç›®å½•
  config_alts_dir: "characters"
  
  # æ—¥å¿—çº§åˆ«
  log_level: "INFO"

character_config:
  # Live2Dé…ç½®
  live2d_model_name: "sakura"
  
  # ASRé…ç½®
  asr_config:
    asr_model: "sherpa_onnx_asr"
  
  # TTSé…ç½®
  tts_config:
    model: "fish_api_tts"
    reference_id: "sakura_voice"
  
  # VADé…ç½®
  vad_config:
    positive_speech_threshold: 0.5
    negative_speech_threshold: 0.3
  
  # Agenté…ç½®
  agent_config:
    agent_type: "basic_memory_agent"
    use_mcpp: true                    # â† å¯ç”¨MCP
```

**ä¼˜åŠ¿**:
- âœ… å£°æ˜å¼é…ç½® - é…ç½®å³æ–‡æ¡£
- âœ… ç‰ˆæœ¬æ§åˆ¶ - é…ç½®æ–‡ä»¶å¯å…¥åº“
- âœ… ç¯å¢ƒåˆ†ç¦» - å¼€å‘/æµ‹è¯•/ç”Ÿäº§ä¸åŒé…ç½®
- âœ… çƒ­åˆ‡æ¢ - éƒ¨åˆ†é…ç½®å¯è¿è¡Œæ—¶ä¿®æ”¹

---

## ğŸ¯ æ¶æ„è®¾è®¡äº®ç‚¹

### 1. é›¶èµ„æºæ³„éœ²è®¾è®¡

```python
# âœ… åŸåœ°ä¿®æ”¹é…ç½®ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡
def save_vad_settings(threshold: float):
    # ç›´æ¥ä¿®æ”¹ç°æœ‰å¯¹è±¡çš„å±æ€§
    default_context_cache.character_config.vad_config.positive_speech_threshold = threshold
    # ä¸åˆ›å»ºæ–°çš„configå¯¹è±¡ï¼Œé›¶å†…å­˜åˆ†é…

# âœ… å¼‚æ­¥éé˜»å¡å¹¿æ’­
asyncio.create_task(
    websocket_handler.broadcast_to_all(message)
)
# ä¸ç­‰å¾…å¹¿æ’­å®Œæˆï¼Œç«‹å³è¿”å›
```

### 2. å•ä¾‹æ¨¡å¼åº”ç”¨

```python
# WebSocket Handler - å…¨å±€å•ä¾‹
class WebSocketServer:
    def __init__(self):
        # åˆ›å»ºå”¯ä¸€çš„WebSocket Handlerå®ä¾‹
        self.websocket_handler = WebSocketHandler(default_context_cache)
        
        # æ‰€æœ‰è·¯ç”±å…±äº«è¿™ä¸ªå®ä¾‹
        self.app.include_router(
            init_webtool_routes(
                default_context_cache=self.default_context_cache,
                websocket_handler=self.websocket_handler  # æ³¨å…¥å•ä¾‹
            )
        )

# ä¼˜åŠ¿: æ‰€æœ‰APIéƒ½å¯ä»¥è®¿é—®åŒä¸€ä¸ªè¿æ¥æ± è¿›è¡Œå¹¿æ’­
```

### 3. ç­–ç•¥æ¨¡å¼åº”ç”¨

```python
# å­˜å‚¨ç­–ç•¥
class StorageInterface(ABC):
    """å­˜å‚¨ç­–ç•¥æ¥å£"""
    
    @abstractmethod
    async def upload_file(...):
        pass

# å…·ä½“ç­–ç•¥
class LocalStorageService(StorageInterface):
    async def upload_file(self, ...):
        # æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç­–ç•¥
        with open(file_path, "wb") as f:
            f.write(file_data)

class S3StorageService(StorageInterface):
    async def upload_file(self, ...):
        # S3äº‘å­˜å‚¨ç­–ç•¥
        self.s3_client.put_object(
            Bucket=self.bucket,
            Key=s3_key,
            Body=file_data
        )

# ä½¿ç”¨æ–¹ä¸å…³å¿ƒå…·ä½“ç­–ç•¥
storage = create_storage_service(config, client_id)
await storage.upload_file(...)  # è‡ªåŠ¨ä½¿ç”¨æ­£ç¡®çš„ç­–ç•¥
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. æ‡’åŠ è½½

```python
# Service Context - æ‡’åŠ è½½å¼•æ“
class ServiceContext:
    _live2d_model: Live2dModel = None
    _asr_engine: ASRInterface = None
    
    def init_live2d(self, model_name: str):
        if self._live2d_model is None:
            self._live2d_model = Live2dModel.load(model_name)
    
    @property
    def live2d_model(self):
        if self._live2d_model is None:
            raise ValueError("Live2Dæœªåˆå§‹åŒ–")
        return self._live2d_model
```

### 2. ç¼“å­˜æœºåˆ¶

```python
# é…ç½®æ–‡ä»¶ç¼“å­˜
default_context_cache = ServiceContext()  # å…¨å±€ç¼“å­˜

# æ–°è¿æ¥æ—¶å¤ç”¨ç¼“å­˜
async def handle_new_connection(websocket, client_uid):
    # ä»ç¼“å­˜å…‹éš†é…ç½®ï¼Œä¸é‡æ–°åŠ è½½
    session_context = await _init_service_context(
        websocket.send_text,
        client_uid,
        default_context_cache  # ä¼ å…¥ç¼“å­˜å¼•ç”¨
    )
```

### 3. å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

```python
# WebSocketå¹¿æ’­ - éé˜»å¡
async def save_settings(settings_data):
    # ä¿å­˜é…ç½®
    save_config(settings_data)
    
    # å¼‚æ­¥å¹¿æ’­ï¼Œä¸ç­‰å¾…å®Œæˆ
    asyncio.create_task(
        websocket_handler.broadcast_settings_update(settings_data)
    )
    
    # ç«‹å³è¿”å›æˆåŠŸ
    return {"success": True}
```

---

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. CLIENT_IDéªŒè¯

```python
# å¤šå±‚éªŒè¯
def validate_client_id(client_id: str, request_source: str):
    # 1. æ ¼å¼éªŒè¯
    if not client_id.startswith('client_'):
        raise ValueError("æ— æ•ˆçš„CLIENT_IDæ ¼å¼")
    
    # 2. é•¿åº¦éªŒè¯
    if len(client_id) > 50:
        raise ValueError("CLIENT_IDè¿‡é•¿")
    
    # 3. å­—ç¬¦éªŒè¯
    if not re.match(r'^client_[a-zA-Z0-9_-]+$', client_id):
        raise ValueError("CLIENT_IDåŒ…å«éæ³•å­—ç¬¦")
    
    # 4. ç™½åå•éªŒè¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    valid_clients = os.getenv('VALID_CLIENTS', '').split(',')
    if valid_clients and client_id not in valid_clients:
        raise PermissionError(f"CLIENT_ID '{client_id}' æœªæˆæƒ")
```

### 2. æ–‡ä»¶éªŒè¯

```python
# å¤šå±‚æ–‡ä»¶éªŒè¯
async def upload_media(file: UploadFile):
    # 1. æ–‡ä»¶æ‰©å±•åéªŒè¯
    ALLOWED_EXTS = {'.mp4', '.avi', '.mov', '.webm'}
    if file_ext not in ALLOWED_EXTS:
        raise ValueError("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹")
    
    # 2. æ–‡ä»¶å¤§å°éªŒè¯
    MAX_SIZE = 500 * 1024 * 1024  # 500MB
    if file_size > MAX_SIZE:
        raise ValueError("æ–‡ä»¶è¿‡å¤§")
    
    # 3. MIMEç±»å‹éªŒè¯ï¼ˆå¯é€‰ï¼‰
    if file.content_type not in ['video/mp4', 'video/x-msvideo']:
        raise ValueError("ä¸æ”¯æŒçš„MIMEç±»å‹")
    
    # 4. æ–‡ä»¶å†…å®¹éªŒè¯ï¼ˆå¯é€‰ï¼Œé˜²æ­¢ä¼ªé€ æ‰©å±•åï¼‰
    # è¯»å–æ–‡ä»¶å¤´éƒ¨ï¼ŒéªŒè¯æ˜¯å¦çœŸçš„æ˜¯è§†é¢‘æ–‡ä»¶
```

### 3. S3è®¿é—®æ§åˆ¶

```python
# S3 IAMç­–ç•¥ç¤ºä¾‹
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::my-bucket/client_001/*",
                "arn:aws:s3:::my-bucket/client_002/*"
            ],
            "Condition": {
                "StringLike": {
                    "s3:prefix": ["client_*"]
                }
            }
        }
    ]
}
```

---

## ğŸ¯ æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡** - æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤
2. **å­˜å‚¨æŠ½è±¡** - æœ¬åœ°/S3æ— ç¼åˆ‡æ¢ï¼Œæœªæ¥å¯æ‰©å±•MinIO/OSS
3. **å¤šç§Ÿæˆ·éš”ç¦»** - CLIENT_IDç¡®ä¿æ•°æ®å®‰å…¨éš”ç¦»
4. **å¼‚æ­¥é«˜å¹¶å‘** - asyncioå®ç°é«˜æ€§èƒ½
5. **ä¾èµ–æ³¨å…¥** - é™ä½è€¦åˆï¼Œæ˜“äºæµ‹è¯•
6. **é…ç½®é©±åŠ¨** - è¡Œä¸ºå¯é…ç½®ï¼Œç¯å¢ƒåˆ†ç¦»

### å…³é”®ç‰¹æ€§

- âœ… **é›¶èµ„æºæ³„éœ²** - åŸåœ°ä¿®æ”¹é…ç½®ï¼Œå¼‚æ­¥éé˜»å¡
- âœ… **å®æ—¶åŒæ­¥** - WebSocketå¹¿æ’­è®¾ç½®æ›´æ–°
- âœ… **çƒ­åˆ‡æ¢** - è§’è‰²é…ç½®ã€å­˜å‚¨æ–¹å¼è¿è¡Œæ—¶åˆ‡æ¢
- âœ… **å¤šç§Ÿæˆ·** - CLIENT_IDå®Œå…¨éš”ç¦»
- âœ… **å¯æ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

### æœªæ¥æ¼”è¿›

- ğŸš€ **MCPå¹¿å‘ŠæœåŠ¡å™¨S3æ”¯æŒ** - æ ¸å¿ƒå¾…å®ç°
- ğŸš€ **Agentèµ„æºåŠ¨æ€ä¸Šä¼ ** - å¢å¼ºå¯¹è¯ä½“éªŒ
- ğŸš€ **é¢„ç­¾åURL** - æ”¯æŒç§æœ‰S3æ¡¶
- ğŸš€ **å¤šåŒºåŸŸéƒ¨ç½²** - å…¨çƒå°±è¿‘è®¿é—®
- ğŸš€ **è‡ªåŠ¨ç¼“å­˜** - æ™ºèƒ½æœ¬åœ°ç¼“å­˜S3èµ„æº

---

**ä¸‹ä¸€ç¯‡**: [05-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—](./05-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—.md)


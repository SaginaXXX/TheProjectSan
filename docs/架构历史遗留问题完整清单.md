# 架构历史遗留问题完整清单

> **分析日期**: 2025-10-06  
> **更新状态**: 最新完整分析  
> **严重性**: 🔴 高 | 🟡 中 | 🟢 低

---

## 📊 总览

### 已解决问题 ✅
- [x] websocket-context.tsx - 重复存储 wsUrl/baseUrl
- [x] vad-context.tsx - 重复存储 5 个 VAD 配置
- [x] bgurl-context.tsx - 重复存储 backgroundUrl
- [x] 删除 3 个 LEGACY 文件

### 待解决问题 ⚠️
- [ ] **websocket-handler.tsx** - 🔴 严重：与 websocket-context 重复存储配置
- [ ] live2d-config-context.tsx - 🟡 中等：使用 useLocalStorage，架构不一致
- [ ] use-advertisement-audio-settings.ts - 🟢 低：独立功能，架构不一致

---

## 🔴 严重问题：websocket-handler.tsx

### 问题描述

**`frontend/src/renderer/src/services/websocket-handler.tsx`** 在第 24-25 行：

```typescript
const [wsUrl, setWsUrl] = useLocalStorage<string>('wsUrl', defaultWsUrl);
const [baseUrl, setBaseUrl] = useLocalStorage<string>('baseUrl', defaultBaseUrl);
```

### 严重性分析

🔴 **高严重性**：与刚修复的 `websocket-context.tsx` 形成**第二处重复**！

#### 数据存储链条：

```
Zustand Store (config.wsUrl, config.baseUrl)
    ↕
websocket-context.tsx (✅ 已修复，现在从 Store 读取)
    ↕
websocket-handler.tsx (❌ 仍在使用 useLocalStorage!)
```

#### 问题影响：

1. **三处存储** - Store + websocket-handler + localStorage
2. **数据不一致风险** - 修改一处，其他两处不更新
3. **违背单一数据源原则**
4. **刚修复的架构又被破坏**

### 为什么会这样？

**架构演进过程**：

```
阶段 1 (早期):
websocket-handler.tsx 直接管理配置
└─ useLocalStorage('wsUrl')

阶段 2 (引入 Context):
websocket-context.tsx 也管理配置
└─ useLocalStorage('wsUrl')
   └─ websocket-handler 和 context 各管各的 (❌ 第一次重复)

阶段 3 (引入 Zustand):
Store 也有配置
└─ config.wsUrl
   └─ websocket-context 和 handler 都还用 localStorage (❌ 三处存储)

阶段 4 (本次修复):
✅ 修复了 websocket-context → 从 Store 读取
❌ 但 websocket-handler 被遗漏了！
```

### 解决方案

#### 方案 A：完全迁移到 Store（推荐）

```typescript
// ❌ Before
const [wsUrl, setWsUrl] = useLocalStorage<string>('wsUrl', defaultWsUrl);
const [baseUrl, setBaseUrl] = useLocalStorage<string>('baseUrl', defaultBaseUrl);

// ✅ After
const { wsUrl, baseUrl } = useConfigStore();
```

#### 方案 B：从 websocket-context 读取

```typescript
// websocket-handler.tsx 应该从 websocket-context 读取
// 而不是自己管理配置
```

#### 推荐：方案 A

**理由**：
- 减少一层间接调用
- 更直接地反映数据流
- 与其他地方的用法一致

### 修复步骤

1. 移除 `useLocalStorage` 导入
2. 导入 `useConfigStore`
3. 从 Store 读取 wsUrl 和 baseUrl
4. 移除 `setWsUrl` 和 `setBaseUrl`（应该由 Provider 设置）
5. 测试 WebSocket 连接和重连

---

## 🟡 中等问题：live2d-config-context.tsx

### 问题描述

**`frontend/src/renderer/src/context/live2d-config-context.tsx`** 使用 useLocalStorage 存储：

```typescript
// 第 121-127 行
const [modelInfo, setModelInfoState] = useLocalStorage<ModelInfo | undefined>(
  "modelInfo",
  DEFAULT_CONFIG.modelInfo,
  {
    filter: (value) => (value ? { ...value, url: "" } : value),
  },
);

// 第 129-132 行
const [scaleMemory, setScaleMemory] = useLocalStorage<Record<string, number>>(
  "scale_memory",
  {},
);
```

### 严重性分析

🟡 **中等严重性**

#### 问题：

1. **架构不一致** - 其他配置在 Store，这个在 localStorage
2. **状态分散** - Live2D 相关状态没有统一管理
3. **Store 中也有** - `config.modelInfo` 存在但未使用

#### 特殊性：

- ✅ Live2D 配置比较复杂（模型、缩放、交互设置）
- ✅ 有特殊的过滤逻辑（url 不存储）
- ✅ 有按模式和角色分别记忆缩放的需求

### 是否需要迁移？

#### 场景 1：保持现状

**理由**：
- Live2D 配置逻辑复杂，迁移风险高
- 功能独立，不影响其他模块
- 当前实现稳定可用

**问题**：
- 架构不统一
- 调试时需要查看两个地方（Store 和 localStorage）

#### 场景 2：迁移到 Store

**优点**：
- ✅ 架构统一
- ✅ 更容易调试
- ✅ 可以与其他状态联动

**缺点**：
- ❌ 迁移复杂度高
- ❌ 风险较大（Live2D 是核心功能）
- ❌ 需要在 Store 中实现复杂的记忆逻辑

### 建议

🟢 **暂时保持现状**，但：

1. 在 Store 中添加注释说明 Live2D 配置为何独立
2. 考虑未来重构时统一到 Store
3. 确保 `config.modelInfo` 与 Context 中的 modelInfo 保持同步

---

## 🟢 低优先级：use-advertisement-audio-settings.ts

### 问题描述

**`frontend/src/renderer/src/hooks/sidebar/setting/use-advertisement-audio-settings.ts`** 使用 useLocalStorage：

```typescript
const [persistedSettings, setPersistedSettings] = useLocalStorage<AdvertisementAudioSettings>(
  'advertisementAudioSettings',
  defaultSettings
);
```

### 严重性分析

🟢 **低严重性**

#### 特点：

1. **功能独立** - 只用于广告音频设置
2. **影响范围小** - 只在设置面板使用
3. **不影响核心功能**

#### 问题：

- 架构不统一（其他设置在 VAD Store 中）
- 与 VAD 自适应功能有关联但分开管理

### 是否需要迁移？

#### 方案 A：迁移到 Media Store

```typescript
// 在 Store 中添加
media: {
  // ... 现有状态
  advertisementAudioSettings: {
    audioMode: AdAudioMode,
    autoSwitchNext: boolean,
    cleanPlaybackExperience: boolean,
    supportAnyLength: boolean,
  }
}
```

**优点**：
- ✅ 架构统一
- ✅ 与其他媒体设置放在一起

**缺点**：
- ❌ 改动较小功能的成本效益不高

#### 方案 B：保持现状

**理由**：
- 功能独立
- 当前实现清晰
- 迁移价值不大

### 建议

🟢 **保持现状**，除非：
- 需要与其他功能深度集成
- 进行大规模架构重构时一并处理

---

## 📋 其他潜在问题

### 1. 配置 Hook 复杂度

**文件**：`use-general-settings.ts`, `use-asr-settings.ts`

#### 观察：

- 这些 Hook 负责临时编辑状态管理
- 有 save/cancel 逻辑
- 与 Context/Store 交互

#### 问题：

- 逻辑分散在多个 Hook 中
- 临时状态管理重复

#### 建议：

🟢 **低优先级** - 考虑统一设置管理模式，但不紧急

---

### 2. Context API vs Zustand 使用混乱

#### 观察到的模式：

**模式 1：纯 Context（业务逻辑）**
- camera-context.tsx ✅
- screen-capture-context.tsx ✅

**模式 2：Context + Store（代理模式）**
- chat-history-context.tsx ✅
- proactive-speak-context.tsx ✅

**模式 3：Context + localStorage（遗留问题）**
- live2d-config-context.tsx ⚠️
- websocket-handler.tsx 🔴

#### 建议：

制定明确的使用规则：

```
┌─────────────────────────────────────────┐
│  Zustand Store                          │
│  用途：全局应用状态                       │
│  - 配置 (wsUrl, baseUrl, VAD settings)  │
│  - UI 状态 (subtitle, showAds)          │
│  - 数据 (messages, history)             │
└─────────────────────────────────────────┘
          ↓ 单向数据流
┌─────────────────────────────────────────┐
│  Context API                            │
│  用途：业务逻辑封装 + 浏览器 API          │
│  - 硬件资源 (Camera, WebSocket 实例)    │
│  - 复杂业务逻辑 (VAD, Live2D 控制)      │
│  - 不存储全局状态，从 Store 读取         │
└─────────────────────────────────────────┘
```

---

## 🎯 修复优先级矩阵

| 问题 | 严重性 | 影响范围 | 修复难度 | 优先级 |
|------|--------|----------|----------|--------|
| websocket-handler.tsx | 🔴 高 | 核心功能 | 🟢 简单 | **P0** |
| live2d-config-context.tsx | 🟡 中 | 核心功能 | 🔴 复杂 | **P2** |
| use-advertisement-audio-settings.ts | 🟢 低 | 辅助功能 | 🟢 简单 | **P3** |
| 设置 Hook 统一 | 🟢 低 | 设置面板 | 🟡 中等 | **P4** |
| Context/Store 规范 | 🟡 中 | 架构层面 | 🟢 文档 | **P1** |

---

## 🚀 推荐行动计划

### 第一步：立即修复（必须）

**修复 websocket-handler.tsx**

- 预计时间：15 分钟
- 风险：低
- 影响：消除配置重复存储的最后一处

### 第二步：制定规范（建议）

**创建 Context/Store 使用规范文档**

- 明确何时用 Context
- 明确何时用 Store
- 明确何时用 localStorage
- 提供标准模板

### 第三步：长期优化（可选）

**评估 Live2D 配置迁移**

- 深入分析需求
- 评估迁移风险
- 制定迁移计划
- 充分测试

---

## 📝 立即行动：修复 websocket-handler.tsx

### 修改内容

```typescript
// frontend/src/renderer/src/services/websocket-handler.tsx

// ❌ 移除这两行
const [wsUrl, setWsUrl] = useLocalStorage<string>('wsUrl', defaultWsUrl);
const [baseUrl, setBaseUrl] = useLocalStorage<string>('baseUrl', defaultBaseUrl);

// ✅ 改为
const { wsUrl, baseUrl } = useConfigStore();
```

### 测试清单

- [ ] WebSocket 连接正常
- [ ] 消息收发正常
- [ ] 修改配置后能正确重连
- [ ] 刷新页面配置保持

---

## 📚 相关文档

- [Context迁移状态分析报告](./Context迁移状态分析报告.md)
- [Context迁移完成报告](./Context迁移完成报告.md)
- [WebSocket配置管理重构方案](./WebSocket配置管理重构方案.md)

---

## ✅ 总结

### 关键发现

1. **websocket-handler.tsx** 是被遗漏的重复存储点
2. Live2D 和广告音频设置使用独立的 localStorage
3. 需要明确的架构使用规范

### 下一步行动

🔴 **立即修复**: websocket-handler.tsx（5-15 分钟）
🟡 **短期规划**: 制定 Context/Store 使用规范
🟢 **长期考虑**: Live2D 配置迁移评估

---

**文档版本**: v1.0  
**最后更新**: 2025-10-06  
**维护者**: AI Assistant


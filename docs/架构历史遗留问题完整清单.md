# æ¶æ„å†å²é—ç•™é—®é¢˜å®Œæ•´æ¸…å•

> **åˆ†ææ—¥æœŸ**: 2025-10-06  
> **æ›´æ–°çŠ¶æ€**: æœ€æ–°å®Œæ•´åˆ†æ  
> **ä¸¥é‡æ€§**: ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½

---

## ğŸ“Š æ€»è§ˆ

### å·²è§£å†³é—®é¢˜ âœ…
- [x] websocket-context.tsx - é‡å¤å­˜å‚¨ wsUrl/baseUrl
- [x] vad-context.tsx - é‡å¤å­˜å‚¨ 5 ä¸ª VAD é…ç½®
- [x] bgurl-context.tsx - é‡å¤å­˜å‚¨ backgroundUrl
- [x] åˆ é™¤ 3 ä¸ª LEGACY æ–‡ä»¶

### å¾…è§£å†³é—®é¢˜ âš ï¸
- [ ] **websocket-handler.tsx** - ğŸ”´ ä¸¥é‡ï¼šä¸ websocket-context é‡å¤å­˜å‚¨é…ç½®
- [ ] live2d-config-context.tsx - ğŸŸ¡ ä¸­ç­‰ï¼šä½¿ç”¨ useLocalStorageï¼Œæ¶æ„ä¸ä¸€è‡´
- [ ] use-advertisement-audio-settings.ts - ğŸŸ¢ ä½ï¼šç‹¬ç«‹åŠŸèƒ½ï¼Œæ¶æ„ä¸ä¸€è‡´

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼šwebsocket-handler.tsx

### é—®é¢˜æè¿°

**`frontend/src/renderer/src/services/websocket-handler.tsx`** åœ¨ç¬¬ 24-25 è¡Œï¼š

```typescript
const [wsUrl, setWsUrl] = useLocalStorage<string>('wsUrl', defaultWsUrl);
const [baseUrl, setBaseUrl] = useLocalStorage<string>('baseUrl', defaultBaseUrl);
```

### ä¸¥é‡æ€§åˆ†æ

ğŸ”´ **é«˜ä¸¥é‡æ€§**ï¼šä¸åˆšä¿®å¤çš„ `websocket-context.tsx` å½¢æˆ**ç¬¬äºŒå¤„é‡å¤**ï¼

#### æ•°æ®å­˜å‚¨é“¾æ¡ï¼š

```
Zustand Store (config.wsUrl, config.baseUrl)
    â†•
websocket-context.tsx (âœ… å·²ä¿®å¤ï¼Œç°åœ¨ä» Store è¯»å–)
    â†•
websocket-handler.tsx (âŒ ä»åœ¨ä½¿ç”¨ useLocalStorage!)
```

#### é—®é¢˜å½±å“ï¼š

1. **ä¸‰å¤„å­˜å‚¨** - Store + websocket-handler + localStorage
2. **æ•°æ®ä¸ä¸€è‡´é£é™©** - ä¿®æ”¹ä¸€å¤„ï¼Œå…¶ä»–ä¸¤å¤„ä¸æ›´æ–°
3. **è¿èƒŒå•ä¸€æ•°æ®æºåŸåˆ™**
4. **åˆšä¿®å¤çš„æ¶æ„åˆè¢«ç ´å**

### ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

**æ¶æ„æ¼”è¿›è¿‡ç¨‹**ï¼š

```
é˜¶æ®µ 1 (æ—©æœŸ):
websocket-handler.tsx ç›´æ¥ç®¡ç†é…ç½®
â””â”€ useLocalStorage('wsUrl')

é˜¶æ®µ 2 (å¼•å…¥ Context):
websocket-context.tsx ä¹Ÿç®¡ç†é…ç½®
â””â”€ useLocalStorage('wsUrl')
   â””â”€ websocket-handler å’Œ context å„ç®¡å„çš„ (âŒ ç¬¬ä¸€æ¬¡é‡å¤)

é˜¶æ®µ 3 (å¼•å…¥ Zustand):
Store ä¹Ÿæœ‰é…ç½®
â””â”€ config.wsUrl
   â””â”€ websocket-context å’Œ handler éƒ½è¿˜ç”¨ localStorage (âŒ ä¸‰å¤„å­˜å‚¨)

é˜¶æ®µ 4 (æœ¬æ¬¡ä¿®å¤):
âœ… ä¿®å¤äº† websocket-context â†’ ä» Store è¯»å–
âŒ ä½† websocket-handler è¢«é—æ¼äº†ï¼
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šå®Œå…¨è¿ç§»åˆ° Storeï¼ˆæ¨èï¼‰

```typescript
// âŒ Before
const [wsUrl, setWsUrl] = useLocalStorage<string>('wsUrl', defaultWsUrl);
const [baseUrl, setBaseUrl] = useLocalStorage<string>('baseUrl', defaultBaseUrl);

// âœ… After
const { wsUrl, baseUrl } = useConfigStore();
```

#### æ–¹æ¡ˆ Bï¼šä» websocket-context è¯»å–

```typescript
// websocket-handler.tsx åº”è¯¥ä» websocket-context è¯»å–
// è€Œä¸æ˜¯è‡ªå·±ç®¡ç†é…ç½®
```

#### æ¨èï¼šæ–¹æ¡ˆ A

**ç†ç”±**ï¼š
- å‡å°‘ä¸€å±‚é—´æ¥è°ƒç”¨
- æ›´ç›´æ¥åœ°åæ˜ æ•°æ®æµ
- ä¸å…¶ä»–åœ°æ–¹çš„ç”¨æ³•ä¸€è‡´

### ä¿®å¤æ­¥éª¤

1. ç§»é™¤ `useLocalStorage` å¯¼å…¥
2. å¯¼å…¥ `useConfigStore`
3. ä» Store è¯»å– wsUrl å’Œ baseUrl
4. ç§»é™¤ `setWsUrl` å’Œ `setBaseUrl`ï¼ˆåº”è¯¥ç”± Provider è®¾ç½®ï¼‰
5. æµ‹è¯• WebSocket è¿æ¥å’Œé‡è¿

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼šlive2d-config-context.tsx

### é—®é¢˜æè¿°

**`frontend/src/renderer/src/context/live2d-config-context.tsx`** ä½¿ç”¨ useLocalStorage å­˜å‚¨ï¼š

```typescript
// ç¬¬ 121-127 è¡Œ
const [modelInfo, setModelInfoState] = useLocalStorage<ModelInfo | undefined>(
  "modelInfo",
  DEFAULT_CONFIG.modelInfo,
  {
    filter: (value) => (value ? { ...value, url: "" } : value),
  },
);

// ç¬¬ 129-132 è¡Œ
const [scaleMemory, setScaleMemory] = useLocalStorage<Record<string, number>>(
  "scale_memory",
  {},
);
```

### ä¸¥é‡æ€§åˆ†æ

ğŸŸ¡ **ä¸­ç­‰ä¸¥é‡æ€§**

#### é—®é¢˜ï¼š

1. **æ¶æ„ä¸ä¸€è‡´** - å…¶ä»–é…ç½®åœ¨ Storeï¼Œè¿™ä¸ªåœ¨ localStorage
2. **çŠ¶æ€åˆ†æ•£** - Live2D ç›¸å…³çŠ¶æ€æ²¡æœ‰ç»Ÿä¸€ç®¡ç†
3. **Store ä¸­ä¹Ÿæœ‰** - `config.modelInfo` å­˜åœ¨ä½†æœªä½¿ç”¨

#### ç‰¹æ®Šæ€§ï¼š

- âœ… Live2D é…ç½®æ¯”è¾ƒå¤æ‚ï¼ˆæ¨¡å‹ã€ç¼©æ”¾ã€äº¤äº’è®¾ç½®ï¼‰
- âœ… æœ‰ç‰¹æ®Šçš„è¿‡æ»¤é€»è¾‘ï¼ˆurl ä¸å­˜å‚¨ï¼‰
- âœ… æœ‰æŒ‰æ¨¡å¼å’Œè§’è‰²åˆ†åˆ«è®°å¿†ç¼©æ”¾çš„éœ€æ±‚

### æ˜¯å¦éœ€è¦è¿ç§»ï¼Ÿ

#### åœºæ™¯ 1ï¼šä¿æŒç°çŠ¶

**ç†ç”±**ï¼š
- Live2D é…ç½®é€»è¾‘å¤æ‚ï¼Œè¿ç§»é£é™©é«˜
- åŠŸèƒ½ç‹¬ç«‹ï¼Œä¸å½±å“å…¶ä»–æ¨¡å—
- å½“å‰å®ç°ç¨³å®šå¯ç”¨

**é—®é¢˜**ï¼š
- æ¶æ„ä¸ç»Ÿä¸€
- è°ƒè¯•æ—¶éœ€è¦æŸ¥çœ‹ä¸¤ä¸ªåœ°æ–¹ï¼ˆStore å’Œ localStorageï¼‰

#### åœºæ™¯ 2ï¼šè¿ç§»åˆ° Store

**ä¼˜ç‚¹**ï¼š
- âœ… æ¶æ„ç»Ÿä¸€
- âœ… æ›´å®¹æ˜“è°ƒè¯•
- âœ… å¯ä»¥ä¸å…¶ä»–çŠ¶æ€è”åŠ¨

**ç¼ºç‚¹**ï¼š
- âŒ è¿ç§»å¤æ‚åº¦é«˜
- âŒ é£é™©è¾ƒå¤§ï¼ˆLive2D æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
- âŒ éœ€è¦åœ¨ Store ä¸­å®ç°å¤æ‚çš„è®°å¿†é€»è¾‘

### å»ºè®®

ğŸŸ¢ **æš‚æ—¶ä¿æŒç°çŠ¶**ï¼Œä½†ï¼š

1. åœ¨ Store ä¸­æ·»åŠ æ³¨é‡Šè¯´æ˜ Live2D é…ç½®ä¸ºä½•ç‹¬ç«‹
2. è€ƒè™‘æœªæ¥é‡æ„æ—¶ç»Ÿä¸€åˆ° Store
3. ç¡®ä¿ `config.modelInfo` ä¸ Context ä¸­çš„ modelInfo ä¿æŒåŒæ­¥

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼šuse-advertisement-audio-settings.ts

### é—®é¢˜æè¿°

**`frontend/src/renderer/src/hooks/sidebar/setting/use-advertisement-audio-settings.ts`** ä½¿ç”¨ useLocalStorageï¼š

```typescript
const [persistedSettings, setPersistedSettings] = useLocalStorage<AdvertisementAudioSettings>(
  'advertisementAudioSettings',
  defaultSettings
);
```

### ä¸¥é‡æ€§åˆ†æ

ğŸŸ¢ **ä½ä¸¥é‡æ€§**

#### ç‰¹ç‚¹ï¼š

1. **åŠŸèƒ½ç‹¬ç«‹** - åªç”¨äºå¹¿å‘ŠéŸ³é¢‘è®¾ç½®
2. **å½±å“èŒƒå›´å°** - åªåœ¨è®¾ç½®é¢æ¿ä½¿ç”¨
3. **ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½**

#### é—®é¢˜ï¼š

- æ¶æ„ä¸ç»Ÿä¸€ï¼ˆå…¶ä»–è®¾ç½®åœ¨ VAD Store ä¸­ï¼‰
- ä¸ VAD è‡ªé€‚åº”åŠŸèƒ½æœ‰å…³è”ä½†åˆ†å¼€ç®¡ç†

### æ˜¯å¦éœ€è¦è¿ç§»ï¼Ÿ

#### æ–¹æ¡ˆ Aï¼šè¿ç§»åˆ° Media Store

```typescript
// åœ¨ Store ä¸­æ·»åŠ 
media: {
  // ... ç°æœ‰çŠ¶æ€
  advertisementAudioSettings: {
    audioMode: AdAudioMode,
    autoSwitchNext: boolean,
    cleanPlaybackExperience: boolean,
    supportAnyLength: boolean,
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¶æ„ç»Ÿä¸€
- âœ… ä¸å…¶ä»–åª’ä½“è®¾ç½®æ”¾åœ¨ä¸€èµ·

**ç¼ºç‚¹**ï¼š
- âŒ æ”¹åŠ¨è¾ƒå°åŠŸèƒ½çš„æˆæœ¬æ•ˆç›Šä¸é«˜

#### æ–¹æ¡ˆ Bï¼šä¿æŒç°çŠ¶

**ç†ç”±**ï¼š
- åŠŸèƒ½ç‹¬ç«‹
- å½“å‰å®ç°æ¸…æ™°
- è¿ç§»ä»·å€¼ä¸å¤§

### å»ºè®®

ğŸŸ¢ **ä¿æŒç°çŠ¶**ï¼Œé™¤éï¼š
- éœ€è¦ä¸å…¶ä»–åŠŸèƒ½æ·±åº¦é›†æˆ
- è¿›è¡Œå¤§è§„æ¨¡æ¶æ„é‡æ„æ—¶ä¸€å¹¶å¤„ç†

---

## ğŸ“‹ å…¶ä»–æ½œåœ¨é—®é¢˜

### 1. é…ç½® Hook å¤æ‚åº¦

**æ–‡ä»¶**ï¼š`use-general-settings.ts`, `use-asr-settings.ts`

#### è§‚å¯Ÿï¼š

- è¿™äº› Hook è´Ÿè´£ä¸´æ—¶ç¼–è¾‘çŠ¶æ€ç®¡ç†
- æœ‰ save/cancel é€»è¾‘
- ä¸ Context/Store äº¤äº’

#### é—®é¢˜ï¼š

- é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ª Hook ä¸­
- ä¸´æ—¶çŠ¶æ€ç®¡ç†é‡å¤

#### å»ºè®®ï¼š

ğŸŸ¢ **ä½ä¼˜å…ˆçº§** - è€ƒè™‘ç»Ÿä¸€è®¾ç½®ç®¡ç†æ¨¡å¼ï¼Œä½†ä¸ç´§æ€¥

---

### 2. Context API vs Zustand ä½¿ç”¨æ··ä¹±

#### è§‚å¯Ÿåˆ°çš„æ¨¡å¼ï¼š

**æ¨¡å¼ 1ï¼šçº¯ Contextï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰**
- camera-context.tsx âœ…
- screen-capture-context.tsx âœ…

**æ¨¡å¼ 2ï¼šContext + Storeï¼ˆä»£ç†æ¨¡å¼ï¼‰**
- chat-history-context.tsx âœ…
- proactive-speak-context.tsx âœ…

**æ¨¡å¼ 3ï¼šContext + localStorageï¼ˆé—ç•™é—®é¢˜ï¼‰**
- live2d-config-context.tsx âš ï¸
- websocket-handler.tsx ğŸ”´

#### å»ºè®®ï¼š

åˆ¶å®šæ˜ç¡®çš„ä½¿ç”¨è§„åˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Zustand Store                          â”‚
â”‚  ç”¨é€”ï¼šå…¨å±€åº”ç”¨çŠ¶æ€                       â”‚
â”‚  - é…ç½® (wsUrl, baseUrl, VAD settings)  â”‚
â”‚  - UI çŠ¶æ€ (subtitle, showAds)          â”‚
â”‚  - æ•°æ® (messages, history)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ å•å‘æ•°æ®æµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context API                            â”‚
â”‚  ç”¨é€”ï¼šä¸šåŠ¡é€»è¾‘å°è£… + æµè§ˆå™¨ API          â”‚
â”‚  - ç¡¬ä»¶èµ„æº (Camera, WebSocket å®ä¾‹)    â”‚
â”‚  - å¤æ‚ä¸šåŠ¡é€»è¾‘ (VAD, Live2D æ§åˆ¶)      â”‚
â”‚  - ä¸å­˜å‚¨å…¨å±€çŠ¶æ€ï¼Œä» Store è¯»å–         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§çŸ©é˜µ

| é—®é¢˜ | ä¸¥é‡æ€§ | å½±å“èŒƒå›´ | ä¿®å¤éš¾åº¦ | ä¼˜å…ˆçº§ |
|------|--------|----------|----------|--------|
| websocket-handler.tsx | ğŸ”´ é«˜ | æ ¸å¿ƒåŠŸèƒ½ | ğŸŸ¢ ç®€å• | **P0** |
| live2d-config-context.tsx | ğŸŸ¡ ä¸­ | æ ¸å¿ƒåŠŸèƒ½ | ğŸ”´ å¤æ‚ | **P2** |
| use-advertisement-audio-settings.ts | ğŸŸ¢ ä½ | è¾…åŠ©åŠŸèƒ½ | ğŸŸ¢ ç®€å• | **P3** |
| è®¾ç½® Hook ç»Ÿä¸€ | ğŸŸ¢ ä½ | è®¾ç½®é¢æ¿ | ğŸŸ¡ ä¸­ç­‰ | **P4** |
| Context/Store è§„èŒƒ | ğŸŸ¡ ä¸­ | æ¶æ„å±‚é¢ | ğŸŸ¢ æ–‡æ¡£ | **P1** |

---

## ğŸš€ æ¨èè¡ŒåŠ¨è®¡åˆ’

### ç¬¬ä¸€æ­¥ï¼šç«‹å³ä¿®å¤ï¼ˆå¿…é¡»ï¼‰

**ä¿®å¤ websocket-handler.tsx**

- é¢„è®¡æ—¶é—´ï¼š15 åˆ†é’Ÿ
- é£é™©ï¼šä½
- å½±å“ï¼šæ¶ˆé™¤é…ç½®é‡å¤å­˜å‚¨çš„æœ€åä¸€å¤„

### ç¬¬äºŒæ­¥ï¼šåˆ¶å®šè§„èŒƒï¼ˆå»ºè®®ï¼‰

**åˆ›å»º Context/Store ä½¿ç”¨è§„èŒƒæ–‡æ¡£**

- æ˜ç¡®ä½•æ—¶ç”¨ Context
- æ˜ç¡®ä½•æ—¶ç”¨ Store
- æ˜ç¡®ä½•æ—¶ç”¨ localStorage
- æä¾›æ ‡å‡†æ¨¡æ¿

### ç¬¬ä¸‰æ­¥ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

**è¯„ä¼° Live2D é…ç½®è¿ç§»**

- æ·±å…¥åˆ†æéœ€æ±‚
- è¯„ä¼°è¿ç§»é£é™©
- åˆ¶å®šè¿ç§»è®¡åˆ’
- å……åˆ†æµ‹è¯•

---

## ğŸ“ ç«‹å³è¡ŒåŠ¨ï¼šä¿®å¤ websocket-handler.tsx

### ä¿®æ”¹å†…å®¹

```typescript
// frontend/src/renderer/src/services/websocket-handler.tsx

// âŒ ç§»é™¤è¿™ä¸¤è¡Œ
const [wsUrl, setWsUrl] = useLocalStorage<string>('wsUrl', defaultWsUrl);
const [baseUrl, setBaseUrl] = useLocalStorage<string>('baseUrl', defaultBaseUrl);

// âœ… æ”¹ä¸º
const { wsUrl, baseUrl } = useConfigStore();
```

### æµ‹è¯•æ¸…å•

- [ ] WebSocket è¿æ¥æ­£å¸¸
- [ ] æ¶ˆæ¯æ”¶å‘æ­£å¸¸
- [ ] ä¿®æ”¹é…ç½®åèƒ½æ­£ç¡®é‡è¿
- [ ] åˆ·æ–°é¡µé¢é…ç½®ä¿æŒ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Contextè¿ç§»çŠ¶æ€åˆ†ææŠ¥å‘Š](./Contextè¿ç§»çŠ¶æ€åˆ†ææŠ¥å‘Š.md)
- [Contextè¿ç§»å®ŒæˆæŠ¥å‘Š](./Contextè¿ç§»å®ŒæˆæŠ¥å‘Š.md)
- [WebSocketé…ç½®ç®¡ç†é‡æ„æ–¹æ¡ˆ](./WebSocketé…ç½®ç®¡ç†é‡æ„æ–¹æ¡ˆ.md)

---

## âœ… æ€»ç»“

### å…³é”®å‘ç°

1. **websocket-handler.tsx** æ˜¯è¢«é—æ¼çš„é‡å¤å­˜å‚¨ç‚¹
2. Live2D å’Œå¹¿å‘ŠéŸ³é¢‘è®¾ç½®ä½¿ç”¨ç‹¬ç«‹çš„ localStorage
3. éœ€è¦æ˜ç¡®çš„æ¶æ„ä½¿ç”¨è§„èŒƒ

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ğŸ”´ **ç«‹å³ä¿®å¤**: websocket-handler.tsxï¼ˆ5-15 åˆ†é’Ÿï¼‰
ğŸŸ¡ **çŸ­æœŸè§„åˆ’**: åˆ¶å®š Context/Store ä½¿ç”¨è§„èŒƒ
ğŸŸ¢ **é•¿æœŸè€ƒè™‘**: Live2D é…ç½®è¿ç§»è¯„ä¼°

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-06  
**ç»´æŠ¤è€…**: AI Assistant


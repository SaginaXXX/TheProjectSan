# 快速修复指南：清空缓存恢复连接

> **问题**: WebSocket 无法连接  
> **原因**: localStorage 中有旧的空值配置  
> **修复时间**: 1 分钟

---

## 🚀 立即执行（三步搞定）

### 步骤 1：打开浏览器开发者工具

按 **F12** 或右键 → 检查

### 步骤 2：切换到 Console（控制台）标签

### 步骤 3：复制粘贴以下命令并回车

```javascript
// 清空所有缓存
localStorage.clear();
sessionStorage.clear();
console.log('✅ 缓存已清空');

// 重新加载页面
location.reload();
```

---

## 📊 原理说明

### 为什么需要清空缓存？

**问题链条**：

```
1. 之前的代码使用 useLocalStorage
   └─ localStorage['wsUrl'] = ''  ❌ 空字符串

2. 我们修复了代码，Store 现在有默认值
   └─ initialConfig.wsUrl = 'ws://127.0.0.1:12393/client-ws' ✅

3. 但 Zustand persist 中间件从 localStorage 还原数据
   └─ 读取到旧的空值
   └─ 覆盖了 Store 的默认值
   └─ wsUrl 又变成 '' ❌

4. WebSocket 尝试连接空 URL
   └─ 连接失败 ❌
```

### 清空缓存后

```
1. localStorage 为空 ✅

2. Zustand persist 找不到旧数据
   └─ 使用 Store 的默认值
   └─ wsUrl = 'ws://127.0.0.1:12393/client-ws' ✅

3. WebSocket 连接成功 ✅

4. 功能恢复正常 ✅
```

---

## ✅ 验证成功

清空缓存并刷新后，应该看到：

```javascript
✅ 正确的日志：

1. 🏪 Zustand企业级状态管理系统已初始化
2. 🌐 自动检测服务器地址: http://localhost:12393
3. 🔌 WebSocketHandler: 初始化WebSocket连接
4. 🌐 WS connecting... ws://127.0.0.1:12393/client-ws
5. ✅ WS open  ← 关键！应该看到这个
6. 🩺 WS heartbeat -> ping
7. 后续正常日志...
```

**功能恢复**：
- ✅ Live2D 模型加载
- ✅ 麦克风可用
- ✅ 可以对话

---

## 🔧 一键修复脚本

如果你经常开发，可以在控制台创建快捷命令：

```javascript
// 保存到浏览器 Snippets
window.clearAppCache = function() {
  localStorage.clear();
  sessionStorage.clear();
  console.log('✅ 应用缓存已清空');
  location.reload();
};

// 使用: clearAppCache()
```

---

## 🔮 永久修复

我已经在代码中添加了防护，以后不会再出现这个问题：

```typescript
// ✅ Store 现在有合理的默认值
const initialConfigState = {
  wsUrl: 'ws://127.0.0.1:12393/client-ws',  // 有效默认值
  baseUrl: 'http://127.0.0.1:12393',         // 有效默认值
};
```

**清空缓存后，以后就正常了！**

---

## ❓ 如果清空缓存后还是不行

### 1. 检查后端是否运行

```bash
# 确保后端服务在运行
python run_server.py
```

**应该看到**：
```
INFO:     Uvicorn running on http://0.0.0.0:12393
```

### 2. 检查 Store 配置

在控制台执行：

```javascript
// 检查 Store 中的配置
const { useAppStore } = await import('./src/store/index.ts');
const state = useAppStore.getState();
console.log('wsUrl:', state.config.wsUrl);
console.log('baseUrl:', state.config.baseUrl);
```

**应该输出**：
```
wsUrl: ws://127.0.0.1:12393/client-ws
baseUrl: http://127.0.0.1:12393
```

### 3. 手动连接测试

```javascript
const { wsService } = await import('./src/services/websocket-service.tsx');
wsService.connect('ws://127.0.0.1:12393/client-ws');
```

---

## 🔄 终极回滚方案

如果以上都不行，回滚所有修改：

```bash
git status
git checkout -- frontend/src/renderer/src/
```

---

**立即执行**: 在浏览器控制台运行 `localStorage.clear(); location.reload();`

**预计结果**: 🟢 **应该立即恢复正常**


<!-- 02435dd7-cbc6-4c95-8cfb-a94e3c127464 1587748a-d2c0-4b52-88c6-0b3cd789b7e4 -->
# ä¿®å¤Webæ§åˆ¶é¢æ¿è®¾ç½®å®Œå…¨æ— æ•ˆé—®é¢˜

## æ ¸å¿ƒå‘ç°

**åŸæ§åˆ¶é¢æ¿é€šè¿‡WebSocketæ¶ˆæ¯`switch-config`å®ç°è§’è‰²åˆ‡æ¢ï¼Œæ— éœ€é‡å¯ï¼**

### åŸæ§åˆ¶é¢æ¿çš„å®ç°

1. å‰ç«¯è°ƒç”¨ï¼š`sendMessage({ type: 'switch-config', file: fileName })`
2. åç«¯å¤„ç†ï¼š`websocket_handler._handle_config_switch()` 
3. é‡æ–°åŠ è½½ï¼š`context.handle_config_switch()` - é‡æ–°åˆå§‹åŒ–é…ç½®å’Œç»„ä»¶

## é—®é¢˜è¯Šæ–­

### 1. è§’è‰²é¢„è®¾åˆ‡æ¢æ— æ•ˆ âœ… æœ‰è§£å†³æ–¹æ¡ˆ

**ç°çŠ¶**ï¼šè¢«æ ‡è®°ä¸º"é‡é‡çº§"ï¼ŒåªåŠ å…¥`heavyweight_pending`åˆ—è¡¨ï¼Œä¸ä¼šç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨`/api/settings/save`ä¸­ï¼Œå½“æ£€æµ‹åˆ°`character_preset`å˜åŒ–æ—¶ï¼Œé€šè¿‡WebSocketå¹¿æ’­`switch-config`æ¶ˆæ¯åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯

### 2. å­—å¹•/UIè®¾ç½®æ— æ•ˆ âŒ éœ€è¦ä¿®å¤

**ç°çŠ¶**ï¼šåªæ ‡è®°ä¸º"å·²åº”ç”¨"ï¼Œæ²¡æœ‰å®é™…ä¿®æ”¹é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼šå®é™…ä¿®æ”¹`default_context_cache.config`ä¸­çš„é…ç½®å±æ€§

### 3. Webæ§åˆ¶é¢æ¿æ— WebSocketè¿æ¥

**ç°çŠ¶**ï¼š`control-panel.html`æ˜¯ç‹¬ç«‹HTMLé¡µé¢ï¼Œæ²¡æœ‰WebSocketè¿æ¥

**å½±å“**ï¼šæ— æ³•æ¥æ”¶å®æ—¶æ›´æ–°é€šçŸ¥

**è§£å†³æ–¹æ¡ˆ**ï¼šWebæ§åˆ¶é¢æ¿ä¸éœ€è¦å®æ—¶çœ‹åˆ°æ•ˆæœï¼Œåªéœ€è¦æ ‘è“æ´¾å‰ç«¯ï¼ˆå·²è¿æ¥WebSocketï¼‰èƒ½å®æ—¶ç”Ÿæ•ˆå³å¯

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šåç«¯å¹¿æ’­ + å‰ç«¯è‡ªåŠ¨åº”ç”¨

**æµç¨‹**ï¼š

```
Webæ§åˆ¶é¢æ¿(æ‰‹æœº) â†’ POST /api/settings/save â†’ 
åç«¯ä¿®æ”¹é…ç½® + WebSocketå¹¿æ’­ â†’ 
æ ‘è“æ´¾å‰ç«¯(å·²è¿æ¥WS)æ¥æ”¶æ¶ˆæ¯ â†’ 
è‡ªåŠ¨åº”ç”¨æ–°è®¾ç½®
```

**ä¼˜ç‚¹**ï¼š

- åˆ©ç”¨ç°æœ‰WebSocketåŸºç¡€è®¾æ–½
- Webæ§åˆ¶é¢æ¿ä¿æŒè½»é‡ï¼ˆæ— éœ€WebSocketï¼‰
- æ ‘è“æ´¾å‰ç«¯å®æ—¶ç”Ÿæ•ˆ
- ç¬¦åˆç”¨æˆ·ä½¿ç”¨åœºæ™¯

## å®æ–½æ­¥éª¤

### 1. ä¿®å¤è§’è‰²é¢„è®¾åˆ‡æ¢ï¼ˆè°ƒç”¨ç°æœ‰æœºåˆ¶ï¼‰

åœ¨`src/ai_chat/routes.py`çš„`save_settings`ä¸­ï¼š

```python
# è§’è‰²é¢„è®¾åˆ‡æ¢ï¼ˆé€šè¿‡WebSocketè§¦å‘ï¼‰
if 'character_preset' in settings_data and settings_data['character_preset']:
    config_filename = settings_data['character_preset']
    
    # é€šè¿‡WebSocketå¹¿æ’­é…ç½®åˆ‡æ¢è¯·æ±‚
    if websocket_handler:
        switch_message = {
            "type": "switch-config",
            "file": config_filename
        }
        # å¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
        await websocket_handler.broadcast_to_all(switch_message)
        lightweight_applied.append('character_preset')
        logger.info(f"âœ… å·²å¹¿æ’­è§’è‰²åˆ‡æ¢: {config_filename}")
```

### 2. ä¿®å¤å­—å¹•è®¾ç½®ï¼ˆå®é™…ä¿®æ”¹é…ç½®ï¼‰

éœ€è¦å…ˆæ£€æŸ¥é…ç½®ç»“æ„ï¼Œç„¶åä¿®æ”¹ï¼š

```python
# å­—å¹•è®¾ç½®
if 'subtitle_bg_color' in settings_data:
    # å‡è®¾è·¯å¾„ï¼ˆéœ€ç¡®è®¤ï¼‰
    default_context_cache.config.system_config.subtitle_bg_color = settings_data['subtitle_bg_color']
    lightweight_applied.append('subtitle_bg_color')
```

### 3. ä¿®å¤UIè®¾ç½®

```python
# UIè®¾ç½®
if 'use_camera_background' in settings_data:
    default_context_cache.config.system_config.use_camera_background = settings_data['use_camera_background']
    lightweight_applied.append('use_camera_background')
```

### 4. å®ç°WebSocketå¹¿æ’­æ–¹æ³•

åœ¨`src/ai_chat/websocket_handler.py`ä¸­æ·»åŠ ï¼š

```python
async def broadcast_to_all(self, message: dict):
    """å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯"""
    if not self.client_connections:
        return
    
    message_str = json.dumps(message)
    for client_uid, ws in self.client_connections.items():
        try:
            await ws.send_text(message_str)
            logger.debug(f"ğŸ“¡ å·²å‘å®¢æˆ·ç«¯ {client_uid} å¹¿æ’­æ¶ˆæ¯")
        except Exception as e:
            logger.warning(f"âš ï¸ å‘å®¢æˆ·ç«¯ {client_uid} å¹¿æ’­å¤±è´¥: {e}")
```

### 5. å‰ç«¯è‡ªåŠ¨åº”ç”¨ï¼ˆå·²å®ç°ï¼‰

å‰ç«¯å·²ç»ç›‘å¬`switch-config`æ¶ˆæ¯å¹¶è‡ªåŠ¨åº”ç”¨ï¼Œæ— éœ€ä¿®æ”¹

## éœ€è¦ç¡®è®¤çš„é…ç½®è·¯å¾„

åœ¨ä¿®æ”¹ä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹é…ç½®çš„ç¡®åˆ‡å±æ€§è·¯å¾„ï¼š

1. **å­—å¹•é…ç½®**ï¼š

   - `subtitle_enabled`
   - `subtitle_bg_color`
   - `subtitle_bg_opacity`
   - `subtitle_text_color`
   - `subtitle_padding_x/y`
   - `subtitle_border_radius`
   - `subtitle_blur`

2. **UIé…ç½®**ï¼š

   - `language`
   - `use_camera_background`
   - `show_subtitle`

æ£€æŸ¥æ–¹æ³•ï¼š

```python
# è¯»å–SystemConfigå®šä¹‰
grep -r "class SystemConfig" src/ai_chat/config_manager/
```

## æµ‹è¯•æµç¨‹

1. æ‰‹æœºæ‰“å¼€Webæ§åˆ¶é¢æ¿
2. ä¿®æ”¹è§’è‰²é¢„è®¾/å­—å¹•è®¾ç½®
3. ç‚¹å‡»ä¿å­˜
4. **æ ‘è“æ´¾å‰ç«¯åº”è¯¥å®æ—¶åˆ‡æ¢è§’è‰²/æ›´æ–°UI**
5. æ— éœ€é‡å¯ä»»ä½•æœåŠ¡

## å…³é”®ä¼˜åŠ¿

âœ… **æ— éœ€é‡å¯** - åˆ©ç”¨ç°æœ‰`switch-config`æœºåˆ¶

âœ… **å®æ—¶ç”Ÿæ•ˆ** - WebSocketå¹¿æ’­åˆ°æ ‘è“æ´¾å‰ç«¯

âœ… **è½»é‡Webé¢æ¿** - ä¸éœ€è¦å»ºç«‹WebSocketè¿æ¥

âœ… **é›¶ä»£ç é‡æ„** - å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½

### To-dos

- [ ] è°ƒæŸ¥routes.pyå¦‚ä½•è®¿é—®WebSocketè¿æ¥æ± è¿›è¡Œå¹¿æ’­
- [ ] å®šä½æ‰€æœ‰è®¾ç½®é¡¹åœ¨ServiceContextä¸­çš„ç¡®åˆ‡å±æ€§è·¯å¾„
- [ ] å®ç°/api/settings/saveä¸­çš„å®é™…é…ç½®ä¿®æ”¹é€»è¾‘
- [ ] æ·»åŠ WebSocketå¹¿æ’­æœºåˆ¶é€šçŸ¥å‰ç«¯åˆ·æ–°
- [ ] å‰ç«¯æ·»åŠ è®¾ç½®æ›´æ–°äº‹ä»¶ç›‘å¬å’Œé…ç½®åˆ·æ–°
- [ ] æµ‹è¯•æ‰‹æœºWebæ§åˆ¶é¢æ¿ä¿®æ”¹è®¾ç½®åï¼Œæ ‘è“æ´¾å‰ç«¯å®æ—¶ç”Ÿæ•ˆ